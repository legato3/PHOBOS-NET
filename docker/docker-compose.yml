services:
  phobos-net:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: phobos-net
    ports:
      - "3434:8080" # Web dashboard
      - "2055:2055/udp" # NetFlow collection (nfcapd)
      - "514:5514/udp" # Syslog receiver (maps host 514 to container 5514)
      - "515:5515/udp" # Firewall syslog (maps host 515 to container 5515)
    environment:
      # Production settings
      - PYTHONUNBUFFERED=1
      - WORKDIR=/app

      # Persistence & Paths (Defaults set in Dockerfile/config.py, overridden here for clarity)
      - NFCAPD_DIR=/var/cache/nfdump
      - THREAT_FEEDS_PATH=/opt/phobos/config/threat-feeds.txt

      # Syslog settings (Non-root container uses high ports internally)
      - SYSLOG_BIND=0.0.0.0
      - SYSLOG_PORT=5514
      - FIREWALL_SYSLOG_BIND=0.0.0.0
      - FIREWALL_SYSLOG_PORT=5515

      # Firewall Source Control
      - FIREWALL_IP=0.0.0.0 # Accepts logs from any source (Restrict to FW IP in prod)
      # Optional Integrations
      # - DNS_SERVER=192.168.0.6
      # - SNMP_HOST=192.168.0.1
      # - SNMP_COMMUNITY=Phoboshomesnmp_3
      # - VIRUSTOTAL_API_KEY=
      # - ABUSEIPDB_API_KEY=

    volumes:
      # Persistent User Data (DBs, Threat Lists, Watchlists)
      - ../docker-data:/app/data
      # NetFlow Data Cache
      - ../docker-data/nfdump:/var/cache/nfdump
    restart: unless-stopped
    # Resource limits matching production (optional, can be adjusted)
    # Resource limits matching production (optional, can be adjusted)
    mem_limit: 2g
    memswap_limit: 3g
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
