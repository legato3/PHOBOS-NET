{% macro widget_card(id, title, icon, min_height='300px', extra_actions=None, show_spinner=False, card_class='',
card_class_bind=None, footer_content=None, title_x_text=None, period_x_text=None) %}
{%- set data_prop = id -%}
{%- if id == 'worldmap' -%}
{%- set data_prop = 'worldMap' -%}
{%- elif id == 'insights' -%}
{%- set data_prop = 'insights' -%}
{%- endif -%}
<div class="card {{ card_class }}" {% if card_class_bind %}:class="{{ card_class_bind }}" {% endif %}>
    <h2>
        <div class="card-title-content" style="display: flex; align-items: center; flex: 1; min-width: 0;">

            <span {% if title_x_text %}x-text="{{ title_x_text }}" {% endif %}
                style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ title }}</span>
            <template x-if="{{ period_x_text or 'false' }}">
                <span class="period-badge" x-text="{{ period_x_text }}"
                    style="margin-left: auto; font-size: 0.7em; color: var(--text-tertiary); font-weight: 500; padding: 2px 6px; border: 1px solid rgba(255,255,255,0.05); border-radius: 4px; text-transform: uppercase; white-space: nowrap; flex-shrink: 0;"></span>
            </template>
        </div>
        <div class="card-actions" style="flex-shrink: 0;">
            {% if extra_actions %}
            {{ extra_actions | safe }}
            {% endif %}

            {% if show_spinner %}
            <div class="spinner" x-show="{{ data_prop }}?.loading"></div>
            {% endif %}
        </div>
    </h2>
    <div class="widget-body" data-min-height="{{ min_height }}" x-init="$el.style.minHeight = $el.dataset.minHeight">
        <!-- Skeleton Loader -->
        <div class="skeleton-container" x-show="{{ data_prop }}?.loading">
            <div class="skeleton-line title w-50"></div>
            <div class="skeleton-chart"></div>
        </div>

        <!-- Real Content -->
        <div x-show="!{{ data_prop }}?.loading" style="display: none;"
            :style="!{{ data_prop }}?.loading ? 'display: block' : ''">
            {{ caller() }}
        </div>
    </div>
    {% if footer_content %}
    <div class="card-footer">
        {{ footer_content | safe }}
    </div>
    {% endif %}
</div>
{% endmacro %}

{# Reusable InsightPanel component - works for Traffic, Firewall, Hosts #}
{% macro insight_panel(panel_key, title, icon, time_window_expr) %}
<div class="card">
    <h2>
        <div class="card-title-content" style="display: flex; align-items: center; flex: 1; min-width: 0;">

            <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ title }}</span>
            <span class="period-badge"
                style="margin-left: auto; font-size: 0.7em; color: var(--text-tertiary); font-weight: 500; padding: 2px 6px; border: 1px solid rgba(255,255,255,0.05); border-radius: 4px; text-transform: uppercase; white-space: nowrap; flex-shrink: 0;"
                x-text="{{ time_window_expr }}"></span>
        </div>
    </h2>
    <div class="widget-body">
        <!-- Loading State -->
        <template x-if="insightPanels.{{ panel_key }}.loading">
            <div class="empty-state">
                <span>Loading insights...</span>
            </div>
        </template>

        <!-- Insight Cards (max 3-4 visible) -->
        <template
            x-if="!insightPanels.{{ panel_key }}.loading && insightPanels.{{ panel_key }}.insights && insightPanels.{{ panel_key }}.insights.length > 0">
            <div style="display: grid; grid-template-columns: 1fr; gap: 0; margin-bottom: 12px;">
                <template x-for="(insight, idx) in insightPanels.{{ panel_key }}.insights.slice(0, 4)"
                    :key="'insight-' + idx + '-' + insight.id">
                    <div class="insight-row"
                        style="padding: 10px 4px; background: transparent; border-bottom: 1px solid var(--border-soft); display: flex; align-items: center; justify-content: space-between;">
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;"
                            x-text="insight.label"></div>
                        <div
                            style="font-size: 1.1em; color: var(--text-primary); margin-bottom: 4px; font-weight: 500;">
                            <template x-if="insight.type === 'talker' || insight.type === 'ip'">
                                <span class="clickable-ip" @click.stop="openIPModal(insight.key)"
                                    role="button" tabindex="0" :aria-label="'View details for ' + insight.key"
                                    @keydown.enter="openIPModal(insight.key)"
                                    @keydown.space.prevent="openIPModal(insight.key)"
                                    style="color: var(--neon-cyan); cursor: pointer;" x-text="insight.key"></span>
                            </template>
                            <template x-if="insight.type === 'protocol'">
                                <span x-text="insight.key"></span>
                            </template>
                            <template x-if="insight.type === 'port'">
                                <span x-text="'Port ' + insight.key"></span>
                            </template>
                            <template x-if="insight.type === 'destination'">
                                <span class="clickable-ip" @click.stop="openIPModal(insight.key)"
                                    role="button" tabindex="0" :aria-label="'View details for ' + insight.key"
                                    @keydown.enter="openIPModal(insight.key)"
                                    @keydown.space.prevent="openIPModal(insight.key)"
                                    style="color: var(--neon-cyan); cursor: pointer;" x-text="insight.key"></span>
                            </template>
                            <template x-if="insight.type === 'rule' || insight.type === 'category'">
                                <span x-text="insight.key"></span>
                            </template>
                            <template x-if="insight.type === 'host'">
                                <span x-text="insight.key"></span>
                            </template>
                            <template x-if="insight.type === 'anomaly' && insight.isStabilityConfirmation">
                                <span style="color: var(--neon-green);" x-text="insight.key"></span>
                            </template>
                            <template x-if="insight.type === 'anomaly' && !insight.isStabilityConfirmation">
                                <span x-text="insight.key"></span>
                            </template>
                        </div>
                        <div style="font-size: 0.9em; color: var(--text-primary); margin-bottom: 2px;"
                            x-text="insight.absolute"></div>
                        <div style="font-size: 0.75em; color: var(--text-secondary);" x-text="insight.relative"></div>
                        <template x-if="insight.service">
                            <div style="font-size: 0.7em; color: var(--text-tertiary); margin-top: 4px;"
                                x-text="insight.service"></div>
                        </template>
                    </div>
                </template>
            </div>
        </template>

        <!-- Expanded View - Custom content per panel type -->
        <div x-show="insightPanels.{{ panel_key }}.expanded" x-collapse
            style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
            {{ caller() }}
        </div>

        <!-- Empty State -->
        <template
            x-if="!insightPanels.{{ panel_key }}.loading && (!insightPanels.{{ panel_key }}.insights || insightPanels.{{ panel_key }}.insights.length === 0)">
            <div class="empty-state">
                <span>No insights available</span>
            </div>
        </template>
    </div>
</div>
{% endmacro %}