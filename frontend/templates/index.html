<!DOCTYPE html>
<html lang="en">

<head>
    <title x-text="appMetadata.name || 'PHOBOS-NET'">PHOBOS-NET</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description"
        content="Real-time NetFlow analytics dashboard with threat intelligence, bandwidth monitoring, and firewall health metrics. Monitor network traffic, detect threats, and analyze security events.">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" :content="appMetadata.name || 'PHOBOS-NET'">
    <meta property="og:description"
        content="Real-time network traffic monitoring with threat intelligence and security analytics">
    <meta property="og:site_name" :content="appMetadata.name || 'PHOBOS-NET'">

    <!-- Resource hints for better performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <!-- Typography - Inter for UI, JetBrains Mono for technical data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Critical JavaScript modules - Preload for faster execution -->
    <!-- Note: widgets.js and utils.js are ES modules imported by app.js, so they're handled by the module graph -->
    <!-- lazy-load.js is loaded as a regular script, so preloading it makes sense -->
    <link rel="preload" href="/static/js/lazy-load.js" as="script">

    <!-- CSS - Critical render path, load first -->
    <!-- CYBERPUNK UI: Signal-first design system -->
    <link rel="stylesheet" href="/static/style.css?v=5.1.1">
    <link rel="stylesheet" href="/static/css/mobile.css?v=5.1.1">
    <!-- Widget-specific enhancements -->


    <!-- External Libs (bundled locally to reduce CDN dependency) - Defer all heavy libraries -->
    <script src="/static/chart.min.js" defer></script>
    <script src="/static/alpine-collapse.min.js" defer></script>

    <!-- Modular JavaScript - Load modules before app (critical path) -->
    <script src="/static/js/lazy-load.js"></script>

    <!-- Main app - Register BEFORE Alpine starts so alpine:init is caught -->
    <script type="module" src="/static/app.js?v=3.2.0"></script>

    <!-- Alpine.js - Defer to allow app.js to register -->
    <script src="/static/alpine.min.js" defer></script>

    <!-- Heavy visualization libraries - Defer until needed -->

    <!-- Leaflet - Local bundle -->
    <link rel="stylesheet" href="/static/leaflet.css">
    <script src="/static/leaflet.js"></script>
</head>

<body class="antialiased" x-data="dashboard">
    {% from 'macros/widgets.html' import widget_card, insight_panel %}

    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Refresh Progress Bar -->
    <div class="refresh-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"
        :aria-valuenow="countdownPercent" aria-label="Auto-refresh countdown">
        <div class="refresh-progress-bar" :class="{ 'paused': paused }" :style="'width: ' + countdownPercent + '%'">
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-screen" x-show="!initDone" role="status" aria-live="polite">
        <div class="loader">Initializing Neural Link...</div>
    </div>

    <div class="container" x-show="initDone" x-transition.opacity.duration.500ms>
        <!-- Mobile filters removed - integrated into header -->


        <!-- Layout with Sidebar -->
        <div class="layout-wrapper">
            <!-- Left Sidebar Menu -->
            <aside class="sidebar" :class="{ 'collapsed': sidebarCollapsed }" title="Main Navigation">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <img src="/static/logo_small.png" alt="PHOBOS-NET Logo"
                            style="width: 24px; height: 24px; object-fit: contain;">
                        <span class="logo-text">PHOBOS-NET</span>
                    </div>
                </div>

                <nav class="sidebar-nav" role="tablist" aria-orientation="vertical" aria-label="Main navigation">
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'overview' }"
                        @click="loadTab('overview')" role="tab" :aria-selected="activeTab === 'overview'"
                        id="overview-tab-btn" aria-controls="overview-tab" aria-label="Dashboard" title="Dashboard">
                        <span class="sidebar-icon">üìä</span>
                        <span class="sidebar-item-text">Dashboard</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'security' }"
                        @click="loadTab('security')" role="tab" :aria-selected="activeTab === 'security'"
                        id="security-tab-btn" aria-controls="security-tab" aria-label="Security" title="Security">
                        <span class="sidebar-icon">üõ°Ô∏è</span>
                        <span class="sidebar-item-text">Security</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'network' }"
                        @click="loadTab('network')" role="tab" :aria-selected="activeTab === 'network'"
                        id="network-tab-btn" aria-controls="network-tab" aria-label="Network" title="Network">
                        <span class="sidebar-icon">üï∏Ô∏è</span>
                        <span class="sidebar-item-text">Network</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'hosts' }"
                        @click="loadTab('hosts')" role="tab" :aria-selected="activeTab === 'hosts'" id="hosts-tab-btn"
                        aria-controls="hosts-tab" aria-label="Hosts" title="Hosts">
                        <span class="sidebar-icon">üñ•Ô∏è</span>
                        <span class="sidebar-item-text">Hosts</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'firewall' }"
                        @click="loadTab('firewall')" role="tab" :aria-selected="activeTab === 'firewall'"
                        id="firewall-tab-btn" aria-controls="firewall-tab" aria-label="Firewall" title="Firewall">
                        <span class="sidebar-icon">üî•</span>
                        <span class="sidebar-item-text">Firewall</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'firewall-snmp' }"
                        @click="loadTab('firewall-snmp')" role="tab" :aria-selected="activeTab === 'firewall-snmp'"
                        id="firewall-snmp-tab-btn" aria-controls="firewall-snmp-tab" aria-label="Interfaces"
                        title="Interfaces">
                        <span class="sidebar-icon">üì°</span>
                        <span class="sidebar-item-text">Interfaces</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'server' }"
                        @click="loadTab('server')" role="tab" :aria-selected="activeTab === 'server'"
                        id="server-tab-btn" aria-controls="server-tab" aria-label="Server" title="Server">
                        <span class="sidebar-icon">üñ•Ô∏è</span>
                        <span class="sidebar-item-text">Server</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'forensics' }"
                        @click="loadTab('forensics')" role="tab" :aria-selected="activeTab === 'forensics'"
                        id="forensics-tab-btn" aria-controls="forensics-tab" aria-label="Forensics" title="Forensics">
                        <span class="sidebar-icon">üîç</span>
                        <span class="sidebar-item-text">Forensics</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'tools' }"
                        @click="loadTab('tools')" role="tab" :aria-selected="activeTab === 'tools'" id="tools-tab-btn"
                        aria-controls="tools-tab" aria-label="Tools" title="Tools">
                        <span class="sidebar-icon">üõ†Ô∏è</span>
                        <span class="sidebar-item-text">Tools</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'assistant' }"
                        @click="loadTab('assistant')" role="tab" :aria-selected="activeTab === 'assistant'"
                        id="assistant-tab-btn" aria-controls="assistant-tab" aria-label="Assistant" title="Assistant">
                        <span class="sidebar-icon">ü§ñ</span>
                        <span class="sidebar-item-text">Assistant</span>
                    </button>
                </nav>

                <div class="sidebar-footer">
                    <div style="display: flex; justify-content: center; margin-bottom: var(--space-2);">
                        <img src="/static/logo_big.png" alt="PHOBOS-NET Logo"
                            style="max-width: 120px; height: auto; opacity: 0.8;">
                    </div>
                    <div class="footer-copy" style="text-align: center; margin-bottom: 0;">
                        <span x-text="appMetadata.name || 'PHOBOS-NET'"></span> <span
                            x-text="appMetadata.version_display || 'v1.1'"></span><br>
                        ¬© 2026
                    </div>
                </div>
            </aside>

            <!-- Header Bar -->
            <header class="header" role="banner">
                <div class="header-left">
                    <button class="header-action-btn sidebar-toggle-main" @click="toggleSidebarMobile()"
                        aria-label="Toggle Sidebar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <h2 class="page-title" x-text="activeTab.charAt(0).toUpperCase() + activeTab.slice(1)">Dashboard
                    </h2>
                </div>

                <div class="header-center mobile-hide-controls">
                    <div class="search-wrapper">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" x-model="searchQuery" placeholder="Search UI" class="global-search"
                            aria-label="Search UI">
                        <span class="search-shortcut">‚åò + /</span>
                    </div>
                </div>

                <div class="header-right">
                    <div class="header-controls mobile-hide-controls">
                        <!-- Time Range -->
                        <div class="header-control-group">
                            <span class="control-label">Time</span>
                            <select x-model="timeRange" class="header-select" aria-label="Time Range">
                                <option value="15m">15m</option>
                                <option value="30m">30m</option>
                                <option value="1h">1h</option>
                                <option value="6h">6h</option>
                                <option value="24h">24h</option>
                                <option value="7d">7d</option>
                            </select>
                        </div>
                        <!-- Refresh Interval -->
                        <div class="header-control-group">
                            <span class="control-label">Refresh</span>
                            <select x-model="refreshInterval" class="header-select" aria-label="Refresh Interval">
                                <option value="10000">10s</option>
                                <option value="30000">30s</option>
                                <option value="60000">1m</option>
                                <option value="300000">5m</option>
                            </select>
                        </div>
                        <!-- Pause Button -->
                        <button class="header-action-btn" :class="{ 'paused': paused }" @click="togglePause()"
                            title="Pause auto-refresh" :title="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'"
                            :aria-label="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" x-show="!paused">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" x-show="paused">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                    </div>

                    <!-- Mobile Controls Menu Button -->
                    <button class="header-action-btn mobile-controls-btn" @click="mobileControlsModalOpen = true"
                        title="Controls" aria-label="Open Controls Menu">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="19" cy="12" r="1"></circle>
                            <circle cx="5" cy="12" r="1"></circle>
                        </svg>
                    </button>

                    <div class="header-actions">
                        <button class="header-action-btn" title="Wallboard / NOC View" aria-label="Wallboard / NOC View"
                            @click="window.open('/wallboard', '_blank')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                <line x1="8" y1="21" x2="16" y2="21"></line>
                                <line x1="12" y1="17" x2="12" y2="21"></line>
                            </svg>
                        </button>
                        <button class="header-action-btn" title="Refresh" aria-label="Refresh" @click="dataRefresh()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                </path>
                            </svg>
                        </button>
                        <button class="header-action-btn" title="Alerts"
                            :aria-label="alertHistory.total > 0 ? 'Alerts (' + alertHistory.total + ' active)' : 'Alerts'"
                            @click="openAlerts()" style="position: relative;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            <span x-show="alertHistory.total > 0"
                                style="position: absolute; top: -4px; right: -4px; background: var(--accent-cyan, #00f3ff); color: var(--bg-primary, #0a0a0f); border-radius: 10px; min-width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; padding: 0 4px;"
                                x-text="alertHistory.total > 99 ? '99+' : alertHistory.total"></span>
                        </button>
                        <button class="header-action-btn" title="Edit Layout" @click="editMode = !editMode"
                            :class="{ 'active': editMode }" :aria-label="editMode ? 'Finish Editing' : 'Edit Layout'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="header-action-btn" title="Settings" aria-label="Settings" @click="openConfig()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="main-content" id="main-content" tabindex="-1">
                <!-- Content Scroll Area -->
                <div class="content-scroll-area">
                    <!-- ============================================
                 OVERVIEW TAB
                 ============================================ -->
                    <div x-show="activeTab === 'overview'"
                        :style="activeTab === 'overview' ? 'display:block' : 'display:none'" id="overview-tab"
                        role="tabpanel" aria-labelledby="overview-tab-btn" tabindex="0">

                        <!-- Summary Stats & Bandwidth - Horizontal Layout -->
                        <section id="section-summary" class="scroll-section mb-8">

                            <!-- Top Row: Summary Stats (Compact Horizontal) -->
                            <div class="summary-stats-grid">
                                <!-- Mobile: Priority Stats (Above Fold) -->
                                <div class="stat-box mobile-priority-stat mobile-health-card" :class="{ 
                                        'status-ok': overallHealth.state === 'healthy',
                                        'status-warning': overallHealth.state === 'degraded',
                                        'status-error': overallHealth.state === 'unhealthy'
                                    }" :title="overallHealth.explanation" @click="overallHealthModalOpen = true"
                                    style="cursor: pointer;">
                                    <div class="value" :class="{
                                            'text-green': overallHealth.state === 'healthy',
                                            'text-yellow': overallHealth.state === 'degraded',
                                            'text-red': overallHealth.state === 'unhealthy'
                                        }" style="font-size: 1.3em; font-weight: 500; text-transform: capitalize;"
                                        x-text="overallHealth.state === 'healthy' ? 'Healthy' : overallHealth.state === 'degraded' ? 'Degraded' : 'Unhealthy'">
                                        ...</div>
                                    <div class="label mobile-secondary-label">Overall Health</div>
                                    <!-- Always show inline explanation (even when healthy) -->
                                    <template x-if="overallHealth.shortExplanation">
                                        <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: var(--space-1);"
                                            x-text="overallHealth.shortExplanation"></div>
                                    </template>
                                    <!-- Mobile-only system metrics integrated into health card -->
                                    <div class="mobile-health-metrics" style="display:none;">
                                        <span class="badge"
                                            :class="firewall.cpu_percent > 80 ? 'badge-danger' : ''">CPU: <span
                                                x-text="firewall.cpu_percent ? firewall.cpu_percent + '%' : '--'"></span></span>
                                        <span class="badge"
                                            :class="firewall.mem_percent > 80 ? 'badge-danger' : ''">MEM: <span
                                                x-text="firewall.mem_percent ? firewall.mem_percent + '%' : '--'"></span></span>
                                        <span class="badge">Flows: <span
                                                x-text="Number(summary.totals.flows || 0).toLocaleString()"></span></span>
                                    </div>
                                </div>
                                <div class="stat-box mobile-priority-stat"
                                    :class="{ 'status-warning': alertHistory.total > 0, 'mobile-zero-state': alertHistory.total === 0 }"
                                    @click="navigateToActiveAlerts()" style="cursor: pointer;"
                                    title="Click to view active alerts">
                                    <div class="value" :class="{ 'mobile-zero-value': alertHistory.total === 0 }"
                                        x-text="alertHistory.loading ? '...' : (alertHistory.total || 0).toLocaleString()">
                                        ...</div>
                                    <div class="label">Active Alerts</div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-top: 2px;">
                                        Live</div>
                                </div>

                                <!-- Mobile: Priority Stats (Above Fold) -->
                                <div class="stat-box mobile-priority-stat" @click="navigateToActiveFlows()"
                                    style="cursor: pointer;" title="Click to view active flows">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.active_flows || 0).toLocaleString()">...</span>
                                        <template
                                            x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.active_flows">
                                            <span>
                                                <span
                                                    :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.active_flows.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (networkStatsOverview.trends.active_flows.muted ? '0.6' : '0.8')"
                                                    x-text="networkStatsOverview.trends.active_flows.indicator"></span>
                                                <span class="mobile-trend-text"
                                                    style="font-size: 0.6em; color: var(--text-secondary); margin-left: 4px; display: none;"
                                                    x-text="(networkStatsOverview.trends.active_flows.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.active_flows.percent_change.toFixed(1) + '%'"></span>
                                            </span>
                                        </template>
                                    </div>
                                    <div class="label">Active Flows</div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-top: 2px;">
                                        Live</div>
                                </div>
                                <div class="stat-box mobile-secondary-stat" @click="navigateToExternalConnections()"
                                    style="cursor: pointer;" title="Click to view external connections">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.external_connections || 0).toLocaleString()">...</span>
                                        <template
                                            x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.external_connections">
                                            <span>
                                                <span
                                                    :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.external_connections.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (networkStatsOverview.trends.external_connections.muted ? '0.6' : '0.8')"
                                                    x-text="networkStatsOverview.trends.external_connections.indicator"></span>
                                                <span class="mobile-trend-text"
                                                    style="font-size: 0.6em; color: var(--text-secondary); margin-left: 4px; display: none;"
                                                    x-text="(networkStatsOverview.trends.external_connections.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.external_connections.percent_change.toFixed(1) + '%'"></span>
                                            </span>
                                        </template>
                                    </div>
                                    <div class="label">External Connections</div>
                                </div>
                                <div class="stat-box mobile-secondary-stat" @click="navigateToFirewallLogs()"
                                    style="cursor: pointer;" title="Click to view firewall logs">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.blocked_events_24h || 0).toLocaleString()">...</span>
                                        <template
                                            x-if="!firewallStatsOverview.loading && firewallStatsOverview.trends?.blocked_events">
                                            <span>
                                                <span
                                                    :style="'font-size: 0.8em; color: ' + (firewallStatsOverview.trends.blocked_events.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (firewallStatsOverview.trends.blocked_events.muted ? '0.6' : '0.8')"
                                                    x-text="firewallStatsOverview.trends.blocked_events.indicator"></span>
                                                <span class="mobile-trend-text"
                                                    style="font-size: 0.6em; color: var(--text-secondary); margin-left: 4px; display: none;"
                                                    x-text="(firewallStatsOverview.trends.blocked_events.percent_change > 0 ? '+' : '') + firewallStatsOverview.trends.blocked_events.percent_change.toFixed(1) + '%'"></span>
                                            </span>
                                        </template>
                                    </div>
                                    <div class="label">Blocked Events (24h)</div>
                                </div>
                                <div class="stat-box mobile-secondary-stat"
                                    :class="{ 'status-warning': networkStatsOverview.anomalies_24h > 0 }"
                                    @click="navigateToAnomalies()" style="cursor: pointer;"
                                    title="Click to view network anomalies">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.anomalies_24h || 0).toLocaleString()">...</span>
                                        <template
                                            x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.anomalies">
                                            <span>
                                                <span
                                                    :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.anomalies.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (networkStatsOverview.trends.anomalies.muted ? '0.6' : '0.8')"
                                                    x-text="networkStatsOverview.trends.anomalies.indicator"></span>
                                                <span class="mobile-trend-text"
                                                    style="font-size: 0.6em; color: var(--text-secondary); margin-left: 4px; display: none;"
                                                    x-text="(networkStatsOverview.trends.anomalies.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.anomalies.percent_change.toFixed(1) + '%'"></span>
                                            </span>
                                        </template>
                                    </div>
                                    <div class="label">Anomalies (24h)</div>

                                </div>
                            </div>

                            <!-- Main Chart: Bandwidth -->
                            <template x-if="isVisible('bandwidth')">
                                {% set bw_actions %}
                                <div class="status-pills">
                                    <span class="status-pill" style="font-size: 0.85em; color: var(--text-secondary);"
                                        x-text="'Based on selected time range'"></span>
                                </div>
                                {% endset %}
                                {% call widget_card('bandwidth', 'Bandwidth & Flow Rate', 'üìä',
                                extra_actions=bw_actions) %}
                                <!-- Mobile Toggle for Bandwidth Chart -->
                                <div class="mobile-chart-toggle" x-data="{ collapsed: window.innerWidth <= 768 }">
                                    <button class="world-map-toggle" style="margin-bottom: 12px;"
                                        x-show="window.innerWidth <= 768" @click="collapsed = !collapsed">
                                        <span x-text="collapsed ? 'üìä Show Chart' : 'üìä Hide Chart'"></span>
                                    </button>
                                    <div class="chart-wrapper chart-expandable"
                                        x-show="!collapsed || window.innerWidth > 768"
                                        @click="openFullscreenChart('bwChart', 'Bandwidth & Flow Rate')"
                                        title="Click to expand">
                                        <canvas id="bwChart"></canvas>
                                    </div>
                                </div>
                                {% endcall %}
                            </template>

                        </section>


                        <!-- World Map Section -->
                        <section id="section-worldmap" class="scroll-section">
                            <!-- Mobile Toggle (hidden on desktop) -->
                            <button class="world-map-toggle" @click="worldMapMobileVisible = !worldMapMobileVisible"
                                :class="{ 'active': worldMapMobileVisible }" style="display: none;"
                                x-show="window.innerWidth <= 768">
                                <span
                                    x-text="worldMapMobileVisible ? 'üó∫Ô∏è Hide World Map' : 'üó∫Ô∏è Show World Map'"></span>
                            </button>

                            {% set wm_actions %}{% endset %}

                            {% set wm_title %}
                            <div>
                                <span>Traffic World Map</span>
                                <span x-show="mapStatus" x-text="'[' + mapStatus + ']'"
                                    class="text-75 text-yellow ml-2"></span>
                                <div style="font-size: 0.75em; color: var(--text-secondary); font-weight: normal; margin-top: 2px;"
                                    x-text="'Based on selected time range'"></div>
                            </div>
                            {% endset %}
                            <div x-show="window.innerWidth > 768 || worldMapMobileVisible">
                                {% call widget_card('worldmap', wm_title, 'üó∫Ô∏è', card_class='wide-card world-map-card',
                                extra_actions=wm_actions) %}
                                <!-- Map Controls -->
                                <div class="world-map-controls">
                                    <div class="world-map-mode-toggle">
                                        <button class="world-map-mode-btn"
                                            :class="{ 'active': worldMapMode === 'traffic' }"
                                            @click="worldMapMode = 'traffic'" title="Traffic view - balanced emphasis">
                                            Traffic
                                        </button>
                                        <button class="world-map-mode-btn"
                                            :class="{ 'active': worldMapMode === 'exposure' }"
                                            @click="worldMapMode = 'exposure'"
                                            title="Exposure view - emphasize destinations">
                                            Exposure
                                        </button>
                                        <button class="world-map-mode-btn"
                                            :class="{ 'active': worldMapMode === 'attacks' }"
                                            @click="worldMapMode = 'attacks'" title="View Threats & Blocked traffic">
                                            Threats & Blocks
                                        </button>
                                    </div>
                                    <div class="world-map-layer-toggles">
                                        <label class="world-map-layer-toggle"
                                            :class="{ 'active': worldMapLayers.sources }" title="Toggle Sources layer">
                                            <input type="checkbox" x-model="worldMapLayers.sources">
                                            <span class="layer-dot layer-dot-cyan"></span>
                                            <span class="layer-label">Sources</span>
                                        </label>
                                        <label class="world-map-layer-toggle"
                                            :class="{ 'active': worldMapLayers.destinations }"
                                            title="Toggle Destinations layer">
                                            <input type="checkbox" x-model="worldMapLayers.destinations">
                                            <span class="layer-dot layer-dot-purple"></span>
                                            <span class="layer-label">Destinations</span>
                                        </label>
                                        <label class="world-map-layer-toggle"
                                            :class="{ 'active': worldMapLayers.threats }" title="Toggle Threats layer">
                                            <input type="checkbox" x-model="worldMapLayers.threats">
                                            <span class="layer-dot layer-dot-red"></span>
                                            <span class="layer-label">Threats</span>
                                        </label>
                                    </div>
                                    <button class="world-map-reset-btn" @click="resetWorldMapView()"
                                        title="Reset map view">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 6v6l4 2"></path>
                                        </svg>
                                        Reset
                                    </button>
                                </div>
                                <div class="world-map-container">
                                    <div id="world-map-svg" class="world-map-svg"></div>
                                    <div x-show="worldMap.loading" class="spinner-overlay">
                                        <div class="spinner"></div>
                                    </div>
                                    <div x-show="worldMap.error" class="error-overlay"
                                        style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:red; display:flex; align-items:center; justify-content:center; z-index:10;"
                                        x-text="worldMap.error"></div>
                                </div>
                                <!-- Country Stats (Interactive) -->
                                <div class="world-map-countries compact-grid">
                                    <div class="wm-country-col">
                                        <h4>üîº Sources</h4>
                                        <template x-for="c in worldMap.source_countries?.slice(0, 5)"
                                            :key="c.iso || c.name">
                                            <div class="wm-country-row"
                                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                                @click="selectCountryForMap(c.iso || c.name)"
                                                style="cursor: pointer; transition: background-color var(--transition-base); padding: var(--space-2); border-radius: var(--radius-sm);"
                                                :style="worldMapSelectedCountry === (c.iso || c.name) ? 'background-color: var(--bg-2); border-left: 2px solid var(--signal-primary);' : ''"
                                                :title="worldMapSelectedCountry === (c.iso || c.name) ? 'Click to deselect' : 'Click to highlight on map'">
                                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                                <span class="wm-c-name" x-text="c.name"></span>
                                                <span class="wm-c-val text-cyan" x-text="c.bytes_fmt"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="wm-country-col">
                                        <h4>üîΩ Dests</h4>
                                        <template x-for="c in worldMap.dest_countries?.slice(0, 5)"
                                            :key="c.iso || c.name">
                                            <div class="wm-country-row"
                                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                                @click="selectCountryForMap(c.iso || c.name)"
                                                style="cursor: pointer; transition: background-color var(--transition-base); padding: var(--space-2); border-radius: var(--radius-sm);"
                                                :style="worldMapSelectedCountry === (c.iso || c.name) ? 'background-color: var(--bg-2); border-left: 2px solid var(--signal-tertiary);' : ''"
                                                :title="worldMapSelectedCountry === (c.iso || c.name) ? 'Click to deselect' : 'Click to highlight on map'">
                                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                                <span class="wm-c-name" x-text="c.name"></span>
                                                <span class="wm-c-val text-purple" x-text="c.bytes_fmt"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="wm-country-col">
                                        <h4>‚ö†Ô∏è Threats</h4>
                                        <template x-for="c in worldMap.threat_countries?.slice(0, 5)"
                                            :key="c.iso || c.name">
                                            <div class="wm-country-row"
                                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                                @click="selectCountryForMap(c.iso || c.name)"
                                                style="cursor: pointer; transition: background-color var(--transition-base); padding: var(--space-2); border-radius: var(--radius-sm);"
                                                :style="worldMapSelectedCountry === (c.iso || c.name) ? 'background-color: var(--bg-2); border-left: 2px solid var(--signal-crit);' : ''"
                                                :title="worldMapSelectedCountry === (c.iso || c.name) ? 'Click to deselect' : 'Click to highlight on map'">
                                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                                <span class="wm-c-name" x-text="c.name"></span>
                                                <span class="wm-c-val text-red"
                                                    x-text="c.bytes_fmt || c.count || 'N/A'"></span>
                                            </div>
                                        </template>
                                        <template
                                            x-if="!worldMap.threat_countries || worldMap.threat_countries.length === 0">
                                            <div class="wm-country-row">
                                                <span class="wm-c-name" style="opacity: 0.6;">No threats</span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                {% endcall %}
                            </div>
                        </section>
                    </div>

                    <!-- ============================================
             SECURITY TAB
             ============================================ -->
                    <div x-show="activeTab === 'security'"
                        :style="activeTab === 'security' ? 'display:block' : 'display:none'" id="security-tab"
                        role="tabpanel" aria-labelledby="security-tab-btn" tabindex="0">
                        <!-- ============================================
             SECURITY CENTER
             ============================================ -->
                        <section id="section-security" class="scroll-section mb-8">
                            <!-- Security Summary Stats -->
                            <div class="grid mb-6 grid-auto-fit">
                                <div class="card stat-box">
                                    <div class="value"
                                        :style="'color: ' + getStateColor(securityObservability.overall_state || 'unknown')"
                                        x-text="securityObservability.overall_state || 'UNKNOWN'"></div>
                                    <div class="label">Security State</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="feedHealth.summary?.ok || 0"></div>
                                    <div class="label">Feeds OK</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="(feedHealth.summary?.total_ips || 0).toLocaleString()">
                                    </div>
                                    <div class="label">Blocklist IPs</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="alertHistory.total || 0"></div>
                                    <div class="label">Alerts 24h</div>
                                </div>
                            </div>

                            <!-- Security Actions -->
                            <div class="flex gap-2 mb-6 flex-wrap">
                                <button class="btn-sm" @click="watchlistModalOpen = true"
                                    aria-label="Manage watchlist">üëÅÔ∏è
                                    Watchlist</button>
                                <button class="btn-sm" @click="exportThreats('csv')"
                                    aria-label="Export threats as CSV">üì•
                                    Export</button>
                                <button class="btn-sm" @click="refreshFeed()" aria-label="Refresh threat feeds">üîÑ
                                    Refresh</button>
                            </div>

                            <!-- Security Widgets Grid -->
                            <div class="security-grid">

                                <!-- Security Observability Widget -->
                                <template x-if="isVisible('securityObservability')">
                                    {% call widget_card('securityObservability', 'Security Observability', 'üîç',
                                    show_spinner=True,
                                    card_class="security-observability-card") %}
                                    <!-- Authority Header -->
                                    <div class="authority-header-compact">
                                        <div class="current-state-dominant">
                                            <span class="authority-label">CURRENT STATE:</span>
                                            <span class="authority-value"
                                                :style="'color: ' + getStateColor(securityObservability.overall_state || 'unknown')"
                                                x-text="securityObservability.overall_state || 'UNKNOWN'"></span>
                                        </div>
                                        <div class="state-explanation">
                                            <span class="explanation-text">Detection confidence reduced (2 feeds
                                                unavailable)</span>
                                        </div>
                                    </div>
                                    <div class="observability-display">

                                        <!-- Compact Cause & Signals -->
                                        <div class="compact-signals">
                                            <!-- One-Line Cause -->
                                            <div class="cause-compact">
                                                <span class="cause-label">Primary limitation:</span>
                                                <span class="cause-text">Threat intelligence coverage gaps (2/13
                                                    feeds)</span>
                                            </div>

                                            <!-- Compact Signals List -->
                                            <div class="signals-list-compact">
                                                <template
                                                    x-if="securityObservability.protection_signals && securityObservability.protection_signals.length > 0">
                                                    <div class="signal-item-compact">
                                                        <span class="signal-icon">üõ°Ô∏è</span>
                                                        <span class="signal-text">Active (230 threats blocked)</span>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="securityObservability.exposure_signals && securityObservability.exposure_signals.length > 0">
                                                    <div class="signal-item-compact">
                                                        <span class="signal-icon">‚ö†Ô∏è</span>
                                                        <span class="signal-text">Elevated (~2√ó baseline attacks)</span>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="securityObservability.data_quality_signals && securityObservability.data_quality_signals.length > 0">
                                                    <div class="signal-item-compact critical">
                                                        <span class="signal-icon">üìä</span>
                                                        <span class="signal-text">Limited (unknown IP visibility)</span>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Details Toggle -->
                                            <div class="details-toggle">
                                                <button class="toggle-button"
                                                    @click="showObservabilityDetails = !showObservabilityDetails">
                                                    <span
                                                        x-text="showObservabilityDetails ? 'Hide details' : 'View details'"></span>
                                                </button>
                                            </div>

                                            <!-- Expandable Details (Hidden by default) -->
                                            <div class="details-section" x-show="showObservabilityDetails" x-transition>
                                                <div class="details-content">
                                                    <template
                                                        x-if="securityObservability.protection_signals && securityObservability.protection_signals.length > 0">
                                                        <div class="detail-group">
                                                            <div class="detail-title">Protection Status</div>
                                                            <template
                                                                x-for="signal in securityObservability.protection_signals"
                                                                :key="signal">
                                                                <div class="detail-item">No unblocked or bypassed
                                                                    attacks observed</div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="securityObservability.exposure_signals && securityObservability.exposure_signals.length > 0">
                                                        <div class="detail-group">
                                                            <div class="detail-title">Exposure Analysis</div>
                                                            <template
                                                                x-for="signal in securityObservability.exposure_signals"
                                                                :key="signal">
                                                                <div class="detail-item">Inbound attacks increased 2√ó
                                                                    over 6-hour baseline</div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="securityObservability.data_quality_signals && securityObservability.data_quality_signals.length > 0">
                                                        <div class="detail-group">
                                                            <div class="detail-title">Data Quality Impact</div>
                                                            <template
                                                                x-for="signal in securityObservability.data_quality_signals"
                                                                :key="signal">
                                                                <div class="detail-item">Unknown IP classification
                                                                    confidence reduced</div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Alert History Widget -->
                                <template x-if="isVisible('alertHistory')">
                                    {% call widget_card('alertHistory', 'Alert History (24h)', 'üîî', show_spinner=True)
                                    %}
                                    <!-- Alert Filters -->
                                    <div class="alert-filters">
                                        <select x-model="alertFilter.severity" class="filter-select"
                                            aria-label="Filter alerts by severity">
                                            <option value="all">All Severities</option>
                                            <option value="critical">üî¥ Critical</option>
                                            <option value="high">üü† High</option>
                                            <option value="medium">üü° Medium</option>
                                            <option value="low">üü¢ Low</option>
                                        </select>
                                        <select x-model="alertFilter.type" class="filter-select"
                                            aria-label="Filter alerts by type">
                                            <option value="all">All Types</option>
                                            <option value="threat_ip">Threat IP</option>
                                            <option value="port_scan">Port Scan</option>
                                            <option value="brute_force">Brute Force</option>
                                            <option value="data_exfil">Data Exfil</option>
                                            <option value="dns_tunneling">DNS Tunneling</option>
                                            <option value="lateral_movement">Lateral Movement</option>
                                            <option value="suspicious_port">Suspicious Port</option>
                                            <option value="large_transfer">Large Transfer</option>
                                            <option value="off_hours">Off-Hours</option>
                                            <option value="watchlist">Watchlist</option>
                                        </select>
                                    </div>
                                    <div class="alert-summary">
                                        <span class="alert-badge critical"
                                            x-show="alertHistory.by_severity?.critical > 0">üî¥ <span
                                                x-text="alertHistory.by_severity?.critical || 0"></span>
                                            critical</span>
                                        <span class="alert-badge high" x-show="alertHistory.by_severity?.high > 0">üü†
                                            <span x-text="alertHistory.by_severity?.high || 0"></span> high</span>
                                        <span class="alert-badge medium"
                                            x-show="alertHistory.by_severity?.medium > 0">üü°
                                            <span x-text="alertHistory.by_severity?.medium || 0"></span>
                                            medium</span>
                                        <span class="alert-badge low" x-show="alertHistory.by_severity?.low > 0">üü¢
                                            <span x-text="alertHistory.by_severity?.low || 0"></span> low</span>
                                        <span class="text-muted">Total: <span
                                                x-text="alertHistory.total || 0"></span></span>
                                    </div>
                                    <div class="alert-list">
                                        <template x-for="(a, idx) in filteredAlerts.slice(0, 10)" :key="idx">
                                            <div class="alert-row" :class="'severity-row-' + a.severity">
                                                <div class="alert-time" x-text="a.time_ago"></div>
                                                <div class="alert-info">
                                                    <span class="alert-type-badge"
                                                        :class="'cat-' + (a.category || a.type || 'unknown').toLowerCase()"
                                                        x-text="a.type || 'alert'"></span>
                                                    <span class="alert-msg" :title="a.msg" x-text="a.msg"></span>
                                                </div>
                                                <div class="alert-severity" :class="'sev-' + a.severity"
                                                    x-text="a.severity"></div>
                                            </div>
                                        </template>
                                        <template x-if="filteredAlerts.length === 0">
                                            <div class="alert-empty"
                                                x-text="alertFilter.severity !== 'all' || alertFilter.type !== 'all' ? 'üîç No matching alerts' : '‚úÖ No alerts in past 24 hours'">
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Threats by Country Widget -->
                                <template x-if="isVisible('threatsByCountry')">
                                    {% call widget_card('threatsByCountry', 'Threats by Country', 'üåç',
                                    show_spinner=True) %}
                                    <div class="country-threat-list">
                                        <template
                                            x-if="threatsByCountry.countries && threatsByCountry.countries.length > 0">
                                            <div>
                                                <div class="text-85 text-muted mb-2">
                                                    <span x-text="threatsByCountry.total_countries || 0"></span>
                                                    countries
                                                    detected
                                                    <template x-if="threatsByCountry.has_fw_data">
                                                        <span> ¬∑ <span class="text-green"
                                                                x-text="threatsByCountry.total_blocked"></span>
                                                            blocked</span>
                                                    </template>
                                                </div>
                                                <template
                                                    x-for="(c, idx) in (threatsByCountry.countries || []).slice(0, 8)"
                                                    :key="c.country_code">
                                                    <div class="country-threat-item">
                                                        <span class="country-flag" x-text="c.country_code"></span>
                                                        <span class="country-name" x-text="c.country_name"></span>
                                                        <span class="country-count">
                                                            <span x-text="c.threat_count"></span>
                                                            <template x-if="c.blocked > 0">
                                                                <span class="text-green text-8 ml-1">üî•<span
                                                                        x-text="c.blocked"></span></span>
                                                            </template>
                                                        </span>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        <template
                                            x-if="!threatsByCountry.countries || threatsByCountry.countries.length === 0">
                                            <div class="empty-state-compact">
                                                <span class="empty-icon">üåç</span>
                                                <span>No geo-located threats</span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Threat Detections - MOVED TO FIREWALL TAB -->

                                <!-- Feed Health -->
                                <template x-if="isVisible('feedHealth')">
                                    {% set feed_actions %}
                                    <button class="icon-btn-small" @click="refreshFeed()" title="Refresh Feeds Now"
                                        class="text-green">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 12a9 9 0 11-2.5-6.3" />
                                            <path d="M21 3v6h-6" />
                                        </svg>
                                    </button>
                                    {% endset %}

                                    {% call widget_card('feedHealth', 'Feed Health', 'üì°', extra_actions=feed_actions,
                                    show_spinner=True) %}
                                    <!-- Summary Bar -->
                                    <div class="feed-summary-bar">
                                        <div class="feed-stat">
                                            <span class="feed-stat-value text-green"
                                                x-text="feedHealth.summary?.ok || 0"></span>
                                            <span class="feed-stat-label">OK</span>
                                        </div>
                                        <div class="feed-stat-divider">/</div>
                                        <div class="feed-stat">
                                            <span class="feed-stat-value"
                                                x-text="feedHealth.summary?.total || 0"></span>
                                            <span class="feed-stat-label">Feeds</span>
                                        </div>
                                        <div class="feed-stat-sep">¬∑</div>
                                        <div class="feed-stat">
                                            <span class="feed-stat-value text-cyan"
                                                x-text="(feedHealth.summary?.total_ips || 0).toLocaleString()"></span>
                                            <span class="feed-stat-label">IPs</span>
                                        </div>
                                        <div class="feed-stat-sep">¬∑</div>
                                        <div class="feed-stat">
                                            <span class="feed-stat-value text-muted"
                                                x-text="feedHealth.summary?.last_refresh || 'never'"></span>
                                        </div>
                                    </div>
                                    <!-- Feed List (Full Width) -->
                                    <div class="feed-list-full">
                                        <template x-for="(f, idx) in feedHealth.feeds" :key="f.name + idx">
                                            <div class="feed-item" :class="{ 'feed-error': f.status !== 'ok' }">
                                                <span class="feed-status-dot" :class="f.status"></span>
                                                <span class="feed-name-full" x-text="f.name" :title="f.name"></span>
                                                <span class="feed-ips-count"
                                                    x-text="(f.ips || 0).toLocaleString()"></span>
                                                <span class="feed-category-tag"
                                                    :class="'cat-' + (f.category || 'unknown').toLowerCase()"
                                                    x-text="f.category"></span>
                                            </div>
                                        </template>
                                        <template x-if="!feedHealth.feeds || feedHealth.feeds.length === 0">
                                            <div class="feed-empty">
                                                <span>üì° No feed data yet</span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Malicious Ports -->
                                {% call widget_card('maliciousPorts', 'Top Malicious Ports', 'üîí', show_spinner=True) %}
                                <div class="text-9 text-muted mb-2">
                                    <template x-if="maliciousPorts.has_syslog">
                                        <span>Ports targeted by threats + blocked by firewall</span>
                                    </template>
                                    <template x-if="!maliciousPorts.has_syslog">
                                        <span>Ports most frequently seen in threat traffic</span>
                                    </template>
                                </div>
                                <div style="max-height: 240px; overflow-y: auto;">
                                    <table class="table-fixed table-compact">
                                        <thead>
                                            <tr>
                                                <th>Port</th>
                                                <th>FW Blocked</th>
                                                <th>Traffic</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(p, i) in maliciousPorts.ports.slice(0, 15)"
                                                :key="p.port + '-' + i">
                                                <tr>
                                                    <td>
                                                        <strong class="text-cyan" x-text="p.port"></strong>
                                                        <template x-if="p.suspicious"><span
                                                                style="color: var(--neon-pink); font-size: 0.75em;">
                                                                ‚ö†</span></template>
                                                        <div class="text-8 text-muted" x-text="p.service || ''">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <template x-if="p.blocked > 0">
                                                            <span class="text-green">üî• <span
                                                                    x-text="p.blocked"></span></span>
                                                        </template>
                                                        <template x-if="!p.blocked || p.blocked === 0">
                                                            <span class="text-muted">‚Äî</span>
                                                        </template>
                                                        <template x-if="p.unique_attackers > 1">
                                                            <div class="text-75 text-muted"
                                                                x-text="p.unique_attackers + ' IPs'"></div>
                                                        </template>
                                                    </td>
                                                    <td>
                                                        <template
                                                            x-if="p.bytes_fmt || (p.netflow_bytes || 0) > 0 || (p.netflow_flows || 0) > 0">
                                                            <div>
                                                                <strong class="text-green"
                                                                    x-text="p.bytes_fmt || (p.netflow_bytes ? fmtBytes(p.netflow_bytes) : '0 B')"></strong>
                                                                <div class="text-8 text-muted"
                                                                    x-text="(p.netflow_flows || 0) + ' flows'"></div>
                                                            </div>
                                                        </template>
                                                        <template
                                                            x-if="!p.bytes_fmt && (p.netflow_bytes || 0) === 0 && (p.netflow_flows || 0) === 0">
                                                            <span class="text-muted">‚Äî</span>
                                                        </template>
                                                    </td>
                                                </tr>
                                            </template>
                                            <template x-if="!maliciousPorts.ports || maliciousPorts.ports.length===0">
                                                <tr>
                                                    <td colspan="3" class="text-muted text-center">
                                                        No
                                                        malicious port data</td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                                {% endcall %}

                                <!-- Blocklist Match Rate -->
                                {% call widget_card('blocklist', 'Blocklist Match Rate', 'üõ°Ô∏è', show_spinner=True) %}
                                <div class="text-85 text-muted mb-2">
                                    Rate of flows matching blocklists / feeds
                                    <template x-if="blocklist.has_fw_data">
                                        <span class="text-green"> + FW blocks</span>
                                    </template>
                                </div>
                                <div class="h-25 mb-2 chart-expandable"
                                    @click="openFullscreenChart('blocklistChart', 'Blocklist Match Rate')"
                                    title="Click to expand">
                                    <canvas id="blocklistChart"></canvas>
                                </div>
                                <div class="blocklist-stats">
                                    <div class="blocklist-stat">
                                        <span class="blocklist-value"
                                            :class="{ 'text-green': blocklist.current_rate == 0, 'text-yellow': blocklist.current_rate > 0 && blocklist.current_rate < 1, 'text-red': blocklist.current_rate >= 1 }"
                                            x-text="(blocklist.current_rate != null) ? (blocklist.current_rate + '%') : '--'"></span>
                                        <span class="blocklist-label">Match Rate</span>
                                    </div>
                                    <div class="blocklist-stat">
                                        <span class="blocklist-value text-muted"
                                            x-text="(blocklist.total_matches || 0).toLocaleString()"></span>
                                        <span class="blocklist-label">Matches</span>
                                    </div>
                                    <template x-if="blocklist.has_fw_data">
                                        <div class="blocklist-stat">
                                            <span class="blocklist-value text-green"
                                                x-text="(blocklist.total_blocked || 0).toLocaleString()"></span>
                                            <span class="blocklist-label">üî• Blocked</span>
                                        </div>
                                    </template>
                                </div>
                                {% endcall %}

                                <!-- Threat Velocity Widget -->
                                <template x-if="isVisible('threatVelocity')">
                                    {% call widget_card('threatVelocity', 'Threat Trend (1h)', 'üìà',
                                    show_spinner=True) %}
                                    <div class="velocity-display">
                                        <div class="velocity-main">
                                            <span class="velocity-value"
                                                :class="{ 'text-green': threatVelocity.current === 0, 'text-yellow': threatVelocity.current > 0 && threatVelocity.current < 5, 'text-red': threatVelocity.current >= 5 }"
                                                x-text="threatVelocity.current || 0"></span>
                                            <span class="velocity-unit">threats/hr</span>
                                        </div>
                                        <div class="velocity-trend"
                                            :class="{ 'trend-up': threatVelocity.trend > 0, 'trend-down': threatVelocity.trend < 0, 'trend-stable': threatVelocity.trend === 0 }">
                                            <span
                                                x-text="threatVelocity.trend > 0 ? '‚Üë' : threatVelocity.trend < 0 ? '‚Üì' : '‚Üí'"></span>
                                            <span x-text="Math.abs(threatVelocity.trend || 0) + '%'"></span>
                                            <span class="trend-label">vs last hour</span>
                                        </div>
                                        <div class="velocity-stats">
                                            <div class="velocity-stat">
                                                <span class="velocity-stat-value"
                                                    x-text="threatVelocity.total_24h || 0"></span>
                                                <span class="velocity-stat-label">24h Total</span>
                                            </div>
                                            <div class="velocity-stat">
                                                <span class="velocity-stat-value"
                                                    x-text="threatVelocity.peak || 0"></span>
                                                <span class="velocity-stat-label">Peak/hr</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- At-Risk Internal Hosts Widget -->
                                <template x-if="isVisible('compromisedHosts')">
                                    {% call widget_card('compromisedHosts', 'At-Risk Internal Hosts', '‚ò¢Ô∏è',
                                    show_spinner=True) %}
                                    <div class="compromised-list">
                                        <template x-for="(host, idx) in compromisedHosts.hosts" :key="host.ip">
                                            <div class="compromised-item"
                                                :class="'risk-' + (host.risk_score > 50 ? 'high' : 'medium')"
                                                @click="openEventDetails({ ip: host.threat_ip, threat_type: host.threat_category || 'Threat', country: host.country, threat_feed: host.threat_feed }, 'threat')"
                                                style="cursor: pointer;">
                                                <div class="compromised-main">
                                                    <div class="compromised-host">
                                                        <strong class="text-cyan clickable-ip"
                                                            @click="openIPModal(host.ip)" x-text="host.ip"></strong>
                                                        <div class="text-xs text-muted" x-show="host.hostname"
                                                            x-text="host.hostname"></div>
                                                    </div>
                                                    <div class="compromised-role">
                                                        <span class="badge"
                                                            :class="host.role && host.role.includes('Outbound') ? 'badge-warn' : 'badge-danger'"
                                                            x-text="host.role"></span>
                                                        <div class="text-xs text-muted" x-text="host.direction"></div>
                                                    </div>
                                                </div>
                                                <div class="compromised-details">
                                                    <div class="compromised-peer">
                                                        <span class="text-red clickable-ip"
                                                            @click="openIPModal(host.threat_ip)"
                                                            x-text="host.threat_ip"></span>
                                                        <span class="text-xs text-muted"
                                                            x-text="'(' + (host.threat_category || 'Unknown') + ')'"></span>
                                                    </div>
                                                    <div class="compromised-stats">
                                                        <span class="text-green" x-text="host.bytes_fmt"></span>
                                                        <span class="text-xs text-muted"
                                                            x-text="host.flows + ' flows'"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                        <template x-if="!compromisedHosts.hosts || compromisedHosts.hosts.length === 0">
                                            <div class="empty-state-compact">
                                                <span class="empty-icon">‚úÖ</span>
                                                <span>No compromised internal hosts detected</span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Threat IPs Widget -->
                                <template x-if="isVisible('topThreatIPs')">
                                    {% call widget_card('topThreatIPs', 'Top Threat IPs', 'üéØ', show_spinner=True)
                                    %}
                                    <div class="threat-ips-list">
                                        <template x-for="(ip, idx) in (topThreatIPs.ips || []).slice(0, 5)"
                                            :key="ip.ip">
                                            <div class="threat-ip-item" @click="openEventDetails(ip, 'threat')"
                                                style="cursor: pointer;">
                                                <div class="threat-ip-rank" x-text="idx + 1"></div>
                                                <div class="threat-ip-info">
                                                    <span class="threat-ip-addr" x-text="ip.ip"></span>
                                                    <span class="threat-ip-meta">
                                                        <span class="badge"
                                                            :class="'cat-' + (ip.category || 'unknown').toLowerCase()"
                                                            x-text="ip.category || 'Unknown'"></span>
                                                        <span x-text="ip.country || '--'"></span>
                                                    </span>
                                                </div>
                                                <div class="threat-ip-hits">
                                                    <span class="hits-value" x-text="ip.hits"></span>
                                                    <span class="hits-label">hits</span>
                                                </div>
                                            </div>
                                        </template>
                                        <template x-if="!topThreatIPs.ips || topThreatIPs.ips.length === 0">
                                            <div class="empty-state-compact">
                                                <span class="empty-icon">‚úÖ</span>
                                                <span>No threat IPs detected</span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- MITRE ATT&CK Coverage Widget -->
                                <template x-if="isVisible('mitreHeatmap')">
                                    {% call widget_card('mitreHeatmap', 'Detected Techniques', 'üéØ',
                                    show_spinner=True) %}
                                    <div x-show="mitreHeatmap.techniques && mitreHeatmap.techniques.length > 0">
                                        <div
                                            style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                            <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                                x-text="mitreHeatmap.total_techniques || 0"></div>
                                            <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                Techniques Detected</div>
                                        </div>
                                        <div
                                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: var(--space-2); max-height: 200px; overflow-y: auto;">
                                            <template x-for="technique in mitreHeatmap.techniques.slice(0, 12)"
                                                :key="technique.id">
                                                <div class="card"
                                                    style="padding: var(--space-1) var(--space-2); text-align: center; cursor: pointer; transition: all var(--motion-base);"
                                                    :style="'background: rgba(255, 0, 60, ' + Math.min(0.1 + (technique.count / 10) * 0.3, 0.4) + '); border: 1px solid rgba(255, 0, 60, ' + Math.min(0.2 + (technique.count / 10) * 0.3, 0.6) + ');'"
                                                    :title="technique.name + ' - ' + technique.count + ' detections'">
                                                    <div style="font-size: var(--text-xs); color: var(--neon-red); font-weight: var(--font-weight-bold);"
                                                        x-text="technique.id"></div>
                                                    <div style="font-size: 10px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                                        x-text="technique.name"></div>
                                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: var(--font-weight-semibold);"
                                                        x-text="technique.count"></div>
                                                </div>
                                            </template>
                                        </div>
                                        <div x-show="Object.keys(mitreHeatmap.by_tactic || {}).length > 0"
                                            style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div
                                                style="font-size: var(--text-xs); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1); color: var(--text-secondary);">
                                                By Tactic:</div>
                                            <div style="display: flex; flex-wrap: wrap; gap: var(--space-1);">
                                                <template x-for="(count, tactic) in (mitreHeatmap.by_tactic || {})"
                                                    :key="tactic">
                                                    <span class="badge"
                                                        style="background: rgba(0, 243, 255, 0.15); color: var(--neon-cyan); padding: 2px 6px; font-size: 10px;">
                                                        <span x-text="tactic"></span>: <strong x-text="count"></strong>
                                                    </span>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                    <div x-show="!mitreHeatmap.loading && (!mitreHeatmap.techniques || mitreHeatmap.techniques.length === 0)"
                                        class="empty-state-compact">
                                        <span class="empty-icon">üéØ</span>
                                        <span>No MITRE techniques detected</span>
                                    </div>
                                    {% endcall %}
                                </template>


                                <!-- Protocol Anomalies Widget -->
                                <template x-if="isVisible('protocolAnomalies')">
                                    {% call widget_card('protocolAnomalies', 'Protocol Anomalies', '‚ö°',
                                    show_spinner=True) %}
                                    <div class="anomaly-summary"
                                        :class="{ 'has-anomalies': protocolAnomalies.anomaly_count > 0 }">
                                        <span x-show="protocolAnomalies.status === 'warming'" class="text-yellow"
                                            style="font-style:italic;">‚ö†Ô∏è Baseline Warming (learning phase)</span>
                                        <span
                                            x-show="protocolAnomalies.status !== 'warming' && protocolAnomalies.anomaly_count > 0"
                                            class="text-red">‚ö†Ô∏è
                                            <span x-text="protocolAnomalies.anomaly_count"></span> anomalies
                                            detected</span>
                                        <span
                                            x-show="protocolAnomalies.status !== 'warming' && protocolAnomalies.anomaly_count === 0"
                                            class="text-green">‚úÖ No
                                            anomalies</span>
                                    </div>
                                    <div class="protocol-anomaly-list">
                                        <template x-for="proto in (protocolAnomalies.protocols || []).slice(0, 6)"
                                            :key="proto.protocol">
                                            <div class="protocol-anomaly-item"
                                                :class="{ 'is-anomaly': proto.is_anomaly }">
                                                <span class="proto-name" x-text="proto.protocol"></span>
                                                <span class="proto-bytes" x-text="proto.bytes_fmt"></span>
                                                <span class="proto-deviation"
                                                    :class="{ 'deviation-high': proto.deviation > 3, 'deviation-medium': proto.deviation > 1.5 }"
                                                    x-text="proto.deviation + 'x'"></span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                            </div> <!-- End security-grid -->

                            <!-- Threat Activity Timeline - Full Width -->
                            <section id="section-threat-activity-timeline" class="scroll-section"
                                style="margin-top: var(--space-6);">
                                {% set threat_actions %}
                                <button class="icon-btn-small" @click="exportThreatActivityTimeline('csv')"
                                    title="Export CSV" style="color: var(--neon-green);"
                                    x-show="threatActivityTimeline.timeline && threatActivityTimeline.timeline.length > 0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                                {% endset %}
                                {% call widget_card('threatActivityTimeline', 'Threat Activity Timeline', 'üìà',
                                card_class='wide-card', extra_actions=threat_actions, show_spinner=True) %}
                                <!-- Time Range Selector -->
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); flex-wrap: wrap; gap: var(--space-1);">
                                    <div style="display: flex; gap: var(--space-1); flex-wrap: wrap;">
                                        <button
                                            @click="threatActivityTimeline.timeRange = '1h'; fetchThreatActivityTimeline()"
                                            :class="{ 'btn--primary': threatActivityTimeline.timeRange === '1h', 'btn--secondary': threatActivityTimeline.timeRange !== '1h' }"
                                            class="btn"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                            1 Hour
                                        </button>
                                        <button
                                            @click="threatActivityTimeline.timeRange = '6h'; fetchThreatActivityTimeline()"
                                            :class="{ 'btn--primary': threatActivityTimeline.timeRange === '6h', 'btn--secondary': threatActivityTimeline.timeRange !== '6h' }"
                                            class="btn"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                            6 Hours
                                        </button>
                                        <button
                                            @click="threatActivityTimeline.timeRange = '24h'; fetchThreatActivityTimeline()"
                                            :class="{ 'btn--primary': threatActivityTimeline.timeRange === '24h', 'btn--secondary': threatActivityTimeline.timeRange !== '24h' }"
                                            class="btn"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                            24 Hours
                                        </button>
                                        <button
                                            @click="threatActivityTimeline.timeRange = '7d'; fetchThreatActivityTimeline()"
                                            :class="{ 'btn--primary': threatActivityTimeline.timeRange === '7d', 'btn--secondary': threatActivityTimeline.timeRange !== '7d' }"
                                            class="btn"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                            7 Days
                                        </button>
                                    </div>
                                    <div style="display: flex; gap: var(--space-1); flex-wrap: wrap;">
                                        <button @click="exportThreatActivityTimeline('csv')" class="btn btn--secondary"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);"
                                            :disabled="!threatActivityTimeline.timeline || threatActivityTimeline.timeline.length === 0">
                                            üì• CSV
                                        </button>
                                        <button @click="exportThreatActivityTimeline('json')" class="btn btn--secondary"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);"
                                            :disabled="!threatActivityTimeline.timeline || threatActivityTimeline.timeline.length === 0">
                                            üì• JSON
                                        </button>
                                    </div>
                                </div>

                                <!-- Stats Summary -->
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: var(--space-2); margin-bottom: var(--space-2);">
                                    <div class="card"
                                        style="padding: var(--space-1) var(--space-2); text-align: center;">
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                            Total Threats</div>
                                        <div style="font-size: var(--text-lg); font-weight: var(--font-weight-bold); color: var(--neon-cyan);"
                                            x-text="threatActivityTimeline.total_24h || 0"></div>
                                    </div>
                                    <div class="card"
                                        style="padding: var(--space-1) var(--space-2); text-align: center;"
                                        x-show="threatActivityTimeline.peak_hour">
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                            Peak Hour</div>
                                        <div style="font-size: var(--text-sm); font-weight: var(--font-weight-semibold); color: var(--neon-red);"
                                            x-text="threatActivityTimeline.peak_hour || 'N/A'"></div>
                                        <div style="font-size: var(--text-xs); color: var(--text-muted);"
                                            x-text="(threatActivityTimeline.peak_count || 0) + ' threats'">
                                        </div>
                                    </div>
                                    <div class="card"
                                        style="padding: var(--space-1) var(--space-2); text-align: center;"
                                        x-show="threatActivityTimeline.has_fw_data">
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                            FW Blocks</div>
                                        <div style="font-size: var(--text-lg); font-weight: var(--font-weight-bold); color: var(--neon-green);"
                                            x-text="threatActivityTimeline.fw_blocks_24h || 0"></div>
                                    </div>
                                </div>

                                <!-- Chart -->
                                <div class="chart-wrapper" style="height: 200px; margin-bottom: var(--space-2);"
                                    x-show="threatActivityTimeline.timeline && threatActivityTimeline.timeline.length > 0">
                                    <canvas id="threatActivityTimelineChart"></canvas>
                                </div>

                                <!-- Empty State -->
                                <div x-show="!threatActivityTimeline.loading && (!threatActivityTimeline.timeline || threatActivityTimeline.timeline.length === 0)"
                                    class="empty-state">
                                    <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">üìà
                                    </div>
                                    <p
                                        style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                        No Threat Activity Data</p>
                                    <p
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); max-width: 400px; margin: 0 auto;">
                                        No threat activity detected in the selected time range.
                                    </p>
                                </div>
                                {% endcall %}
                            </section>

                        </section>
                    </div>

                    <!-- ============================================
             NETWORK TAB
             ============================================ -->
                    <div x-show="activeTab === 'network'"
                        :style="activeTab === 'network' ? 'display:block' : 'display:none'" id="network-tab"
                        role="tabpanel" aria-labelledby="network-tab-btn" tabindex="0">
                        <!-- Network Dashboard -->
                        <section id="section-network" class="scroll-section mb-8">

                            <!-- Network Status Blocks -->
                            <div class="grid mb-6 grid-auto-fit">
                                <div class="card stat-box">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.active_flows || 0).toLocaleString()">...</span>
                                        <template
                                            x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.active_flows">
                                            <span
                                                :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.active_flows.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (networkStatsOverview.trends.active_flows.muted ? '0.6' : '0.8')"
                                                x-text="networkStatsOverview.trends.active_flows.indicator"
                                                :title="'Since last hour: ' + (networkStatsOverview.trends.active_flows.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.active_flows.percent_change.toFixed(1) + '%'"></span>
                                        </template>
                                    </div>
                                    <div class="label">Active Flows</div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-top: 2px;">
                                        Live</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.external_connections || 0).toLocaleString()">...</span>
                                        <template
                                            x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.external_connections">
                                            <span
                                                :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.external_connections.muted ? 'var(--text-tertiary)' : 'var(--text-tertiary)') + '; opacity: ' + (networkStatsOverview.trends.external_connections.muted ? '0.6' : '0.8')"
                                                x-text="networkStatsOverview.trends.external_connections.indicator"
                                                :title="'Since last hour: ' + (networkStatsOverview.trends.external_connections.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.external_connections.percent_change.toFixed(1) + '%'"></span>
                                        </template>
                                    </div>
                                    <div class="label">External Connections</div>
                                </div>
                                <div class="card stat-box"
                                    :class="{ 'status-warning': networkStatsOverview.anomalies_24h > 0 }">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.anomalies_24h || 0).toLocaleString()">...</span>
                                        <template
                                            x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.anomalies">
                                            <span
                                                :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.anomalies.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (networkStatsOverview.trends.anomalies.muted ? '0.6' : '0.8')"
                                                x-text="networkStatsOverview.trends.anomalies.indicator"
                                                :title="'Since last hour: ' + (networkStatsOverview.trends.anomalies.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.anomalies.percent_change.toFixed(1) + '%'"></span>
                                        </template>
                                    </div>
                                    <div class="label">Network Anomalies (24h)
                                        <span style="margin-left: var(--space-1); opacity: 0.6; cursor: help;"
                                            title="Anomalies are behavioral deviations from normal network patterns, not confirmed threats. They indicate unusual activity that may warrant investigation.">‚ÑπÔ∏è</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Network Health Stat Boxes -->
                            <div class="grid mb-6 grid-auto-fit" style="margin-top: var(--space-4);">
                                <!-- Health Score Stat Box -->
                                <div class="card stat-box"
                                    :class="'grade-' + (netHealth.health_score >= 90 ? 'a' : netHealth.health_score >= 70 ? 'b' : netHealth.health_score >= 50 ? 'c' : 'd')"
                                    title="Score based on static thresholds for TCP resets, SYN floods, and ICMP traffic.">
                                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span class="health-icon" x-text="netHealth.status_icon || 'üíö'"
                                            style="font-size: 1.2em;"></span>
                                        <span
                                            x-text="netHealth.loading ? '...' : (netHealth.health_score || 100)">...</span>
                                    </div>
                                    <div class="label">Network Health <span style="opacity:0.6; cursor:help;">‚ÑπÔ∏è</span>
                                        <span
                                            x-text="netHealth.status ? ' (' + netHealth.status.toUpperCase() + ')' : ''"
                                            style="margin-left: 4px; font-weight: normal;"></span>
                                    </div>
                                </div>
                                <!-- Health Indicator Stat Boxes -->
                                <template x-for="ind in netHealth.indicators" :key="ind.name">
                                    <div class="card stat-box"
                                        :class="'status-' + (ind.status === 'good' ? 'ok' : ind.status === 'warn' ? 'warning' : ind.status === 'bad' || ind.status === 'critical' ? 'critical' : 'info')">
                                        <div class="value"
                                            style="display: flex; align-items: center; gap: var(--space-2);">
                                            <span x-text="ind.icon" style="font-size: 1.1em;"></span>
                                            <span x-text="ind.value || 'N/A'"></span>
                                        </div>
                                        <div class="label" x-text="ind.name"></div>
                                    </div>
                                </template>
                                <!-- Loading State -->
                                <template x-if="netHealth.loading && netHealth.indicators.length === 0">
                                    <div class="card stat-box">
                                        <div class="value">...</div>
                                        <div class="label">Loading Health Data</div>
                                    </div>
                                </template>
                                <!-- Empty State -->
                                <template x-if="!netHealth.loading && netHealth.indicators.length === 0">
                                    <div class="card stat-box">
                                        <div class="value">‚Äî</div>
                                        <div class="label">No Health Indicators</div>
                                    </div>
                                </template>
                            </div>

                            <!-- Primary Network Endpoints: Sources & Destinations -->


                            <!-- Supporting Network Metrics -->
                            <div class="grid" data-reorder="true" data-grid-id="network-overview"
                                style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: var(--space-4);">


                                <!-- Top Sources -->
                                <template x-if="isVisible('sources')">
                                    {% set src_actions %}
                                    <div class="status-pills">
                                        <span class="status-pill running">Running</span>
                                    </div>
                                    {% endset %}
                                    {% set src_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('sources')">View All</button>
                                    {% endset %}
                                    {% call widget_card('sources', 'Top Sources', 'üîº', extra_actions=src_actions,
                                    footer_content=src_footer) %}
                                    <div class="widget-body-inner">
                                        <div class="endpoint-grid-header">
                                            <div class="grid-th w-50">Source Address</div>
                                            <div class="grid-th w-50" style="text-align: right;">Traffic</div>
                                        </div>
                                        <div class="endpoint-grid-body">
                                            <template x-for="(item, index) in filteredSources" :key="index">
                                                <div @click="openIPModal(item.key)"
                                                    class="network-endpoint-row grid-row" :data-row-rank="index"
                                                    :data-percentage="filteredSources.length > 0 && filteredSources[0]?.bytes ? Math.round((item.bytes / filteredSources[0].bytes) * 100) : 0"
                                                    :style="'--row-percentage: ' + (filteredSources.length > 0 && filteredSources[0]?.bytes ? Math.round((item.bytes / filteredSources[0].bytes) * 100) : 0)">

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell">
                                                            <!-- Primary: IP Address -->
                                                            <div class="endpoint-primary-line">
                                                                <strong x-text="item.key" class="endpoint-ip"></strong>
                                                                <button class="icon-btn-small endpoint-filter-btn"
                                                                    @click.stop="applyFilter(item.key)"
                                                                    title="Filter / Details"
                                                                    :aria-label="'View details for ' + item.key">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14"
                                                                        height="14" viewBox="0 0 24 24" fill="none"
                                                                        stroke="currentColor" stroke-width="2"
                                                                        stroke-linecap="round" stroke-linejoin="round">
                                                                        <circle cx="11" cy="11" r="8"></circle>
                                                                        <line x1="21" y1="21" x2="16.65" y2="16.65">
                                                                        </line>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                            <!-- Secondary: Metadata with inline sparkline -->
                                                            <div class="endpoint-meta-line">
                                                                <span x-text="item.region"></span>
                                                                <span
                                                                    x-show="item.hostname && item.hostname !== item.key"
                                                                    x-text="' ‚Ä¢ ' + item.hostname"></span>
                                                                <span class="endpoint-meta-sparkline">
                                                                    <canvas class="spark spark-subtle" width="80"
                                                                        height="14" :data-ip="item.key"
                                                                        data-kind="source"></canvas>
                                                                </span>
                                                            </div>
                                                            <!-- Supporting: Badges -->
                                                            <div class="endpoint-badges">
                                                                <span class="badge threat"
                                                                    x-show="item.threat">THREAT</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell endpoint-value-cell">
                                                            <div class="endpoint-value"
                                                                :class="{'text-green': item.bytes > (filteredSources[0]?.bytes * 0.5)}"
                                                                x-text="item.bytes_fmt || fmtBytes(item.bytes || 0)">
                                                            </div>
                                                            <div class="endpoint-flows"
                                                                x-text="(item.flows || 0) + ' flows'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Destinations -->
                                <template x-if="isVisible('destinations')">
                                    {% set dst_actions %}
                                    <div class="status-pills">
                                        <span class="status-pill running">Running</span>
                                    </div>
                                    {% endset %}
                                    {% set dst_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('destinations')">View
                                        All</button>
                                    {% endset %}
                                    {% call widget_card('destinations', 'Top Destinations', 'üéØ',
                                    extra_actions=dst_actions,
                                    footer_content=dst_footer) %}
                                    <div class="widget-body-inner">
                                        <div class="endpoint-grid-header">
                                            <div class="grid-th w-50">IP Address</div>
                                            <div class="grid-th w-50" style="text-align: right;">Traffic</div>
                                        </div>
                                        <div class="endpoint-grid-body">
                                            <template x-for="(item, index) in filteredDestinations" :key="index">
                                                <div @click="openIPModal(item.key)"
                                                    class="network-endpoint-row grid-row" :data-row-rank="index"
                                                    :data-percentage="filteredDestinations.length > 0 && filteredDestinations[0]?.bytes ? Math.round((item.bytes / filteredDestinations[0].bytes) * 100) : 0"
                                                    :style="'--row-percentage: ' + (filteredDestinations.length > 0 && filteredDestinations[0]?.bytes ? Math.round((item.bytes / filteredDestinations[0].bytes) * 100) : 0)">

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell">
                                                            <!-- Primary: IP Address -->
                                                            <div class="endpoint-primary-line">
                                                                <strong x-text="item.key" class="endpoint-ip"></strong>
                                                                <button class="icon-btn-small endpoint-filter-btn"
                                                                    @click.stop="applyFilter(item.key)"
                                                                    title="Filter / Details"
                                                                    :aria-label="'View details for ' + item.key">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14"
                                                                        height="14" viewBox="0 0 24 24" fill="none"
                                                                        stroke="currentColor" stroke-width="2"
                                                                        stroke-linecap="round" stroke-linejoin="round">
                                                                        <circle cx="11" cy="11" r="8"></circle>
                                                                        <line x1="21" y1="21" x2="16.65" y2="16.65">
                                                                        </line>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                            <!-- Secondary: Metadata with inline sparkline -->
                                                            <div class="endpoint-meta-line">
                                                                <span x-text="item.region"></span>
                                                                <span
                                                                    x-show="item.hostname && item.hostname !== item.key"
                                                                    x-text="' ‚Ä¢ ' + item.hostname"></span>
                                                                <span class="endpoint-meta-sparkline">
                                                                    <canvas class="spark spark-subtle" width="80"
                                                                        height="14" :data-ip="item.key"
                                                                        data-kind="dest"></canvas>
                                                                </span>
                                                            </div>
                                                            <!-- Supporting: Badges -->
                                                            <div class="endpoint-badges">
                                                                <span class="badge threat"
                                                                    x-show="item.threat">THREAT</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell endpoint-value-cell">
                                                            <div class="endpoint-value"
                                                                :class="{'text-green': item.bytes > (filteredDestinations[0]?.bytes * 0.5)}"
                                                                x-text="item.bytes_fmt || fmtBytes(item.bytes || 0)">
                                                            </div>
                                                            <div class="endpoint-flows"
                                                                x-text="(item.flows || 0) + ' flows'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Protocol Hierarchy -->
                                <template x-if="isVisible('protocolHierarchy')">
                                    {% call widget_card('protocolHierarchy', 'Protocol Hierarchy', 'üß¨',
                                    show_spinner=True) %}
                                    <div class="chart-wrapper" style="height: 300px; position: relative;">
                                        <canvas id="protocolHierarchyChart"></canvas>
                                    </div>
                                    <div class="text-center text-xs text-muted mt-3">
                                        <span class="badge"
                                            style="background: rgba(0, 243, 255, 0.1); color: var(--neon-cyan); font-size: 0.7rem;">Inner:
                                            Layer 4</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <span class="badge"
                                            style="background: rgba(188, 19, 254, 0.1); color: var(--neon-purple); font-size: 0.7rem;">Outer:
                                            Layer 7</span>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Traffic Distribution -->
                                <template x-if="isVisible('trafficScatter')">
                                    {% call widget_card('trafficScatter', 'Host Traffic Matrix', 'üí†',
                                    show_spinner=True) %}
                                    <div class="chart-wrapper" style="height: 300px; position: relative;">
                                        <canvas id="trafficScatterChart"></canvas>
                                    </div>
                                    <div class="text-center text-xs text-muted mt-3">
                                        <span style="color: var(--neon-cyan)">‚Üì Download</span> (Log) vs
                                        <span style="color: var(--neon-purple)">‚Üë Upload</span> (Log)
                                    </div>
                                    {% endcall %}
                                </template>
                                <!-- Top Ports -->
                                <template x-if="isVisible('ports')">
                                    {% set ports_actions %}
                                    <div class="status-pills">
                                        <span class="status-pill running">Running</span>
                                    </div>
                                    {% endset %}
                                    {% call widget_card('ports', 'Top Ports', 'üîå', extra_actions=ports_actions) %}
                                    <table class="table-fixed table-compact">
                                        <thead>
                                            <tr>
                                                <th class="w-70">Port</th>
                                                <th class="w-30">Traffic</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(item, index) in (ports.ports || []).slice(0, 5)"
                                                :key="index">
                                                <tr :data-percentage="ports.ports.length > 0 && ports.ports[0]?.bytes ? Math.round((item.bytes / ports.ports[0].bytes) * 100) : 0"
                                                    :style="'--row-percentage: ' + (ports.ports.length > 0 && ports.ports[0]?.bytes ? Math.round((item.bytes / ports.ports[0].bytes) * 100) : 0)">
                                                    <td style="overflow: hidden;">
                                                        <strong class="text-cyan" x-text="item.key"></strong>
                                                        <div class="truncate text-9 text-muted" x-text="item.service"
                                                            :title="item.service"></div>
                                                    </td>
                                                    <td>
                                                        <div class="text-green"
                                                            x-text="item.bytes_fmt || fmtBytes(item.bytes)">
                                                        </div>
                                                        <span class="badge suspicious"
                                                            x-show="item.suspicious">SUSPICIOUS</span>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                    {% endcall %}
                                </template>

                                <!-- Top ASNs -->
                                <template x-if="isVisible('asns')">
                                    {% set asns_actions %}
                                    <div class="status-pills">
                                        <span class="status-pill running">Live</span>
                                    </div>
                                    {% endset %}
                                    {% call widget_card('asns', 'Top ASNs', 'üè¢', extra_actions=asns_actions) %}
                                    <div class="widget-body-inner">
                                        <template x-for="asn in asns.asns" :key="asn.asn">
                                            <div class="asn-row">
                                                <div class="asn-name" x-text="asn.asn" :title="asn.asn"
                                                    style="color: var(--text-primary); font-weight: 500;"></div>
                                                <div class="asn-bar-container">
                                                    <div class="asn-bar"
                                                        :style="'width:' + (asn.bytes / (asns.maxBytes||1) * 100) + '%'">
                                                    </div>
                                                </div>
                                                <div class="asn-val" x-text="asn.bytes_fmt"
                                                    style="color: var(--text-primary); font-weight: 500;"></div>
                                            </div>
                                        </template>
                                        <div x-show="!asns.loading && (!asns.asns || asns.asns.length === 0)"
                                            class="empty-state">No ASN data available</div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Countries -->
                                <template x-if="isVisible('countries')">
                                    {% set country_actions %}
                                    <div class="status-pills">
                                        <span class="status-pill running">Live</span>
                                    </div>
                                    {% endset %}
                                    {% set country_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('countries')">View
                                        All</button>
                                    {% endset %}
                                    {% call widget_card('countries', 'Top Countries', 'üåç',
                                    extra_actions=country_actions,
                                    footer_content=country_footer) %}
                                    <div class="widget-body-inner">
                                        <div class="chart-wrapper-small chart-expandable"
                                            @click="openFullscreenChart('countriesChart', 'Top Countries by Traffic')"
                                            title="Click to expand">
                                            <canvas id="countriesChart"></canvas>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Talkers - MOVED TO FIREWALL TAB -->

                                <!-- Top Services -->
                                <template x-if="isVisible('services')">
                                    {% set svc_actions %}
                                    <div class="status-pills">
                                        <span class="status-pill running">Live</span>
                                    </div>
                                    {% endset %}
                                    {% set svc_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('services')">View
                                        All</button>
                                    {% endset %}
                                    {% call widget_card('services', 'Top Services', 'üåê', extra_actions=svc_actions,
                                    footer_content=svc_footer) %}
                                    <div class="widget-body-inner">
                                        <template x-for="svc in services.services" :key="svc.service">
                                            <div class="service-row">
                                                <div class="service-name" x-text="svc.service" :title="svc.service">
                                                </div>
                                                <div class="service-bar-container">
                                                    <div class="service-bar" :style="'width:' + svc.pct + '%'">
                                                    </div>
                                                </div>
                                                <div class="service-val" x-text="svc.bytes_fmt"></div>
                                            </div>
                                        </template>
                                        <div x-show="!services.loading && (!services.services || services.services.length === 0)"
                                            class="empty-state">No data</div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Traffic by Hour -->
                                <template x-if="isVisible('hourlyTraffic')">
                                    {% call widget_card('hourlyTraffic', 'Traffic by Hour', '‚è∞', show_spinner=True) %}
                                    <div class="hourly-summary">
                                        <div class="hourly-stat">
                                            <span class="hourly-stat-value text-green"
                                                x-text="hourlyTraffic.peak_hour + ':00'"></span>
                                            <span class="hourly-stat-label">Peak Hour</span>
                                        </div>
                                        <div class="hourly-stat">
                                            <span class="hourly-stat-value text-cyan"
                                                x-text="hourlyTraffic.peak_bytes_fmt"></span>
                                            <span class="hourly-stat-label">Peak Traffic</span>
                                        </div>
                                        <div class="hourly-stat">
                                            <span class="hourly-stat-value"
                                                x-text="hourlyTraffic.total_bytes_fmt"></span>
                                            <span class="hourly-stat-label">24h Total</span>
                                        </div>
                                    </div>
                                    <div class="chart-wrapper-small chart-expandable"
                                        @click="openFullscreenChart('hourlyChart', 'Traffic by Hour (24h)')"
                                        title="Click to expand">
                                        <canvas id="hourlyChart"></canvas>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- TCP Flags -->
                                <template x-if="isVisible('flags')">
                                    {% call widget_card('flags', 'TCP Flags', 'üè≥Ô∏è', show_spinner=True) %}
                                    <div class="chart-wrapper-small chart-expandable"
                                        @click="openFullscreenChart('flagsChart', 'TCP Flags Distribution')"
                                        title="Click to expand">
                                        <canvas id="flagsChart"></canvas>
                                    </div>
                                    <!-- Custom legend with flag names and colors -->
                                    <div class="flags-custom-legend"
                                        style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; padding: 0 10px;">
                                        <template x-for="(flag, idx) in flags.flags" :key="flag.flag">
                                            <div class="flags-legend-item"
                                                style="display: flex; align-items: center; gap: 6px;">
                                                <span class="flags-legend-color"
                                                    :style="'width: 12px; height: 12px; border-radius: 2px; background: ' + getFlagColor(idx) + ';'"></span>
                                                <span style="color: var(--text-1); font-size: 0.85em;"
                                                    x-text="flag.flag"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div
                                        style="margin-top:10px; font-size:0.75em; color:var(--text-muted); line-height:1.4;">
                                        <strong>Flags:</strong>
                                        <span title="Acknowledge">AP=ACK+PSH</span> ¬∑
                                        <span title="Acknowledge">A=ACK</span> ¬∑
                                        <span title="ACK+PSH+SYN+FIN">APSF=ACK+PSH+SYN+FIN</span> ¬∑
                                        <span title="Reset">R=RST</span> ¬∑
                                        <span title="No flags">None</span>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Long Flows - MOVED TO FIREWALL TAB -->

                                <!-- Packet Size Distribution -->
                                <template x-if="isVisible('packetSizes')">
                                    {% call widget_card('packetSizes', 'Packet Sizes', 'üì¶', show_spinner=True) %}
                                    <div class="chart-wrapper-small chart-expandable"
                                        @click="openFullscreenChart('pktSizeChart', 'Packet Size Distribution')"
                                        title="Click to expand">
                                        <canvas id="pktSizeChart"></canvas>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Protocols -->
                                <template x-if="isVisible('protocols')">
                                    {% call widget_card('protocols', 'Protocols', 'üì°', show_spinner=True) %}
                                    <div class="chart-wrapper-small chart-expandable"
                                        style="margin-bottom: 12px; height: 160px;"
                                        x-show="protoMix && protoMix.labels && protoMix.labels.length > 0"
                                        @click="openFullscreenChart('protoMixChart', 'Protocol Distribution')"
                                        title="Click to expand">
                                        <canvas id="protoMixChart"></canvas>
                                    </div>
                                    <table class="table-fixed table-compact"
                                        x-show="protocols.protocols && protocols.protocols.length > 0">
                                        <thead>
                                            <tr>
                                                <th>Protocol</th>
                                                <th>Stats</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(item, index) in protocols.protocols" :key="index">
                                                <tr>
                                                    <td>
                                                        <strong class="text-cyan" x-text="item.proto_name"></strong>
                                                    </td>
                                                    <td>
                                                        <div class="text-green"
                                                            x-text="item.bytes_fmt || fmtBytes(item.bytes)">
                                                        </div>
                                                        <div class="text-8 text-muted"
                                                            x-text="Number(item.flows).toLocaleString() + ' flows'">
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                    <div x-show="!protocols.loading && (!protocols.protocols || protocols.protocols.length === 0)"
                                        class="empty-state">No protocol data available</div>
                                    {% endcall %}
                                </template>

                                <!-- Traffic Insights (Unified InsightPanel) -->
                                <template x-if="isVisible('insights')">
                                    {% call insight_panel('traffic', 'Traffic Insights', 'üí°', 'global_time_range') %}
                                    <!-- Expanded View Content - Top 5 Talkers -->
                                    <template x-if="sources.sources && sources.sources.length > 0">
                                        <div style="margin-bottom: 16px;">
                                            <div
                                                style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; font-size: 0.9em;">
                                                Top Talkers</div>
                                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                                <template x-for="(src, idx) in sources.sources.slice(0, 5)"
                                                    :key="src.key">
                                                    <div
                                                        style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85em;">
                                                        <span>
                                                            <span class="clickable-ip"
                                                                @click.stop="openIPModal(src.key)"
                                                                style="color: var(--neon-cyan); cursor: pointer;"
                                                                x-text="src.key"></span>
                                                            <span
                                                                style="color: var(--text-secondary); margin-left: 6px;"
                                                                x-text="'(' + (src.bytes && summary.total_bytes ? ((src.bytes / summary.total_bytes * 100).toFixed(1)) : '0') + '% of total)'"></span>
                                                        </span>
                                                        <span style="color: var(--text-primary); font-weight: 500;"
                                                            x-text="src.bytes_fmt || fmtBytes(src.bytes || 0)"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Top 5 Ports -->
                                    <template x-if="ports.ports && ports.ports.length > 0">
                                        <div style="margin-bottom: 16px;">
                                            <div
                                                style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; font-size: 0.9em;">
                                                Top Ports</div>
                                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                                <template x-for="(port, idx) in ports.ports.slice(0, 5)"
                                                    :key="port.key">
                                                    <div
                                                        style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85em;">
                                                        <span>
                                                            <span style="color: var(--text-primary);"
                                                                x-text="'Port ' + port.key"></span>
                                                            <span
                                                                style="color: var(--text-secondary); margin-left: 6px;"
                                                                x-text="port.service ? '(' + port.service + ')' : ''"></span>
                                                            <span
                                                                style="color: var(--text-secondary); margin-left: 6px;"
                                                                x-text="'(' + (port.bytes && summary.total_bytes ? ((port.bytes / summary.total_bytes * 100).toFixed(1)) : '0') + '% of total)'"></span>
                                                        </span>
                                                        <span style="color: var(--text-primary); font-weight: 500;"
                                                            x-text="port.bytes_fmt || fmtBytes(port.bytes || 0)"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Protocol Distribution -->
                                    <template x-if="protocols.protocols && protocols.protocols.length > 0">
                                        <div>
                                            <div
                                                style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; font-size: 0.9em;">
                                                Protocol Distribution</div>
                                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                                <template x-for="(proto, idx) in protocols.protocols.slice(0, 5)"
                                                    :key="proto.key">
                                                    <div
                                                        style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85em;">
                                                        <span>
                                                            <span style="color: var(--text-primary);"
                                                                x-text="proto.proto_name || proto.key"></span>
                                                            <span
                                                                style="color: var(--text-secondary); margin-left: 6px;"
                                                                x-text="'(' + (proto.bytes && summary.total_bytes ? ((proto.bytes / summary.total_bytes * 100).toFixed(1)) : '0') + '% of total)'"></span>
                                                        </span>
                                                        <span style="color: var(--text-primary); font-weight: 500;"
                                                            x-text="proto.bytes_fmt || fmtBytes(proto.bytes || 0)"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                    {% endcall %}
                                </template>

                                <!-- Flow Statistics -->
                                <template x-if="isVisible('flowStats')">
                                    {% call widget_card('flowStats', 'Flow Statistics', 'üìä', show_spinner=True) %}
                                    <div class="flow-stats-grid">
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-cyan"
                                                x-text="(flowStats.total_flows || 0).toLocaleString()"></span>
                                            <span class="flow-stat-label">Total Flows</span>
                                        </div>
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-green"
                                                x-text="flowStats.avg_duration_fmt || '0s'"></span>
                                            <span class="flow-stat-label">Avg Duration</span>
                                        </div>
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-cyan"
                                                x-text="flowStats.avg_bytes_fmt || '0 B'"></span>
                                            <span class="flow-stat-label">Avg Size</span>
                                        </div>
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-yellow"
                                                x-text="(flowStats.bytes_per_packet || 0) + ' B'"></span>
                                            <span class="flow-stat-label">Bytes/Pkt</span>
                                        </div>
                                    </div>
                                    <div class="duration-dist" x-show="flowStats.duration_dist">
                                        <div class="duration-dist-label">Duration Distribution:</div>
                                        <div class="duration-dist-bars">
                                            <div class="dist-bar-group">
                                                <div class="dist-bar short"
                                                    :style="'width:' + (flowStats.duration_dist?.short / (flowStats.total_flows || 1) * 100) + '%'">
                                                </div>
                                                <span class="dist-label">&lt;1s</span>
                                            </div>
                                            <div class="dist-bar-group">
                                                <div class="dist-bar medium"
                                                    :style="'width:' + (flowStats.duration_dist?.medium / (flowStats.total_flows || 1) * 100) + '%'">
                                                </div>
                                                <span class="dist-label">1s-1m</span>
                                            </div>
                                            <div class="dist-bar-group">
                                                <div class="dist-bar long"
                                                    :style="'width:' + (flowStats.duration_dist?.long / (flowStats.total_flows || 1) * 100) + '%'">
                                                </div>
                                                <span class="dist-label">&gt;1m</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>






                            </div>
                        </section>

                    </div>

                    <!-- ============================================
                 HOSTS TAB
                 ============================================ -->
                    <div x-show="activeTab === 'hosts'"
                        :style="activeTab === 'hosts' ? 'display:block' : 'display:none'" id="hosts-tab" class="fade-in"
                        role="tabpanel" aria-labelledby="hosts-tab-btn" tabindex="0">

                        <!-- Hosts Top Stats -->
                        <section id="section-hosts-stats" class="mb-6">
                            <div class="grid grid-auto-fit gap-4">
                                <!-- Total Hosts -->
                                <div class="card stat-box">
                                    <div class="value"
                                        x-text="hosts.loading ? '...' : (hosts.stats.total_hosts || 0).toLocaleString()">
                                        ...</div>
                                    <div class="label">Total Hosts (24h)</div>
                                </div>
                                <!-- Active Hosts -->
                                <div class="card stat-box">
                                    <div class="value"
                                        x-text="hosts.loading ? '...' : (hosts.stats.active_hosts || 0).toLocaleString()">
                                        ...</div>
                                    <div class="label">Active Hosts (1h)</div>
                                </div>
                                <!-- New Hosts -->
                                <div class="card stat-box">
                                    <div class="value" x-text="hosts.loading ? '...' : hosts.stats.new_hosts">...</div>
                                    <div class="label">New Hosts (24h)</div>
                                </div>
                                <!-- Anomalies -->
                                <div class="card stat-box">
                                    <div class="value" :class="{'text-red': hosts.stats.anomalies > 0}"
                                        x-text="hosts.loading ? '...' : (hosts.stats.anomalies || 0).toLocaleString()">
                                        ...</div>
                                    <div class="label">Hosts with Anomalies</div>
                                </div>
                            </div>
                        </section>

                        <!-- Hosts Table -->
                        <section id="section-hosts-list" class="scroll-section">
                            {% call widget_card('hosts', 'Network Hosts', 'üñ•Ô∏è', card_class='wide-card',
                            show_spinner=True, extra_actions='
                            <div class="flex gap-2">
                                <button class="btn btn-sm"
                                    :class="hosts.viewMode === \'observed\' ? \'btn-primary\' : \'btn-ghost\'"
                                    @click="switchHostsView(\'observed\')">Observed</button>
                                <button class="btn btn-sm"
                                    :class="hosts.viewMode === \'discovered\' ? \'btn-primary\' : \'btn-ghost\'"
                                    @click="switchHostsView(\'discovered\')">Discovered</button>
                            </div>
                            ') %}

                            <!-- Discovery Controls -->
                            <div x-show="hosts.viewMode === 'discovered'"
                                class="mb-4 p-4 border rounded border-gray-700 bg-gray-900 bg-opacity-50">
                                <div class="flex items-end gap-4">
                                    <div class="form-control w-full max-w-xs">
                                        <label class="label" for="discovery-target-subnet">
                                            <span class="label-text">Target Subnet</span>
                                        </label>
                                        <select id="discovery-target-subnet"
                                            class="select select-bordered select-sm w-full"
                                            x-model="hosts.discovery.target" aria-label="Target Subnet">
                                            <option value="" disabled selected>Select subnet</option>
                                            <template x-for="net in hosts.discovery.subnets" :key="net.cidr">
                                                <option :value="net.cidr" x-text="net.interface + ' - ' + net.cidr">
                                                </option>
                                            </template>
                                            <option value="custom">Custom...</option>
                                        </select>
                                    </div>
                                    <div class="form-control w-full max-w-xs"
                                        x-show="hosts.discovery.target === 'custom'">
                                        <label class="label">
                                            <span class="label-text">Custom CIDR</span>
                                        </label>
                                        <input type="text" x-model="hosts.discovery.target" placeholder="192.168.1.0/24"
                                            class="input input-bordered input-sm w-full" />
                                    </div>

                                    <button class="btn btn-sm btn-primary" @click="runDiscoveryScan()"
                                        :disabled="hosts.discovery.loading || !hosts.discovery.target">
                                        <span x-show="hosts.discovery.loading"
                                            class="loading loading-spinner text-primary"></span>
                                        <span x-show="!hosts.discovery.loading">Scan Network</span>
                                    </button>
                                </div>
                                <div x-show="hosts.discovery.error" class="text-error text-sm mt-2"
                                    x-text="hosts.discovery.error"></div>
                                <div x-show="hosts.discovery.results" class="text-success text-sm mt-2">
                                    Last scan: <span
                                        x-text="new Date(hosts.discovery.results?.scanned_at).toLocaleTimeString()"></span>
                                    - Found <span x-text="hosts.discovery.results?.count"></span> hosts
                                </div>
                            </div>

                            <!-- Observed Hosts Table -->
                            <div x-show="hosts.viewMode === 'observed'">
                                <div x-show="!hosts.loading && (!hosts.list || hosts.list.length === 0)"
                                    class="empty-state">
                                    <div style="font-size: 32px; margin-bottom: var(--space-2);">üîç</div>
                                    <p>No hosts observed in the selected time range.</p>
                                </div>

                                <div class="table-container" x-show="hosts.list && hosts.list.length > 0">
                                    <table class="table-fixed table-compact thead-sticky">
                                        <thead>
                                            <tr>
                                                <th style="width: 25%">Host</th>
                                                <th style="width: 10%">Type</th>
                                                <th style="width: 15%">First Seen</th>
                                                <th style="width: 15%">Last Seen</th>
                                                <th style="width: 15%">Volume</th>
                                                <th style="width: 10%">Flows</th>
                                                <th style="width: 10%">Flags</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="host in hosts.list" :key="host.ip">
                                                <tr @click="openHostDetail(host.ip)" style="cursor: pointer;">
                                                    <td>
                                                        <div class="flex items-center gap-2">
                                                            <div class="font-mono text-cyan" x-text="host.ip"></div>
                                                            <!-- Subtle new host indicator -->
                                                            <template x-if="host.is_new">
                                                                <span class="host-new-indicator"
                                                                    title="New host (first seen within 24h)">üÜï</span>
                                                            </template>
                                                        </div>
                                                        <!-- Optional hostname if available in future -->
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                            :class="isInternalIP(host.ip) ? 'cat-lateral-movement' : 'cat-new-country'"
                                                            x-text="isInternalIP(host.ip) ? 'INTERNAL' : 'EXTERNAL'">
                                                        </span>
                                                    </td>
                                                    <td class="text-sm text-muted"
                                                        x-text="formatFlowTimestamp(host.first_seen)">
                                                    </td>
                                                    <td class="text-sm text-muted"
                                                        x-text="formatFlowTimestamp(host.last_seen)"></td>
                                                    <td>
                                                        <div x-text="fmtBytes(host.total_bytes)"></div>
                                                        <div class="text-xs text-muted"
                                                            x-text="'RX: ' + fmtBytes(host.rx_bytes) + ' | TX: ' + fmtBytes(host.tx_bytes)">
                                                        </div>
                                                    </td>
                                                    <td x-text="(host.rx_flows + host.tx_flows).toLocaleString()"></td>
                                                    <td>
                                                        <!-- Flags -->
                                                        <div class="flex gap-1">
                                                            <template
                                                                x-if="isInternalIP(host.ip) && host.tx_bytes > host.rx_bytes * 10">
                                                                <span title="High Upload (Internal)">üì§</span>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Discovered Hosts Table -->
                            <div x-show="hosts.viewMode === 'discovered'">
                                <div x-show="!hosts.discovery.results || !hosts.discovery.results.hosts || hosts.discovery.results.hosts.length === 0"
                                    class="empty-state">
                                    <div style="font-size: 32px; margin-bottom: var(--space-2);">üéØ</div>
                                    <p>Scan a subnet to discover active hosts.</p>
                                </div>

                                <div class="table-container"
                                    x-show="hosts.discovery.results && hosts.discovery.results.hosts && hosts.discovery.results.hosts.length > 0">
                                    <table class="table-fixed table-compact thead-sticky">
                                        <thead>
                                            <tr>
                                                <th style="width: 20%">IP Address</th>
                                                <th style="width: 20%">MAC Address</th>
                                                <th style="width: 30%">Vendor</th>
                                                <th style="width: 15%">Status</th>
                                                <th style="width: 15%">Last Seen</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="host in hosts.discovery.results?.hosts" :key="host.ip">
                                                <tr class="hover:bg-gray-800 cursor-pointer"
                                                    @click="openHostDetail(host.ip, { mac: host.mac, vendor: host.vendor, hostname: host.hostname })">
                                                    <td class="font-mono text-cyan" x-text="host.ip"></td>
                                                    <td class="font-mono text-xs" x-text="host.mac"></td>
                                                    <td class="text-xs text-muted" x-text="host.vendor"></td>
                                                    <td>
                                                        <span class="badge badge-success" x-text="host.status"></span>
                                                    </td>
                                                    <td class="text-xs text-muted"
                                                        x-text="new Date(host.last_seen).toLocaleTimeString()"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endcall %}
                        </section>

                    </div>
                    <!-- ============================================
             FIREWALL TAB - Investigation & Incident Response
             ============================================ -->
                    <div x-show="activeTab === 'firewall'"
                        :style="activeTab === 'firewall' ? 'display:block' : 'display:none'" id="firewall-tab"
                        role="tabpanel" aria-labelledby="firewall-tab-btn" tabindex="0">

                        <!-- Firewall Stats Overview (4 stat boxes) -->
                        <div class="grid mb-6 grid-auto-fit">
                            <div class="card stat-box">
                                <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                    <span
                                        x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.blocked_events_24h || 0).toLocaleString()">...</span>
                                    <template
                                        x-if="!firewallStatsOverview.loading && firewallStatsOverview.trends?.blocked_events">
                                        <span
                                            :style="'font-size: 0.8em; color: ' + (firewallStatsOverview.trends.blocked_events.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (firewallStatsOverview.trends.blocked_events.muted ? '0.6' : '0.8')"
                                            x-text="firewallStatsOverview.trends.blocked_events.indicator"
                                            :title="'Since last hour: ' + (firewallStatsOverview.trends.blocked_events.percent_change > 0 ? '+' : '') + firewallStatsOverview.trends.blocked_events.percent_change.toFixed(1) + '%'"></span>
                                    </template>
                                </div>
                                <div class="label">Blocked Events (24h)</div>
                            </div>
                            <div class="card stat-box">
                                <div class="value"
                                    x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.unique_blocked_sources || 0).toLocaleString()">
                                    ...</div>
                                <div class="label">Unique Blocked Sources</div>
                            </div>
                            <div class="card stat-box">
                                <div class="value"
                                    x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.new_blocked_ips || 0).toLocaleString()">
                                    ...</div>
                                <div class="label">New Blocked IPs</div>
                            </div>
                            <div class="card stat-box">
                                <div class="value" style="font-size: 0.9em;"
                                    x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.top_block_reason || 'N/A')">
                                    ...</div>
                                <div class="label">Top Block Reason</div>
                                <div x-show="!firewallStatsOverview.loading && firewallStatsOverview.top_block_count > 0"
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-top: var(--space-1);"
                                    x-text="'(' + (firewallStatsOverview.top_block_count || 0).toLocaleString() + ' times)'">
                                </div>
                            </div>
                        </div>

                        <!-- IP Investigation - Compact Top Menu -->
                        <div class="card"
                            style="margin-bottom: var(--space-4); padding: var(--space-2) var(--space-3); background: rgba(0, 234, 255, 0.05); border: 1px solid rgba(0, 234, 255, 0.15);">
                            <div style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap;">
                                <span
                                    style="color: var(--text-secondary); font-size: var(--text-sm); white-space: nowrap;">üîç
                                    IP Investigation:</span>
                                <input type="text" x-model="ipInvestigation.searchIP" @keyup.enter="investigateIP()"
                                    aria-label="IP address to investigate" placeholder="IP, hostname, or domain..."
                                    class="search-box"
                                    style="flex: 1; min-width: 200px; max-width: 400px; font-size: var(--text-sm); padding: var(--space-1) var(--space-2);">
                                <button @click="investigateIP()" class="btn btn--primary"
                                    :disabled="!ipInvestigation.searchIP.trim() || ipInvestigation.loading"
                                    style="font-size: var(--text-sm); padding: var(--space-1) var(--space-2); white-space: nowrap;">
                                    <span x-show="!ipInvestigation.loading">Investigate</span>
                                    <span x-show="ipInvestigation.loading">Loading...</span>
                                </button>
                                <div class="spinner" x-show="ipInvestigation.loading"
                                    style="width: 14px; height: 14px;">
                                </div>
                            </div>
                        </div>

                        <!-- ========================================
     FIREWALL LOGS (Moved from Security)
     ======================================== -->
                        <section id="section-firewall-forensics" class="scroll-section">
                            <!-- Firewall Logs Widget -->
                            <!-- Firewall Logs Widget -->
                            {% set fw_actions %}
                            <div class="card-actions" style="gap: var(--space-2); flex-wrap: wrap;">
                                <button class="icon-btn-small"
                                    @click="recentBlocksAutoRefresh = !recentBlocksAutoRefresh; toggleRecentBlocksAutoRefresh()"
                                    title="Toggle auto-refresh"
                                    :title="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                                    :aria-label="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                                    :style="recentBlocksAutoRefresh ? 'color: var(--signal-crit);' : 'color: var(--text-muted);'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" x-show="recentBlocksAutoRefresh">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" x-show="!recentBlocksAutoRefresh">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="10" y1="8" x2="10" y2="16"></line>
                                        <line x1="14" y1="8" x2="14" y2="16"></line>
                                    </svg>
                                </button>
                            </div>
                            {% endset %}
                            {% call widget_card('recentBlocks', 'Firewall Logs', 'üî•', card_class='wide-card',
                            extra_actions=fw_actions, show_spinner=True) %}
                            <div x-show="recentBlocks.blocks.length === 0 && !recentBlocks.loading" class="empty-state">
                                <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">‚úÖ</div>
                                <p
                                    style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                    No firewall logs yet</p>
                                <p style="font-size: var(--text-xs); color: var(--text-tertiary);">The firewall has not
                                    blocked any recent traffic.</p>
                            </div>
                            <div x-show="recentBlocks.blocks.length > 0">
                                <div class="log-toolbar">
                                    <div class="log-chips">
                                        <span class="log-chip"><strong
                                                x-text="(recentBlocks.stats?.total || recentBlocks.blocks.length).toLocaleString()"></strong>
                                            Logs</span>
                                        <span class="log-chip log-chip-red"><strong
                                                x-text="((recentBlocks.stats?.actions?.block || 0) + (recentBlocks.stats?.actions?.reject || 0)).toLocaleString()"></strong>
                                            Block/Reject</span>
                                        <span class="log-chip log-chip-green"><strong
                                                x-text="(recentBlocks.stats?.actions?.pass || 0).toLocaleString()"></strong>
                                            Pass</span>
                                        <span class="log-chip log-chip-pink"><strong
                                                x-text="(recentBlocks.stats?.threats || 0).toLocaleString()"></strong>
                                            Threat</span>
                                        <span class="log-chip log-chip-slate"><strong
                                                x-text="(recentBlocks.stats?.unique_src || 0).toLocaleString()"></strong>
                                            Src</span>
                                        <span class="log-chip log-chip-slate"><strong
                                                x-text="(recentBlocks.stats?.unique_dst || 0).toLocaleString()"></strong>
                                            Dst</span>
                                    </div>
                                    <div class="log-controls">
                                        <span class="log-count"
                                            x-text="'Showing ' + Math.min(recentBlocksView || filteredRecentBlocks.length, filteredRecentBlocks.length).toLocaleString() + ' / ' + (filteredRecentBlocks.length || 0).toLocaleString() + ' (of ' + (recentBlocks.blocks.length || 0).toLocaleString() + ' total)'"></span>
                                        <span class="log-update-time" x-show="recentBlocks.lastUpdate"
                                            :title="recentBlocks.lastUpdate"
                                            x-text="'Updated ' + timeAgo(new Date(recentBlocks.lastUpdate).getTime() / 1000)"></span>
                                        <div class="log-range">
                                            <button :class="{ 'active': recentBlocksView === 50 }"
                                                @click="setRecentBlocksView(50)">50</button>
                                            <button :class="{ 'active': recentBlocksView === 200 }"
                                                @click="setRecentBlocksView(200)">200</button>
                                            <button :class="{ 'active': recentBlocksView === 1000 }"
                                                @click="setRecentBlocksView(1000)">1000</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Enhanced Filters -->
                                <div class="log-filters"
                                    style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(255, 255, 255, 0.02); border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.05);">
                                    <select x-model="recentBlocksFilter.action" class="filter-select"
                                        style="min-width: 120px;" aria-label="Filter by action">
                                        <option value="all">All Actions</option>
                                        <option value="block">Block</option>
                                        <option value="reject">Reject</option>
                                        <option value="pass">Pass</option>
                                    </select>
                                    <input type="text" x-model="recentBlocksFilter.searchIP"
                                        placeholder="Search IP address..." class="search-box"
                                        style="flex: 1; min-width: 200px; max-width: 300px;"
                                        aria-label="Search by IP address">
                                    <input type="text" x-model="recentBlocksFilter.port" placeholder="Filter by port..."
                                        class="search-box" style="min-width: 120px; max-width: 150px;"
                                        aria-label="Filter by port">
                                    <select x-model="recentBlocksFilter.protocol" class="filter-select"
                                        style="min-width: 120px;" aria-label="Filter by protocol">
                                        <option value="all">All Protocols</option>
                                        <option value="TCP">TCP</option>
                                        <option value="UDP">UDP</option>
                                        <option value="ICMP">ICMP</option>
                                    </select>
                                    <label
                                        style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" x-model="recentBlocksFilter.threatOnly"
                                            style="cursor: pointer;">
                                        <span style="color: var(--text-secondary); font-size: var(--text-sm);">Threats
                                            Only</span>
                                    </label>
                                    <button
                                        @click="recentBlocksFilter = { action: 'all', searchIP: '', port: '', protocol: 'all', threatOnly: false }"
                                        class="btn btn--secondary" style="white-space: nowrap;"
                                        :disabled="recentBlocksFilter.action === 'all' && !recentBlocksFilter.searchIP && !recentBlocksFilter.port && recentBlocksFilter.protocol === 'all' && !recentBlocksFilter.threatOnly">
                                        Clear Filters
                                    </button>
                                </div>

                                <div class="log-table-wrapper">
                                    <table class="table-fixed table-compact thead-sticky"
                                        x-show="recentBlocks.blocks.length > 0">
                                        <thead>
                                            <tr>
                                                <th class="w-16">Time</th>
                                                <th class="w-13">Dir / IF</th>
                                                <th class="w-22">Source</th>
                                                <th class="w-4"></th>
                                                <th style="width: 25%;">Destination</th>
                                                <th style="width: 10%;">Protocol</th>
                                                <th style="width: 10%;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template
                                                x-for="block in filteredRecentBlocks.slice(0, recentBlocksView || filteredRecentBlocks.length)"
                                                :key="block.id || (block.src_ip + block.timestamp + block.dst_port)">
                                                <tr @click="openEventDetails(block, 'firewall')"
                                                    :class="{ 'log-row-threat': block.is_threat, 'log-row-pass': block.action === 'pass' }"
                                                    style="cursor: pointer;">
                                                    <td style="font-size: 0.85em; color: var(--text-muted);">
                                                        <div style="font-family: monospace;"
                                                            x-text="(block.timestamp || '').replace('T', ' ').split('.')[0] || block.timestamp">
                                                        </div>
                                                        <div class="log-sub" x-text="timeAgo(block.timestamp_ts)">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="log-direction"
                                                            :class="block.direction === 'in' ? 'text-green' : 'text-cyan'">
                                                            <span
                                                                x-text="(block.direction || 'in').toUpperCase()"></span>
                                                            <span class="log-sub" x-text="block.interface || '-'"
                                                                style="display:block;"></span>
                                                        </div>
                                                    </td>
                                                    <td @click.stop="openEventDetails(block, 'firewall')"
                                                        style="cursor: pointer;" title="Click to view event details">
                                                        <div class="truncate"><strong class="text-green"
                                                                x-text="block.src_ip || '--'"></strong>
                                                        </div>
                                                        <div class="log-sub"
                                                            x-text="block.src_port ? 'Port ' + block.src_port : ''">
                                                        </div>
                                                    </td>
                                                    <td style="text-align: center; color: var(--text-muted);">
                                                        ‚Üí
                                                    </td>
                                                    <td @click.stop="openEventDetails(block, 'firewall')"
                                                        style="cursor: pointer;" title="Click to view event details">
                                                        <div class="truncate">
                                                            <span class="text-cyan"
                                                                x-text="block.dst_ip || '192.168.0.1'"></span>
                                                            <span class="port-badge" style="margin-left: 4px;"
                                                                x-show="block.dst_port"
                                                                x-text="':' + block.dst_port"></span>
                                                        </div>
                                                        <div class="log-sub"
                                                            x-text="block.service || 'Unknown service'">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                            style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                                            x-text="(block.proto || 'TCP').toUpperCase()"></span>
                                                        <div class="log-sub" x-show="block.direction"
                                                            x-text="block.direction === 'in' ? 'Inbound' : 'Outbound'">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                            :style="(block.action === 'pass') ? 'background: rgba(0,255,100,0.2); color: var(--neon-green);' : 'background: rgba(255,0,60,0.2); color: var(--neon-red);'"
                                                            x-text="(block.action || 'block').toUpperCase()"></span>
                                                        <div class="log-sub" x-show="block.is_threat"
                                                            style="color: var(--neon-red);">Threat</div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endcall %}
                        </section>
                        <!-- ========================================
     FIREWALL INVESTIGATION TOOLS
     ======================================== -->

                        <!-- Alert Correlation & Attack Chains -->
                        <section id="section-alert-correlation" class="scroll-section" style="margin-bottom: 32px;">
                            {% call widget_card('alertCorrelation', 'Alert Correlation & Attack Chains', 'üîó',
                            card_class='wide-card', show_spinner=True) %}
                            <!-- Explanation Panel (Collapsible) -->
                            <div class="card"
                                style="margin-bottom: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0, 243, 255, 0.06); border: 1px solid rgba(0, 243, 255, 0.15); border-radius: var(--radius-sm);">
                                <button @click="alertCorrelation.showExplanation = !alertCorrelation.showExplanation"
                                    style="display: flex; align-items: center; gap: var(--space-2); width: 100%; background: none; border: none; color: var(--neon-cyan); cursor: pointer; padding: 0; font-size: var(--text-sm);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        :style="'transform: rotate(' + (alertCorrelation.showExplanation ? '90' : '0') + 'deg); transition: transform 0.2s;'">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                    <span style="font-weight: var(--font-weight-semibold);">‚ÑπÔ∏è How Alert
                                        Correlation
                                        Works</span>
                                </button>
                                <div x-show="alertCorrelation.showExplanation"
                                    style="margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.5;">
                                    <p style="margin: 0 0 var(--space-2) 0;">Analyzes security alerts to
                                        identify
                                        <strong>multi-stage attack chains</strong> by correlating related
                                        alerts
                                        from the same IP address within a 1-hour time window.
                                    </p>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-2); font-size: var(--text-xs);">
                                        <div><strong>üîç Detection:</strong> Groups
                                            by IP and time proximity</div>
                                        <div><strong>‚ö° Chains:</strong> Sequences
                                            of related security events</div>
                                        <div><strong>üéØ Use:</strong> Identify
                                            attack progression patterns</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats Summary -->
                            <div
                                style="display: flex; gap: var(--space-2); margin-bottom: var(--space-3); flex-wrap: wrap;">
                                <div class="card"
                                    style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Attack Chains</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                        x-text="alertCorrelation.chains?.length || 0"></div>
                                </div>
                                <div class="card"
                                    style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Total Alerts Correlated</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-cyan);"
                                        x-text="(alertCorrelation.chains || []).reduce((sum, chain) => sum + (chain.alerts?.length || 0), 0)">
                                    </div>
                                </div>
                            </div>

                            <!-- Attack Chains List -->
                            <div x-show="alertCorrelation.chains && alertCorrelation.chains.length > 0">
                                <template x-for="(chain, idx) in alertCorrelation.chains" :key="idx">
                                    <div class="card"
                                        style="margin-bottom: var(--space-4); border-left: 4px solid var(--neon-red); background: rgba(255,0,60,0.05); transition: background var(--motion-base);">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3); flex-wrap: wrap; gap: var(--space-2);">
                                            <div style="flex: 1;">
                                                <div
                                                    style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                                    <strong class="text-red" style="font-size: var(--text-lg);">Attack
                                                        Chain
                                                        #<span x-text="idx + 1"></span></strong>
                                                    <span class="badge"
                                                        style="background: rgba(255,0,60,0.2); color: var(--neon-red); font-size: var(--text-sm);"
                                                        x-text="chain.alerts.length + ' alerts'"></span>
                                                </div>
                                                <div style="margin-bottom: var(--space-2);">
                                                    <span
                                                        style="color: var(--text-secondary); font-size: var(--text-sm);">Source
                                                        IP: </span>
                                                    <span class="text-cyan"
                                                        style="font-family: var(--font-mono); font-weight: var(--font-weight-semibold); cursor: pointer;"
                                                        @click="openIPInvestigationModal(chain.ip)" x-text="chain.ip"
                                                        title="Click to investigate this IP"></span>
                                                </div>
                                                <div style="color: var(--text-muted); font-size: var(--text-sm);">
                                                    <span x-text="chain.timespan"></span>
                                                </div>
                                            </div>
                                            <button @click="openIPInvestigationModal(chain.ip)"
                                                class="btn btn--secondary"
                                                style="white-space: nowrap; font-size: var(--text-sm);">
                                                üîç Investigate IP
                                            </button>
                                        </div>
                                        <div>
                                            <div
                                                style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--text-primary); font-size: var(--text-sm);">
                                                Attack Progression Timeline:</div>
                                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                                <template x-for="(alert, alertIdx) in chain.alerts" :key="alert.id">
                                                    <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border-left: 3px solid var(--neon-red); transition: background var(--motion-base);"
                                                        :style="alertIdx === 0 ? 'border-left-color: var(--neon-green);' : (alertIdx === chain.alerts.length - 1 ? 'border-left-color: var(--neon-red);' : 'border-left-color: var(--neon-yellow);')">
                                                        <div style="flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: rgba(255,0,60,0.2); display: flex; align-items: center; justify-content: center; font-size: var(--text-xs); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                                            x-text="alertIdx + 1"></div>
                                                        <div style="flex: 1; min-width: 0;">
                                                            <div
                                                                style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; margin-bottom: var(--space-1);">
                                                                <span class="badge"
                                                                    :class="'cat-' + (alert.type || '').toLowerCase().replace(/[^a-z0-9]/g, '-')"
                                                                    style="font-size: var(--text-xs);"
                                                                    x-text="alert.type || 'Unknown'"></span>
                                                                <span
                                                                    style="color: var(--text-muted); font-size: var(--text-xs); font-family: var(--font-mono);"
                                                                    x-text="alert.time"></span>
                                                            </div>
                                                            <div style="color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.4;"
                                                                x-text="alert.message || 'Security alert detected'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!alertCorrelation.chains || alertCorrelation.chains.length === 0"
                                class="empty-state" style="text-align: center;">
                                <p
                                    style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                    No Correlated Attack Chains Detected</p>
                                <p
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); max-width: 400px; margin: 0 auto;">
                                    No multi-stage attack patterns identified. Network appears secure or attacks are
                                    isolated events.
                                </p>
                            </div>
                            {% endcall %}
                        </section>


                        <!-- Active Flows Widget -->
                        <section id="section-flows" class="scroll-section" style="margin-bottom: 32px;">
                            {% set conv_actions %}
                            <div class="flex gap-2" style="align-items: center;">
                                <div class="status-pills">
                                    <span class="status-pill running">Live</span>
                                </div>
                                <button @click="setFlowsViewLimit(15)"
                                    :class="{ 'btn--primary': flows.viewLimit === 15, 'btn--secondary': flows.viewLimit !== 15 }"
                                    class="btn"
                                    style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                    Top 15
                                </button>
                                <button @click="setFlowsViewLimit(50)"
                                    :class="{ 'btn--primary': flows.viewLimit === 50, 'btn--secondary': flows.viewLimit !== 50 }"
                                    class="btn"
                                    style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                    Top 50
                                </button>
                                <button @click="setFlowsViewLimit(999999)"
                                    :class="{ 'btn--primary': flows.viewLimit >= 999999, 'btn--secondary': flows.viewLimit < 999999 }"
                                    class="btn"
                                    style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);"
                                    title="Show all flows (may be slow)">
                                    All
                                </button>
                            </div>
                            {% endset %}
                            {% call widget_card('flows', 'Active Flows', '‚ö°', card_class='wide-card',
                            extra_actions=conv_actions, footer_content=conv_footer, show_spinner=True) %}
                            <!-- List View -->
                            <table class="table-fixed table-compact">
                                <thead>
                                    <tr>
                                        <th style="width: 15%; cursor: pointer;" @click="sortFlows('age')">
                                            Age <span x-show="flows.sortKey==='age'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 28%; cursor: pointer;" @click="sortFlows('src')">
                                            Source <span x-show="flows.sortKey==='src'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 6%;" title="Flow Direction">Dir</th>
                                        <th style="width: 28%; cursor: pointer;" @click="sortFlows('dst')">
                                            Destination <span x-show="flows.sortKey==='dst'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 8%; cursor: pointer;" @click="sortFlows('proto_name')">
                                            Proto <span x-show="flows.sortKey==='proto_name'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 10%; cursor: pointer;" @click="sortFlows('bytes')">
                                            Stats <span x-show="flows.sortKey==='bytes'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(flow, idx) in flows.flows.slice(0, flows.viewLimit || 15)"
                                        :key="idx">
                                        <tr class="flow-item" @click="openFlowDetails(flow)" style="cursor: pointer;"
                                            :class="{ 
                                                'flow-item-heavy': flow.bytes > 1000000,
                                                'flow-item-long-duration': flow.duration_seconds > 300 && flow.bytes < 100000,
                                                'flow-item-burst': flow.duration_seconds < 10 && flow.bytes > 500000,
                                                'flow-item-detected': flow.is_detected
                                            }">
                                            <td class="text-xs text-muted font-mono" style="position: relative;">
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span
                                                        x-text="flow.age_seconds !== undefined ? formatAge(flow.age_seconds) : (flow.first_seen_ts ? timeAgo(flow.first_seen_ts) : timeAgo(flow.ts))"></span>
                                                    <!-- Detection indicator (Phase 2) -->
                                                    <template x-if="flow.is_detected">
                                                        <span
                                                            :title="flow.detection_reason || 'Detected: Long-lived low-volume external flow'"
                                                            style="font-size: 0.85em; opacity: 0.9; color: var(--neon-yellow); cursor: help; line-height: 1; display: inline-block; font-weight: bold;"
                                                            x-text="'‚ö†Ô∏è'"></span>
                                                    </template>
                                                    <!-- Threat correlation indicator (Phase 1) -->
                                                    <template x-if="flow.has_threat">
                                                        <span
                                                            :title="'Threat correlation: ' + (flow.threat_count || 0) + ' threat IP(s) in this flow'"
                                                            style="font-size: 0.85em; opacity: 0.8; color: var(--neon-red); cursor: help; line-height: 1; display: inline-block;"
                                                            x-text="'üõ°Ô∏è'"></span>
                                                    </template>
                                                    <!-- Interesting flow indicators (max 2) -->
                                                    <template
                                                        x-if="flow.interesting_flags && flow.interesting_flags.length > 0">
                                                        <div style="display: flex; gap: 3px; margin-left: 4px;">
                                                            <template
                                                                x-for="(flag, idx) in flow.interesting_flags.slice(0, 2)"
                                                                :key="idx">
                                                                <span :title="getInterestingFlowTooltip(flag)"
                                                                    class="flow-interest-icon"
                                                                    x-text="getInterestingFlowIcon(flag)"></span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </td>
                                            <td @click.stop="openIPModal(flow.src)" class="flow-cell-ip">
                                                <!-- Line 1: IP address (primary) + optional hostname inline -->
                                                <div class="flow-line-1">
                                                    <span
                                                        :class="'flag-icon flag-icon-' + (flow.src_country_code || 'unknown').toLowerCase()"
                                                        class="flow-flag"></span>
                                                    <strong class="text-cyan flow-ip" x-text="flow.src"></strong>
                                                    <span x-show="flow.src_hostname" class="flow-hostname"
                                                        :title="flow.src_hostname"
                                                        x-text="' ' + flow.src_hostname"></span>
                                                </div>
                                                <!-- Line 2: Port / protocol (secondary, muted) - always present -->
                                                <div class="flow-line-2">
                                                    <span class="text-muted flow-port">
                                                        <span x-text="flow.src_port"></span>
                                                        <span x-show="flow.proto_name"
                                                            x-text="'/' + flow.proto_name"></span>
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="flow-cell-dir" :title="getDirectionIndicator(flow).title"
                                                :style="'color: ' + getDirectionIndicator(flow).color + ';'">
                                                <span class="flow-dir-icon"
                                                    x-text="getDirectionIndicator(flow).symbol"></span>
                                            </td>
                                            <td @click.stop="openIPModal(flow.dst)" class="flow-cell-ip">
                                                <!-- Line 1: IP address (primary) + optional hostname inline -->
                                                <div class="flow-line-1">
                                                    <span
                                                        :class="'flag-icon flag-icon-' + (flow.dst_country_code || 'unknown').toLowerCase()"
                                                        class="flow-flag"></span>
                                                    <strong class="text-cyan flow-ip" x-text="flow.dst"></strong>
                                                    <span x-show="flow.dst_hostname" class="flow-hostname"
                                                        :title="flow.dst_hostname"
                                                        x-text="' ' + flow.dst_hostname"></span>
                                                </div>
                                                <!-- Line 2: Port / protocol (secondary, muted) - always present -->
                                                <div class="flow-line-2">
                                                    <span class="text-muted flow-port">
                                                        <span x-text="flow.dst_port"></span>
                                                        <span
                                                            x-show="flow.service && flow.service !== flow.dst_port && flow.service !== 'unknown'"
                                                            x-text="' (' + flow.service + ')'"></span>
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="flow-cell-proto">
                                                <span class="text-muted flow-proto" x-text="flow.proto_name"></span>
                                            </td>
                                            <td style="padding: 6px 8px;">
                                                <div style="font-size:0.85em; white-space: nowrap;">
                                                    <strong class="text-green" x-text="flow.bytes_fmt"></strong>
                                                    <span
                                                        style="color:var(--text-muted); margin-left:4px; font-size: 0.8em;"
                                                        x-text="flow.duration"></span>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <div x-show="flows.flows.length > (flows.viewLimit || 15)"
                                style="margin-top: var(--space-2); padding: var(--space-2); background: rgba(255, 200, 0, 0.1); border: 1px solid rgba(255, 200, 0, 0.3); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: var(--text-sm);">
                                Showing <strong x-text="flows.viewLimit || 15"></strong> of <strong
                                    x-text="flows.flows.length"></strong> flows. Use controls above to show more.
                            </div>
                            {% endcall %}
                        </section>
                    </div>

                    <!-- ============================================
             SERVER TAB - Server Health & Statistics
             ============================================ -->
                    <div x-show="activeTab === 'server'"
                        :style="activeTab === 'server' ? 'display:block' : 'display:none'" id="server-tab"
                        role="tabpanel" aria-labelledby="server-tab-btn" tabindex="0">
                        <section id="section-server" class="scroll-section" style="margin-bottom: 32px;">
                            <!-- Loading State -->
                            <template x-if="serverHealth.loading">
                                <div class="empty-state">
                                    <span>Loading server health data...</span>
                                </div>
                            </template>

                            <!-- Error State -->
                            <template x-if="serverHealth.error && !serverHealth.loading">
                                <div class="empty-state" style="color: var(--neon-red);">
                                    <span x-text="serverHealth.error"></span>
                                </div>
                            </template>

                            <!-- Server Health Content - Reorganized into 4 Primary Widgets -->
                            <template x-if="!serverHealth.loading && !serverHealth.error">
                                <div class="grid"
                                    style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">

                                    <!-- 1. System Health (Composite) -->
                                    <div x-data="{ expanded: false }"
                                        x-show="serverHealth.cpu || serverHealth.memory || serverHealth.disk">
                                        {% set health_badge %}
                                        <span class="server-stat-badge" :class="{
                                            'badge-success': (serverHealth.cpu?.percent || 0) < 70 && (serverHealth.memory?.percent || 0) < 80 && (serverHealth.disk?.root?.percent_used || 0) < 80,
                                            'badge-warning': (serverHealth.cpu?.percent || 0) >= 70 || (serverHealth.memory?.percent || 0) >= 80 || (serverHealth.disk?.root?.percent_used || 0) >= 80,
                                            'badge-error': (serverHealth.cpu?.percent || 0) >= 90 || (serverHealth.memory?.percent || 0) >= 90 || (serverHealth.disk?.root?.percent_used || 0) >= 90
                                        }">HEALTHY</span>
                                        {% endset %}
                                        <div class="card">
                                            <h2>
                                                <div class="card-title-content">
                                                    <span class="title-icon">üíö</span>
                                                    <span>System Health</span>
                                                </div>
                                                <div class="card-actions">
                                                    {{ health_badge | safe }}
                                                </div>
                                            </h2>
                                            <div class="widget-body" style="min-height: 300px;">
                                                <div x-show="!serverHealth.loading">
                                                    <div class="server-stat-value" style="font-size: 1.1em;">
                                                        <span
                                                            x-show="serverHealth.cpu && serverHealth.cpu.percent !== undefined">
                                                            CPU: <span :class="{
                                                    'text-green': serverHealth.cpu.percent < 70,
                                                    'text-yellow': serverHealth.cpu.percent >= 70 && serverHealth.cpu.percent < 90,
                                                    'text-red': serverHealth.cpu.percent >= 90
                                                }" x-text="serverHealth.cpu.percent + '%'"></span>
                                                        </span>
                                                        <span
                                                            x-show="serverHealth.memory && serverHealth.memory.percent !== undefined"
                                                            style="margin-left: 12px;">
                                                            MEM: <span :class="{
                                                    'text-green': serverHealth.memory.percent < 80,
                                                    'text-yellow': serverHealth.memory.percent >= 80 && serverHealth.memory.percent < 90,
                                                    'text-red': serverHealth.memory.percent >= 90
                                                }" x-text="serverHealth.memory.percent + '%'"></span>
                                                        </span>
                                                        <span
                                                            x-show="serverHealth.disk && serverHealth.disk.root && serverHealth.disk.root.percent_used !== undefined"
                                                            style="margin-left: 12px;">
                                                            DISK: <span :class="{
                                                    'text-green': serverHealth.disk.root.percent_used < 80,
                                                    'text-yellow': serverHealth.disk.root.percent_used >= 80 && serverHealth.disk.root.percent_used < 90,
                                                    'text-red': serverHealth.disk.root.percent_used >= 90
                                                }" x-text="serverHealth.disk.root.percent_used + '%'"></span>
                                                        </span>
                                                    </div>
                                                    <button @click="expanded = !expanded"
                                                        style="margin-top: 12px; padding: 6px 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.85em;">
                                                        <span
                                                            x-text="expanded ? '‚ñº Hide Details' : '‚ñ∂ Show Details'"></span>
                                                    </button>
                                                    <div x-show="expanded" x-collapse
                                                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                                        <div class="server-stat-details">
                                                            <div
                                                                x-show="serverHealth.system && serverHealth.system.hostname">
                                                                <span>Hostname:</span>
                                                                <span x-text="serverHealth.system.hostname"></span>
                                                            </div>
                                                            <div
                                                                x-show="serverHealth.system && serverHealth.system.uptime_formatted">
                                                                <span>Uptime:</span>
                                                                <span
                                                                    x-text="serverHealth.system.uptime_formatted"></span>
                                                            </div>
                                                            <div x-show="serverHealth.timestamp">
                                                                <span>Last Update:</span>
                                                                <span
                                                                    x-text="serverHealth.timestamp ? new Date(serverHealth.timestamp).toLocaleString() : 'N/A'"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 2. CPU & Memory -->
                                    <div x-data="{ expanded: false }"
                                        x-show="(serverHealth.cpu && !serverHealth.cpu.error) || (serverHealth.memory && !serverHealth.memory.error)">
                                        {% set cpu_mem_badge %}
                                        <span class="server-stat-badge" :class="{
                                            'badge-success': (serverHealth.cpu?.percent || 0) < 70 && (serverHealth.memory?.percent || 0) < 80,
                                            'badge-warning': (serverHealth.cpu?.percent || 0) >= 70 || (serverHealth.memory?.percent || 0) >= 80,
                                            'badge-error': (serverHealth.cpu?.percent || 0) >= 90 || (serverHealth.memory?.percent || 0) >= 90
                                        }">OK</span>
                                        {% endset %}
                                        <div class="card">
                                            <h2>
                                                <div class="card-title-content">
                                                    <span class="title-icon">‚ö°üíæ</span>
                                                    <span>CPU & Memory</span>
                                                </div>
                                                <div class="card-actions">
                                                    {{ cpu_mem_badge | safe }}
                                                </div>
                                            </h2>
                                            <div class="widget-body" style="min-height: 300px;">
                                                <div x-show="!serverHealth.loading">
                                                    <div
                                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                        <!-- CPU Summary -->
                                                        <div x-show="serverHealth.cpu && !serverHealth.cpu.error">
                                                            <div
                                                                style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">
                                                                CPU</div>
                                                            <div class="server-stat-value"
                                                                x-text="serverHealth.cpu.percent ? serverHealth.cpu.percent + '%' : 'N/A'">
                                                            </div>
                                                            <div class="server-stat-progress"
                                                                x-show="serverHealth.cpu.percent !== undefined">
                                                                <div class="server-stat-progress-bar" :class="{
                                                        'warning': serverHealth.cpu.percent >= 70 && serverHealth.cpu.percent < 90,
                                                        'error': serverHealth.cpu.percent >= 90
                                                    }" :style="'width: ' + (serverHealth.cpu.percent || 0) + '%'">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- Memory Summary -->
                                                        <div x-show="serverHealth.memory && !serverHealth.memory.error">
                                                            <div
                                                                style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">
                                                                Memory</div>
                                                            <div class="server-stat-value"
                                                                x-text="serverHealth.memory.percent ? serverHealth.memory.percent + '%' : 'N/A'">
                                                            </div>
                                                            <div class="server-stat-progress"
                                                                x-show="serverHealth.memory.percent !== undefined">
                                                                <div class="server-stat-progress-bar" :class="{
                                                        'warning': serverHealth.memory.percent >= 80 && serverHealth.memory.percent < 90,
                                                        'error': serverHealth.memory.percent >= 90
                                                    }" :style="'width: ' + (serverHealth.memory.percent || 0) + '%'">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button @click="expanded = !expanded"
                                                        style="margin-top: 12px; padding: 6px 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.85em;">
                                                        <span
                                                            x-text="expanded ? '‚ñº Hide Details' : '‚ñ∂ Show Details'"></span>
                                                    </button>
                                                    <div x-show="expanded" x-collapse
                                                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                                        <!-- CPU Details -->
                                                        <div class="server-stat-details"
                                                            x-show="serverHealth.cpu && serverHealth.cpu.load_1min">
                                                            <div
                                                                style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                                                CPU Details</div>
                                                            <div>
                                                                <span>Load 1m:</span>
                                                                <span x-text="serverHealth.cpu.load_1min"></span>
                                                            </div>
                                                            <div>
                                                                <span>Load 5m:</span>
                                                                <span x-text="serverHealth.cpu.load_5min"></span>
                                                            </div>
                                                            <div>
                                                                <span>Load 15m:</span>
                                                                <span x-text="serverHealth.cpu.load_15min"></span>
                                                            </div>
                                                            <div x-show="serverHealth.cpu.frequency_mhz">
                                                                <span>Frequency:</span>
                                                                <span
                                                                    x-text="serverHealth.cpu.frequency_mhz + ' MHz'"></span>
                                                            </div>
                                                            <div x-show="serverHealth.cpu?.process_count">
                                                                <span>Processes:</span>
                                                                <span
                                                                    x-text="serverHealth.cpu?.process_count?.toLocaleString()"></span>
                                                            </div>
                                                        </div>
                                                        <!-- Memory Details -->
                                                        <div class="server-stat-details"
                                                            x-show="serverHealth.memory && serverHealth.memory.total_gb">
                                                            <div
                                                                style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                                                Memory Details</div>
                                                            <div>
                                                                <span>Used:</span>
                                                                <span
                                                                    x-text="serverHealth.memory.used_gb ? serverHealth.memory.used_gb + ' GB' : 'N/A'"></span>
                                                            </div>
                                                            <div>
                                                                <span>Available:</span>
                                                                <span
                                                                    x-text="serverHealth.memory.available_gb ? serverHealth.memory.available_gb + ' GB' : 'N/A'"></span>
                                                            </div>
                                                            <div>
                                                                <span>Total:</span>
                                                                <span
                                                                    x-text="serverHealth.memory.total_gb ? serverHealth.memory.total_gb + ' GB' : 'N/A'"></span>
                                                            </div>
                                                            <div x-show="serverHealth.memory.buffers_gb">
                                                                <span>Buffers:</span>
                                                                <span
                                                                    x-text="serverHealth.memory.buffers_gb + ' GB'"></span>
                                                            </div>
                                                            <div x-show="serverHealth.memory.cached_gb">
                                                                <span>Cached:</span>
                                                                <span
                                                                    x-text="serverHealth.memory.cached_gb + ' GB'"></span>
                                                            </div>
                                                            <div x-show="serverHealth.memory.process_mb">
                                                                <span>Process:</span>
                                                                <span
                                                                    x-text="serverHealth.memory.process_mb + ' MB'"></span>
                                                            </div>
                                                            <div x-show="serverHealth.memory.pressure">
                                                                <span>Pressure:</span>
                                                                <span :class="{
                                                        'text-green': serverHealth.memory.pressure === 'low',
                                                        'text-yellow': serverHealth.memory.pressure === 'medium',
                                                        'text-red': serverHealth.memory.pressure === 'high'
                                                    }" x-text="serverHealth.memory.pressure ? serverHealth.memory.pressure.toUpperCase() : 'N/A'"></span>
                                                            </div>
                                                            <div
                                                                x-show="serverHealth.memory.swap_total_gb && serverHealth.memory.swap_total_gb > 0 && serverHealth.memory.swap_percent !== undefined">
                                                                <span>Swap:</span>
                                                                <span
                                                                    x-text="serverHealth.memory.swap_percent + '%'"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 3. Network & NetFlow -->
                                    <div x-data="{ 
                                        expanded: false,
                                        getPrimaryInterface() {
                                            if (!serverHealth.network || !serverHealth.network.interfaces) return null;
                                            const ifaces = serverHealth.network.interfaces;
                                            // Prefer eth0, then eth1, then first non-loopback interface
                                            let ifaceName = null;
                                            let ifaceData = null;
                                            if (ifaces['eth0']) {
                                                ifaceName = 'eth0';
                                                ifaceData = ifaces['eth0'];
                                            } else if (ifaces['eth1']) {
                                                ifaceName = 'eth1';
                                                ifaceData = ifaces['eth1'];
                                            } else {
                                                const name = Object.keys(ifaces).find(n => n !== 'lo' && !n.startsWith('lo:'));
                                                if (name) {
                                                    ifaceName = name;
                                                    ifaceData = ifaces[name];
                                                }
                                            }
                                            if (!ifaceName || !ifaceData) return null;
                                            return { name: ifaceName, data: ifaceData };
                                        }
                                    }"
                                        x-show="(serverHealth.network && serverHealth.network.interfaces && Object.keys(serverHealth.network.interfaces).length > 0) || (serverHealth.netflow && !serverHealth.netflow.error)">
                                        {% set network_badge %}
                                        <span class="server-stat-badge" :class="{
                                            'badge-success': serverHealth.netflow?.available,
                                            'badge-error': serverHealth.netflow && !serverHealth.netflow.available
                                        }" x-text="serverHealth.netflow?.available ? 'ONLINE' : 'ACTIVE'"></span>
                                        {% endset %}
                                        <div class="card">
                                            <h2>
                                                <div class="card-title-content">
                                                    <span class="title-icon">üåê</span>
                                                    <span>Network & NetFlow</span>
                                                </div>
                                                <div class="card-actions">
                                                    {{ network_badge | safe }}
                                                </div>
                                            </h2>
                                            <div class="widget-body" style="min-height: 300px;">
                                                <div x-show="!serverHealth.loading">
                                                    <div
                                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                        <!-- Network Summary -->
                                                        <template x-if="getPrimaryInterface()">
                                                            <div>
                                                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;"
                                                                    x-text="'Interface (' + getPrimaryInterface().name + ')'">
                                                                </div>
                                                                <div class="server-stat-value"
                                                                    style="font-size: 0.9em;">
                                                                    <div>RX: <span
                                                                            x-text="getPrimaryInterface().data.rx_bytes ? fmtBytes(getPrimaryInterface().data.rx_bytes) : 'N/A'"></span>
                                                                    </div>
                                                                    <div style="margin-top: 4px;">TX: <span
                                                                            x-text="getPrimaryInterface().data.tx_bytes ? fmtBytes(getPrimaryInterface().data.tx_bytes) : 'N/A'"></span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        <!-- NetFlow Summary -->
                                                        <div
                                                            x-show="serverHealth.netflow && !serverHealth.netflow.error">
                                                            <div
                                                                style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">
                                                                NetFlow</div>
                                                            <div class="server-stat-value"
                                                                x-text="serverHealth.netflow.files_count !== undefined ? serverHealth.netflow.files_count.toLocaleString() + ' files' : 'N/A'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button @click="expanded = !expanded"
                                                        style="margin-top: 12px; padding: 6px 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.85em;">
                                                        <span
                                                            x-text="expanded ? '‚ñº Hide Details' : '‚ñ∂ Show Details'"></span>
                                                    </button>
                                                    <div x-show="expanded" x-collapse
                                                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                                        <!-- Network Details -->
                                                        <template x-if="getPrimaryInterface()">
                                                            <div class="server-stat-details">
                                                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);"
                                                                    x-text="'Network Interface Details (' + getPrimaryInterface().name + ')'">
                                                                </div>
                                                                <div>
                                                                    <span>RX:</span>
                                                                    <span
                                                                        x-text="getPrimaryInterface().data.rx_bytes ? fmtBytes(getPrimaryInterface().data.rx_bytes) : 'N/A'"></span>
                                                                </div>
                                                                <div>
                                                                    <span>TX:</span>
                                                                    <span
                                                                        x-text="getPrimaryInterface().data.tx_bytes ? fmtBytes(getPrimaryInterface().data.tx_bytes) : 'N/A'"></span>
                                                                </div>
                                                                <div>
                                                                    <span>RX Packets:</span>
                                                                    <span
                                                                        x-text="getPrimaryInterface().data.rx_packets ? getPrimaryInterface().data.rx_packets.toLocaleString() : '0'"></span>
                                                                </div>
                                                                <div>
                                                                    <span>TX Packets:</span>
                                                                    <span
                                                                        x-text="getPrimaryInterface().data.tx_packets ? getPrimaryInterface().data.tx_packets.toLocaleString() : '0'"></span>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        <!-- NetFlow Details -->
                                                        <div class="server-stat-details"
                                                            x-show="serverHealth.netflow && !serverHealth.netflow.error">
                                                            <div
                                                                style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                                                NetFlow Details</div>
                                                            <div x-show="serverHealth.netflow.version"
                                                                style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                                                                <span style="flex-shrink: 0;">Version:</span>
                                                                <span x-text="serverHealth.netflow.version"
                                                                    style="font-size: 0.85em; word-break: break-word; white-space: normal; text-align: right; flex: 1;"></span>
                                                            </div>
                                                            <div x-show="serverHealth.netflow.directory">
                                                                <span>Directory:</span>
                                                                <span x-text="serverHealth.netflow.directory"
                                                                    style="font-size: 0.85em;"></span>
                                                            </div>
                                                            <div
                                                                x-show="serverHealth.netflow.files_count !== undefined">
                                                                <span>Files:</span>
                                                                <span
                                                                    x-text="serverHealth.netflow.files_count.toLocaleString()"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 4. Storage & Database -->
                                    <div x-data="{ expanded: false }"
                                        x-show="(serverHealth.disk && serverHealth.disk.root && !serverHealth.disk.error) || databaseStats.databases?.length > 0">
                                        {% set storage_badge %}
                                        <span class="server-stat-badge" :class="{
                                            'badge-success': (serverHealth.disk?.root?.percent_used || 0) < 80,
                                            'badge-warning': (serverHealth.disk?.root?.percent_used || 0) >= 80 && (serverHealth.disk?.root?.percent_used || 0) < 90,
                                            'badge-error': (serverHealth.disk?.root?.percent_used || 0) >= 90
                                        }"
                                            x-text="serverHealth.disk?.root?.percent_used ? serverHealth.disk.root.percent_used + '%' : 'OK'"></span>
                                        {% endset %}
                                        <div class="card">
                                            <h2>
                                                <div class="card-title-content">
                                                    <span class="title-icon">üíøüóÑÔ∏è</span>
                                                    <span>Storage & Database</span>
                                                </div>
                                                <div class="card-actions">
                                                    {{ storage_badge | safe }}
                                                </div>
                                            </h2>
                                            <div class="widget-body" style="min-height: 300px;">
                                                <div x-show="!serverHealth.loading">
                                                    <div
                                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                        <!-- Disk Summary -->
                                                        <div
                                                            x-show="serverHealth.disk && serverHealth.disk.root && !serverHealth.disk.error">
                                                            <div
                                                                style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">
                                                                Disk (Root)</div>
                                                            <div class="server-stat-value"
                                                                x-text="serverHealth.disk.root.percent_used ? serverHealth.disk.root.percent_used + '%' : 'N/A'">
                                                            </div>
                                                            <div class="server-stat-progress"
                                                                x-show="serverHealth.disk.root.percent_used !== undefined">
                                                                <div class="server-stat-progress-bar" :class="{
                                                        'warning': serverHealth.disk.root.percent_used >= 80 && serverHealth.disk.root.percent_used < 90,
                                                        'error': serverHealth.disk.root.percent_used >= 90
                                                    }" :style="'width: ' + (serverHealth.disk.root.percent_used || 0) + '%'">
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- Database Summary -->
                                                        <div
                                                            x-show="databaseStats.databases && databaseStats.databases.length > 0">
                                                            <div
                                                                style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">
                                                                SQLite Databases</div>
                                                            <div class="server-stat-value"
                                                                x-text="databaseStats.databases.length + ' databases'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button @click="expanded = !expanded"
                                                        style="margin-top: 12px; padding: 6px 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.85em;">
                                                        <span
                                                            x-text="expanded ? '‚ñº Hide Details' : '‚ñ∂ Show Details'"></span>
                                                    </button>
                                                    <div x-show="expanded" x-collapse
                                                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                                        <!-- Disk Details -->
                                                        <div class="server-stat-details"
                                                            x-show="serverHealth.disk && serverHealth.disk.root && !serverHealth.disk.error">
                                                            <div
                                                                style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                                                Disk Details</div>
                                                            <div>
                                                                <span>Used:</span>
                                                                <span
                                                                    x-text="serverHealth.disk.root.used_gb ? serverHealth.disk.root.used_gb + ' GB' : 'N/A'"></span>
                                                            </div>
                                                            <div>
                                                                <span>Free:</span>
                                                                <span
                                                                    x-text="serverHealth.disk.root.free_gb ? serverHealth.disk.root.free_gb + ' GB' : 'N/A'"></span>
                                                            </div>
                                                            <div>
                                                                <span>Total:</span>
                                                                <span
                                                                    x-text="serverHealth.disk.root.total_gb ? serverHealth.disk.root.total_gb + ' GB' : 'N/A'"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- System Diagnostics (Collapsed by default) -->
                            <template x-if="!serverHealth.loading && !serverHealth.error">
                                <div x-data="{ expanded: false }" style="margin-top: 32px;">
                                    <button @click="expanded = !expanded"
                                        style="width: 100%; padding: 16px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 1.1em; font-weight: 600; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                                        <span>üîß System Diagnostics</span>
                                        <span x-text="expanded ? '‚ñº' : '‚ñ∂'" style="font-size: 0.9em;"></span>
                                    </button>
                                    <div x-show="expanded" x-collapse style="margin-top: 16px;">
                                        <div class="grid"
                                            style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                            <!-- Full Syslog Widget -->
                                            {% set syslog_badge %}
                                            <span class="server-stat-badge" :class="{
                                                'badge-success': serverHealth.syslog.active,
                                                'badge-error': !serverHealth.syslog.active
                                            }" x-text="serverHealth.syslog.active ? 'ACTIVE' : 'INACTIVE'"></span>
                                            {% endset %}
                                            <div x-show="serverHealth.syslog && !serverHealth.syslog.error">
                                                {% call widget_card('server_syslog', 'Syslog', 'üìù',
                                                extra_actions=syslog_badge) %}
                                                <div class="server-stat-value"
                                                    x-text="serverHealth.syslog.received ? serverHealth.syslog.received.toLocaleString() : '0'">
                                                </div>
                                                <div class="server-stat-details">
                                                    <div>
                                                        <span>Received:</span>
                                                        <span
                                                            x-text="serverHealth.syslog.received ? serverHealth.syslog.received.toLocaleString() : '0'"></span>
                                                    </div>
                                                    <div>
                                                        <span>Parsed:</span>
                                                        <span
                                                            x-text="serverHealth.syslog.parsed ? serverHealth.syslog.parsed.toLocaleString() : '0'"></span>
                                                    </div>
                                                    <div>
                                                        <span>Errors:</span>
                                                        <span
                                                            x-text="serverHealth.syslog.errors ? serverHealth.syslog.errors.toLocaleString() : '0'"
                                                            :class="serverHealth.syslog.errors > 0 ? 'text-red' : ''"></span>
                                                    </div>
                                                    <div x-show="serverHealth.syslog.last_log">
                                                        <span>Last Log:</span>
                                                        <span
                                                            x-text="serverHealth.syslog.last_log ? new Date(serverHealth.syslog.last_log * 1000).toLocaleTimeString() : 'Never'"></span>
                                                    </div>
                                                </div>
                                                {% endcall %}
                                            </div>

                                            <!-- Full Database Widget (old one) -->
                                            {% set db_badge %}
                                            <span class="server-stat-badge" :class="{
                                                'badge-success': serverHealth.database.connected,
                                                'badge-error': !serverHealth.database.connected
                                            }"
                                                x-text="serverHealth.database.connected ? 'CONNECTED' : 'DISCONNECTED'"></span>
                                            {% endset %}
                                            <div x-show="serverHealth.database">
                                                {% call widget_card('server_database', 'Database', 'üóÑÔ∏è',
                                                extra_actions=db_badge) %}
                                                <div class="server-stat-value"
                                                    x-text="serverHealth.database.log_count ? serverHealth.database.log_count.toLocaleString() : '0'">
                                                </div>
                                                <div class="server-stat-details">
                                                    <div>
                                                        <span>Logs:</span>
                                                        <span
                                                            x-text="serverHealth.database.log_count ? serverHealth.database.log_count.toLocaleString() : '0'"></span>
                                                    </div>
                                                    <div x-show="serverHealth.database.size_mb">
                                                        <span>Size:</span>
                                                        <span x-text="serverHealth.database.size_mb + ' MB'"></span>
                                                    </div>
                                                    <div
                                                        x-show="serverHealth.database?.growth_rate_per_hour !== undefined">
                                                        <span>Growth (1h):</span>
                                                        <span
                                                            x-text="(serverHealth.database?.growth_rate_per_hour || 0).toLocaleString() + ' logs'"></span>
                                                    </div>
                                                    <div
                                                        x-show="serverHealth.database?.growth_rate_per_day !== undefined">
                                                        <span>Growth (24h):</span>
                                                        <span
                                                            x-text="(serverHealth.database?.growth_rate_per_day || 0).toLocaleString() + ' logs'"></span>
                                                    </div>
                                                    <div x-show="serverHealth.database.path">
                                                        <span>Path:</span>
                                                        <span x-text="serverHealth.database.path"
                                                            style="font-size: 0.85em;"></span>
                                                    </div>
                                                </div>
                                                {% endcall %}
                                            </div>

                                            <!-- Full System Information -->
                                            {% set system_badge %}
                                            <span class="server-stat-badge badge-success">ONLINE</span>
                                            {% endset %}
                                            <div x-show="serverHealth.system && !serverHealth.system.error">
                                                {% call widget_card('server_system', 'System', 'üñ•Ô∏è',
                                                extra_actions=system_badge) %}
                                                <div class="server-stat-value"
                                                    x-text="serverHealth.system.hostname || 'N/A'"
                                                    style="font-size: 1.2em;"></div>
                                                <div class="server-stat-details">
                                                    <div x-show="serverHealth.system.uptime_formatted">
                                                        <span>Uptime:</span>
                                                        <span
                                                            x-text="serverHealth.system.uptime_formatted || 'N/A'"></span>
                                                    </div>
                                                    <div x-show="serverHealth.system.uptime_seconds">
                                                        <span>Total Uptime:</span>
                                                        <span
                                                            x-text="serverHealth.system.uptime_seconds ? Math.floor(serverHealth.system.uptime_seconds / 86400) + ' days' : 'N/A'"></span>
                                                    </div>
                                                    <div x-show="serverHealth.system.boot_time_formatted">
                                                        <span>Boot Time:</span>
                                                        <span x-text="serverHealth.system.boot_time_formatted"></span>
                                                    </div>
                                                    <div x-show="serverHealth.system.kernel_version">
                                                        <span>Kernel:</span>
                                                        <span x-text="serverHealth.system.kernel_version"
                                                            style="font-size: 0.85em;"></span>
                                                    </div>
                                                    <div x-show="serverHealth.system.os_info">
                                                        <span>OS:</span>
                                                        <span x-text="serverHealth.system.os_info"
                                                            style="font-size: 0.85em;"></span>
                                                    </div>
                                                    <div x-show="serverHealth.timestamp">
                                                        <span>Last Update:</span>
                                                        <span
                                                            x-text="serverHealth.timestamp ? new Date(serverHealth.timestamp).toLocaleString() : 'N/A'"></span>
                                                    </div>
                                                </div>
                                                {% endcall %}
                                            </div>

                                            <!-- Process Widget -->
                                            {% set process_badge %}
                                            <span class="server-stat-badge badge-success">ACTIVE</span>
                                            {% endset %}
                                            <div
                                                x-show="(serverHealth.system && serverHealth.system.process_threads !== undefined && !serverHealth.system.error) || serverHealth.process">
                                                {% call widget_card('server_process', 'Process', '‚öôÔ∏è',
                                                extra_actions=process_badge) %}
                                                <div class="server-stat-value"
                                                    x-text="serverHealth.process && serverHealth.process.process_memory_mb ? serverHealth.process.process_memory_mb + ' MB' : (serverHealth.system && serverHealth.system.process_threads ? serverHealth.system.process_threads.toLocaleString() + ' threads' : 'N/A')">
                                                </div>
                                                <div class="server-stat-details">
                                                    <div
                                                        x-show="serverHealth.process && serverHealth.process.process_memory_mb">
                                                        <span>Memory:</span>
                                                        <span
                                                            x-text="serverHealth.process.process_memory_mb + ' MB'"></span>
                                                    </div>
                                                    <div x-show="serverHealth.process && serverHealth.process.threads">
                                                        <span>Threads:</span>
                                                        <span
                                                            x-text="serverHealth.process.threads.toLocaleString()"></span>
                                                    </div>
                                                    <div
                                                        x-show="serverHealth.system && serverHealth.system.process_threads !== undefined">
                                                        <span>System Threads:</span>
                                                        <span
                                                            x-text="serverHealth.system.process_threads ? serverHealth.system.process_threads.toLocaleString() : '0'"></span>
                                                    </div>
                                                    <div
                                                        x-show="serverHealth.system && serverHealth.system.process_name">
                                                        <span>Process:</span>
                                                        <span x-text="serverHealth.system.process_name || 'N/A'"
                                                            style="font-size: 0.85em;"></span>
                                                    </div>
                                                </div>
                                                {% endcall %}
                                            </div>

                                            <!-- Cache Widget -->
                                            {% set cache_badge %}
                                            <span class="server-stat-badge badge-success">ACTIVE</span>
                                            {% endset %}
                                            <div x-show="serverHealth.cache">
                                                {% call widget_card('server_cache', 'Cache', 'üíæ',
                                                extra_actions=cache_badge) %}
                                                <div class="server-stat-value"
                                                    x-text="(serverHealth.cache.dns_cache_size || 0) + (serverHealth.cache.geo_cache_size || 0) + (serverHealth.cache.common_cache_size || 0) + ' entries'">
                                                </div>
                                                <div class="server-stat-details">
                                                    <div x-show="serverHealth.cache.dns_cache_size !== undefined">
                                                        <span>DNS Cache:</span>
                                                        <span
                                                            x-text="serverHealth.cache.dns_cache_size.toLocaleString() + ' entries'"></span>
                                                    </div>
                                                    <div x-show="serverHealth.cache.geo_cache_size !== undefined">
                                                        <span>GeoIP Cache:</span>
                                                        <span
                                                            x-text="serverHealth.cache.geo_cache_size.toLocaleString() + ' entries'"></span>
                                                    </div>
                                                    <div x-show="serverHealth.cache.common_cache_size !== undefined">
                                                        <span>Common Cache:</span>
                                                        <span
                                                            x-text="serverHealth.cache.common_cache_size.toLocaleString() + ' entries'"></span>
                                                    </div>
                                                    <div
                                                        x-show="serverHealth.cache.bandwidth_history_size !== undefined">
                                                        <span>Bandwidth History:</span>
                                                        <span
                                                            x-text="serverHealth.cache.bandwidth_history_size.toLocaleString() + ' entries'"></span>
                                                    </div>
                                                </div>
                                                {% endcall %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- System Activity (Compact inline metrics) -->
                            <div class="card" style="margin-top: 32px; width: 100%;"
                                x-show="!serverHealth.loading && !serverHealth.error && serverHealth">
                                <h2>
                                    <div class="card-title-content">
                                        <span class="title-icon">üìä</span>
                                        <span>System Activity</span>
                                    </div>
                                </h2>
                                <div class="widget-body" style="padding: 16px;">
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; font-size: 0.9em; min-height: 80px;">
                                        <!-- Syslog Activity -->
                                        <div x-show="serverHealth && serverHealth.syslog && !serverHealth.syslog.error"
                                            style="display: flex; flex-direction: column; gap: 8px;">
                                            <div
                                                style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                                <span>üìù</span>
                                                <span>Syslog</span>
                                                <span class="server-stat-badge" :class="{
                                                    'badge-success': serverHealth.syslog && serverHealth.syslog.active,
                                                    'badge-error': serverHealth.syslog && !serverHealth.syslog.active
                                                }" style="font-size: 0.75em; padding: 2px 6px; margin-left: auto;"
                                                    x-text="serverHealth.syslog && serverHealth.syslog.active ? 'ACTIVE' : 'INACTIVE'"></span>
                                            </div>
                                            <div
                                                style="display: flex; flex-direction: column; gap: 4px; color: var(--text-secondary);">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span>Received:</span>
                                                    <span style="color: var(--text-primary); font-weight: 500;"
                                                        x-text="serverHealth.syslog && serverHealth.syslog.received ? serverHealth.syslog.received.toLocaleString() : '0'"></span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span>Errors:</span>
                                                    <span
                                                        :class="serverHealth.syslog && serverHealth.syslog.errors > 0 ? 'text-red' : ''"
                                                        style="font-weight: 500;"
                                                        x-text="serverHealth.syslog && serverHealth.syslog.errors ? serverHealth.syslog.errors.toLocaleString() : '0'"></span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;"
                                                    x-show="serverHealth.syslog && serverHealth.syslog.last_log">
                                                    <span>Last Event:</span>
                                                    <span style="color: var(--text-primary); font-size: 0.85em;"
                                                        x-text="serverHealth.syslog && serverHealth.syslog.last_log ? new Date(serverHealth.syslog.last_log * 1000).toLocaleTimeString() : 'Never'"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Database Activity -->
                                        <div x-show="serverHealth && serverHealth.database"
                                            style="display: flex; flex-direction: column; gap: 8px;">
                                            <div
                                                style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                                <span>üóÑÔ∏è</span>
                                                <span>Database</span>
                                                <span class="server-stat-badge" :class="{
                                                    'badge-success': serverHealth.database && serverHealth.database.connected,
                                                    'badge-error': serverHealth.database && !serverHealth.database.connected
                                                }" style="font-size: 0.75em; padding: 2px 6px; margin-left: auto;"
                                                    x-text="serverHealth.database && serverHealth.database.connected ? 'CONNECTED' : 'DISCONNECTED'"></span>
                                            </div>
                                            <div
                                                style="display: flex; flex-direction: column; gap: 4px; color: var(--text-secondary);">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span>Log Count:</span>
                                                    <span style="color: var(--text-primary); font-weight: 500;"
                                                        x-text="serverHealth.database && serverHealth.database.log_count ? serverHealth.database.log_count.toLocaleString() : '0'"></span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;"
                                                    x-show="serverHealth.database && serverHealth.database.growth_rate_per_hour !== undefined">
                                                    <span>Growth (1h):</span>
                                                    <span style="color: var(--text-primary); font-weight: 500;"
                                                        x-text="(serverHealth.database && serverHealth.database.growth_rate_per_hour || 0).toLocaleString() + ' logs'"></span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;"
                                                    x-show="serverHealth.database && serverHealth.database.growth_rate_per_day !== undefined">
                                                    <span>Growth (24h):</span>
                                                    <span style="color: var(--text-primary); font-weight: 500;"
                                                        x-text="(serverHealth.database && serverHealth.database.growth_rate_per_day || 0).toLocaleString() + ' logs'"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- NetFlow Activity -->
                                        <div x-show="serverHealth && serverHealth.netflow && !serverHealth.netflow.error"
                                            style="display: flex; flex-direction: column; gap: 8px;">
                                            <div
                                                style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                                <span>üåê</span>
                                                <span>NetFlow</span>
                                                <span class="server-stat-badge" :class="{
                                                    'badge-success': serverHealth.netflow && serverHealth.netflow.available,
                                                    'badge-error': serverHealth.netflow && !serverHealth.netflow.available
                                                }" style="font-size: 0.75em; padding: 2px 6px; margin-left: auto;"
                                                    x-text="serverHealth.netflow && serverHealth.netflow.available ? 'ONLINE' : 'OFFLINE'"></span>
                                            </div>
                                            <div
                                                style="display: flex; flex-direction: column; gap: 4px; color: var(--text-secondary);">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span>File Count:</span>
                                                    <span style="color: var(--text-primary); font-weight: 500;"
                                                        x-text="serverHealth.netflow && serverHealth.netflow.files_count !== undefined ? serverHealth.netflow.files_count.toLocaleString() : 'N/A'"></span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;"
                                                    x-show="serverHealth.netflow && serverHealth.netflow.directory">
                                                    <span>Status:</span>
                                                    <span style="color: var(--text-primary); font-size: 0.85em;"
                                                        x-text="serverHealth.netflow && serverHealth.netflow.available ? 'Collecting' : 'Idle'"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Database (SQLite) Statistics - Always visible (moved here from below) -->
                            <div style="margin-top: 32px;" x-show="!serverHealth.loading && !serverHealth.error">
                                <h2 style="margin-bottom: 20px; font-size: 1.2em; color: var(--text-primary);">Database
                                    (SQLite)</h2>

                                <!-- Loading State -->
                                <template x-if="databaseStats.loading">
                                    <div class="empty-state">
                                        <span>Loading database statistics...</span>
                                    </div>
                                </template>

                                <!-- Error State -->
                                <template x-if="databaseStats.error && !databaseStats.loading">
                                    <div class="empty-state" style="color: var(--neon-red);">
                                        <span x-text="databaseStats.error"></span>
                                    </div>
                                </template>

                                <!-- Database Stats Content -->
                                <template
                                    x-if="!databaseStats.loading && !databaseStats.error && databaseStats.databases">
                                    <div class="grid"
                                        style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                                        <template x-for="db in databaseStats.databases" :key="db.name">
                                            <div class="card">
                                                <h3
                                                    style="margin-bottom: 12px; font-size: 1em; color: var(--text-primary);">
                                                    <span x-text="db.name"></span> Database
                                                    <template x-if="db.error">
                                                        <span
                                                            style="color: var(--neon-red); font-size: 0.85em; margin-left: 8px;">‚ö†Ô∏è</span>
                                                    </template>
                                                </h3>

                                                <!-- Stat Cards -->
                                                <div
                                                    style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                                    <!-- File Size -->
                                                    <div
                                                        style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                                        <div
                                                            style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">
                                                            File Size</div>
                                                        <div style="font-size: 0.95em; color: var(--text-primary); margin-bottom: 4px;"
                                                            x-text="db.file_size ? fmtBytes(db.file_size) : 'N/A'">
                                                        </div>
                                                        <template x-if="db.size_history && db.size_history.length > 1">
                                                            <canvas x-bind:id="'dbSparkline_' + db.name"
                                                                style="width: 100%; height: 24px; display: block;"
                                                                width="120" height="24"></canvas>
                                                        </template>
                                                    </div>

                                                    <!-- Total Records -->
                                                    <div
                                                        style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                                        <div
                                                            style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">
                                                            Records</div>
                                                        <div style="font-size: 0.95em; color: var(--text-primary);"
                                                            x-text="db.total_records ? db.total_records.toLocaleString() : 'N/A'">
                                                        </div>
                                                    </div>

                                                    <!-- WAL Status -->
                                                    <div
                                                        style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                                        <div
                                                            style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">
                                                            WAL</div>
                                                        <div style="font-size: 0.95em; color: var(--text-primary);">
                                                            <template x-if="db.wal_exists">
                                                                <span x-text="fmtBytes(db.wal_size)"></span>
                                                            </template>
                                                            <template
                                                                x-if="!db.wal_exists && db.journal_mode && db.journal_mode.toLowerCase() === 'wal'">
                                                                <span
                                                                    style="color: var(--text-secondary); opacity: 0.8;"
                                                                    title="WAL mode enabled but no active WAL file (no pending transactions)">WAL
                                                                    mode (idle)</span>
                                                            </template>
                                                            <template
                                                                x-if="!db.wal_exists && (!db.journal_mode || db.journal_mode.toLowerCase() !== 'wal')">
                                                                <span
                                                                    style="color: var(--text-secondary); opacity: 0.7;"
                                                                    title="WAL mode not enabled">Not enabled</span>
                                                            </template>
                                                        </div>
                                                    </div>

                                                    <!-- Last Write -->
                                                    <div
                                                        style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                                        <div
                                                            style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 4px;">
                                                            Last Write</div>
                                                        <div style="font-size: 0.85em; color: var(--text-primary);"
                                                            x-text="db.last_write ? new Date(db.last_write).toLocaleString() : 'N/A'">
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Write Pressure Hint -->
                                                <template x-if="db.write_pressure">
                                                    <div
                                                        style="margin-bottom: 12px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; border-left: 2px solid rgba(255,255,255,0.2);">
                                                        <div style="font-size: 0.8em; color: var(--text-secondary);">
                                                            <span style="opacity: 0.8;">Write Activity:</span>
                                                            <span style="margin-left: 6px; color: var(--text-primary);"
                                                                :class="db.write_pressure === 'elevated' ? 'text-warn' : ''"
                                                                x-text="db.write_pressure === 'elevated' ? 'Elevated' : 'Normal'"></span>
                                                        </div>
                                                    </div>
                                                </template>

                                                <!-- Retention Awareness -->
                                                <template x-if="db.oldest_record_age">
                                                    <div
                                                        style="margin-bottom: 12px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; border-left: 2px solid rgba(255,255,255,0.2);">
                                                        <div style="font-size: 0.8em; color: var(--text-secondary);">
                                                            <span style="opacity: 0.8;">Oldest Record:</span>
                                                            <span style="margin-left: 6px; color: var(--text-primary);"
                                                                x-text="db.oldest_record_age"></span>
                                                        </div>
                                                    </div>
                                                </template>

                                                <!-- Detail Panel -->
                                                <div
                                                    style="padding: 12px; background: rgba(0,0,0,0.15); border-radius: 4px; border-top: 1px solid rgba(255,255,255,0.1);">
                                                    <div
                                                        style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px;">
                                                        Configuration</div>
                                                    <div
                                                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.85em;">
                                                        <div>
                                                            <span style="color: var(--text-secondary);">SQLite:</span>
                                                            <span style="color: var(--text-primary); margin-left: 6px;"
                                                                x-text="db.sqlite_version || 'N/A'"></span>
                                                        </div>
                                                        <div>
                                                            <span style="color: var(--text-secondary);">Journal:</span>
                                                            <span style="color: var(--text-primary); margin-left: 6px;"
                                                                x-text="db.journal_mode || 'N/A'"></span>
                                                        </div>
                                                        <div>
                                                            <span style="color: var(--text-secondary);">Sync:</span>
                                                            <span style="color: var(--text-primary); margin-left: 6px;"
                                                                x-text="db.synchronous || 'N/A'"></span>
                                                        </div>
                                                        <div>
                                                            <span style="color: var(--text-secondary);">Page
                                                                Size:</span>
                                                            <span style="color: var(--text-primary); margin-left: 6px;"
                                                                x-text="db.page_size ? fmtBytes(db.page_size) : 'N/A'"></span>
                                                        </div>
                                                        <div>
                                                            <span style="color: var(--text-secondary);">Cache:</span>
                                                            <span style="color: var(--text-primary); margin-left: 6px;">
                                                                <template x-if="db.cache_size && db.page_size">
                                                                    <span x-text="db.cache_size + ' pages'"></span>
                                                                    <span
                                                                        style="color: var(--text-secondary); opacity: 0.7; margin-left: 4px;"
                                                                        x-text="'(' + fmtBytes(db.cache_size * db.page_size) + ')'"></span>
                                                                </template>
                                                                <template x-if="db.cache_size && !db.page_size">
                                                                    <span x-text="db.cache_size + ' pages'"></span>
                                                                </template>
                                                                <template x-if="!db.cache_size">
                                                                    <span>N/A</span>
                                                                </template>
                                                            </span>
                                                        </div>
                                                        <div>
                                                            <span style="color: var(--text-secondary);">Foreign
                                                                Keys:</span>
                                                            <span style="color: var(--text-primary); margin-left: 6px;"
                                                                :title="db.foreign_keys ? 'Enabled: Enforces referential integrity but may impact write performance' : (db.foreign_keys === false ? 'Disabled: Better write performance but no referential integrity checks' : '')"
                                                                x-text="db.foreign_keys !== null ? (db.foreign_keys ? 'Enabled' : 'Disabled') : 'N/A'"></span>
                                                        </div>
                                                    </div>
                                                    <template x-if="db.path">
                                                        <div
                                                            style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05);">
                                                            <div
                                                                style="font-size: 0.75em; color: var(--text-secondary);">
                                                                Path:</div>
                                                            <div style="font-size: 0.8em; color: var(--text-primary); font-family: monospace; word-break: break-all;"
                                                                x-text="db.path"></div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>

                            <!-- Server Logs Widget - At bottom of Server tab -->
                            <div class="card" style="margin-top: 32px;">
                                <h2>
                                    <div class="card-title-content">
                                        <span class="title-icon">üìã</span>
                                        <span>Server Logs</span>
                                    </div>
                                    <div class="card-actions">
                                        <span class="server-stat-badge" :class="{
                                            'badge-success': serverLogs.source === 'buffer' || serverLogs.source === 'docker',
                                            'badge-warning': serverLogs.source === 'files',
                                            'badge-error': serverLogs.source === 'none'
                                        }"
                                            x-text="serverLogs.source === 'docker' ? 'DOCKER' : (serverLogs.source === 'buffer' ? 'BUFFER' : (serverLogs.source === 'files' ? 'FILES' : 'N/A'))"></span>
                                    </div>
                                </h2>
                                <div class="widget-body"
                                    style="min-height: 400px; max-height: 600px; display: flex; flex-direction: column;">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <span style="font-size: 0.85em; color: var(--text-secondary);">Lines:</span>
                                            <select x-model="serverLogs.lines"
                                                @change="fetchServerLogs(serverLogs.lines)"
                                                aria-label="Number of log lines to display" title="Number of log lines"
                                                style="padding: 4px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); font-size: 0.85em;">
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                                <option value="200">200</option>
                                                <option value="500">500</option>
                                            </select>
                                            <button @click="fetchServerLogs(serverLogs.lines)"
                                                aria-label="Refresh server logs" title="Refresh logs"
                                                style="padding: 4px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.85em;"
                                                :disabled="serverLogs.loading">
                                                <span x-text="serverLogs.loading ? 'Loading...' : 'Refresh'"></span>
                                            </button>
                                        </div>
                                        <span style="font-size: 0.85em; color: var(--text-secondary);"
                                            x-text="serverLogs.count + ' lines'"></span>
                                    </div>
                                    <div x-show="serverLogs.loading"
                                        style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                        <span>Loading logs...</span>
                                    </div>
                                    <div x-show="!serverLogs.loading && serverLogs.logs.length > 0"
                                        style="flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; line-height: 1.6;">
                                        <template x-for="(log, index) in serverLogs.logs" :key="index">
                                            <div style="margin-bottom: 2px; color: var(--text-secondary); word-break: break-all;"
                                                x-text="log"></div>
                                        </template>
                                    </div>
                                    <div x-show="!serverLogs.loading && serverLogs.logs.length === 0"
                                        style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                        <span>No logs available</span>
                                    </div>
                                    <div x-show="serverLogs.container"
                                        style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8em; color: var(--text-secondary);">
                                        <span>Container: </span><span x-text="serverLogs.container"></span>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- ============================================
             FIREWALL SNMP STATUS TAB
             ============================================ -->
                    <div x-show="activeTab === 'firewall-snmp'"
                        :style="activeTab === 'firewall-snmp' ? 'display:block' : 'display:none'" id="firewall-snmp-tab"
                        role="tabpanel" aria-labelledby="firewall-snmp-tab-btn" tabindex="0">
                        <section id="section-firewall-snmp" class="scroll-section" style="margin-bottom: 32px;">

                            <!-- Loading State -->
                            <template x-if="firewallSNMP.loading">
                                <div class="empty-state">
                                    <div class="loader">Loading firewall status...</div>
                                </div>
                            </template>

                            <!-- Error State -->
                            <template x-if="!firewallSNMP.loading && firewallSNMP.error && !firewallSNMP.poll_success">
                                <div class="empty-state">
                                    <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">‚ö†Ô∏è
                                    </div>
                                    <p
                                        style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                        SNMP Unavailable</p>
                                    <p style="font-size: var(--text-xs); color: var(--text-tertiary);"
                                        x-text="firewallSNMP.error">
                                    </p>
                                </div>
                            </template>

                            <!-- Content -->
                            <template x-if="!firewallSNMP.loading && firewallSNMP.poll_success">
                                <div>
                                    <!-- Top Stat Boxes -->
                                    <div class="stat-grid"
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                                        <!-- CPU Usage -->
                                        <div class="stat-box">
                                            <div class="stat-label">CPU Usage</div>
                                            <div class="stat-value"
                                                :class="{ 'text-warn': firewallSNMP.cpu_percent > 80, 'text-crit': firewallSNMP.cpu_percent > 90 }"
                                                x-text="firewallSNMP.cpu_percent !== null ? firewallSNMP.cpu_percent.toFixed(1) + '%' : 'N/A'">
                                            </div>
                                            <div class="stat-desc" x-show="firewallSNMP.cpu_percent !== null">
                                                <span
                                                    x-text="firewallSNMP.cpu_percent < 50 ? 'Normal' : firewallSNMP.cpu_percent < 80 ? 'Elevated' : 'High'"></span>
                                            </div>
                                        </div>

                                        <!-- Memory Usage -->
                                        <div class="stat-box">
                                            <div class="stat-label">Memory Usage</div>
                                            <div class="stat-value"
                                                :class="{ 'text-warn': firewallSNMP.memory_percent > 80, 'text-crit': firewallSNMP.memory_percent > 90 }"
                                                x-text="firewallSNMP.memory_percent !== null ? firewallSNMP.memory_percent.toFixed(1) + '%' : 'N/A'">
                                            </div>
                                            <div class="stat-desc" x-show="firewallSNMP.memory_percent !== null">
                                                <span
                                                    x-text="firewallSNMP.memory_percent < 70 ? 'Normal' : firewallSNMP.memory_percent < 85 ? 'Elevated' : 'High'"></span>
                                            </div>
                                        </div>

                                        <!-- Active Firewall Sessions -->
                                        <div class="stat-box">
                                            <div class="stat-label">Active Firewall Sessions</div>
                                            <div class="stat-value"
                                                x-text="firewallSNMP.active_sessions !== null ? firewallSNMP.active_sessions.toLocaleString() : 'N/A'">
                                            </div>
                                            <div class="stat-desc">TCP connections</div>
                                        </div>

                                        <!-- Interface Throughput -->
                                        <div class="stat-box">
                                            <div class="stat-label">Total Throughput</div>
                                            <div class="stat-value"
                                                x-text="firewallSNMP.total_throughput_mbps !== null ? firewallSNMP.total_throughput_mbps.toFixed(2) + ' Mbps' : 'N/A'">
                                            </div>
                                            <div class="stat-desc">Aggregate RX + TX</div>
                                        </div>

                                        <!-- Uptime -->
                                        <div class="stat-box">
                                            <div class="stat-label">Uptime</div>
                                            <div class="stat-value" style="font-size: var(--fs-sm);"
                                                x-text="firewallSNMP.uptime_formatted || 'N/A'"></div>
                                            <div class="stat-desc">System uptime</div>
                                        </div>
                                    </div>

                                    <!-- Interface Table -->
                                    <div class="card">
                                        <h2>
                                            <div class="card-title-content">
                                                <span class="title-icon">üåê</span>
                                                <span>Network Interfaces</span>
                                            </div>
                                        </h2>
                                        <div class="widget-body">
                                            <template
                                                x-if="firewallSNMP.interfaces && firewallSNMP.interfaces.length > 0">
                                                <div>
                                                    <table class="table-fixed table-compact">
                                                        <thead>
                                                            <tr>
                                                                <th>Interface</th>
                                                                <th>Status</th>
                                                                <th>RX Rate</th>
                                                                <th>TX Rate</th>
                                                                <th>Errors</th>
                                                                <th>Drops</th>
                                                                <th>Utilization</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <template x-for="iface in firewallSNMP.interfaces"
                                                                :key="iface.name">
                                                                <tr>
                                                                    <td><strong x-text="iface.name"></strong></td>
                                                                    <td>
                                                                        <span class="badge" :class="{ 
                                                                    'badge-success': iface.status === 'up', 
                                                                    'badge-error': iface.status === 'down',
                                                                    'badge-warning': iface.status === 'stale' || iface.status === 'unknown' || iface.status === 'admin_down'
                                                                }" x-text="iface.status === 'up' ? 'UP' : iface.status === 'down' ? 'DOWN' : iface.status === 'stale' ? 'STALE' : iface.status === 'admin_down' ? 'ADMIN DOWN' : 'UNKNOWN'"></span>
                                                                    </td>
                                                                    <td>
                                                                        <span
                                                                            x-show="iface.rx_mbps != null && iface.rx_mbps !== undefined"
                                                                            x-text="(typeof iface.rx_mbps === 'number' ? iface.rx_mbps : 0).toFixed(2) + ' Mbps'"></span>
                                                                        <span
                                                                            x-show="iface.rx_mbps == null || iface.rx_mbps === undefined"
                                                                            class="text-muted">‚Äî</span>
                                                                    </td>
                                                                    <td>
                                                                        <span
                                                                            x-show="iface.tx_mbps != null && iface.tx_mbps !== undefined"
                                                                            x-text="(typeof iface.tx_mbps === 'number' ? iface.tx_mbps : 0).toFixed(2) + ' Mbps'"></span>
                                                                        <span
                                                                            x-show="iface.tx_mbps == null || iface.tx_mbps === undefined"
                                                                            class="text-muted">‚Äî</span>
                                                                    </td>
                                                                    <td>
                                                                        <template
                                                                            x-if="iface.rx_errors !== null && iface.rx_errors !== undefined && iface.tx_errors !== null && iface.tx_errors !== undefined">
                                                                            <span
                                                                                :class="{ 'text-warn': (iface.rx_errors + iface.tx_errors) > 0, 'text-muted': (iface.rx_errors + iface.tx_errors) === 0 }"
                                                                                x-text="(iface.rx_errors + iface.tx_errors).toFixed(1) + '/s'"></span>
                                                                        </template>
                                                                        <template
                                                                            x-if="iface.rx_errors === null || iface.rx_errors === undefined || iface.tx_errors === null || iface.tx_errors === undefined">
                                                                            <span class="text-muted">‚Äî</span>
                                                                        </template>
                                                                    </td>
                                                                    <td>
                                                                        <template
                                                                            x-if="iface.rx_drops !== null && iface.rx_drops !== undefined && iface.tx_drops !== null && iface.tx_drops !== undefined">
                                                                            <span
                                                                                :class="{ 'text-warn': (iface.rx_drops + iface.tx_drops) > 0, 'text-muted': (iface.rx_drops + iface.tx_drops) === 0 }"
                                                                                x-text="(iface.rx_drops + iface.tx_drops).toFixed(1) + '/s'"></span>
                                                                        </template>
                                                                        <template
                                                                            x-if="iface.rx_drops === null || iface.rx_drops === undefined || iface.tx_drops === null || iface.tx_drops === undefined">
                                                                            <span class="text-muted">‚Äî</span>
                                                                        </template>
                                                                    </td>
                                                                    <td>
                                                                        <div
                                                                            style="display: flex; align-items: center; gap: var(--space-2);">
                                                                            <span x-show="iface.utilization != null"
                                                                                :class="{ 'text-warn': iface.utilization > 80, 'text-crit': iface.utilization > 90, 'text-muted': iface.utilization <= 80 }"
                                                                                x-text="(iface.utilization || 0).toFixed(1) + '%'"
                                                                                :title="iface.speed_mbps ? 'Link speed: ' + iface.speed_mbps + ' Mbps' : ''"></span>
                                                                            <span x-show="iface.utilization == null"
                                                                                class="text-muted">‚Äî</span>
                                                                            <!-- Utilization sparkline -->
                                                                            <template
                                                                                x-if="iface.utilization_history && iface.utilization_history.length >= 2">
                                                                                <svg width="60" height="16"
                                                                                    style="opacity: 0.5; margin-left: var(--space-1);"
                                                                                    :title="'Utilization trend (' + iface.utilization_history.length + ' samples)'"
                                                                                    x-effect="
                                                                            if (iface.utilization_history && iface.utilization_history.length >= 2) {
                                                                                const history = iface.utilization_history;
                                                                                const width = 60;
                                                                                const height = 16;
                                                                                const maxVal = Math.max(...history, 1) || 1;
                                                                                const points = history.map((val, idx) => {
                                                                                    const x = idx * (width / Math.max(history.length - 1, 1));
                                                                                    const y = height - (val / maxVal) * height;
                                                                                    return x + ',' + y;
                                                                                }).join(' ');
                                                                                const polyline = $el.querySelector('polyline');
                                                                                if (polyline) polyline.setAttribute('points', points);
                                                                            }
                                                                        ">
                                                                                    <polyline fill="none"
                                                                                        stroke="currentColor"
                                                                                        stroke-width="1"
                                                                                        style="color: var(--text-muted);">
                                                                                    </polyline>
                                                                                </svg>
                                                                            </template>
                                                                            <!-- Saturation hint -->
                                                                            <template x-if="iface.saturation_hint">
                                                                                <span class="text-muted"
                                                                                    style="font-size: 0.85em; opacity: 0.7; margin-left: var(--space-2);"
                                                                                    :title="'Sustained utilization above baseline: ' + iface.saturation_hint"
                                                                                    x-text="'‚ö† ' + iface.saturation_hint"></span>
                                                                            </template>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            </template>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </template>
                                            <template
                                                x-if="!firewallSNMP.interfaces || firewallSNMP.interfaces.length === 0">
                                                <div class="empty-state">
                                                    <p class="text-muted">No interface data available</p>
                                                </div>
                                            </template>

                                            <!-- Traffic Correlation Status -->
                                            <template
                                                x-if="firewallSNMP.traffic_correlation && firewallSNMP.traffic_correlation.status">
                                                <div
                                                    style="margin-top: var(--space-4); padding: var(--space-3); background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--card-radius);">
                                                    <div
                                                        style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                                        <span
                                                            style="font-size: 0.9em; font-weight: var(--font-weight-semibold); color: var(--text-secondary);">Traffic
                                                            Correlation (1h):</span>
                                                        <span class="badge" :class="{
                                                    'badge-success': firewallSNMP.traffic_correlation.status === 'aligned',
                                                    'badge-warning': firewallSNMP.traffic_correlation.status === 'flow_heavy' || firewallSNMP.traffic_correlation.status === 'interface_heavy'
                                                }" x-text="firewallSNMP.traffic_correlation.status === 'aligned' ? 'Aligned' : firewallSNMP.traffic_correlation.status === 'flow_heavy' ? 'Flow-heavy' : firewallSNMP.traffic_correlation.status === 'interface_heavy' ? 'Interface-heavy' : 'Unknown'"></span>
                                                    </div>
                                                    <template x-if="firewallSNMP.traffic_correlation.hint">
                                                        <p style="font-size: 0.85em; color: var(--text-muted); margin: 0;"
                                                            x-text="firewallSNMP.traffic_correlation.hint"></p>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>

                                        <!-- System Info Panel -->
                                        <div class="card">
                                            <h2>
                                                <div class="card-title-content">
                                                    <span class="title-icon">‚ÑπÔ∏è</span>
                                                    <span>System Information</span>
                                                </div>
                                            </h2>
                                            <div class="widget-body">
                                                <div
                                                    style="display: flex; flex-direction: column; gap: var(--space-3);">
                                                    <div
                                                        style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span class="text-secondary">Uptime:</span>
                                                        <span
                                                            x-text="firewallSNMP.uptime_formatted || 'Unknown'"></span>
                                                    </div>
                                                    <div
                                                        style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span class="text-secondary">Last SNMP Poll:</span>
                                                        <span
                                                            x-text="firewallSNMP.last_poll ? timeAgo(firewallSNMP.last_poll) : 'Never'"></span>
                                                    </div>
                                                    <div
                                                        style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span class="text-secondary">SNMP Status:</span>
                                                        <span class="badge"
                                                            :class="{ 'badge-success': firewallSNMP.poll_success, 'badge-error': !firewallSNMP.poll_success }"
                                                            x-text="firewallSNMP.poll_success ? 'ACTIVE' : 'ERROR'"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                            </template>

                        </section>
                    </div>

                    <!-- ============================================
             AI ASSISTANT TAB - Ollama Chat Interface
             ============================================ -->
                    <div x-show="activeTab === 'assistant'"
                        :style="activeTab === 'assistant' ? 'display:block' : 'display:none'" id="assistant-tab"
                        role="tabpanel" aria-labelledby="assistant-tab-btn" tabindex="0">
                        <section id="section-assistant" class="scroll-section" style="margin-bottom: 32px;">
                            <div class="card wide-card"
                                style="height: calc(100vh - 200px); display: flex; flex-direction: column;">
                                <h2>
                                    <span>ü§ñ Assistant</span>
                                    <div class="card-actions">
                                        <select x-model="ollamaChat.model" class="filter-select"
                                            style="min-width: 150px;" @change="fetchOllamaModels()"
                                            title="Select Ollama model">
                                            <template
                                                x-for="model in ollamaChat.availableModels.length > 0 ? ollamaChat.availableModels : ['deepseek-coder-v2:16b']"
                                                :key="model">
                                                <option :value="model" x-text="model"></option>
                                            </template>
                                        </select>
                                        <label
                                            style="display: flex; align-items: center; gap: 6px; font-size: var(--text-xs); color: var(--text-secondary); cursor: pointer;"
                                            title="Include current dashboard data as context">
                                            <input type="checkbox" x-model="ollamaChat.includeContext"
                                                style="cursor: pointer;">
                                            <span>Use Context</span>
                                        </label>
                                        <select x-model="ollamaChat.analysisType" class="filter-select"
                                            style="min-width: 120px;"
                                            title="Analysis type for enhanced threat investigation">
                                            <option value="general">General</option>
                                            <option value="forensics">Forensics</option>
                                            <option value="investigation">Investigation</option>
                                            <option value="mitigation">Mitigation</option>
                                        </select>
                                        <button class="btn btn--secondary" @click="clearChat()" title="Clear chat">
                                            Clear
                                        </button>
                                    </div>
                                </h2>

                                <!-- Chat Messages Area -->
                                <div class="chat-messages" style="flex: 1; overflow-y: auto; padding: var(--space-4); 
                                    display: flex; flex-direction: column; gap: var(--space-3); min-height: 0;">
                                    <template x-if="ollamaChat.messages.length === 0">
                                        <div
                                            style="text-align: center; color: var(--text-secondary); padding: var(--space-8);">
                                            <div style="font-size: 48px; margin-bottom: var(--space-4);">ü§ñ</div>
                                            <div style="font-size: var(--text-lg); margin-bottom: var(--space-2);">AI
                                                Assistant</div>
                                            <div style="font-size: var(--text-sm);">Ask me anything about your network,
                                                security, or system.</div>
                                            <div
                                                style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-4);">
                                                Powered by Ollama (local LLM)
                                            </div>
                                        </div>
                                    </template>
                                    <template x-for="(msg, idx) in ollamaChat.messages" :key="idx">
                                        <div
                                            :class="'chat-message ' + (msg.role === 'user' ? 'chat-message-user' : 'chat-message-assistant')">
                                            <div class="chat-message-role"
                                                x-text="msg.role === 'user' ? 'You' : 'Assistant'"></div>
                                            <div class="chat-message-content"
                                                x-html="msg.content.replace(/\n/g, '<br>')">
                                            </div>
                                            <div class="chat-message-time" x-text="msg.timestamp"></div>
                                        </div>
                                    </template>
                                    <div x-show="ollamaChat.loading" class="chat-message chat-message-assistant">
                                        <div class="chat-message-role">Assistant</div>
                                        <div class="chat-message-content">
                                            <div class="spinner"
                                                style="display: inline-block; margin-right: var(--space-2);"></div>
                                            <span>Thinking...</span>
                                        </div>
                                    </div>
                                    <div x-show="ollamaChat.error" class="chat-message chat-message-error">
                                        <div class="chat-message-role">Error</div>
                                        <div class="chat-message-content" x-text="ollamaChat.error"></div>
                                    </div>
                                </div>

                                <!-- Chat Input Area -->
                                <div style="padding: var(--space-4); border-top: 1px solid var(--card-border);">
                                    <div style="display: flex; gap: var(--space-2);">
                                        <textarea x-model="ollamaChat.inputMessage"
                                            @keydown.enter.prevent="ollamaChat.inputMessage.trim() && !ollamaChat.loading && sendChatMessage()"
                                            @keydown.enter.shift="ollamaChat.inputMessage += '\n'"
                                            placeholder="Type your message... (Enter to send, Shift+Enter for new line)"
                                            style="flex: 1; min-height: 60px; max-height: 150px; padding: var(--space-3); 
                                                background: var(--bg-primary); border: 1px solid var(--card-border); 
                                                border-radius: var(--radius-md); color: var(--text-primary); 
                                                font-family: inherit; font-size: var(--text-base); resize: vertical;"
                                            :disabled="ollamaChat.loading"></textarea>
                                        <button class="btn btn--primary" @click="sendChatMessage()"
                                            :disabled="!ollamaChat.inputMessage.trim() || ollamaChat.loading"
                                            style="align-self: flex-end;">
                                            <span x-show="!ollamaChat.loading">Send</span>
                                            <span x-show="ollamaChat.loading">...</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- ============================================
             NETWORK FORENSICS TAB - Incident Response Tools
             ============================================ -->
                    <div x-show="activeTab === 'forensics'"
                        :style="activeTab === 'forensics' ? 'display:block' : 'display:none'" id="forensics-tab"
                        role="tabpanel" aria-labelledby="forensics-tab-btn" tabindex="0">

                        <!-- Timeline Analysis Section -->
                        <section id="section-forensics-timeline" class="scroll-section" style="margin-bottom: 32px;">
                            <div class="card">
                                <h2>
                                    <span>üîç Timeline Analysis</span>
                                    <div class="card-actions">
                                        <input type="text" x-model="forensics.timeline.targetIp"
                                            placeholder="Target IP (e.g., 192.168.1.100)"
                                            style="padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                                        <select x-model="forensics.timeline.timeRange" class="filter-select">
                                            <option value="1h">Last Hour</option>
                                            <option value="6h">Last 6 Hours</option>
                                            <option value="24h" selected>Last 24 Hours</option>
                                            <option value="7d">Last 7 Days</option>
                                        </select>
                                        <button class="btn btn--primary" @click="generateTimeline()"
                                            :disabled="!forensics.timeline.targetIp || forensics.timeline.loading">
                                            <span x-show="!forensics.timeline.loading">Generate Timeline</span>
                                            <span x-show="forensics.timeline.loading">...</span>
                                        </button>
                                        <button class="btn btn--secondary" @click="forensics.timeline.data = null"
                                            title="Clear timeline">
                                            Clear
                                        </button>
                                    </div>
                                </h2>

                                <div x-show="forensics.timeline.error" class="alert alert--danger"
                                    style="margin: 16px 0;">
                                    <strong>Error:</strong> <span x-text="forensics.timeline.error"></span>
                                </div>

                                <div x-show="forensics.timeline.data" style="margin-top: 16px;">
                                    <!-- Timeline Summary -->
                                    <div class="card" style="margin-bottom: 16px;">
                                        <h3>Summary</h3>
                                        <div
                                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div>
                                                <div class="label">Target IP</div>
                                                <div x-text="forensics.timeline.data.summary.target_ip"></div>
                                            </div>
                                            <div>
                                                <div class="label">Total Events</div>
                                                <div x-text="forensics.timeline.data.summary.total_events"></div>
                                            </div>
                                            <div>
                                                <div class="label">Total Bytes</div>
                                                <div
                                                    x-text="DashboardUtils.formatBytes(forensics.timeline.data.summary.total_bytes)">
                                                </div>
                                            </div>
                                            <div>
                                                <div class="label">Suspicious Events</div>
                                                <div x-text="forensics.timeline.data.summary.suspicious_events"
                                                    :style="forensics.timeline.data.summary.suspicious_events > 0 ? 'color: var(--neon-red)' : 'color: var(--neon-green)'">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Timeline Events -->
                                    <div class="card">
                                        <h3>Timeline Events</h3>
                                        <div style="max-height: 400px; overflow-y: auto;">
                                            <table class="table-fixed table-compact" style="width: 100%;">
                                                <thead style="position: sticky; top: 0; background: #111;">
                                                    <tr>
                                                        <th style="padding: 8px;">Timestamp</th>
                                                        <th style="padding: 8px;">Direction</th>
                                                        <th style="padding: 8px;">Source IP</th>
                                                        <th style="padding: 8px;">Dest IP</th>
                                                        <th style="padding: 8px;">Port</th>
                                                        <th style="padding: 8px;">Protocol</th>
                                                        <th style="padding: 8px;">Bytes</th>
                                                        <th style="padding: 8px;">Indicators</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <template x-for="event in forensics.timeline.data.timeline"
                                                        :key="event.timestamp">
                                                        <tr
                                                            :style="event.suspicious ? 'background: rgba(255, 0, 0, 0.1)' : ''">
                                                            <td style="padding: 6px; font-size: 12px;"
                                                                x-text="event.timestamp"></td>
                                                            <td style="padding: 6px;">
                                                                <span x-text="event.direction"
                                                                    :style="event.direction === 'outbound' ? 'color: var(--neon-orange)' : 'color: var(--neon-cyan)'"></span>
                                                            </td>
                                                            <td style="padding: 6px; font-family: monospace;"
                                                                x-text="event.src_ip"></td>
                                                            <td style="padding: 6px; font-family: monospace;"
                                                                x-text="event.dst_ip"></td>
                                                            <td style="padding: 6px;"
                                                                x-text="event.direction === 'outbound' ? event.dst_port : event.src_port">
                                                            </td>
                                                            <td style="padding: 6px;" x-text="event.protocol"></td>
                                                            <td style="padding: 6px;"
                                                                x-text="DashboardUtils.formatBytes(event.bytes)"></td>
                                                            <td style="padding: 6px;">
                                                                <template x-for="indicator in event.indicators"
                                                                    :key="indicator">
                                                                    <span class="badge badge--warning"
                                                                        style="font-size: 10px; margin-right: 4px;"
                                                                        x-text="indicator"></span>
                                                                </template>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Session Reconstruction Section -->
                        <section id="section-forensics-session" class="scroll-section" style="margin-bottom: 32px;">
                            <div class="card">
                                <h2>
                                    <span>üîó Session Reconstruction</span>
                                    <div class="card-actions">
                                        <input type="text" x-model="forensics.session.srcIp" placeholder="Source IP"
                                            style="padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                                        <input type="text" x-model="forensics.session.dstIp"
                                            placeholder="Destination IP"
                                            style="padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                                        <select x-model="forensics.session.timeRange" class="filter-select">
                                            <option value="1h" selected>Last Hour</option>
                                            <option value="6h">Last 6 Hours</option>
                                            <option value="24h">Last 24 Hours</option>
                                        </select>
                                        <button class="btn btn--primary" @click="reconstructSession()"
                                            :disabled="!forensics.session.srcIp || !forensics.session.dstIp || forensics.session.loading">
                                            <span x-show="!forensics.session.loading">Reconstruct</span>
                                            <span x-show="forensics.session.loading">...</span>
                                        </button>
                                        <button class="btn btn--secondary" @click="forensics.session.data = null"
                                            title="Clear session">
                                            Clear
                                        </button>
                                    </div>
                                </h2>

                                <div x-show="forensics.session.error" class="alert alert--danger"
                                    style="margin: 16px 0;">
                                    <strong>Error:</strong> <span x-text="forensics.session.error"></span>
                                </div>

                                <div x-show="forensics.session.data" style="margin-top: 16px;">
                                    <!-- Session Summary -->
                                    <div class="card" style="margin-bottom: 16px;">
                                        <h3>Session Summary</h3>
                                        <div
                                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div>
                                                <div class="label">Communication</div>
                                                <div
                                                    x-text="forensics.session.data.summary.src_ip + ' ‚Üí ' + forensics.session.data.summary.dst_ip">
                                                </div>
                                            </div>
                                            <div>
                                                <div class="label">Duration</div>
                                                <div
                                                    x-text="Math.round(forensics.session.data.summary.session_duration_seconds) + ' seconds'">
                                                </div>
                                            </div>
                                            <div>
                                                <div class="label">Total Flows</div>
                                                <div x-text="forensics.session.data.summary.total_flows"></div>
                                            </div>
                                            <div>
                                                <div class="label">Data Volume</div>
                                                <div
                                                    x-text="DashboardUtils.formatBytes(forensics.session.data.summary.total_bytes)">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Session Flows -->
                                    <div class="card">
                                        <h3>Communication Flows</h3>
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            <table class="table-fixed table-compact" style="width: 100%;">
                                                <thead style="position: sticky; top: 0; background: #111;">
                                                    <tr>
                                                        <th style="padding: 8px;">Timestamp</th>
                                                        <th style="padding: 8px;">Source Port</th>
                                                        <th style="padding: 8px;">Dest Port</th>
                                                        <th style="padding: 8px;">Protocol</th>
                                                        <th style="padding: 8px;">Bytes</th>
                                                        <th style="padding: 8px;">Packets</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <template x-for="flow in forensics.session.data.flows"
                                                        :key="flow.timestamp">
                                                        <tr>
                                                            <td style="padding: 6px; font-size: 12px;"
                                                                x-text="flow.timestamp"></td>
                                                            <td style="padding: 6px;" x-text="flow.src_port"></td>
                                                            <td style="padding: 6px;" x-text="flow.dst_port"></td>
                                                            <td style="padding: 6px;" x-text="flow.protocol"></td>
                                                            <td style="padding: 6px;"
                                                                x-text="DashboardUtils.formatBytes(flow.bytes)"></td>
                                                            <td style="padding: 6px;" x-text="flow.packets"></td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Evidence Collection Section -->
                        <section id="section-forensics-evidence" class="scroll-section" style="margin-bottom: 32px;">
                            <div class="card">
                                <h2>
                                    <span>üì¶ Evidence Collection</span>
                                    <div class="card-actions">
                                        <select x-model="forensics.evidence.incidentType" class="filter-select">
                                            <option value="general">General</option>
                                            <option value="malware">Malware</option>
                                            <option value="data_exfiltration">Data Exfiltration</option>
                                            <option value="dos">Denial of Service</option>
                                            <option value="scan">Scanning</option>
                                        </select>
                                        <textarea x-model="forensics.evidence.targetIpsString"
                                            placeholder="Target IPs (one per line)"
                                            style="width: 300px; height: 60px; padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); font-family: monospace; font-size: 12px;"
                                            @input="forensics.evidence.targetIps = $el.value.split('\\n').map(ip => ip.trim()).filter(ip => ip)"></textarea>
                                        <select x-model="forensics.evidence.timeRange" class="filter-select">
                                            <option value="1h">Last Hour</option>
                                            <option value="6h">Last 6 Hours</option>
                                            <option value="24h" selected>Last 24 Hours</option>
                                            <option value="7d">Last 7 Days</option>
                                        </select>
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;">
                                            <input type="checkbox" x-model="forensics.evidence.preserveData">
                                            <span>Preserve Data</span>
                                        </label>
                                        <button class="btn btn--primary" @click="collectEvidence()"
                                            :disabled="!forensics.evidence.targetIps.length || forensics.evidence.loading">
                                            <span x-show="!forensics.evidence.loading">Collect Evidence</span>
                                            <span x-show="forensics.evidence.loading">...</span>
                                        </button>
                                        <button class="btn btn--secondary" @click="forensics.evidence.report = null"
                                            title="Clear report">
                                            Clear
                                        </button>
                                    </div>
                                </h2>

                                <div x-show="forensics.evidence.error" class="alert alert--danger"
                                    style="margin: 16px 0;">
                                    <strong>Error:</strong> <span x-text="forensics.evidence.error"></span>
                                </div>

                                <div x-show="forensics.evidence.report" style="margin-top: 16px;">
                                    <!-- Evidence Report -->
                                    <div class="card" style="margin-bottom: 16px;">
                                        <h3>Evidence Report</h3>
                                        <div style="margin-bottom: 16px;">
                                            <strong>Incident Type:</strong> <span
                                                x-text="forensics.evidence.report.incident_metadata.incident_type"></span><br>
                                            <strong>Collection Time:</strong> <span
                                                x-text="new Date(forensics.evidence.report.incident_metadata.collection_timestamp).toLocaleString()"></span><br>
                                            <strong>Target IPs:</strong> <span
                                                x-text="forensics.evidence.report.incident_metadata.target_ips.join(', ')"></span>
                                        </div>

                                        <h4>Chain of Custody</h4>
                                        <div
                                            style="background: rgba(0,255,0,0.1); padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                                            <div><strong>Collector:</strong> <span
                                                    x-text="forensics.evidence.report.chain_of_custody.collector"></span>
                                            </div>
                                            <div><strong>Method:</strong> <span
                                                    x-text="forensics.evidence.report.chain_of_custody.collection_method"></span>
                                            </div>
                                            <div><strong>Integrity Check:</strong> <span
                                                    x-text="forensics.evidence.report.chain_of_custody.integrity_check"></span>
                                            </div>
                                            <div><strong>Preservation Status:</strong> <span
                                                    x-text="forensics.evidence.report.chain_of_custody.preservation_status"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Evidence Items -->
                                    <div class="card" style="margin-bottom: 16px;">
                                        <h3>Evidence Items</h3>
                                        <template x-for="item in forensics.evidence.report.evidence_items"
                                            :key="item.type + item.target">
                                            <div
                                                style="background: var(--card-bg); padding: 12px; margin-bottom: 8px; border-radius: 4px; border-left: 4px solid var(--neon-cyan);">
                                                <div style="font-weight: bold;"
                                                    x-text="item.type + ' - ' + item.target"></div>
                                                <div style="font-size: 12px; color: var(--text-secondary);"
                                                    x-text="item.description"></div>
                                                <div style="font-size: 11px; margin-top: 4px;">
                                                    <span x-text="'Records: ' + (item.record_count || 'N/A')"></span>
                                                    <span x-show="item.preserved"
                                                        style="color: var(--neon-green); margin-left: 12px;">‚úì
                                                        Preserved</span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Recommendations -->
                                    <div class="card">
                                        <h3>Investigation Recommendations</h3>
                                        <ul style="margin: 0; padding-left: 20px;">
                                            <template
                                                x-for="recommendation in forensics.evidence.report.recommendations"
                                                :key="recommendation">
                                                <li style="margin-bottom: 4px;" x-text="recommendation"></li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- ============================================
             TOOLS TAB - Network & Security Utilities
             ============================================ -->
                    <div x-show="activeTab === 'tools'"
                        :style="activeTab === 'tools' ? 'display:block' : 'display:none'" id="tools-tab" role="tabpanel"
                        aria-labelledby="tools-tab-btn" tabindex="0">

                        <div class="grid-3-col">
                            <!-- DNS Lookup Tool -->
                            <div class="card">
                                <h2>
                                    <div class="card-title-content">
                                        <span class="title-icon">üîé</span>
                                        <span>DNS Lookup</span>
                                    </div>
                                    <div class="card-actions">
                                        <div class="spinner" x-show="tools.dns.loading"></div>
                                    </div>
                                </h2>
                                <div class="widget-body">
                                    <p class="text-muted mb-3">Resolve and inspect DNS records</p>
                                    <div class="tool-input-group">
                                        <input type="text" x-model="tools.dns.query"
                                            placeholder="Domain or IP (e.g., google.com)" class="tool-input"
                                            @keydown.enter="runDnsLookup()">
                                        <select x-model="tools.dns.type" class="tool-select">
                                            <option value="A">A</option>
                                            <option value="AAAA">AAAA</option>
                                            <option value="MX">MX</option>
                                            <option value="TXT">TXT</option>
                                            <option value="NS">NS</option>
                                            <option value="PTR">PTR</option>
                                        </select>
                                        <button class="btn btn--primary" @click="runDnsLookup()"
                                            :disabled="!tools.dns.query || tools.dns.loading">
                                            Query
                                        </button>
                                    </div>
                                    <div x-show="tools.dns.error" class="tool-error" x-text="tools.dns.error"></div>
                                    <div x-show="tools.dns.result" class="tool-result">
                                        <pre x-text="tools.dns.result"></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Port Check Tool -->
                            <div class="card">
                                <h2>
                                    <div class="card-title-content">
                                        <span class="title-icon">üö™</span>
                                        <span>Port Check</span>
                                    </div>
                                    <div class="card-actions">
                                        <div class="spinner" x-show="tools.port.loading"></div>
                                    </div>
                                </h2>
                                <div class="widget-body">
                                    <p class="text-muted mb-3">Test service reachability on specific ports</p>
                                    <div class="tool-input-group">
                                        <input type="text" x-model="tools.port.host"
                                            placeholder="Host (e.g., 192.168.1.1)" class="tool-input"
                                            @keydown.enter="runPortCheck()">
                                        <input type="text" x-model="tools.port.ports"
                                            placeholder="Ports (e.g., 22,80,443)" class="tool-input-sm"
                                            @keydown.enter="runPortCheck()">
                                        <button class="btn btn--primary" @click="runPortCheck()"
                                            :disabled="!tools.port.host || !tools.port.ports || tools.port.loading">
                                            Check
                                        </button>
                                    </div>
                                    <div x-show="tools.port.error" class="tool-error" x-text="tools.port.error"></div>
                                    <div x-show="tools.port.result" class="tool-result">
                                        <template x-for="port in tools.port.result" :key="port.port">
                                            <div class="port-result-row">
                                                <span class="port-number" x-text="port.port"></span>
                                                <span class="port-status"
                                                    :class="port.open ? 'status-open' : 'status-closed'"
                                                    x-text="port.open ? 'OPEN' : 'CLOSED'"></span>
                                                <span class="port-service" x-text="port.service || ''"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Ping / Traceroute Tool -->
                            <div class="card">
                                <h2>
                                    <div class="card-title-content">
                                        <span class="title-icon">üì°</span>
                                        <span>Ping / Traceroute</span>
                                    </div>
                                    <div class="card-actions">
                                        <div class="spinner" x-show="tools.ping.loading"></div>
                                    </div>
                                </h2>
                                <div class="widget-body">
                                    <p class="text-muted mb-3">Reachability and path testing</p>
                                    <div class="tool-input-group">
                                        <input type="text" x-model="tools.ping.host" placeholder="Host (e.g., 8.8.8.8)"
                                            class="tool-input" @keydown.enter="runPing()">
                                        <select x-model="tools.ping.mode" class="tool-select">
                                            <option value="ping">Ping</option>
                                            <option value="traceroute">Traceroute</option>
                                        </select>
                                        <button class="btn btn--primary" @click="runPing()"
                                            :disabled="!tools.ping.host || tools.ping.loading">
                                            Run
                                        </button>
                                    </div>
                                    <div x-show="tools.ping.error" class="tool-error" x-text="tools.ping.error"></div>
                                    <div x-show="tools.ping.result" class="tool-result">
                                        <pre x-text="tools.ping.result"></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Whois / ASN Lookup Tool -->
                            <div class="card">
                                <h2>
                                    <div class="card-title-content">
                                        <span class="title-icon">üåç</span>
                                        <span>Whois / ASN Lookup</span>
                                    </div>
                                    <div class="card-actions">
                                        <div class="spinner" x-show="tools.whois.loading"></div>
                                    </div>
                                </h2>
                                <div class="widget-body">
                                    <p class="text-muted mb-3">Network ownership and geographic origin</p>
                                    <div class="tool-input-group">
                                        <input type="text" x-model="tools.whois.query" placeholder="IP or domain"
                                            class="tool-input" @keydown.enter="runWhoisLookup()">
                                        <button class="btn btn--primary" @click="runWhoisLookup()"
                                            :disabled="!tools.whois.query || tools.whois.loading">
                                            Lookup
                                        </button>
                                    </div>
                                    <div x-show="tools.whois.error" class="tool-error" x-text="tools.whois.error"></div>
                                    <div x-show="tools.whois.result" class="tool-result">
                                        <div class="whois-result">
                                            <div><strong>ASN:</strong> <span
                                                    x-text="tools.whois.result?.asn || 'N/A'"></span></div>
                                            <div><strong>Organization:</strong> <span
                                                    x-text="tools.whois.result?.org || 'N/A'"></span></div>
                                            <div><strong>Country:</strong> <span
                                                    x-text="tools.whois.result?.country || 'N/A'"></span></div>
                                            <div><strong>Network:</strong> <span
                                                    x-text="tools.whois.result?.network || 'N/A'"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

            </main>


            <!-- Expanded Table Modal -->
            <div class="modal" x-show="expandedModalOpen" :style="expandedModalOpen ? 'display:flex' : 'display:none'"
                @click.self="expandedModalOpen = false">
                <div class="modal-content" style="max-width: 1000px; height: 90vh;">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h2 style="margin:0"><span class="text-cyan" x-text="expandedTitle"></span></h2>
                        <button @click="expandedModalOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close">√ó</button>
                    </div>

                    <div x-show="expandedLoading" class="spinner" style="margin: 0 auto;"></div>

                    <div x-show="!expandedLoading" style="overflow-y:auto; height: calc(100% - 60px);">
                        <table class="table-fixed table-compact" style="width:100%; border-collapse:collapse;">
                            <thead style="position:sticky; top:0; background: #111; z-index:1;">
                                <tr style="border-bottom: 1px solid var(--neon-cyan);">
                                    <template x-for="col in expandedColumns">
                                        <th style="padding:10px; text-align:left; color:var(--text-muted);"
                                            x-text="col">
                                        </th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(row, idx) in expandedData" :key="idx">
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        <template x-for="val in row">
                                            <td style="padding:8px;" x-html="val"></td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div x-show="expandedData.length === 0"
                            style="padding:20px; text-align:center; color:var(--text-muted)">No data available</div>
                    </div>
                </div>
            </div>

            <!-- Network Graph Modal -->
            <div class="modal" x-show="networkGraphOpen" :style="networkGraphOpen ? 'display:flex' : 'display:none'"
                @click.self="networkGraphOpen = false">
                <div class="modal-content"
                    style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h2 style="margin:0">üï∏Ô∏è Network Graph</h2>
                        <button @click="networkGraphOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close">√ó</button>
                    </div>
                    <div id="network-graph-container"
                        style="flex: 1; border: 1px solid rgba(0,243,255,0.2); background: rgba(0,0,0,0.5); border-radius: 4px;">
                    </div>
                    <div style="font-size:0.8em; color:var(--text-muted); margin-top:5px; text-align:center;">
                        <span style="color:#00f3ff">‚óè Source</span> &nbsp;
                        <span style="color:#bc13fe">‚óè Destination</span> &nbsp;
                        <span style="color:#0aff0a">‚óè Both</span>
                        &nbsp;|&nbsp; Drag to pan, Scroll to zoom, Click node to highlight
                    </div>
                </div>
            </div>

            <!-- IP Detail Modal -->
            <div class="modal" x-show="modalOpen" :style="modalOpen ? 'display:flex' : 'display:none'"
                @click.self="modalOpen = false">
                <div class="modal-content">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="margin:0">
                            IP Details: <span class="text-cyan" x-text="selectedIP"></span>
                            <!-- Subtle new host indicator -->
                            <template x-if="ipDetails?.is_new">
                                <span class="host-new-indicator" title="New host (first seen within 24h)"
                                    style="margin-left: 8px; font-size: 0.7em; opacity: 0.7;">üÜï</span>
                            </template>
                        </h2>
                        <button @click="modalOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close details">√ó</button>
                    </div>

                    <div x-show="ipLoading" class="spinner" style="margin: 0 auto;"></div>

                    <div x-show="!ipLoading && ipDetails">
                        <div class="grid">
                            <div class="card">
                                <p><strong>Hostname:</strong> <span x-text="ipDetails?.hostname || 'N/A'"></span></p>
                                <p><strong>Region:</strong> <span x-text="ipDetails?.region"></span> <span
                                        x-text="ipDetails?.geo?.city"></span></p>
                                <!-- Host memory: first seen -->
                                <template x-if="ipDetails?.first_seen">
                                    <p style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary);">
                                        <strong>First Seen:</strong> <span
                                            x-text="formatFlowTimestamp(ipDetails.first_seen)"></span>
                                        <template x-if="ipDetails?.is_new">
                                            <span style="margin-left: 6px; opacity: 0.7;"
                                                title="First seen within the last 24 hours">(New)</span>
                                        </template>
                                        <template x-if="!ipDetails?.is_new">
                                            <span style="margin-left: 6px; opacity: 0.6;"
                                                title="Previously seen host">(Known)</span>
                                        </template>
                                    </p>
                                </template>

                                <!-- Hardware Info (for discovered hosts) -->
                                <div x-show="ipDetails?.mac"
                                    style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <p><strong>MAC Address:</strong> <span class="font-mono text-cyan"
                                            x-text="ipDetails?.mac"></span></p>
                                    <p><strong>Vendor:</strong> <span class="text-muted"
                                            x-text="ipDetails?.vendor"></span>
                                    </p>
                                </div>
                            </div>

                            <!-- Reputation Context -->
                            <div class="card">
                                <h4
                                    style="margin-bottom: 10px; font-size: 0.95em; color: var(--text-secondary); font-weight: 500;">
                                    Reputation Context</h4>

                                <!-- Geographic Context -->
                                <template x-if="ipDetails?.geo">
                                    <div style="margin-bottom: 12px;">
                                        <template
                                            x-if="ipDetails.geo.country || ipDetails.geo.country_iso || ipDetails.geo.country_code">
                                            <p style="font-size: 0.9em; margin-bottom: 6px;">
                                                <strong style="color: var(--text-secondary);">Country:</strong>
                                                <span
                                                    x-text="ipDetails.geo.country || ipDetails.geo.country_iso || ipDetails.geo.country_code || 'N/A'"></span>
                                                <template
                                                    x-if="(ipDetails.geo.country_iso || ipDetails.geo.country_code) && (ipDetails.geo.country_iso || ipDetails.geo.country_code) !== ipDetails.geo.country">
                                                    <span style="color: var(--text-secondary); opacity: 0.7;"> (<span
                                                            x-text="ipDetails.geo.country_iso || ipDetails.geo.country_code"></span>)</span>
                                                </template>
                                            </p>
                                        </template>
                                        <template x-if="ipDetails.geo.asn">
                                            <p style="font-size: 0.9em; margin-bottom: 6px;">
                                                <strong style="color: var(--text-secondary);">ASN:</strong>
                                                <span x-text="ipDetails.geo.asn"></span>
                                                <template x-if="ipDetails.geo.asn_org">
                                                    <span style="color: var(--text-secondary); opacity: 0.8;"> ¬∑ <span
                                                            x-text="ipDetails.geo.asn_org"></span></span>
                                                </template>
                                            </p>
                                        </template>
                                    </div>
                                </template>

                                <!-- Threat List Presence (Passive, Informative) -->
                                <template x-if="ipDetails?.is_threat && ipDetails?.threat_info">
                                    <div
                                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);">
                                        <p style="font-size: 0.9em; margin-bottom: 6px;">
                                            <strong style="color: var(--text-secondary);">Threat List:</strong>
                                            <span style="color: var(--text-primary);"
                                                x-text="ipDetails.threat_info.feed || 'Unknown'"></span>
                                        </p>
                                        <template
                                            x-if="ipDetails.threat_info.category && ipDetails.threat_info.category !== 'UNKNOWN'">
                                            <p
                                                style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.8; margin-bottom: 4px;">
                                                Category: <span x-text="ipDetails.threat_info.category"></span>
                                            </p>
                                        </template>
                                        <template x-if="ipDetails.threat_info.mitre_name">
                                            <p style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.8;">
                                                MITRE: <span x-text="ipDetails.threat_info.mitre_name"></span>
                                                <template x-if="ipDetails.threat_info.mitre_technique">
                                                    <span style="opacity: 0.6;"> (<span
                                                            x-text="ipDetails.threat_info.mitre_technique"></span>)</span>
                                                </template>
                                            </p>
                                        </template>
                                    </div>
                                </template>

                                <!-- No threat list presence -->
                                <template x-if="!ipDetails?.is_threat">
                                    <div
                                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);">
                                        <p
                                            style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.7; font-style: italic;">
                                            Not present in known threat lists
                                        </p>
                                    </div>
                                </template>
                            </div>
                            <div class="card">
                                <p>‚¨ÜÔ∏è Upload: <strong class="text-green"
                                        x-text="fmtBytes(ipDetails?.direction?.upload || 0)"></strong></p>
                                <p>‚¨áÔ∏è Download: <strong class="text-green"
                                        x-text="fmtBytes(ipDetails?.direction?.download || 0)"></strong></p>
                            </div>
                        </div>

                        <!-- Activity Timeline -->
                        <div x-show="ipDetails?.timeline && (ipDetails.timeline.labels?.length > 0 || ipDetails.timeline.loading)"
                            style="margin-top: 20px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; font-size: 0.95em; color: var(--text-secondary);">Activity
                                Timeline (24h)</h3>
                            <div
                                style="position: relative; height: 120px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; padding: 8px;">
                                <div x-show="ipDetails?.timeline?.loading" class="spinner" style="margin: 40px auto;">
                                </div>
                                <canvas
                                    x-show="ipDetails?.timeline && !ipDetails.timeline.loading && ipDetails.timeline.labels?.length > 0"
                                    id="hostDetailTimelineChart"></canvas>
                                <div x-show="ipDetails?.timeline && !ipDetails.timeline.loading && (!ipDetails.timeline.labels || ipDetails.timeline.labels.length === 0)"
                                    style="text-align: center; padding: 40px; color: var(--text-secondary); font-size: 0.9em;">
                                    No activity data available
                                </div>
                            </div>
                        </div>

                        <h3>Ports & Protocols</h3>
                        <div class="grid">
                            <div class="card">
                                <h4>Src Ports</h4>
                                <template x-for="p in ipDetails?.src_ports">
                                    <div style="font-size:0.9em; margin-bottom:4px;">
                                        <span class="text-cyan" x-text="p.key"></span> (<span
                                            x-text="p.service"></span>):
                                        <span x-text="fmtBytes(p.bytes)"></span>
                                    </div>
                                </template>
                            </div>
                            <div class="card">
                                <h4>Dst Ports</h4>
                                <template x-for="p in ipDetails?.dst_ports">
                                    <div style="font-size:0.9em; margin-bottom:4px;">
                                        <span class="text-cyan" x-text="p.key"></span> (<span
                                            x-text="p.service"></span>):
                                        <span x-text="fmtBytes(p.bytes)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IP Deep Dive Investigation Modal -->
            <div class="modal" x-show="ipInvestigationModalOpen"
                :style="ipInvestigationModalOpen ? 'display:flex' : 'display:none'"
                @click.self="ipInvestigationModalOpen = false">
                <div class="modal-content"
                    style="max-width: 1200px; width: 90vw; height: 85vh; display: flex; flex-direction: column;">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 style="margin:0">üîç IP Deep Dive Investigation: <span class="text-cyan"
                                x-text="ipInvestigation.searchIP || 'Enter IP address'"></span></h2>
                        <button @click="ipInvestigationModalOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close IP investigation">√ó</button>
                    </div>

                    <div class="ip-investigation-content"
                        style="flex: 1; overflow-y: auto; padding: 0 var(--space-4) var(--space-4);">
                        <!-- Loading State -->
                        <div x-show="ipInvestigation.loading" style="text-align: center; padding: 60px 20px;">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <p style="color: var(--text-secondary);">Investigating IP address...</p>
                            <p
                                style="color: var(--text-tertiary); font-size: var(--text-xs); margin-top: var(--space-2);">
                                This may take a few seconds...</p>
                        </div>

                        <!-- Error State -->
                        <div x-show="ipInvestigation.error && !ipInvestigation.loading"
                            style="padding: var(--space-4); background: rgba(255, 0, 60, 0.1); border: 1px solid rgba(255, 0, 60, 0.3); border-radius: var(--radius-md); margin: var(--space-4) 0;">
                            <div style="display: flex; align-items: flex-start; gap: var(--space-2);">
                                <div style="font-size: 20px;">‚ö†Ô∏è</div>
                                <div style="flex: 1;">
                                    <strong
                                        style="color: var(--neon-red); display: block; margin-bottom: var(--space-1);">Investigation
                                        Failed</strong>
                                    <p style="color: var(--text-secondary); font-size: var(--text-sm); margin: 0 0 var(--space-3) 0;"
                                        x-text="ipInvestigation.error"></p>
                                    <button @click="investigateIP()" class="btn btn--secondary"
                                        style="font-size: var(--text-sm);">Retry Investigation</button>
                                </div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div x-show="!ipInvestigation.loading && ipInvestigation.result">
                            <!-- Quick Stats Cards -->
                            <div class="grid"
                                style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                                <div class="card" style="padding: var(--space-4);">
                                    <div
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                        Classification</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                        :class="ipInvestigation.result?.classification === 'Internal' ? 'text-green' : 'text-cyan'"
                                        x-text="ipInvestigation.result?.classification || 'N/A'"></div>
                                </div>
                                <div class="card" style="padding: var(--space-4);">
                                    <div
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                        Threat Status</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                        :class="ipInvestigation.result?.is_threat ? 'text-red' : 'text-green'"
                                        x-text="ipInvestigation.result?.is_threat ? '‚ö†Ô∏è THREAT' : '‚úÖ Clean'"></div>
                                </div>
                                <div class="card" style="padding: var(--space-4);">
                                    <div
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                        Total Traffic</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                        class="text-cyan" x-text="ipInvestigation.result?.total_bytes_fmt || 'N/A'">
                                    </div>
                                </div>
                                <div class="card" style="padding: var(--space-4);"
                                    x-show="ipInvestigation.result?.flow_count !== undefined">
                                    <div
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                        Total Flows</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                        class="text-cyan"
                                        x-text="(ipInvestigation.result?.flow_count || 0).toLocaleString()">
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Information Grid -->
                            <div class="grid"
                                style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                                <div class="card">
                                    <h4
                                        style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                        Geographic Information</h4>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                        <div>
                                            <strong style="color: var(--text-secondary);">Country:</strong>
                                            <span style="margin-left: var(--space-2);"
                                                x-text="ipInvestigation.result?.geo?.country || ipInvestigation.result?.country || 'N/A'"></span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary);">Region:</strong>
                                            <span style="margin-left: var(--space-2);"
                                                x-text="ipInvestigation.result?.region || ipInvestigation.result?.geo?.region || 'N/A'"></span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary);">City:</strong>
                                            <span style="margin-left: var(--space-2);"
                                                x-text="ipInvestigation.result?.geo?.city || 'N/A'"></span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary);">ASN:</strong>
                                            <span style="margin-left: var(--space-2);"
                                                x-text="ipInvestigation.result?.geo?.asn || ipInvestigation.result?.asn || 'N/A'"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.geo?.org">
                                            <strong style="color: var(--text-secondary);">Organization:</strong>
                                            <span style="margin-left: var(--space-2);"
                                                x-text="ipInvestigation.result?.geo?.org"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <h4
                                        style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                        Activity Summary</h4>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                        <div>
                                            <strong style="color: var(--text-secondary);">Hostname:</strong>
                                            <span style="margin-left: var(--space-2); font-family: var(--font-mono);"
                                                x-text="ipInvestigation.result?.hostname || 'N/A'"></span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary);">Classification:</strong>
                                            <span style="margin-left: var(--space-2);"
                                                :class="ipInvestigation.result?.classification === 'Internal' ? 'text-green' : 'text-cyan'"
                                                x-text="ipInvestigation.result?.classification || (ipInvestigation.result?.internal ? 'Internal' : 'External')"></span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary);">Total Traffic:</strong>
                                            <span style="margin-left: var(--space-2);" class="text-cyan"
                                                x-text="ipInvestigation.result?.total_bytes_fmt || 'N/A'"></span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary);">Total Flows:</strong>
                                            <span style="margin-left: var(--space-2);"
                                                x-text="ipInvestigation.result?.flow_count || 0"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Network Activity Card -->
                                <div class="card"
                                    x-show="ipInvestigation.result?.src_ports?.length || ipInvestigation.result?.dst_ports?.length || ipInvestigation.result?.protocols?.length">
                                    <h4
                                        style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                        Network Activity</h4>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                        <div x-show="ipInvestigation.result?.protocols?.length">
                                            <strong
                                                style="color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">Top
                                                Protocols:</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                                                <template
                                                    x-for="(proto, idx) in (ipInvestigation.result?.protocols || []).slice(0, 5)"
                                                    :key="idx">
                                                    <span class="badge"
                                                        style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                                        x-text="proto.proto_name || proto.key"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div
                                            x-show="ipInvestigation.result?.src_ports?.length || ipInvestigation.result?.dst_ports?.length">
                                            <strong
                                                style="color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">Active
                                                Ports:</strong>
                                            <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                                x-text="((ipInvestigation.result?.src_ports?.length || 0) + (ipInvestigation.result?.dst_ports?.length || 0)) + ' ports'">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Activity Timeline -->
                            <div class="card" style="margin-bottom: var(--space-6);"
                                x-show="ipInvestigation.timeline.labels && ipInvestigation.timeline.labels.length > 0">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                                    <h4
                                        style="margin: 0; font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                        üìà Activity Timeline</h4>
                                    <label
                                        style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); cursor: pointer;">
                                        <input type="checkbox" x-model="ipInvestigation.timeline.compareHistory"
                                            @change="loadIPTimeline(ipInvestigation.searchIP)" style="cursor: pointer;">
                                        <span>Compare with previous period</span>
                                    </label>
                                </div>
                                <div class="chart-wrapper" style="height: 250px;">
                                    <canvas id="ipInvestigationTimelineChart"></canvas>
                                </div>
                                <p
                                    style="margin-top: var(--space-2); font-size: var(--text-xs); color: var(--text-muted); text-align: center;">
                                    Traffic patterns over the selected time range (bytes and flow counts)
                                    <span x-show="ipInvestigation.timeline.compareHistory"> ‚Ä¢ Dashed lines show previous
                                        period</span>
                                </p>
                            </div>

                            <!-- Threat Intelligence -->
                            <div class="card" style="margin-bottom: var(--space-6);"
                                x-show="ipInvestigation.result?.threat_intel?.enabled">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    üõ°Ô∏è Threat Intelligence</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                    <!-- VirusTotal -->
                                    <div x-show="ipInvestigation.result?.threat_intel?.virustotal">
                                        <div
                                            style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                            <strong style="color: var(--text-secondary);">VirusTotal:</strong>
                                            <span
                                                x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'found'"
                                                class="badge"
                                                :class="(ipInvestigation.result?.threat_intel?.virustotal?.malicious || 0) > 0 ? 'badge--danger' : 'badge--success'"
                                                x-text="(ipInvestigation.result?.threat_intel?.virustotal?.malicious || 0) + ' malicious'"></span>
                                            <span
                                                x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'rate_limited'"
                                                class="badge badge--warning" x-text="'Rate Limited'"></span>
                                            <span
                                                x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'not_found'"
                                                class="badge" x-text="'Not Found'"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'found'"
                                            style="font-size: var(--text-sm); color: var(--text-secondary); margin-left: var(--space-4);">
                                            <div>Reputation: <span
                                                    x-text="ipInvestigation.result?.threat_intel?.virustotal?.reputation || 0"></span>
                                            </div>
                                            <div>Harmless: <span
                                                    x-text="ipInvestigation.result?.threat_intel?.virustotal?.harmless || 0"></span>
                                                ‚Ä¢ Suspicious: <span
                                                    x-text="ipInvestigation.result?.threat_intel?.virustotal?.suspicious || 0"></span>
                                            </div>
                                            <div x-show="ipInvestigation.result?.threat_intel?.virustotal?.as_owner">AS
                                                Owner:
                                                <span
                                                    x-text="ipInvestigation.result?.threat_intel?.virustotal?.as_owner"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- AbuseIPDB -->
                                    <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb">
                                        <div
                                            style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                            <strong style="color: var(--text-secondary);">AbuseIPDB:</strong>
                                            <span
                                                x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'found'"
                                                class="badge"
                                                :class="(ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) > 50 ? 'badge--danger' : (ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) > 25 ? 'badge--warning' : 'badge--success'"
                                                x-text="'Confidence: ' + (ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) + '%'"></span>
                                            <span
                                                x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'rate_limited'"
                                                class="badge badge--warning" x-text="'Rate Limited'"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'found'"
                                            style="font-size: var(--text-sm); color: var(--text-secondary); margin-left: var(--space-4);">
                                            <div>Reports: <span
                                                    x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.num_reports || 0"></span>
                                            </div>
                                            <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.usage_type">
                                                Usage:
                                                <span
                                                    x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.usage_type"></span>
                                            </div>
                                            <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.isp">ISP:
                                                <span
                                                    x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.isp"></span>
                                            </div>
                                            <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.is_known_attacker"
                                                class="badge badge--danger" style="margin-top: var(--space-1);">Known
                                                Attacker</div>
                                        </div>
                                    </div>
                                    <div x-show="!ipInvestigation.result?.threat_intel?.enabled"
                                        style="font-size: var(--text-xs); color: var(--text-muted);">
                                        Threat intelligence APIs not configured. Set VIRUSTOTAL_API_KEY and/or
                                        ABUSEIPDB_API_KEY environment variables to enable.
                                    </div>
                                </div>
                            </div>

                            <!-- Anomaly Detection -->
                            <div class="card" style="margin-bottom: var(--space-6);"
                                x-show="ipInvestigation.result?.anomalies && ipInvestigation.result.anomalies.length > 0">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    ‚ö†Ô∏è Detected Anomalies</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    <template x-for="(anomaly, idx) in ipInvestigation.result?.anomalies || []"
                                        :key="idx">
                                        <div style="padding: var(--space-3); background: rgba(255, 152, 0, 0.1); border-left: 3px solid rgba(255, 152, 0, 0.8); border-radius: var(--radius-sm);"
                                            :style="anomaly.severity === 'high' ? 'background: rgba(255, 0, 60, 0.1); border-left-color: rgba(255, 0, 60, 0.8);' : anomaly.severity === 'medium' ? 'background: rgba(255, 152, 0, 0.1); border-left-color: rgba(255, 152, 0, 0.8);' : 'background: rgba(100, 181, 246, 0.1); border-left-color: rgba(100, 181, 246, 0.8);'">
                                            <div
                                                style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                                <span class="badge"
                                                    :class="anomaly.severity === 'high' ? 'badge--danger' : anomaly.severity === 'medium' ? 'badge--warning' : 'badge--info'"
                                                    x-text="anomaly.severity.toUpperCase()"></span>
                                                <strong style="color: var(--text-primary);"
                                                    x-text="anomaly.message"></strong>
                                            </div>
                                            <div x-show="anomaly.port_count"
                                                style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                Port Count: <span x-text="anomaly.port_count"></span>
                                            </div>
                                            <div x-show="anomaly.ports"
                                                style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                Ports: <span x-text="anomaly.ports.join(', ')"></span>
                                            </div>
                                            <div x-show="anomaly.ratio"
                                                style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                Ratio: <span x-text="anomaly.ratio + ':1'"></span> (Upload: <span
                                                    x-text="anomaly.upload_mb + ' MB'"></span>, Download: <span
                                                    x-text="anomaly.download_mb + ' MB'"></span>)
                                            </div>
                                            <div x-show="anomaly.total_mb"
                                                style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                Total Traffic: <span x-text="anomaly.total_mb + ' MB'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Related IPs -->
                            <div class="card" style="margin-bottom: var(--space-6);"
                                x-show="ipInvestigation.result?.related_ips && ipInvestigation.result.related_ips.length > 0">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    üîó Related IPs</h4>
                                <p
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3);">
                                    IPs that directly communicate with this IP (as source or destination)
                                </p>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    <template
                                        x-for="(related, idx) in (ipInvestigation.result?.related_ips || []).slice(0, 10)"
                                        :key="idx">
                                        <div
                                            style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-2) var(--space-3); background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border-left: 3px solid var(--neon-cyan);">
                                            <div style="flex: 1; min-width: 0;">
                                                <div
                                                    style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                                    <span class="text-cyan"
                                                        style="font-family: var(--font-mono); font-weight: var(--font-weight-semibold); cursor: pointer;"
                                                        @click="openIPInvestigationModal(related.ip)"
                                                        x-text="related.ip" title="Click to investigate this IP"></span>
                                                    <span class="badge"
                                                        style="background: rgba(0,243,255,0.15); color: var(--neon-cyan); font-size: var(--text-xs);"
                                                        x-text="related.type === 'destination' ? 'Destination' : 'Source'"></span>
                                                    <span x-show="related.country_code"
                                                        x-text="flagFromIso(related.country_code)"
                                                        style="font-size: 16px;"></span>
                                                </div>
                                                <div style="font-size: var(--text-xs); color: var(--text-muted);">
                                                    <span x-text="fmtBytes(related.bytes)"></span>
                                                    <span style="margin: 0 var(--space-1);">‚Ä¢</span>
                                                    <span x-text="related.count + ' flows'"></span>
                                                    <span x-show="related.country" style="margin-left: var(--space-2);"
                                                        x-text="related.country"></span>
                                                </div>
                                            </div>
                                            <button @click="openIPInvestigationModal(related.ip)"
                                                class="btn btn--secondary"
                                                style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2); white-space: nowrap;">
                                                Investigate
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Export Actions -->
                            <div
                                style="display: flex; gap: var(--space-3); margin-bottom: var(--space-6); flex-wrap: wrap;">
                                <button @click="exportInvestigationResults('json')" class="btn btn--secondary"
                                    :disabled="!ipInvestigation.result">
                                    üì• Export JSON
                                </button>
                                <button @click="exportInvestigationResults('csv')" class="btn btn--secondary"
                                    :disabled="!ipInvestigation.result">
                                    üì• Export CSV
                                </button>
                                <button @click="copyInvestigationIP()" class="btn btn--secondary"
                                    :disabled="!ipInvestigation.searchIP">
                                    üìã Copy IP
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div x-show="!ipInvestigation.loading && !ipInvestigation.result"
                            style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <div style="font-size: 48px; margin-bottom: var(--space-4);" aria-hidden="true">üîç</div>
                            <p style="font-size: var(--text-lg); margin-bottom: var(--space-2);">Enter an IP address to
                                begin investigation</p>
                            <p style="font-size: var(--text-sm); color: var(--text-tertiary);">Use the search bar at the
                                top
                                of the Firewall page</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IP Trend Modal -->
            <div class="modal" x-show="trendModalOpen" :style="trendModalOpen ? 'display:flex' : 'display:none'"
                @click.self="trendModalOpen = false">
                <div class="modal-content" style="max-width: 760px;">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h2 style="margin:0">Trend: <span class="text-cyan" x-text="trendIP"></span> <span
                                style="color:var(--text-muted); font-size:0.7em"
                                x-text="'(' + (trendKind==='source' ? 'Source' : 'Destination') + ')' "></span></h2>
                        <button @click="trendModalOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close trend">√ó</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="ipTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Fullscreen Chart Modal -->
            <div class="modal fullscreen-chart-modal" x-show="fullscreenChart"
                :style="fullscreenChart ? 'display:flex' : 'display:none'" @click.self="closeFullscreenChart()">
                <div class="modal-content fullscreen-chart-content">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="margin:0"><span class="text-cyan" x-text="fullscreenChart?.title || 'Chart'"></span>
                        </h2>
                        <button @click="closeFullscreenChart()"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close fullscreen">√ó</button>
                    </div>
                    <div class="fullscreen-chart-wrapper">
                        <canvas id="fullscreenChartCanvas"></canvas>
                    </div>
                    <p style="text-align:center; color:var(--text-muted); font-size:0.8em; margin-top:12px;">Press
                        <kbd>ESC</kbd> or click outside to close
                    </p>
                </div>
            </div>

            <!-- Thresholds Modal -->
            <div class="modal" x-show="thresholdsModalOpen"
                :style="thresholdsModalOpen ? 'display:flex' : 'display:none'"
                @click.self="thresholdsModalOpen = false">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h2 style="margin:0">Threshold Settings</h2>
                        <button @click="thresholdsModalOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close settings">√ó</button>
                    </div>
                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                        <div class="card" style="min-height:auto;">
                            <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">Utilization (%)</h3>
                            <label>Warn <input type="number" min="0" max="100" x-model.number="thresholds.util_warn"
                                    style="width:80px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" min="0" max="100"
                                    x-model.number="thresholds.util_crit" style="width:80px; margin-left:8px"></label>
                        </div>
                        <div class="card" style="min-height:auto;">
                            <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">TCP Resets (/s)</h3>
                            <label>Warn <input type="number" step="0.1" x-model.number="thresholds.resets_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.resets_crit" style="width:90px; margin-left:8px"></label>
                        </div>
                        <div class="card" style="min-height:auto;">
                            <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">IP Errors (/s)</h3>
                            <label>Warn <input type="number" step="0.1" x-model.number="thresholds.ip_err_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.ip_err_crit" style="width:90px; margin-left:8px"></label>
                        </div>
                        <div class="card" style="min-height:auto;">
                            <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">ICMP Errors (/s)</h3>
                            <label>Warn <input type="number" step="0.1" x-model.number="thresholds.icmp_err_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.icmp_err_crit"
                                    style="width:90px; margin-left:8px"></label>
                        </div>
                        <div class="card" style="min-height:auto;">
                            <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">Interface Err/Disc
                                (/s)
                            </h3>
                            <label>Warn <input type="number" step="0.1" x-model.number="thresholds.if_err_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.if_err_crit" style="width:90px; margin-left:8px"></label>
                        </div>
                        <div class="card" style="min-height:auto;">
                            <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">TCP Reliability (/s)
                            </h3>
                            <div>
                                <label>Fails Warn <input type="number" step="0.1"
                                        x-model.number="thresholds.tcp_fails_warn"
                                        style="width:90px; margin-left:8px"></label>
                                <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                        x-model.number="thresholds.tcp_fails_crit"
                                        style="width:90px; margin-left:8px"></label>
                            </div>
                            <div style="margin-top:8px;">
                                <label>Retrans Warn <input type="number" step="0.1"
                                        x-model.number="thresholds.tcp_retrans_warn"
                                        style="width:90px; margin-left:8px"></label>
                                <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                        x-model.number="thresholds.tcp_retrans_crit"
                                        style="width:90px; margin-left:8px"></label>
                            </div>
                        </div>
                    </div>
                    <div class="modal__footer"
                        style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
                        <button class="btn btn--ghost" @click="thresholdsModalOpen=false">Cancel</button>
                        <button class="btn btn--primary" @click="saveThresholds()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Firewall Detail Modal -->
            <div class="modal" x-show="fwDetailOpen" :style="fwDetailOpen ? 'display:flex' : 'display:none'"
                @click.self="closeFwDetail()">
                <div class="modal-content fw-detail-modal" style="max-width: 500px;">
                    <template x-if="fwDetailType && fwDetails[fwDetailType]">
                        <div>
                            <div class="modal__header"
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                                <h2 style="margin:0" x-text="fwDetails[fwDetailType].title"></h2>
                                <button @click="closeFwDetail()"
                                    style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                                    aria-label="Close detail modal">√ó</button>
                            </div>

                            <p class="fw-detail-desc" x-text="fwDetails[fwDetailType].description"></p>

                            <div class="fw-detail-values">
                                <h4>üìä Current Values</h4>
                                <div class="fw-values-grid">
                                    <template x-for="field in fwDetails[fwDetailType].fields" :key="field">
                                        <div class="fw-value-item">
                                            <span class="fw-field-name"
                                                x-text="field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                            <span class="fw-field-value" x-text="getFwValue(field)"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <template x-if="fwDetails[fwDetailType].thresholds">
                                <div class="fw-detail-thresholds">
                                    <h4>‚ö†Ô∏è Thresholds</h4>
                                    <div class="fw-threshold-row">
                                        <span class="status-warning-badge">Warning: <span
                                                x-text="fwDetails[fwDetailType].thresholds.warning"></span></span>
                                        <span class="status-critical-badge">Critical: <span
                                                x-text="fwDetails[fwDetailType].thresholds.critical"></span></span>
                                    </div>
                                </div>
                            </template>

                            <template x-if="fwDetails[fwDetailType].tips && fwDetails[fwDetailType].tips.length">
                                <div class="fw-detail-tips">
                                    <h4>üí° Tips</h4>
                                    <ul>
                                        <template x-for="tip in fwDetails[fwDetailType].tips" :key="tip">
                                            <li x-text="tip"></li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Configuration Settings Modal -->
            <div class="modal" x-show="configModalOpen" :style="configModalOpen ? 'display:flex' : 'display:none'"
                @click.self="configModalOpen = false">
                <div class="modal-content config-modal" style="max-width: 420px;">
                    <div class="modal__header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h2 style="margin:0">‚öôÔ∏è Configuration Settings</h2>
                        <button @click="configModalOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close config modal">√ó</button>
                    </div>

                    <div x-show="configLoading" style="text-align:center; padding:20px;">
                        <div class="spinner"></div>
                        <p style="color:var(--text-muted); margin-top:10px;">Loading configuration...</p>
                    </div>

                    <div x-show="!configLoading" :style="!configLoading ? 'display:block' : 'display:none'">
                        <div class="config-section">
                            <h3>üåê Network</h3>
                            <div class="config-row">
                                <label>DNS Server</label>
                                <input type="text" x-model="config.dns_server" placeholder="192.168.0.6">
                                <span class="config-hint">Used for hostname resolution</span>
                            </div>
                            <div class="config-row">
                                <label>Internal Networks</label>
                                <input type="text" x-model="config.internal_networks"
                                    placeholder="192.168.0.0/16,10.0.0.0/8">
                                <span class="config-hint">CIDR notation, comma-separated</span>
                            </div>
                        </div>

                        <div class="config-section">
                            <h3>üì° SNMP (Firewall Monitoring)</h3>
                            <div class="config-row">
                                <label>SNMP Host</label>
                                <input type="text" x-model="config.snmp_host" placeholder="192.168.0.1">
                                <span class="config-hint">OPNsense/pfSense firewall IP</span>
                            </div>
                            <div class="config-row">
                                <label>SNMP Community</label>
                                <input type="password" x-model="config.snmp_community" placeholder="public">
                                <span class="config-hint">SNMP v2c community string</span>
                            </div>
                            <div class="config-row">
                                <label for="snmp-poll-interval">Poll Interval (sec)</label>
                                <input id="snmp-poll-interval" type="number" x-model.number="config.snmp_poll_interval"
                                    min="1" max="60" step="1" placeholder="Enter poll interval">
                                <span class="config-hint">How often to poll SNMP (1-60s)</span>
                            </div>
                        </div>

                        <div class="config-section">
                            <h3>üìä Analysis</h3>
                            <div class="config-row">
                                <label for="default-time-range">Default Time Range</label>
                                <select id="default-time-range" x-model="config.default_time_range"
                                    aria-label="Default Time Range">
                                    <option value="15m">15 minutes</option>
                                    <option value="30m">30 minutes</option>
                                    <option value="1h">1 hour</option>
                                    <option value="6h">6 hours</option>
                                    <option value="24h">24 hours</option>
                                    <option value="7d">7 days</option>
                                </select>
                                <span class="config-hint">Default time window for data queries</span>
                            </div>
                            <div class="config-row">
                                <label>Refresh Interval (ms)</label>
                                <input type="number" x-model.number="config.refresh_interval" min="5000" max="300000"
                                    step="1000" placeholder="30000">
                                <span class="config-hint">How often to refresh dashboard data (5-300 seconds)</span>
                            </div>
                        </div>

                        <div class="config-section">
                            <h3>üîß System Resources</h3>
                            <div class="config-row"
                                style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                                <div>
                                    <label style="margin: 0;">NetFlow Data</label>
                                    <span class="config-hint" style="display: block; margin-top: 2px;"
                                        x-text="serverHealth.netflow?.directory || 'Checking...'"></span>
                                </div>
                                <span class="server-stat-badge" :class="{
                                'badge-success': serverHealth.netflow?.available,
                                'badge-error': serverHealth.netflow && !serverHealth.netflow.available,
                                'badge-warning': serverHealth.loading
                            }" x-text="serverHealth.loading ? '...' : (serverHealth.netflow?.available ? '‚úì Loaded' : '‚úó Not Available')"></span>
                            </div>
                            <div class="config-row"
                                style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                                <div>
                                    <label style="margin: 0;">GeoIP Databases</label>
                                    <span class="config-hint" style="display: block; margin-top: 2px;"
                                        x-text="serverHealth.cache?.geo_cache_size !== undefined ? (serverHealth.cache.geo_cache_size.toLocaleString() + ' cached entries') : 'Checking...'"></span>
                                </div>
                                <span class="server-stat-badge" :class="{
                                'badge-success': serverHealth.cache?.geo_cache_size !== undefined && serverHealth.cache.geo_cache_size > 0,
                                'badge-error': serverHealth.cache?.geo_cache_size === 0,
                                'badge-warning': serverHealth.cache?.geo_cache_size === undefined
                            }" x-text="serverHealth.cache?.geo_cache_size === undefined ? '...' : (serverHealth.cache.geo_cache_size > 0 ? '‚úì Loaded' : '‚úó Not Available')"></span>
                            </div>
                            <div class="config-row"
                                style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                                <div>
                                    <label style="margin: 0;">Threat Feeds</label>
                                    <span class="config-hint" style="display: block; margin-top: 2px;"
                                        x-text="feedHealth.loading ? 'Checking...' : (feedHealth.summary ? (feedHealth.summary.total > 0 ? (feedHealth.summary.total_ips.toLocaleString() + ' IPs from ' + feedHealth.summary.total + ' feeds') : 'No feeds loaded') : 'Unable to load')"></span>
                                </div>
                                <span class="server-stat-badge" :class="{
                                'badge-success': feedHealth.summary && feedHealth.summary.ok > 0,
                                'badge-error': feedHealth.summary && feedHealth.summary.ok === 0 && feedHealth.summary.total > 0,
                                'badge-warning': !feedHealth.summary || feedHealth.loading || (feedHealth.summary && feedHealth.summary.total === 0)
                            }" x-text="feedHealth.loading ? '...' : (!feedHealth.summary ? 'Error' : (feedHealth.summary.ok > 0 ? '‚úì Loaded' : (feedHealth.summary.total === 0 ? 'Not Configured' : '‚úó Not Available')))"></span>
                            </div>
                            <p
                                style="color: var(--text-muted); font-size: 0.75em; margin-top: 8px; font-style: italic;">
                                System resources are configured via Docker environment variables and cannot be changed
                                from the UI.</p>
                        </div>

                        <div class="modal__footer"
                            style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px; padding-top:16px; border-top:1px solid var(--card-border);">
                            <button class="btn btn--ghost" @click="configModalOpen = false">Cancel</button>
                            <button class="btn btn--primary" @click="saveConfig()" :disabled="configSaving">
                                <span x-show="!configSaving">üíæ Save Configuration</span>
                                <span x-show="configSaving">Saving...</span>
                            </button>
                        </div>

                        <p style="color:var(--text-muted); font-size:0.8em; margin-top:12px; text-align:center;">‚ö†Ô∏è Some
                            changes require a service restart to take full effect</p>
                    </div>
                </div>
            </div>

            <!-- Watchlist Manager Modal -->
            <div class="modal" x-show="watchlistModalOpen" :style="watchlistModalOpen ? 'display:flex' : 'display:none'"
                @click.self="watchlistModalOpen = false">
                <div class="modal-content" style="max-width: 500px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h2 style="margin:0">üëÅÔ∏è IP Watchlist</h2>
                        <button @click="watchlistModalOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close watchlist modal">√ó</button>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 12px;">Monitor specific IPs for
                        any
                        network activity. Matches will appear in threat detections.</p>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" x-model="watchlistInput" aria-label="IP address to add to watchlist"
                            placeholder="Enter IP address (e.g., 192.168.1.100)"
                            style="flex: 1; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--neon-cyan); border-radius: 4px; color: #fff;">
                        <button class="btn btn--primary" @click="addToWatchlist()" :disabled="!watchlistInput"
                            title="Add IP to watchlist">‚ûï Add</button>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <template x-if="watchlist.watchlist && watchlist.watchlist.length > 0">
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <template x-for="entry in watchlist.watchlist" :key="entry.ip">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(0,243,255,0.05); border: 1px solid rgba(0,243,255,0.1); border-radius: 4px;">
                                        <div>
                                            <span style="color: var(--neon-yellow);" x-text="entry.ip"></span>
                                            <span style="font-size: 0.8em; color: var(--text-muted); margin-left: 8px;"
                                                x-text="'added ' + entry.added_ago"></span>
                                        </div>
                                        <button class="btn btn--danger" @click="removeFromWatchlist(entry.ip)"
                                            title="Remove from watchlist"
                                            style="padding: 4px 8px; font-size: 0.85em;">üóëÔ∏è</button>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!watchlist.watchlist || watchlist.watchlist.length === 0">
                            <div style="color: var(--text-muted); text-align: center; padding: 24px;">
                                No IPs in watchlist. Add IPs above to monitor them.
                            </div>
                        </template>
                    </div>
                    <div
                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,243,255,0.1); text-align: right;">
                        <span style="color: var(--text-muted); font-size: 0.85em;"
                            x-text="(watchlist.count || 0) + ' IPs in watchlist'"></span>
                    </div>
                </div>
            </div>

            <!-- Flow Details Modal -->
            <div class="modal" x-show="flowDetailsModalOpen"
                :style="flowDetailsModalOpen ? 'display:flex' : 'display:none'" @click.self="closeFlowDetailsModal()"
                @keydown.escape.window="closeFlowDetailsModal()" x-data="{ flow: selectedFlow }">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal__header">
                        <div style="flex: 1;">
                            <h2
                                style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                                <span class="text-cyan" x-text="selectedFlow?.src || ''"></span>
                                <span x-text="selectedFlow ? (getDirectionIndicator(selectedFlow)?.symbol || '‚Üí') : '‚Üí'"
                                    :style="selectedFlow ? ('color: ' + (getDirectionIndicator(selectedFlow)?.color || 'var(--text-muted)') + '; font-size: 1.1em;') : 'color: var(--text-muted); font-size: 1.1em;'"></span>
                                <span class="text-cyan" x-text="selectedFlow?.dst || ''"></span>
                                <span class="text-muted"
                                    style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                    x-text="selectedFlow?.proto_name || ''"></span>
                            </h2>
                        </div>
                        <button @click="closeFlowDetailsModal()"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                            aria-label="Close flow details">√ó</button>
                    </div>

                    <div style="padding: var(--space-4) 0;">
                        <!-- Identity Section (only if data exists) -->
                        <template
                            x-if="selectedFlow && (selectedFlow.src_hostname || selectedFlow.dst_hostname || selectedFlow.src_country || selectedFlow.dst_country)">
                            <div class="card"
                                style="margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.03); border: 1px solid rgba(0, 234, 255, 0.1);">
                                <h3
                                    style="margin: 0 0 var(--space-2) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Identity</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                    <!-- Source Identity -->
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Source</div>
                                        <div x-show="selectedFlow?.src_hostname"
                                            style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                            <span class="text-muted">Hostname:</span> <span
                                                x-text="selectedFlow.src_hostname"></span>
                                        </div>
                                        <div x-show="selectedFlow?.src_country"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            <span class="text-muted">Location:</span>
                                            <span x-show="selectedFlow.src_flag"
                                                :class="'flag-icon flag-icon-' + (selectedFlow.src_country_code || 'unknown').toLowerCase()"
                                                style="margin: 0 4px;"></span>
                                            <span x-text="selectedFlow.src_country || 'Unknown'"></span>
                                        </div>
                                    </div>
                                    <!-- Destination Identity -->
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Destination</div>
                                        <div x-show="selectedFlow?.dst_hostname"
                                            style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                            <span class="text-muted">Hostname:</span> <span
                                                x-text="selectedFlow.dst_hostname"></span>
                                        </div>
                                        <div x-show="selectedFlow?.dst_country"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            <span class="text-muted">Location:</span>
                                            <span x-show="selectedFlow.dst_flag"
                                                :class="'flag-icon flag-icon-' + (selectedFlow.dst_country_code || 'unknown').toLowerCase()"
                                                style="margin: 0 4px;"></span>
                                            <span x-text="selectedFlow.dst_country || 'Unknown'"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Flow Metrics -->
                        <div class="card" style="margin-bottom: var(--space-4); padding: var(--space-3);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Flow Metrics</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        First Seen</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedFlow?.first_seen_ts ? formatFlowTimestamp(selectedFlow.first_seen_ts) : (selectedFlow?.age_seconds ? formatAge(selectedFlow.age_seconds) + ' ago' : 'Unknown')">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Duration</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedFlow?.duration || selectedFlow?.duration_seconds ? (selectedFlow.duration || selectedFlow.duration_seconds + 's') : 'Unknown'">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Bytes</div>
                                    <div style="font-size: var(--text-sm); color: var(--signal-ok); font-weight: 500;"
                                        x-text="selectedFlow?.bytes_fmt || '0 B'"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Packets</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="(selectedFlow?.packets || 0).toLocaleString()"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Average Rate</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedFlow ? calculateFlowRate(selectedFlow) : '0 B/s'"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Direction</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedFlow?.direction ? selectedFlow.direction.charAt(0).toUpperCase() + selectedFlow.direction.slice(1) : 'Unknown'">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ports & Protocol Details -->
                        <div class="card" style="padding: var(--space-3);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Ports & Protocol</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Source Port</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedFlow?.src_port || 'Unknown'"></div>
                                    <div x-show="selectedFlow?.service && selectedFlow.service !== 'unknown' && selectedFlow.service !== selectedFlow.src_port"
                                        style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="selectedFlow?.service ? 'Service: ' + selectedFlow?.service : ''"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Destination Port</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedFlow?.dst_port || 'Unknown'"></div>
                                    <div x-show="selectedFlow?.service && selectedFlow.service !== 'unknown' && selectedFlow.service !== selectedFlow.dst_port"
                                        style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="selectedFlow?.service ? 'Service: ' + selectedFlow?.service : ''"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Interesting Flow Characteristics (Phase 2) -->
                        <template x-if="selectedFlow?.interesting_flags && selectedFlow.interesting_flags.length > 0">
                            <div class="card"
                                style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.02); border: 1px solid rgba(0, 234, 255, 0.08);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Interesting Characteristics</h3>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    <template x-for="flag in selectedFlow.interesting_flags" :key="flag">
                                        <div
                                            style="display: flex; align-items: flex-start; gap: var(--space-2); font-size: var(--text-sm);">
                                            <span style="font-size: 1em; opacity: 0.7;"
                                                x-text="getInterestingFlowIcon(flag)"></span>
                                            <div style="flex: 1; color: var(--text-secondary);">
                                                <div style="font-weight: 500; margin-bottom: 2px;"
                                                    x-text="getInterestingFlowTooltip(flag).split(':')[0]"></div>
                                                <div style="font-size: var(--text-xs); color: var(--text-tertiary);"
                                                    x-text="getInterestingFlowTooltip(flag).split(':').slice(1).join(':').trim() || getInterestingFlowTooltip(flag)">
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div
                                    style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(0, 234, 255, 0.1); font-size: var(--text-xs); color: var(--text-tertiary);">
                                    These are informational hints to help identify unusual patterns. They are not alerts
                                    or
                                    threats.
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Actions -->
                    <div class="modal__footer">
                        <button class="btn btn--secondary" @click="openIPInvestigationModal(selectedFlow?.src)"
                            :disabled="!selectedFlow?.src">
                            Investigate Source IP
                        </button>
                        <button class="btn btn--secondary" @click="openIPInvestigationModal(selectedFlow?.dst)"
                            :disabled="!selectedFlow?.dst">
                            Investigate Destination IP
                        </button>
                        <button class="btn btn--primary"
                            @click="addToWatchlist(selectedFlow?.src); closeFlowDetailsModal();"
                            :disabled="!selectedFlow?.src" title="Add source IP to watchlist">
                            Add Source to Watchlist
                        </button>
                    </div>
                </div>
            </div>

            <!-- Unified Event Details Modal (Flow, Firewall, Threat) -->
            <div class="modal" x-show="eventDetailsModalOpen"
                :style="eventDetailsModalOpen ? 'display:flex' : 'display:none'" @click.self="closeEventDetailsModal()"
                @keydown.escape.window="closeEventDetailsModal()">
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal__header">
                        <div style="flex: 1;">
                            <!-- Flow Header -->
                            <template x-if="selectedEventType === 'flow'">
                                <h2
                                    style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                                    <span class="text-cyan" x-text="selectedEvent?.src || ''"></span>
                                    <span x-text="getDirectionIndicator(selectedEvent)?.symbol || '‚Üí'"
                                        :style="'color: ' + (getDirectionIndicator(selectedEvent)?.color || 'var(--text-muted)') + '; font-size: 1.1em;'"></span>
                                    <span class="text-cyan" x-text="selectedEvent?.dst || ''"></span>
                                    <span class="text-muted"
                                        style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                        x-text="selectedEvent?.proto_name || ''"></span>
                                </h2>
                            </template>
                            <!-- Firewall Header -->
                            <template x-if="selectedEventType === 'firewall'">
                                <h2
                                    style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                                    <span class="text-green" x-text="selectedEvent?.src_ip || ''"></span>
                                    <span style="color: var(--text-muted);">‚Üí</span>
                                    <span class="text-cyan" x-text="selectedEvent?.dst_ip || ''"></span>
                                    <span class="text-muted"
                                        style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                        x-text="(selectedEvent?.proto || 'TCP').toUpperCase()"></span>
                                </h2>
                            </template>
                            <!-- Threat Header -->
                            <template x-if="selectedEventType === 'threat'">
                                <h2
                                    style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                                    <span class="text-red"
                                        x-text="selectedEvent?.ip || selectedEvent?.src_ip || ''"></span>
                                    <span class="text-muted"
                                        style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                        x-text="selectedEvent?.threat_type || 'Threat'"></span>
                                </h2>
                            </template>
                        </div>
                        <button @click="closeEventDetailsModal()"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                            aria-label="Close event details">√ó</button>
                    </div>

                    <div style="padding: var(--space-4) 0;">
                        <!-- Flow Content -->
                        <template x-if="selectedEventType === 'flow'">
                            <!-- Identity Section (only if data exists) -->
                            <template
                                x-if="selectedEvent && (selectedEvent.src_hostname || selectedEvent.dst_hostname || selectedEvent.src_country || selectedEvent.dst_country)">
                                <div class="card"
                                    style="margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.03); border: 1px solid rgba(0, 234, 255, 0.1);">
                                    <h3
                                        style="margin: 0 0 var(--space-2) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                        Identity</h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                        <div>
                                            <div
                                                style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                                Source</div>
                                            <div x-show="selectedEvent?.src_hostname"
                                                style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                                <span class="text-muted">Hostname:</span> <span
                                                    x-text="selectedEvent.src_hostname"></span>
                                            </div>
                                            <div x-show="selectedEvent?.src_country"
                                                style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                <span class="text-muted">Location:</span>
                                                <span x-show="selectedEvent.src_flag"
                                                    :class="'flag-icon flag-icon-' + (selectedEvent.src_country_code || 'unknown').toLowerCase()"
                                                    style="margin: 0 4px;"></span>
                                                <span x-text="selectedEvent.src_country || 'Unknown'"></span>
                                            </div>
                                        </div>
                                        <div>
                                            <div
                                                style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                                Destination</div>
                                            <div x-show="selectedEvent?.dst_hostname"
                                                style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                                <span class="text-muted">Hostname:</span> <span
                                                    x-text="selectedEvent.dst_hostname"></span>
                                            </div>
                                            <div x-show="selectedEvent?.dst_country"
                                                style="font-size: var(--text-sm); color: var(--text-secondary);">
                                                <span class="text-muted">Location:</span>
                                                <span x-show="selectedEvent.dst_flag"
                                                    :class="'flag-icon flag-icon-' + (selectedEvent.dst_country_code || 'unknown').toLowerCase()"
                                                    style="margin: 0 4px;"></span>
                                                <span x-text="selectedEvent.dst_country || 'Unknown'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <!-- Flow Metrics -->
                            <div class="card" style="margin-bottom: var(--space-4); padding: var(--space-3);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Flow Metrics</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            First Seen</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.first_seen_ts ? formatFlowTimestamp(selectedEvent.first_seen_ts) : (selectedEvent?.age_seconds ? formatAge(selectedEvent.age_seconds) + ' ago' : 'Unknown')">
                                        </div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Duration</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.duration || selectedEvent?.duration_seconds ? (selectedEvent.duration || selectedEvent.duration_seconds + 's') : 'Unknown'">
                                        </div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Bytes</div>
                                        <div style="font-size: var(--text-sm); color: var(--signal-ok); font-weight: 500;"
                                            x-text="selectedEvent?.bytes_fmt || '0 B'"></div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Packets</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="(selectedEvent?.packets || 0).toLocaleString()"></div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Average Rate</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent ? calculateFlowRate(selectedEvent) : '0 B/s'"></div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Direction</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.direction ? selectedEvent.direction.charAt(0).toUpperCase() + selectedEvent.direction.slice(1) : 'Unknown'">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Ports & Protocol Details -->
                            <div class="card" style="padding: var(--space-3);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Ports & Protocol</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Source Port</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.src_port || 'Unknown'"></div>
                                        <div x-show="selectedEvent?.service && selectedEvent.service !== 'unknown' && selectedEvent.service !== selectedEvent.src_port"
                                            style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                            x-text="'Service: ' + selectedEvent.service"></div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Destination Port</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.dst_port || 'Unknown'"></div>
                                        <div x-show="selectedEvent?.service && selectedEvent.service !== 'unknown' && selectedEvent.service !== selectedEvent.dst_port"
                                            style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                            x-text="'Service: ' + selectedEvent.service"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Detection (Phase 2) -->
                            <template x-if="selectedEvent?.is_detected">
                                <div class="card"
                                    style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(255, 200, 0, 0.08); border: 1px solid rgba(255, 200, 0, 0.25);">
                                    <h3
                                        style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--neon-yellow); font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                        <span>‚ö†Ô∏è</span>
                                        <span>Detection: Long-Lived Low-Volume External Flow</span>
                                    </h3>
                                    <div
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3); line-height: 1.5;">
                                        <div
                                            x-text="selectedEvent?.detection_reason || 'This flow matches detection criteria for suspicious behavior.'">
                                        </div>
                                    </div>
                                    <div
                                        style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(255, 200, 0, 0.2); font-size: var(--text-xs); color: var(--text-tertiary);">
                                        Detection criteria: Duration > 5 minutes AND bytes < 100 KB AND external flow
                                            (not internal). This pattern may indicate persistent C2, data exfiltration,
                                            or beaconing activity. </div>
                                    </div>
                            </template>
                            <!-- Threat Correlation (Phase 1) -->
                            <template x-if="selectedEvent?.has_threat">
                                <div class="card"
                                    style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(255, 0, 60, 0.05); border: 1px solid rgba(255, 0, 60, 0.15);">
                                    <h3
                                        style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--neon-red); font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                        <span>üõ°Ô∏è</span>
                                        <span>Threat Correlation</span>
                                    </h3>
                                    <div
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3);">
                                        This flow contains <strong style="color: var(--neon-red);"
                                            x-text="selectedEvent?.threat_count || 0"></strong> threat IP(s) from known
                                        threat
                                        intelligence feeds.
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                        <template x-for="(threat, idx) in selectedEvent?.threat_info || []" :key="idx">
                                            <div
                                                style="display: flex; align-items: flex-start; gap: var(--space-2); font-size: var(--text-sm); padding: var(--space-2); background: rgba(255, 0, 60, 0.05); border-radius: var(--radius-sm);">
                                                <div style="flex: 1;">
                                                    <div
                                                        style="font-weight: 500; color: var(--text-primary); margin-bottom: 2px;">
                                                        <span class="text-red" x-text="threat.ip"></span>
                                                    </div>
                                                    <div
                                                        style="font-size: var(--text-xs); color: var(--text-tertiary);">
                                                        <span>Category: </span><span
                                                            x-text="threat.category || 'UNKNOWN'"></span>
                                                        <span style="margin-left: var(--space-2);">Feed: </span><span
                                                            x-text="threat.feed || 'unknown'"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <div
                                        style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(255, 0, 60, 0.2); font-size: var(--text-xs); color: var(--text-tertiary);">
                                        Threat correlation is informational. This flow involves IPs from threat
                                        intelligence
                                        feeds.
                                    </div>
                                </div>
                            </template>
                            <!-- Flow History Timeline (Phase 3) -->
                            <template x-if="selectedEvent?.history && selectedEvent.history.length > 1">
                                <div class="card"
                                    style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.02); border: 1px solid rgba(0, 234, 255, 0.08);">
                                    <h3
                                        style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                        Flow History (Last 60 min)</h3>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-3);">
                                        This flow pattern has occurred <strong
                                            x-text="selectedEvent.history.length"></strong>
                                        time(s) in the last hour.
                                    </div>
                                    <div
                                        style="display: flex; flex-direction: column; gap: var(--space-2); max-height: 200px; overflow-y: auto;">
                                        <template
                                            x-for="(entry, idx) in selectedEvent.history.slice().reverse().slice(0, 10)"
                                            :key="idx">
                                            <div
                                                style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-2); background: rgba(0, 234, 255, 0.03); border-radius: var(--radius-sm); font-size: var(--text-xs);">
                                                <div style="color: var(--text-secondary);">
                                                    <span
                                                        x-text="new Date(entry.ts * 1000).toLocaleTimeString()"></span>
                                                    <span
                                                        style="margin-left: var(--space-2); color: var(--text-tertiary);"
                                                        x-text="'(' + timeAgo(entry.ts) + ')'"></span>
                                                </div>
                                                <div
                                                    style="display: flex; gap: var(--space-3); color: var(--text-secondary);">
                                                    <span><strong class="text-cyan"
                                                            x-text="fmtBytes(entry.bytes)"></strong></span>
                                                    <span style="color: var(--text-tertiary);"
                                                        x-text="entry.packets + ' pkts'"></span>
                                                    <span style="color: var(--text-tertiary);"
                                                        x-text="entry.duration.toFixed(1) + 's'"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <div
                                        style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(0, 234, 255, 0.1); font-size: var(--text-xs); color: var(--text-tertiary);">
                                        History aggregated by source, destination, and port. Shows recurring patterns.
                                    </div>
                                </div>
                            </template>
                            <!-- Interesting Flow Characteristics (Phase 2) -->
                            <template
                                x-if="selectedEvent?.interesting_flags && selectedEvent.interesting_flags.length > 0">
                                <div class="card"
                                    style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.02); border: 1px solid rgba(0, 234, 255, 0.08);">
                                    <h3
                                        style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                        Interesting Characteristics</h3>
                                    <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                        <template x-for="flag in selectedEvent.interesting_flags" :key="flag">
                                            <div
                                                style="display: flex; align-items: flex-start; gap: var(--space-2); font-size: var(--text-sm);">
                                                <span style="font-size: 1em; opacity: 0.7;"
                                                    x-text="getInterestingFlowIcon(flag)"></span>
                                                <div style="flex: 1; color: var(--text-secondary);">
                                                    <div style="font-weight: 500; margin-bottom: 2px;"
                                                        x-text="getInterestingFlowTooltip(flag).split(':')[0]"></div>
                                                    <div style="font-size: var(--text-xs); color: var(--text-tertiary);"
                                                        x-text="getInterestingFlowTooltip(flag).split(':').slice(1).join(':').trim() || getInterestingFlowTooltip(flag)">
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <div
                                        style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(0, 234, 255, 0.1); font-size: var(--text-xs); color: var(--text-tertiary);">
                                        These are informational hints to help identify unusual patterns. They are not
                                        alerts
                                        or
                                        threats.
                                    </div>
                                </div>
                            </template>
                        </template>

                        <!-- Firewall Content -->
                        <template x-if="selectedEventType === 'firewall'">
                            <!-- Firewall Event Details -->
                            <div class="card" style="margin-bottom: var(--space-4); padding: var(--space-3);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Event Details</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Timestamp</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500; font-family: monospace;"
                                            x-text="(selectedEvent?.timestamp || selectedEvent?.timestamp_iso || '').replace('T', ' ').split('.')[0] || 'Unknown'">
                                        </div>
                                        <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                            x-text="selectedEvent?.timestamp_ts ? timeAgo(selectedEvent.timestamp_ts) : ''">
                                        </div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Action</div>
                                        <div>
                                            <span class="badge"
                                                :style="(selectedEvent?.action === 'pass') ? 'background: rgba(0,255,100,0.2); color: var(--neon-green);' : 'background: rgba(255,0,60,0.2); color: var(--neon-red);'"
                                                x-text="(selectedEvent?.action || 'block').toUpperCase()"></span>
                                            <div x-show="selectedEvent?.is_threat"
                                                style="font-size: var(--text-xs); color: var(--neon-red); margin-top: var(--space-1);">
                                                Threat Detected</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Direction</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            :class="selectedEvent?.direction === 'in' ? 'text-green' : 'text-cyan'"
                                            x-text="(selectedEvent?.direction || 'in').toUpperCase()"></div>
                                        <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                            x-text="'Interface: ' + (selectedEvent?.interface || '-')"></div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Protocol</div>
                                        <div>
                                            <span class="badge"
                                                style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                                x-text="(selectedEvent?.proto || 'TCP').toUpperCase()"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Connection Details -->
                            <div class="card" style="padding: var(--space-3);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Connection</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Source</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.src_ip || 'Unknown'"></div>
                                        <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                            x-text="selectedEvent?.src_port ? 'Port: ' + selectedEvent.src_port : ''">
                                        </div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Destination</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.dst_ip || 'Unknown'"></div>
                                        <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                            x-text="selectedEvent?.dst_port ? 'Port: ' + selectedEvent.dst_port : ''">
                                        </div>
                                        <div x-show="selectedEvent?.service"
                                            style="font-size: var(--text-xs); color: var(--text-muted);"
                                            x-text="'Service: ' + selectedEvent.service"></div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Threat Content -->
                        <template x-if="selectedEventType === 'threat'">
                            <div class="card" style="padding: var(--space-3);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Threat Details</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            IP Address</div>
                                        <div style="font-size: var(--text-sm); color: var(--neon-red); font-weight: 500;"
                                            x-text="selectedEvent?.ip || selectedEvent?.src_ip || 'Unknown'"></div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Threat Type</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="selectedEvent?.threat_type || 'Unknown'"></div>
                                    </div>
                                    <div x-show="selectedEvent?.threat_feed">
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Threat Feed</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                            x-text="selectedEvent.threat_feed"></div>
                                    </div>
                                    <div x-show="selectedEvent?.country">
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Country</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                            x-text="selectedEvent.country"></div>
                                    </div>
                                    <div x-show="selectedEvent?.hits !== undefined">
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Occurrences</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                            x-text="(selectedEvent.hits || 0).toLocaleString() + ' hits'"></div>
                                    </div>
                                    <div x-show="selectedEvent?.category">
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Category</div>
                                        <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                            x-text="selectedEvent.category"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Actions -->
                    <div class="modal__footer">
                        <!-- Flow Actions -->
                        <template x-if="selectedEventType === 'flow'">
                            <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                <button class="btn btn--secondary"
                                    @click="openIPInvestigationModal(selectedEvent?.src); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.src">
                                    Investigate Source IP
                                </button>
                                <button class="btn btn--secondary"
                                    @click="openIPInvestigationModal(selectedEvent?.dst); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.dst">
                                    Investigate Destination IP
                                </button>
                                <button class="btn btn--primary"
                                    @click="addToWatchlist(selectedEvent?.src); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.src" title="Add source IP to watchlist">
                                    Add Source to Watchlist
                                </button>
                            </div>
                        </template>
                        <!-- Firewall Actions -->
                        <template x-if="selectedEventType === 'firewall'">
                            <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                <button class="btn btn--secondary"
                                    @click="openIPInvestigationModal(selectedEvent?.src_ip); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.src_ip">
                                    Investigate Source IP
                                </button>
                                <button class="btn btn--secondary"
                                    @click="openIPInvestigationModal(selectedEvent?.dst_ip); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.dst_ip">
                                    Investigate Destination IP
                                </button>
                                <button class="btn btn--primary"
                                    @click="addToWatchlist(selectedEvent?.src_ip); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.src_ip" title="Add source IP to watchlist">
                                    Add Source to Watchlist
                                </button>
                            </div>
                        </template>
                        <!-- Threat Actions -->
                        <template x-if="selectedEventType === 'threat'">
                            <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                <button class="btn btn--secondary"
                                    @click="openIPInvestigationModal(selectedEvent?.ip || selectedEvent?.src_ip); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.ip && !selectedEvent?.src_ip">
                                    Investigate IP
                                </button>
                                <button class="btn btn--primary"
                                    @click="addToWatchlist(selectedEvent?.ip || selectedEvent?.src_ip); closeEventDetailsModal();"
                                    :disabled="!selectedEvent?.ip && !selectedEvent?.src_ip"
                                    title="Add IP to watchlist">
                                    Add to Watchlist
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Widget Manager Modal -->
            <div class="modal" x-show="widgetManagerOpen" :style="widgetManagerOpen ? 'display:flex' : 'display:none'"
                @click.self="widgetManagerOpen = false">
                <div class="modal-content" style="max-width: 600px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h2 style="margin:0">Customize Widgets</h2>
                        <button @click="widgetManagerOpen = false"
                            style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                            aria-label="Close widget manager">√ó</button>
                    </div>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <div style="display: grid; gap: 10px;">
                            <template x-for="(visible, widgetId) in widgetVisibility" :key="widgetId">
                                <div
                                    style="display: flex; align-items: center; padding: 10px; background: rgba(0,243,255,0.05); border-radius: 4px; border: 1px solid rgba(0,243,255,0.1); justify-content: space-between;">
                                    <label
                                        style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <input type="checkbox" :checked="visible" @change="toggleWidget(widgetId)"
                                            style="cursor: pointer;">
                                        <span x-text="getWidgetLabel(widgetId)"></span>
                                    </label>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div
                        style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,243,255,0.1); display:flex; justify-content:space-between; gap:10px;">
                        <button class="btn btn--danger" @click="resetWidgetPreferences()">Reset All</button>
                        <button class="btn btn--ghost" @click="widgetManagerOpen=false">Close</button>
                    </div>
                </div>
            </div>

            <!-- Keyboard Shortcuts Hint -->
            <div class="keyboard-hint" title="Press ? for all shortcuts">
                <kbd>R</kbd> Refresh <kbd>P</kbd> Pause <kbd>1-6</kbd> Time
            </div>

            <!-- Sticky Status Bar -->
            <div class="status-bar"
                style="display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: center; gap: var(--space-3);">
                <!-- System Metrics -->
                <div class="status-bar-item">
                    <span class="status-bar-dot"
                        :class="{ 'warning': firewall.cpu_percent >= 70, 'disconnected': firewall.cpu_percent >= 90 }"></span>
                    <span class="label">CPU:</span>
                    <span class="value"
                        :class="{ 'warning': firewall.cpu_percent >= 70, 'critical': firewall.cpu_percent >= 90 }"
                        x-text="(firewall.cpu_percent || '--') + '%'"></span>
                </div>
                <div class="status-bar-item">
                    <span class="label">MEM:</span>
                    <span class="value"
                        :class="{ 'warning': firewall.mem_percent >= 70, 'critical': firewall.mem_percent >= 90 }"
                        x-text="(firewall.mem_percent || '--') + '%'"></span>
                </div>
                <!-- Network Metrics -->
                <div class="status-bar-item">
                    <span class="label">Threats:</span>
                    <span class="value" :class="{ 'critical': threats.hits.length > 0 }"
                        x-text="threats.hits.length"></span>
                </div>
                <div class="status-bar-item">
                    <span class="label">Flows:</span>
                    <span class="value" x-text="Number(summary.totals.flows || 0).toLocaleString()"></span>
                </div>
                <!-- Status -->
                <div class="status-bar-item">
                    <span class="status-bar-dot" :class="{ 'disconnected': !firewallStreamActive && !initDone }"></span>
                    <span class="label">Status:</span>
                    <span class="value" x-text="paused ? 'Paused' : 'Live'"></span>
                </div>
                <!-- Performance & Timing -->
                <div class="status-bar-item latency-indicator" x-show="avgLatency !== null">
                    <span class="label">API:</span>
                    <span class="value" :class="latencyClass" x-text="avgLatency + 'ms'"></span>
                </div>
                <div class="status-bar-item">
                    <span class="label">Next:</span>
                    <span class="value" style="color: var(--text-muted);"
                        x-text="paused ? '--' : refreshCountdown + 's'"></span>
                </div>
                <div class="status-bar-item">
                    <span class="label">Up:</span>
                    <span class="value" style="color: var(--text-muted);" x-text="lastUpdate"></span>
                </div>
            </div>

            <!-- Mobile Bottom Navigation -->
            <nav class="mobile-nav">
                <button class="mobile-nav-item" :class="{ 'active': activeTab === 'overview' }"
                    @click="loadTab('overview')" title="Overview">
                    <span class="mobile-nav-icon">üìä</span>
                    <span class="mobile-nav-label">Overview</span>
                </button>
                <button class="mobile-nav-item" :class="{ 'active': activeTab === 'security' }"
                    @click="loadTab('security')" title="Security">
                    <span class="mobile-nav-icon">üõ°Ô∏è</span>
                    <span class="mobile-nav-label">Security</span>
                </button>
                <button class="mobile-nav-item" :class="{ 'active': activeTab === 'network' }"
                    @click="loadTab('network')" title="Network">
                    <span class="mobile-nav-icon">üï∏Ô∏è</span>
                    <span class="mobile-nav-label">Network</span>
                </button>
                <button class="mobile-nav-item" :class="{ 'active': activeTab === 'forensics' }"
                    @click="loadTab('forensics')" title="Forensics">
                    <span class="mobile-nav-icon">üîç</span>
                    <span class="mobile-nav-label">Forensics</span>
                </button>
                <button class="mobile-nav-item" :class="{ 'active': activeTab === 'assistant' }"
                    @click="loadTab('assistant')" title="Assistant">
                    <span class="mobile-nav-icon">ü§ñ</span>
                    <span class="mobile-nav-label">Assistant</span>
                </button>
                <button class="mobile-nav-item"
                    :class="{ 'active': ['server', 'hosts', 'firewall', 'firewall-snmp'].includes(activeTab) || mobileMoreModalOpen }"
                    @click="mobileMoreModalOpen = true" title="More">
                    <span class="mobile-nav-icon">‚ãØ</span>
                    <span class="mobile-nav-label">More</span>
                </button>
            </nav>

        </div> <!-- End content-scroll-area -->
        </main>
    </div>

    <!-- App Logic already loaded in <head> to ensure Alpine picks it up -->

    <!-- Mobile More Menu Modal -->
    <div class="modal" x-show="mobileMoreModalOpen" :style="mobileMoreModalOpen ? 'display:flex' : 'display:none'"
        @click.self="mobileMoreModalOpen = false">
        <div class="modal-content" style="max-width: 100%;">
            <div class="modal__header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--text-0);">More Navigation</h3>
                <button @click="mobileMoreModalOpen = false"
                    style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                    aria-label="Close">√ó</button>
            </div>
            <div class="modal__body" style="color:var(--text-0);">
                <div class="grid grid-2" style="gap: var(--space-3);">
                    <button class="btn btn--secondary" :class="{ 'active': activeTab === 'server' }"
                        @click="loadTab('server'); mobileMoreModalOpen = false"
                        style="justify-content: flex-start; gap: 12px; height: 60px;">
                        <span style="font-size: 1.5em;">üñ•Ô∏è</span>
                        <span>Server Health</span>
                    </button>
                    <button class="btn btn--secondary" :class="{ 'active': activeTab === 'hosts' }"
                        @click="loadTab('hosts'); mobileMoreModalOpen = false"
                        style="justify-content: flex-start; gap: 12px; height: 60px;">
                        <span style="font-size: 1.5em;">üñ•Ô∏è</span>
                        <span>Hosts</span>
                    </button>
                    <button class="btn btn--secondary" :class="{ 'active': activeTab === 'firewall' }"
                        @click="loadTab('firewall'); mobileMoreModalOpen = false"
                        style="justify-content: flex-start; gap: 12px; height: 60px;">
                        <span style="font-size: 1.5em;">üî•</span>
                        <span>Firewall Logs</span>
                    </button>
                    <button class="btn btn--secondary" :class="{ 'active': activeTab === 'firewall-snmp' }"
                        @click="loadTab('firewall-snmp'); mobileMoreModalOpen = false"
                        style="justify-content: flex-start; gap: 12px; height: 60px;">
                        <span style="font-size: 1.5em;">üì°</span>
                        <span>Interfaces</span>
                    </button>
                </div>
            </div>
            <div class="modal__footer"
                style="display:flex; justify-content:flex-end; gap:10px; margin-top:var(--space-4);">
                <button class="btn btn--primary" @click="mobileMoreModalOpen = false"
                    style="min-height:44px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Overall Health Details Modal -->
    <div class="modal" x-show="overallHealthModalOpen" :style="overallHealthModalOpen ? 'display:flex' : 'display:none'"
        @click.self="overallHealthModalOpen = false">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal__header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--text-0);">Overall Health Details</h3>
                <button @click="overallHealthModalOpen = false"
                    style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                    aria-label="Close">√ó</button>
            </div>
            <div class="modal__body" style="color:var(--text-0);">
                <div style="margin-bottom:var(--space-4);">
                    <div style="display:flex; align-items:center; gap:var(--space-3); margin-bottom:var(--space-3);">
                        <div style="font-size:var(--text-2xl); font-weight:var(--font-weight-semibold); text-transform:capitalize;"
                            :class="{
                                    'text-green': overallHealth.state === 'healthy',
                                    'text-yellow': overallHealth.state === 'degraded',
                                    'text-red': overallHealth.state === 'unhealthy'
                                }"
                            x-text="overallHealth.state === 'healthy' ? 'Healthy' : overallHealth.state === 'degraded' ? 'Degraded' : 'Unhealthy'">
                        </div>
                        <div style="flex:1; height:2px; background:var(--border-soft);"></div>
                    </div>
                    <p style="font-size:var(--text-base); line-height:var(--line-height-normal); color:var(--text-1); margin:0;"
                        x-text="overallHealth.explanation || 'All systems operating normally.'">
                    </p>
                </div>

                <div style="border-top:1px solid var(--border-soft); padding-top:var(--space-4);">
                    <h4
                        style="font-size:var(--text-sm); color:var(--text-secondary); text-transform:uppercase; letter-spacing:var(--letter-spacing-wide); margin-bottom:var(--space-3);">
                        Current Metrics
                    </h4>
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:var(--space-3);">
                        <div>
                            <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Active Alerts</div>
                            <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                x-text="alertHistory.total || 0">
                            </div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Active Flows</div>
                            <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                x-text="(networkStatsOverview.active_flows || 0).toLocaleString()">
                            </div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-xs); color:var(--text-tertiary);">External Connections
                            </div>
                            <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                x-text="(networkStatsOverview.external_connections || 0).toLocaleString()">
                            </div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Blocked Events (24h)
                            </div>
                            <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                x-text="(firewallStatsOverview.blocked_events_24h || 0).toLocaleString()">
                            </div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Network Anomalies (24h)
                            </div>
                            <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                x-text="(networkStatsOverview.anomalies_24h || 0).toLocaleString()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal__footer"
                style="display:flex; justify-content:flex-end; gap:10px; margin-top:var(--space-4);">
                <button class="btn btn--primary" @click="overallHealthModalOpen = false">Close</button>
            </div>
        </div>
    </div>

    <!-- Mobile Controls Modal -->
    <div class="modal" x-show="mobileControlsModalOpen"
        :style="mobileControlsModalOpen ? 'display:flex' : 'display:none'"
        @click.self="mobileControlsModalOpen = false">
        <div class="modal-content" style="max-width: 100%;">
            <div class="modal__header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--text-0);">Controls</h3>
                <button @click="mobileControlsModalOpen = false"
                    style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                    aria-label="Close">√ó</button>
            </div>
            <div class="modal__body" style="color:var(--text-0);">
                <!-- Search -->
                <div style="margin-bottom:var(--space-4);">
                    <label
                        style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Search
                        UI</label>
                    <div class="search-wrapper" style="width:100%;">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" x-model="searchQuery" placeholder="Search UI" class="global-search"
                            aria-label="Search UI" style="width:100%;">
                    </div>
                </div>

                <!-- Time Range -->
                <div style="margin-bottom:var(--space-4);">
                    <label
                        style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Time
                        Range</label>
                    <select x-model="timeRange" class="header-select" aria-label="Time Range"
                        style="width:100%; min-height:44px;">
                        <option value="15m">15m</option>
                        <option value="30m">30m</option>
                        <option value="1h">1h</option>
                        <option value="6h">6h</option>
                        <option value="24h">24h</option>
                        <option value="7d">7d</option>
                    </select>
                </div>

                <!-- Refresh Interval -->
                <div style="margin-bottom:var(--space-4);">
                    <label
                        style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Refresh
                        Interval</label>
                    <select x-model="refreshInterval" class="header-select" aria-label="Refresh Interval"
                        style="width:100%; min-height:44px;">
                        <option value="10000">10s</option>
                        <option value="30000">30s</option>
                        <option value="60000">1m</option>
                        <option value="300000">5m</option>
                    </select>
                </div>

                <!-- Live Controls -->
                <div style="margin-bottom:var(--space-4);">
                    <label
                        style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Auto-Refresh</label>
                    <div style="display:flex; gap:var(--space-3); align-items:center;">
                        <button class="btn" :class="{ 'paused': paused }" @click="togglePause()"
                            style="flex:1; min-height:44px;" title="Toggle auto-refresh pause"
                            :title="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'"
                            :aria-label="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'">
                            <template x-if="!paused">
                                <span>‚è∏ Pause</span>
                            </template>
                            <template x-if="paused">
                                <span>‚ñ∂ Resume</span>
                            </template>
                        </button>
                        <button class="btn" @click="dataRefresh(); mobileControlsModalOpen = false"
                            style="flex:1; min-height:44px;" title="Refresh" aria-label="Refresh">
                            <span>üîÑ Refresh Now</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal__footer"
                style="display:flex; justify-content:flex-end; gap:10px; margin-top:var(--space-4);">
                <button class="btn btn--primary" @click="mobileControlsModalOpen = false"
                    style="min-height:44px;">Close</button>
            </div>
        </div>
    </div>
</body>

</html>