<!DOCTYPE html>
<html lang="en">

<head>
    <title>PHOBOS-NET</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <!-- theme-color: Supported in Chrome, Edge, Safari, Opera. Firefox requires extension for support -->
    <meta name="theme-color" content="#0a0e17">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description"
        content="Real-time NetFlow analytics dashboard with threat intelligence, bandwidth monitoring, and firewall health metrics. Monitor network traffic, detect threats, and analyze security events.">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="PHOBOS-NET">
    <meta property="og:description"
        content="Real-time network traffic monitoring with threat intelligence and security analytics">
    <meta property="og:site_name" content="PHOBOS-NET">

    <!-- Resource hints for better performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <!-- Typography - Inter for UI, JetBrains Mono for technical data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Critical JavaScript modules - Preload for faster execution -->
    <!-- Note: widgets.js and utils.js are ES modules imported by app.js, so they're handled by the module graph -->
    <!-- lazy-load.js is loaded as a regular script, so preloading it makes sense -->
    <link rel="preload" href="/static/js/lazy-load.js" as="script">

    <!-- CSS - Critical render path, load first -->
    <!-- CYBERPUNK UI: Signal-first design system -->
    <link rel="stylesheet" href="/static/style.css?v=5.0.0">
    <!-- Widget-specific enhancements -->


    <!-- External Libs (bundled locally to reduce CDN dependency) - Defer all heavy libraries -->
    <script src="/static/chart.min.js" defer></script>
    <script src="/static/alpine-collapse.min.js" defer></script>

    <!-- Modular JavaScript - Load modules before app (critical path) -->
    <script src="/static/js/lazy-load.js"></script>

    <!-- Main app - Register BEFORE Alpine starts so alpine:init is caught -->
    <script type="module" src="/static/app.js?v=3.1.8"></script>

    <!-- Alpine.js - Defer to allow app.js to register -->
    <script src="/static/alpine.min.js" defer></script>

    <!-- Heavy visualization libraries - Defer until needed -->

    <!-- Leaflet - Local bundle -->
    <link rel="stylesheet" href="/static/leaflet.css">
    <script src="/static/leaflet.js"></script>
</head>

<body class="antialiased" x-data="dashboard">
    {% from 'macros/widgets.html' import widget_card %}

    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Refresh Progress Bar -->
    <div class="refresh-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"
        :aria-valuenow="countdownPercent" aria-label="Auto-refresh countdown">
        <div class="refresh-progress-bar" :class="{ 'paused': paused }" :style="'width: ' + countdownPercent + '%'">
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-screen" x-show="!initDone" role="status" aria-live="polite">
        <div class="loader">Initializing Neural Link...</div>
    </div>

    <div class="container" x-show="initDone" x-transition.opacity.duration.500ms>
        <!-- Mobile filters removed - integrated into header -->


        <!-- Layout with Sidebar -->
        <div class="layout-wrapper">
            <!-- Left Sidebar Menu -->
            <aside class="sidebar" :class="{ 'collapsed': sidebarCollapsed }" title="Main Navigation">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--signal-primary)">
                            <path d="M12 2L4 7l8 5 8-5-8-5zM4 12l8 5 8-5M4 17l8 5 8-5" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                        </svg>
                        <span class="logo-text">PHOBOS</span>
                    </div>
                </div>

                <nav class="sidebar-nav" role="tablist" aria-orientation="vertical" aria-label="Main navigation">
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'overview' }"
                        @click="loadTab('overview')" role="tab" :aria-selected="activeTab === 'overview'"
                        id="overview-tab-btn" aria-controls="overview-tab">
                        <span class="sidebar-icon">üìä</span>
                        <span class="sidebar-item-text">Dashboard</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'security' }"
                        @click="loadTab('security')" role="tab" :aria-selected="activeTab === 'security'"
                        id="security-tab-btn" aria-controls="security-tab">
                        <span class="sidebar-icon">üõ°Ô∏è</span>
                        <span class="sidebar-item-text">Security</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'network' }"
                        @click="loadTab('network')" role="tab" :aria-selected="activeTab === 'network'"
                        id="network-tab-btn" aria-controls="network-tab">
                        <span class="sidebar-icon">üï∏Ô∏è</span>
                        <span class="sidebar-item-text">Network</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'server' }"
                        @click="loadTab('server')" role="tab" :aria-selected="activeTab === 'server'"
                        id="server-tab-btn" aria-controls="server-tab">
                        <span class="sidebar-icon">üñ•Ô∏è</span>
                        <span class="sidebar-item-text">Server</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'forensics' }"
                        @click="loadTab('forensics')" role="tab" :aria-selected="activeTab === 'forensics'"
                        id="forensics-tab-btn" aria-controls="forensics-tab">
                        <span class="sidebar-icon">üî•</span>
                        <span class="sidebar-item-text">Firewall</span>
                    </button>
                    <button type="button" class="sidebar-item" :class="{ 'active': activeTab === 'assistant' }"
                        @click="loadTab('assistant')" role="tab" :aria-selected="activeTab === 'assistant'"
                        id="assistant-tab-btn" aria-controls="assistant-tab">
                        <span class="sidebar-icon">ü§ñ</span>
                        <span class="sidebar-item-text">AI Assistant</span>
                    </button>
                </nav>

                <div class="sidebar-footer">
                    <div class="system-info">
                        <div class="system-name">PHOBOS-NET</div>
                        <div class="edition-badge">COMMUNITY EDITION</div>
                    </div>
                    <div class="footer-copy">
                        ProxFlow‚Ñ¢ Community Edition<br>
                        ¬© 2026 iSystems, Inc.
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Header Bar -->
                <header class="header" role="banner">
                    <div class="header-left">
                        <button class="header-action-btn sidebar-toggle-main"
                            @click="sidebarCollapsed = !sidebarCollapsed" aria-label="Toggle Sidebar">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="3" y1="12" x2="21" y2="12"></line>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                                <line x1="3" y1="18" x2="21" y2="18"></line>
                            </svg>
                        </button>
                        <h2 class="page-title" x-text="activeTab.charAt(0).toUpperCase() + activeTab.slice(1)">Dashboard
                        </h2>
                    </div>

                    <div class="header-center">
                        <div class="search-wrapper">
                            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" x-model="searchQuery" placeholder="Search UI" class="global-search"
                                aria-label="Search UI">
                            <span class="search-shortcut">‚åò + /</span>
                        </div>
                    </div>

                    <div class="header-right">
                        <div class="header-controls">
                            <!-- Time Range -->
                            <div class="header-control-group">
                                <span class="control-label">Time</span>
                                <select x-model="timeRange" class="header-select" aria-label="Time Range">
                                    <option value="15m">15m</option>
                                    <option value="30m">30m</option>
                                    <option value="1h">1h</option>
                                    <option value="6h">6h</option>
                                    <option value="24h">24h</option>
                                    <option value="7d">7d</option>
                                </select>
                            </div>
                            <!-- Refresh Interval -->
                            <div class="header-control-group">
                                <span class="control-label">Refresh</span>
                                <select x-model="refreshInterval" class="header-select" aria-label="Refresh Interval">
                                    <option value="10000">10s</option>
                                    <option value="30000">30s</option>
                                    <option value="60000">1m</option>
                                    <option value="300000">5m</option>
                                </select>
                            </div>
                            <!-- Pause Button -->
                            <button class="header-action-btn" :class="{ 'paused': paused }" @click="togglePause()"
                                :title="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'"
                                :aria-label="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" x-show="!paused">
                                    <rect x="6" y="4" width="4" height="16"></rect>
                                    <rect x="14" y="4" width="4" height="16"></rect>
                                </svg>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" x-show="paused">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                            </button>
                        </div>

                        <div class="header-actions">
                            <button class="header-action-btn" title="Refresh" @click="dataRefresh()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M23 4v6h-6"></path>
                                    <path d="M1 20v-6h6"></path>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                    </path>
                                </svg>
                            </button>
                            <button class="header-action-btn" title="Alerts" @click="openAlerts()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                            </button>
                            <button class="header-action-btn" title="Edit Layout" @click="editMode = !editMode"
                                :class="{ 'active': editMode }"
                                :aria-label="editMode ? 'Finish Editing' : 'Edit Layout'">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="header-action-btn" title="Settings" @click="openConfig()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path
                                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Content Scroll Area -->
                <div class="content-scroll-area">
                    <!-- ============================================
                 OVERVIEW TAB
                 ============================================ -->
                    <div x-show="activeTab === 'overview'"
                        :style="activeTab === 'overview' ? 'display:block' : 'display:none'" id="overview-tab"
                        role="tabpanel" aria-labelledby="overview-tab-btn" tabindex="0">

                        <!-- Mobile Quick Stats Bar -->
                        <div class="mobile-stats-bar">
                            <div class="mobile-stat">
                                <span class="mobile-stat-value"
                                    x-text="firewall.cpu_percent ? firewall.cpu_percent + '%' : '--'"></span>
                                <span class="mobile-stat-label">CPU</span>
                            </div>
                            <div class="mobile-stat">
                                <span class="mobile-stat-value"
                                    x-text="firewall.mem_percent ? firewall.mem_percent + '%' : '--'"></span>
                                <span class="mobile-stat-label">MEM</span>
                            </div>
                            <div class="mobile-stat">
                                <span class="mobile-stat-value" :class="{ 'text-red': threats.hits.length > 0 }"
                                    x-text="threats.hits.length"></span>
                                <span class="mobile-stat-label">Threats</span>
                            </div>
                            <div class="mobile-stat">
                                <span class="mobile-stat-value"
                                    x-text="Number(summary.totals.flows || 0).toLocaleString()"></span>
                                <span class="mobile-stat-label">Flows</span>
                            </div>
                            <div class="mobile-stat">
                                <span class="mobile-stat-value" :class="paused ? 'text-yellow' : 'text-green'"
                                    x-text="paused ? '‚è∏' : '‚ñ∂'"></span>
                                <span class="mobile-stat-label" x-text="paused ? 'Paused' : 'Live'"></span>
                            </div>
                        </div>

                        <!-- Summary Stats & Bandwidth - Horizontal Layout -->
                        <section id="section-summary" class="scroll-section mb-8">

                            <!-- Top Row: Summary Stats (Compact Horizontal) -->
                            <div class="summary-stats-grid">
                                <div class="stat-box">
                                    <div class="value" x-text="summary.totals.bytes_fmt">...</div>
                                    <div class="label">Total Traffic</div>
                                </div>
                                <div class="stat-box">
                                    <div class="value" x-text="Number(summary.totals.flows).toLocaleString()">...</div>
                                    <div class="label">Total Flows</div>
                                </div>
                                <div class="stat-box">
                                    <div class="value" x-text="summary.totals.avg_packet_size + ' B'">...</div>
                                    <div class="label">Avg Packet Size</div>
                                </div>
                                <div class="stat-box" :class="{ 'status-warning': threats.hits.length > 0 }">
                                    <div class="value" x-text="threats.hits.length || 0">0</div>
                                    <div class="label">Threats</div>
                                </div>
                                <div class="stat-box" x-show="firewall.cpu_percent !== null">
                                    <div class="value" x-text="(firewall.cpu_percent || 0) + '%'">--</div>
                                    <div class="label">Firewall CPU</div>
                                </div>
                                <div class="stat-box" x-show="firewall.mem_percent !== null">
                                    <div class="value" x-text="(firewall.mem_percent || 0) + '%'">--</div>
                                    <div class="label">Firewall MEM</div>
                                </div>
                            </div>

                            <!-- Main Chart: Bandwidth -->
                            <div class="primary-column w-full">
                                <template x-if="isVisible('bandwidth')">
                                    {% set bw_actions %}
                                    <div class="status-pills" x-show="!isMinimized('bandwidth')">
                                        <span class="status-pill running">Live</span>
                                    </div>
                                    {% endset %}
                                    {% call widget_card('bandwidth', 'Bandwidth & Flow Rate', 'üìä',
                                    extra_actions=bw_actions) %}
                                    <div class="chart-wrapper chart-expandable"
                                        @click="openFullscreenChart('bwChart', 'Bandwidth & Flow Rate')"
                                        title="Click to expand">
                                        <canvas id="bwChart"></canvas>
                                    </div>
                                    {% endcall %}
                                </template>
                            </div>
                        </section>


                        <!-- World Map Section -->
                        <section id="section-worldmap" class="scroll-section">
                            {% set wm_actions %}
                            <div class="status-pills" x-show="!isMinimized('worldmap')">
                                <span class="status-pill running">Live</span>
                            </div>
                            <div class="world-map-stats-badges" x-show="worldMap.summary && !isMinimized('worldmap')">
                                <span class="wm-badge wm-badge-cyan"
                                    :title="worldMap.summary?.countries_reached + ' countries'">
                                    <span class="wm-badge-icon">üåç</span>
                                    <span class="wm-badge-value"
                                        x-text="worldMap.summary?.countries_reached || 0"></span>
                                </span>
                            </div>
                            <!-- External Link Icon preserved in actions -->
                            <svg class="external-link-icon" width="12" height="12" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" class="ml-2 opacity-50">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            {% endset %}

                            {% set wm_title %}
                            <span>Traffic World Map</span>
                            <span x-show="mapStatus" x-text="'[' + mapStatus + ']'"
                                class="text-7 text-yellow ml-2"></span>
                            {% endset %}
                            {% call widget_card('worldmap', wm_title, 'üó∫Ô∏è', card_class='wide-card world-map-card',
                            extra_actions=wm_actions) %}
                            <!-- Map Controls -->
                            <div class="world-map-controls">
                                <div class="world-map-layer-toggles">
                                    <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.sources }"
                                        title="Toggle Sources layer">
                                        <input type="checkbox" x-model="worldMapLayers.sources">
                                        <span class="layer-dot layer-dot-green"></span>
                                        <span class="layer-label">Sources</span>
                                    </label>
                                    <label class="world-map-layer-toggle"
                                        :class="{ 'active': worldMapLayers.destinations }"
                                        title="Toggle Destinations layer">
                                        <input type="checkbox" x-model="worldMapLayers.destinations">
                                        <span class="layer-dot layer-dot-cyan"></span>
                                        <span class="layer-label">Destinations</span>
                                    </label>
                                    <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.threats }"
                                        title="Toggle Threats layer">
                                        <input type="checkbox" x-model="worldMapLayers.threats">
                                        <span class="layer-dot layer-dot-red"></span>
                                        <span class="layer-label">Threats</span>
                                    </label>
                                </div>
                                <button class="world-map-reset-btn" @click="resetWorldMapView()" title="Reset map view">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M12 6v6l4 2"></path>
                                    </svg>
                                    Reset View
                                </button>
                            </div>
                            <div class="world-map-container">
                                <div id="world-map-svg" class="world-map-svg"></div>
                                <div x-show="worldMap.loading" class="spinner-overlay">
                                    <div class="spinner"></div>
                                </div>
                                <div x-show="worldMap.error" class="error-overlay"
                                    style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:red; display:flex; align-items:center; justify-content:center; z-index:10;"
                                    x-text="worldMap.error"></div>
                            </div>
                            <!-- Country Stats -->
                            <div class="world-map-countries compact-grid">
                                <div class="wm-country-col">
                                    <h4>üîº Sources</h4>
                                    <template x-for="c in worldMap.source_countries?.slice(0, 5)" :key="c.iso">
                                        <div class="wm-country-row">
                                            <span x-text="flagFromIso(c.iso)"></span>
                                            <span class="wm-c-name" x-text="c.name"></span>
                                            <span class="wm-c-val text-cyan" x-text="c.bytes_fmt"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="wm-country-col">
                                    <h4>üîΩ Dests</h4>
                                    <template x-for="c in worldMap.dest_countries?.slice(0, 5)" :key="c.iso">
                                        <div class="wm-country-row">
                                            <span x-text="flagFromIso(c.iso)"></span>
                                            <span class="wm-c-name" x-text="c.name"></span>
                                            <span class="wm-c-val text-cyan" x-text="c.bytes_fmt"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            {% endcall %}
                        </section>
                    </div>

                    <!-- ============================================
             SECURITY TAB
             ============================================ -->
                    <div x-show="activeTab === 'security'"
                        :style="activeTab === 'security' ? 'display:block' : 'display:none'" id="security-tab"
                        role="tabpanel" aria-labelledby="security-tab-btn" tabindex="0">
                        <!-- ============================================
             SECURITY CENTER
             ============================================ -->
                        <section id="section-security" class="scroll-section mb-8">
                            <!-- Security Summary Stats -->
                            <div class="grid mb-6 grid-auto-fit">
                                <div class="card stat-box">
                                    <div class="value" :class="'grade-' + (securityScore.grade || 'A').toLowerCase()"
                                        x-text="securityScore.score || 100"></div>
                                    <div class="label">Security Score</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="feedHealth.summary?.ok || 0"></div>
                                    <div class="label">Feeds OK</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="(feedHealth.summary?.total_ips || 0).toLocaleString()">
                                    </div>
                                    <div class="label">Blocklist IPs</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="alertHistory.total || 0"></div>
                                    <div class="label">Alerts 24h</div>
                                </div>
                            </div>

                            <!-- Security Actions -->
                            <div class="flex gap-2 mb-6 flex-wrap">
                                <button class="btn-sm" @click="watchlistModalOpen = true"
                                    aria-label="Manage watchlist">üëÅÔ∏è
                                    Watchlist</button>
                                <button class="btn-sm" @click="exportThreats('csv')"
                                    aria-label="Export threats as CSV">üì•
                                    Export</button>
                                <button class="btn-sm" @click="refreshFeed()" aria-label="Refresh threat feeds">üîÑ
                                    Refresh</button>
                            </div>

                            <!-- Security Widgets Grid -->
                            <div class="security-grid">

                                <!-- Security Score Widget -->
                                <template x-if="isVisible('securityScore')">
                                    {% call widget_card('securityScore', 'Security Score', 'üõ°Ô∏è', show_spinner=True,
                                    card_class="security-score-card", card_class_bind="{ 'score-excellent':
                                    securityScore.grade === 'A', 'score-good': securityScore.grade === 'B',
                                    'score-fair': securityScore.grade === 'C', 'score-poor': securityScore.grade ===
                                    'D', 'score-critical': securityScore.grade === 'F' }") %}
                                    <div class="score-display" x-show="!isMinimized('securityScore')">
                                        <div class="score-gauge">
                                            <div class="score-circle" :style="'--score: ' + (securityScore.score || 0)">
                                                <span class="score-value" x-text="securityScore.score || 0"></span>
                                                <span class="score-grade" x-text="securityScore.grade || '-'"></span>
                                            </div>
                                            <div class="score-trend" x-show="securityScore.trend">
                                                <span :class="securityScore.trend === 'up' ? 'trend-up' : 'trend-down'"
                                                    x-text="securityScore.trend === 'up' ? '‚Üë' : '‚Üì'"></span>
                                            </div>
                                        </div>
                                        <div class="score-details">
                                            <div class="score-status" x-text="securityScore.status || 'calculating...'">
                                            </div>
                                            <div class="score-reasons">
                                                <template x-for="reason in (securityScore.reasons || [])" :key="reason">
                                                    <div class="score-reason" x-text="reason"></div>
                                                </template>
                                            </div>
                                            <div class="score-stats">
                                                <span>üõ°Ô∏è <span
                                                        x-text="securityScore.blocklist_ips?.toLocaleString() || 0"></span>
                                                    IPs in blocklist</span>
                                                <span>üì° <span x-text="securityScore.feeds_ok || 0"></span>/<span
                                                        x-text="securityScore.feeds_total || 0"></span> feeds</span>
                                            </div>
                                            <template
                                                x-if="securityScore.fw_blocks_1h !== undefined && securityScore.fw_blocks_1h > 0">
                                                <div class="score-stats" style="margin-top: 4px;">
                                                    <span class="text-green">üî• <span
                                                            x-text="securityScore.fw_blocks_1h?.toLocaleString() || 0"></span>
                                                        blocks/hr</span>
                                                    <span>üéØ <span
                                                            x-text="securityScore.fw_threats_blocked?.toLocaleString() || 0"></span>
                                                        threats blocked</span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Alert History Widget -->
                                <template x-if="isVisible('alertHistory')">
                                    {% call widget_card('alertHistory', 'Alert History (24h)', 'üîî', show_spinner=True)
                                    %}
                                    <!-- Alert Filters -->
                                    <div class="alert-filters" x-show="!isMinimized('alertHistory')">
                                        <select x-model="alertFilter.severity" class="filter-select"
                                            aria-label="Filter alerts by severity">
                                            <option value="all">All Severities</option>
                                            <option value="critical">üî¥ Critical</option>
                                            <option value="high">üü† High</option>
                                            <option value="medium">üü° Medium</option>
                                            <option value="low">üü¢ Low</option>
                                        </select>
                                        <select x-model="alertFilter.type" class="filter-select"
                                            aria-label="Filter alerts by type">
                                            <option value="all">All Types</option>
                                            <option value="threat_ip">Threat IP</option>
                                            <option value="port_scan">Port Scan</option>
                                            <option value="brute_force">Brute Force</option>
                                            <option value="data_exfil">Data Exfil</option>
                                            <option value="dns_tunneling">DNS Tunneling</option>
                                            <option value="lateral_movement">Lateral Movement</option>
                                            <option value="suspicious_port">Suspicious Port</option>
                                            <option value="large_transfer">Large Transfer</option>
                                            <option value="off_hours">Off-Hours</option>
                                            <option value="watchlist">Watchlist</option>
                                        </select>
                                    </div>
                                    <div class="alert-summary" x-show="!isMinimized('alertHistory')">
                                        <span class="alert-badge critical"
                                            x-show="alertHistory.by_severity?.critical > 0">üî¥ <span
                                                x-text="alertHistory.by_severity?.critical || 0"></span>
                                            critical</span>
                                        <span class="alert-badge high" x-show="alertHistory.by_severity?.high > 0">üü†
                                            <span x-text="alertHistory.by_severity?.high || 0"></span> high</span>
                                        <span class="alert-badge medium"
                                            x-show="alertHistory.by_severity?.medium > 0">üü°
                                            <span x-text="alertHistory.by_severity?.medium || 0"></span>
                                            medium</span>
                                        <span class="alert-badge low" x-show="alertHistory.by_severity?.low > 0">üü¢
                                            <span x-text="alertHistory.by_severity?.low || 0"></span> low</span>
                                        <span class="text-muted">Total: <span
                                                x-text="alertHistory.total || 0"></span></span>
                                    </div>
                                    <div class="alert-list" x-show="!isMinimized('alertHistory')">
                                        <template x-for="(a, idx) in filteredAlerts.slice(0, 10)" :key="idx">
                                            <div class="alert-row" :class="'severity-row-' + a.severity">
                                                <div class="alert-time" x-text="a.time_ago"></div>
                                                <div class="alert-info">
                                                    <span class="alert-type-badge"
                                                        :class="'cat-' + (a.category || a.type || 'unknown').toLowerCase()"
                                                        x-text="a.type || 'alert'"></span>
                                                    <span class="alert-msg" :title="a.msg" x-text="a.msg"></span>
                                                </div>
                                                <div class="alert-severity" :class="'sev-' + a.severity"
                                                    x-text="a.severity"></div>
                                            </div>
                                        </template>
                                        <template x-if="filteredAlerts.length === 0">
                                            <div class="alert-empty"
                                                x-text="alertFilter.severity !== 'all' || alertFilter.type !== 'all' ? 'üîç No matching alerts' : '‚úÖ No alerts in past 24 hours'">
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Threats by Country Widget -->
                                <template x-if="isVisible('threatsByCountry')">
                                    {% call widget_card('threatsByCountry', 'Threats by Country', 'üåç',
                                    show_spinner=True) %}
                                    <div class="country-threat-list">
                                        <template
                                            x-if="threatsByCountry.countries && threatsByCountry.countries.length > 0">
                                            <div>
                                                <div class="text-85 text-muted mb-2">
                                                    <span x-text="threatsByCountry.total_countries || 0"></span>
                                                    countries
                                                    detected
                                                    <template x-if="threatsByCountry.has_fw_data">
                                                        <span> ¬∑ <span class="text-green"
                                                                x-text="threatsByCountry.total_blocked"></span>
                                                            blocked</span>
                                                    </template>
                                                </div>
                                                <template
                                                    x-for="(c, idx) in (threatsByCountry.countries || []).slice(0, 8)"
                                                    :key="c.country_code">
                                                    <div class="country-threat-item">
                                                        <span class="country-flag" x-text="c.country_code"></span>
                                                        <span class="country-name" x-text="c.country_name"></span>
                                                        <span class="country-count">
                                                            <span x-text="c.threat_count"></span>
                                                            <template x-if="c.blocked > 0">
                                                                <span class="text-green text-8 ml-1">üî•<span
                                                                        x-text="c.blocked"></span></span>
                                                            </template>
                                                        </span>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        <template
                                            x-if="!threatsByCountry.countries || threatsByCountry.countries.length === 0">
                                            <div class="empty-state-compact">
                                                <span class="empty-icon">üåç</span>
                                                <span>No geo-located threats</span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Threat Detections - MOVED TO FORENSICS TAB -->

                                <!-- Feed Health -->
                                <template x-if="isVisible('feedHealth')">
                                    {% set feed_actions %}
                                    <button class="icon-btn-small" @click="refreshFeed()" title="Refresh Feeds Now"
                                        class="text-green">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 12a9 9 0 11-2.5-6.3" />
                                            <path d="M21 3v6h-6" />
                                        </svg>
                                    </button>
                                    {% endset %}

                                    {% call widget_card('feedHealth', 'Feed Health', 'üì°', extra_actions=feed_actions,
                                    show_spinner=True) %}
                                    <!-- Summary Bar -->
                                    <div class="feed-summary-bar">
                                        <div class="feed-stat">
                                            <span class="feed-stat-value text-green"
                                                x-text="feedHealth.summary?.ok || 0"></span>
                                            <span class="feed-stat-label">OK</span>
                                        </div>
                                        <div class="feed-stat-divider">/</div>
                                        <div class="feed-stat">
                                            <span class="feed-stat-value"
                                                x-text="feedHealth.summary?.total || 0"></span>
                                            <span class="feed-stat-label">Feeds</span>
                                        </div>
                                        <div class="feed-stat-sep">¬∑</div>
                                        <div class="feed-stat">
                                            <span class="feed-stat-value text-cyan"
                                                x-text="(feedHealth.summary?.total_ips || 0).toLocaleString()"></span>
                                            <span class="feed-stat-label">IPs</span>
                                        </div>
                                        <div class="feed-stat-sep">¬∑</div>
                                        <div class="feed-stat">
                                            <span class="feed-stat-value text-muted"
                                                x-text="feedHealth.summary?.last_refresh || 'never'"></span>
                                        </div>
                                    </div>
                                    <!-- Feed List (Full Width) -->
                                    <div class="feed-list-full">
                                        <template x-for="(f, idx) in feedHealth.feeds" :key="f.name + idx">
                                            <div class="feed-item" :class="{ 'feed-error': f.status !== 'ok' }">
                                                <span class="feed-status-dot" :class="f.status"></span>
                                                <span class="feed-name-full" x-text="f.name" :title="f.name"></span>
                                                <span class="feed-ips-count"
                                                    x-text="(f.ips || 0).toLocaleString()"></span>
                                                <span class="feed-category-tag"
                                                    :class="'cat-' + (f.category || 'unknown').toLowerCase()"
                                                    x-text="f.category"></span>
                                            </div>
                                        </template>
                                        <template x-if="!feedHealth.feeds || feedHealth.feeds.length === 0">
                                            <div class="feed-empty">
                                                <span>üì° No feed data yet</span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Malicious Ports -->
                                {% call widget_card('maliciousPorts', 'Top Malicious Ports', 'üîí', show_spinner=True) %}
                                <div class="text-9 text-muted mb-2">
                                    <template x-if="maliciousPorts.has_syslog">
                                        <span>Ports targeted by threats + blocked by firewall</span>
                                    </template>
                                    <template x-if="!maliciousPorts.has_syslog">
                                        <span>Ports most frequently seen in threat traffic</span>
                                    </template>
                                </div>
                                <table class="table-fixed table-compact">
                                    <thead>
                                        <tr>
                                            <th>Port</th>
                                            <th>FW Blocked</th>
                                            <th>Traffic</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(p, i) in maliciousPorts.ports" :key="p.port + '-' + i">
                                            <tr>
                                                <td>
                                                    <strong class="text-cyan" x-text="p.port"></strong>
                                                    <template x-if="p.suspicious"><span
                                                            style="color: var(--neon-pink); font-size: 0.75em;">
                                                            ‚ö†</span></template>
                                                    <div class="text-8 text-muted" x-text="p.service || ''">
                                                    </div>
                                                </td>
                                                <td>
                                                    <template x-if="p.blocked > 0">
                                                        <span class="text-green">üî• <span
                                                                x-text="p.blocked"></span></span>
                                                    </template>
                                                    <template x-if="!p.blocked || p.blocked === 0">
                                                        <span class="text-muted">‚Äî</span>
                                                    </template>
                                                    <template x-if="p.unique_attackers > 1">
                                                        <div class="text-75 text-muted"
                                                            x-text="p.unique_attackers + ' IPs'"></div>
                                                    </template>
                                                </td>
                                                <td>
                                                    <strong class="text-green"
                                                        x-text="p.bytes_fmt || fmtBytes(p.netflow_bytes || 0)"></strong>
                                                    <div class="text-8 text-muted"
                                                        x-text="(p.netflow_flows || p.hits || 0) + ' flows'"></div>
                                                </td>
                                            </tr>
                                        </template>
                                        <template x-if="!maliciousPorts.ports || maliciousPorts.ports.length===0">
                                            <tr>
                                                <td colspan="3" class="text-muted text-center">
                                                    No
                                                    malicious port data</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                                {% endcall %}

                                <!-- Blocklist Match Rate -->
                                {% call widget_card('blocklist', 'Blocklist Match Rate', 'üõ°Ô∏è', show_spinner=True) %}
                                <div class="text-85 text-muted mb-2">
                                    Rate of flows matching blocklists / feeds
                                    <template x-if="blocklist.has_fw_data">
                                        <span class="text-green"> + FW blocks</span>
                                    </template>
                                </div>
                                <div class="h-25 mb-2 chart-expandable"
                                    @click="openFullscreenChart('blocklistChart', 'Blocklist Match Rate')"
                                    title="Click to expand">
                                    <canvas id="blocklistChart"></canvas>
                                </div>
                                <div class="blocklist-stats">
                                    <div class="blocklist-stat">
                                        <span class="blocklist-value"
                                            :class="{ 'text-green': blocklist.current_rate == 0, 'text-yellow': blocklist.current_rate > 0 && blocklist.current_rate < 1, 'text-red': blocklist.current_rate >= 1 }"
                                            x-text="(blocklist.current_rate != null) ? (blocklist.current_rate + '%') : '--'"></span>
                                        <span class="blocklist-label">Match Rate</span>
                                    </div>
                                    <div class="blocklist-stat">
                                        <span class="blocklist-value text-muted"
                                            x-text="(blocklist.total_matches || 0).toLocaleString()"></span>
                                        <span class="blocklist-label">Matches</span>
                                    </div>
                                    <template x-if="blocklist.has_fw_data">
                                        <div class="blocklist-stat">
                                            <span class="blocklist-value text-green"
                                                x-text="(blocklist.total_blocked || 0).toLocaleString()"></span>
                                            <span class="blocklist-label">üî• Blocked</span>
                                        </div>
                                    </template>
                                </div>
                                {% endcall %}

                                <!-- Threat Velocity Widget -->
                                <template x-if="isVisible('threatVelocity')">
                                    <template x-if="isVisible('threatVelocity')">
                                        {% call widget_card('threatVelocity', 'Threat Velocity', 'üìà',
                                        show_spinner=True) %}
                                        <div class="velocity-display">
                                            <div class="velocity-main">
                                                <span class="velocity-value"
                                                    :class="{ 'text-green': threatVelocity.current === 0, 'text-yellow': threatVelocity.current > 0 && threatVelocity.current < 5, 'text-red': threatVelocity.current >= 5 }"
                                                    x-text="threatVelocity.current || 0"></span>
                                                <span class="velocity-unit">threats/hr</span>
                                            </div>
                                            <div class="velocity-trend"
                                                :class="{ 'trend-up': threatVelocity.trend > 0, 'trend-down': threatVelocity.trend < 0, 'trend-stable': threatVelocity.trend === 0 }">
                                                <span
                                                    x-text="threatVelocity.trend > 0 ? '‚Üë' : threatVelocity.trend < 0 ? '‚Üì' : '‚Üí'"></span>
                                                <span x-text="Math.abs(threatVelocity.trend || 0) + '%'"></span>
                                                <span class="trend-label">vs last hour</span>
                                            </div>
                                            <div class="velocity-stats">
                                                <div class="velocity-stat">
                                                    <span class="velocity-stat-value"
                                                        x-text="threatVelocity.total_24h || 0"></span>
                                                    <span class="velocity-stat-label">24h Total</span>
                                                </div>
                                                <div class="velocity-stat">
                                                    <span class="velocity-stat-value"
                                                        x-text="threatVelocity.peak || 0"></span>
                                                    <span class="velocity-stat-label">Peak/hr</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </template>

                                    <!-- Top Threat IPs Widget -->
                                    <template x-if="isVisible('topThreatIPs')">
                                        {% call widget_card('topThreatIPs', 'Top Threat IPs', 'üéØ', show_spinner=True)
                                        %}
                                        <div class="threat-ips-list">
                                            <template x-for="(ip, idx) in (topThreatIPs.ips || []).slice(0, 5)"
                                                :key="ip.ip">
                                                <div class="threat-ip-item">
                                                    <div class="threat-ip-rank" x-text="idx + 1"></div>
                                                    <div class="threat-ip-info">
                                                        <span class="threat-ip-addr" x-text="ip.ip"></span>
                                                        <span class="threat-ip-meta">
                                                            <span class="badge"
                                                                :class="'cat-' + (ip.category || 'unknown').toLowerCase()"
                                                                x-text="ip.category || 'Unknown'"></span>
                                                            <span x-text="ip.country || '--'"></span>
                                                        </span>
                                                    </div>
                                                    <div class="threat-ip-hits">
                                                        <span class="hits-value" x-text="ip.hits"></span>
                                                        <span class="hits-label">hits</span>
                                                    </div>
                                                </div>
                                            </template>
                                            <template x-if="!topThreatIPs.ips || topThreatIPs.ips.length === 0">
                                                <div class="empty-state-compact">
                                                    <span class="empty-icon">‚úÖ</span>
                                                    <span>No threat IPs detected</span>
                                                </div>
                                            </template>
                                        </div>
                                        {% endcall %}
                                    </template>

                                    <!-- Network Risk Index Widget -->
                                    <template x-if="isVisible('riskIndex')">
                                        {% call widget_card('riskIndex', 'Network Risk Index', '‚ö†Ô∏è', show_spinner=True,
                                        card_class="risk-index-card", card_class_bind="{ 'risk-low': riskIndex.level ===
                                        'LOW', 'risk-moderate': riskIndex.level === 'MODERATE', 'risk-elevated':
                                        riskIndex.level === 'ELEVATED', 'risk-high': riskIndex.level === 'HIGH',
                                        'risk-critical': riskIndex.level === 'CRITICAL' }") %}
                                        <div class="risk-display">
                                            <div class="risk-meter">
                                                <div class="risk-bar-bg">
                                                    <div class="risk-bar-fill"
                                                        :style="'width: ' + (riskIndex.score || 0) + '%'"></div>
                                                </div>
                                                <div class="risk-labels">
                                                    <span>LOW</span>
                                                    <span>MOD</span>
                                                    <span>ELEV</span>
                                                    <span>HIGH</span>
                                                    <span>CRIT</span>
                                                </div>
                                            </div>
                                            <div class="risk-score-display">
                                                <span class="risk-value" x-text="riskIndex.score || 0"></span>
                                                <span class="risk-max">/ 100</span>
                                                <span class="risk-level-badge"
                                                    :class="'level-' + (riskIndex.level || 'low').toLowerCase()"
                                                    x-text="riskIndex.level || 'LOW'"></span>
                                            </div>
                                            <div class="risk-factors">
                                                <template x-for="factor in (riskIndex.factors || []).slice(0, 4)"
                                                    :key="factor.factor">
                                                    <div class="risk-factor-item">
                                                        <span class="factor-name" x-text="factor.factor"></span>
                                                        <span class="factor-value" :class="'impact-' + factor.impact"
                                                            x-text="factor.value"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </template>

                                    <!-- Attack Timeline - MOVED TO FORENSICS TAB -->

                                    <!-- MITRE ATT&CK Coverage - MOVED TO FORENSICS TAB -->

                                    <!-- Protocol Anomalies Widget -->
                                    <template x-if="isVisible('protocolAnomalies')">
                                        {% call widget_card('protocolAnomalies', 'Protocol Anomalies', '‚ö°',
                                        show_spinner=True) %}
                                        <div class="anomaly-summary"
                                            :class="{ 'has-anomalies': protocolAnomalies.anomaly_count > 0 }">
                                            <span x-show="protocolAnomalies.anomaly_count > 0" class="text-red">‚ö†Ô∏è
                                                <span x-text="protocolAnomalies.anomaly_count"></span> anomalies
                                                detected</span>
                                            <span x-show="protocolAnomalies.anomaly_count === 0" class="text-green">‚úÖ No
                                                anomalies</span>
                                        </div>
                                        <div class="protocol-anomaly-list">
                                            <template x-for="proto in (protocolAnomalies.protocols || []).slice(0, 6)"
                                                :key="proto.protocol">
                                                <div class="protocol-anomaly-item"
                                                    :class="{ 'is-anomaly': proto.is_anomaly }">
                                                    <span class="proto-name" x-text="proto.protocol"></span>
                                                    <span class="proto-bytes" x-text="proto.bytes_fmt"></span>
                                                    <span class="proto-deviation"
                                                        :class="{ 'deviation-high': proto.deviation > 3, 'deviation-medium': proto.deviation > 1.5 }"
                                                        x-text="proto.deviation + 'x'"></span>
                                                </div>
                                            </template>
                                        </div>
                                        {% endcall %}
                                    </template>

                            </div> <!-- End security-grid -->

                            <!-- Firewall Logs - MOVED TO FORENSICS TAB -->
                            <!-- Old Firewall Logs widget disabled -->
                            </template>

                        </section>
                    </div>

                    <!-- ============================================
             NETWORK TAB
             ============================================ -->
                    <div x-show="activeTab === 'network'"
                        :style="activeTab === 'network' ? 'display:block' : 'display:none'" id="network-tab"
                        role="tabpanel" aria-labelledby="network-tab-btn" tabindex="0">
                        <!-- Network Dashboard -->
                        <section id="section-network" class="scroll-section mb-8">

                            <!-- Primary Network Endpoints: Sources & Destinations -->


                            <!-- Supporting Network Metrics -->
                            <div class="grid" data-reorder="true" data-grid-id="network-overview"
                                style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: var(--space-4);">

                                <!-- Top Sources -->
                                <template x-if="isVisible('sources')">
                                    {% set src_actions %}
                                    <div class="status-pills" x-show="!isMinimized('sources')">
                                        <span class="status-pill running">Running</span>
                                    </div>
                                    {% endset %}
                                    {% set src_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('sources')">View All</button>
                                    {% endset %}
                                    {% call widget_card('sources', 'Top Sources', 'üîº', extra_actions=src_actions,
                                    footer_content=src_footer) %}
                                    <div class="widget-body-inner">
                                        <div class="endpoint-grid-header">
                                            <div class="grid-th w-50">Source Address</div>
                                            <div class="grid-th w-50">Traffic</div>
                                        </div>
                                        <div class="endpoint-grid-body">
                                            <template x-for="(item, index) in filteredSources" :key="index">
                                                <div @click="openIPModal(item.key)"
                                                    class="network-endpoint-row grid-row" :data-row-rank="index"
                                                    :data-percentage="filteredSources.length > 0 && filteredSources[0]?.bytes ? Math.round((item.bytes / filteredSources[0].bytes) * 100) : 0"
                                                    :style="'--row-percentage: ' + (filteredSources.length > 0 && filteredSources[0]?.bytes ? Math.round((item.bytes / filteredSources[0].bytes) * 100) : 0)">

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell">
                                                            <!-- Primary: IP Address -->
                                                            <div class="endpoint-primary-line">
                                                                <span x-text="item.flag" class="endpoint-flag"></span>
                                                                <strong x-text="item.key" class="endpoint-ip"></strong>
                                                                <button class="icon-btn-small endpoint-filter-btn"
                                                                    @click.stop="applyFilter(item.key)"
                                                                    title="Filter / Details"
                                                                    :aria-label="'View details for ' + item.key">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14"
                                                                        height="14" viewBox="0 0 24 24" fill="none"
                                                                        stroke="currentColor" stroke-width="2"
                                                                        stroke-linecap="round" stroke-linejoin="round">
                                                                        <circle cx="11" cy="11" r="8"></circle>
                                                                        <line x1="21" y1="21" x2="16.65" y2="16.65">
                                                                        </line>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                            <!-- Secondary: Metadata with inline sparkline -->
                                                            <div class="endpoint-meta-line">
                                                                <span x-text="item.region"></span>
                                                                <span
                                                                    x-show="item.hostname && item.hostname !== item.key"
                                                                    x-text="' ‚Ä¢ ' + item.hostname"></span>
                                                                <span class="endpoint-meta-sparkline">
                                                                    <canvas class="spark spark-subtle" width="80"
                                                                        height="14" :data-ip="item.key"
                                                                        data-kind="source"></canvas>
                                                                </span>
                                                            </div>
                                                            <!-- Supporting: Badges -->
                                                            <div class="endpoint-badges">
                                                                <span class="badge"
                                                                    :class="item.internal ? 'internal' : 'external'"
                                                                    x-text="item.internal ? 'Internal' : 'External'"></span>
                                                                <span class="badge threat"
                                                                    x-show="item.threat">THREAT</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell endpoint-value-cell">
                                                            <div class="endpoint-value"
                                                                :class="{'text-green': item.bytes > (filteredSources[0]?.bytes * 0.5)}"
                                                                x-text="item.bytes_fmt || fmtBytes(item.bytes || 0)">
                                                            </div>
                                                            <div class="endpoint-flows"
                                                                x-text="(item.flows || 0) + ' flows'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Destinations -->
                                <template x-if="isVisible('destinations')">
                                    {% set dst_actions %}
                                    <div class="status-pills" x-show="!isMinimized('destinations')">
                                        <span class="status-pill running">Running</span>
                                    </div>
                                    {% endset %}
                                    {% set dst_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('destinations')">View
                                        All</button>
                                    {% endset %}
                                    {% call widget_card('destinations', 'Top Destinations', 'üéØ',
                                    extra_actions=dst_actions,
                                    footer_content=dst_footer) %}
                                    <div class="widget-body-inner">
                                        <div class="endpoint-grid-header">
                                            <div class="grid-th w-50">IP Address</div>
                                            <div class="grid-th w-50">Traffic</div>
                                        </div>
                                        <div class="endpoint-grid-body">
                                            <template x-for="(item, index) in filteredDestinations" :key="index">
                                                <div @click="openIPModal(item.key)"
                                                    class="network-endpoint-row grid-row" :data-row-rank="index"
                                                    :data-percentage="filteredDestinations.length > 0 && filteredDestinations[0]?.bytes ? Math.round((item.bytes / filteredDestinations[0].bytes) * 100) : 0"
                                                    :style="'--row-percentage: ' + (filteredDestinations.length > 0 && filteredDestinations[0]?.bytes ? Math.round((item.bytes / filteredDestinations[0].bytes) * 100) : 0)">

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell">
                                                            <!-- Primary: IP Address -->
                                                            <div class="endpoint-primary-line">
                                                                <span x-text="item.flag" class="endpoint-flag"></span>
                                                                <strong x-text="item.key" class="endpoint-ip"></strong>
                                                                <button class="icon-btn-small endpoint-filter-btn"
                                                                    @click.stop="applyFilter(item.key)"
                                                                    title="Filter / Details"
                                                                    :aria-label="'View details for ' + item.key">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14"
                                                                        height="14" viewBox="0 0 24 24" fill="none"
                                                                        stroke="currentColor" stroke-width="2"
                                                                        stroke-linecap="round" stroke-linejoin="round">
                                                                        <circle cx="11" cy="11" r="8"></circle>
                                                                        <line x1="21" y1="21" x2="16.65" y2="16.65">
                                                                        </line>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                            <!-- Secondary: Metadata with inline sparkline -->
                                                            <div class="endpoint-meta-line">
                                                                <span x-text="item.region"></span>
                                                                <span
                                                                    x-show="item.hostname && item.hostname !== item.key"
                                                                    x-text="' ‚Ä¢ ' + item.hostname"></span>
                                                                <span class="endpoint-meta-sparkline">
                                                                    <canvas class="spark spark-subtle" width="80"
                                                                        height="14" :data-ip="item.key"
                                                                        data-kind="dest"></canvas>
                                                                </span>
                                                            </div>
                                                            <!-- Supporting: Badges -->
                                                            <div class="endpoint-badges">
                                                                <span class="badge"
                                                                    :class="item.internal ? 'internal' : 'external'"
                                                                    x-text="item.internal ? 'Internal' : 'External'"></span>
                                                                <span class="badge threat"
                                                                    x-show="item.threat">THREAT</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="grid-td w-50">
                                                        <div class="endpoint-cell endpoint-value-cell">
                                                            <div class="endpoint-value"
                                                                :class="{'text-green': item.bytes > (filteredDestinations[0]?.bytes * 0.5)}"
                                                                x-text="item.bytes_fmt || fmtBytes(item.bytes || 0)">
                                                            </div>
                                                            <div class="endpoint-flows"
                                                                x-text="(item.flows || 0) + ' flows'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                        </table>
                                    </div>
                                    {% endcall %}
                                </template>
                                <!-- Top Ports -->
                                <template x-if="isVisible('ports')">
                                    {% set ports_actions %}
                                    <div class="status-pills" x-show="!isMinimized('ports')">
                                        <span class="status-pill running">Running</span>
                                    </div>
                                    {% endset %}
                                    {% call widget_card('ports', 'Top Ports', 'üîå', extra_actions=ports_actions) %}
                                    <table class="table-fixed table-compact">
                                        <thead>
                                            <tr>
                                                <th class="w-70">Port</th>
                                                <th class="w-30">Traffic</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(item, index) in ports.ports" :key="index">
                                                <tr :data-percentage="ports.ports.length > 0 && ports.ports[0]?.bytes ? Math.round((item.bytes / ports.ports[0].bytes) * 100) : 0"
                                                    :style="'--row-percentage: ' + (ports.ports.length > 0 && ports.ports[0]?.bytes ? Math.round((item.bytes / ports.ports[0].bytes) * 100) : 0)">
                                                    <td style="overflow: hidden;">
                                                        <strong class="text-cyan" x-text="item.key"></strong>
                                                        <div class="truncate text-9 text-muted" x-text="item.service"
                                                            :title="item.service"></div>
                                                    </td>
                                                    <td>
                                                        <div class="text-green"
                                                            x-text="item.bytes_fmt || fmtBytes(item.bytes)">
                                                        </div>
                                                        <span class="badge suspicious"
                                                            x-show="item.suspicious">SUSPICIOUS</span>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                    </table>
                                    {% endcall %}
                                </template>

                                <!-- Top ASNs -->
                                <template x-if="isVisible('asns')">
                                    {% set asns_actions %}
                                    <div class="status-pills" x-show="!isMinimized('asns')">
                                        <span class="status-pill running">Live</span>
                                    </div>
                                    {% endset %}
                                    {% set asns_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('asns')">View All</button>
                                    {% endset %}
                                    {% call widget_card('asns', 'Top ASNs', 'üè¢', extra_actions=asns_actions,
                                    footer_content=asns_footer) %}
                                    <div class="widget-body-inner">
                                        <template x-for="asn in asns.asns" :key="asn.asn">
                                            <div class="asn-row">
                                                <div class="asn-name" x-text="asn.asn" :title="asn.asn"></div>
                                                <div class="asn-bar-container">
                                                    <div class="asn-bar"
                                                        :style="'width:' + (asn.bytes / (asns.maxBytes||1) * 100) + '%'">
                                                    </div>
                                                </div>
                                                <div class="asn-val" x-text="asn.bytes_fmt"></div>
                                            </div>
                                        </template>
                                        <div x-show="!asns.loading && (!asns.asns || asns.asns.length === 0)"
                                            class="empty-state">No ASN data available</div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Countries -->
                                <template x-if="isVisible('countries')">
                                    {% set country_actions %}
                                    <div class="status-pills" x-show="!isMinimized('countries')">
                                        <span class="status-pill running">Live</span>
                                    </div>
                                    {% endset %}
                                    {% set country_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('countries')">View
                                        All</button>
                                    {% endset %}
                                    {% call widget_card('countries', 'Top Countries', 'üåç',
                                    extra_actions=country_actions,
                                    footer_content=country_footer) %}
                                    <div class="widget-body-inner">
                                        <div class="chart-wrapper-small chart-expandable"
                                            @click="openFullscreenChart('countriesChart', 'Top Countries by Traffic')"
                                            title="Click to expand">
                                            <canvas id="countriesChart"></canvas>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Top Talkers - MOVED TO FORENSICS TAB -->

                                <!-- Top Services -->
                                <template x-if="isVisible('services')">
                                    {% set svc_actions %}
                                    <div class="status-pills" x-show="!isMinimized('services')">
                                        <span class="status-pill running">Live</span>
                                    </div>
                                    {% endset %}
                                    {% set svc_footer %}
                                    <button class="btn-view-all" @click="openExpandedTable('services')">View
                                        All</button>
                                    {% endset %}
                                    {% call widget_card('services', 'Top Services', 'üåê', extra_actions=svc_actions,
                                    footer_content=svc_footer) %}
                                    <div class="widget-body-inner">
                                        <template x-for="svc in services.services" :key="svc.service">
                                            <div class="service-row">
                                                <div class="service-name" x-text="svc.service" :title="svc.service">
                                                </div>
                                                <div class="service-bar-container">
                                                    <div class="service-bar" :style="'width:' + svc.pct + '%'">
                                                    </div>
                                                </div>
                                                <div class="service-val" x-text="svc.bytes_fmt"></div>
                                            </div>
                                        </template>
                                        <div x-show="!services.loading && (!services.services || services.services.length === 0)"
                                            class="empty-state">No data</div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Traffic by Hour -->
                                <template x-if="isVisible('hourlyTraffic')">
                                    {% call widget_card('hourlyTraffic', 'Traffic by Hour', '‚è∞', show_spinner=True) %}
                                    <div class="hourly-summary">
                                        <div class="hourly-stat">
                                            <span class="hourly-stat-value text-green"
                                                x-text="hourlyTraffic.peak_hour + ':00'"></span>
                                            <span class="hourly-stat-label">Peak Hour</span>
                                        </div>
                                        <div class="hourly-stat">
                                            <span class="hourly-stat-value text-cyan"
                                                x-text="hourlyTraffic.peak_bytes_fmt"></span>
                                            <span class="hourly-stat-label">Peak Traffic</span>
                                        </div>
                                        <div class="hourly-stat">
                                            <span class="hourly-stat-value"
                                                x-text="hourlyTraffic.total_bytes_fmt"></span>
                                            <span class="hourly-stat-label">24h Total</span>
                                        </div>
                                    </div>
                                    <div class="chart-wrapper-small chart-expandable"
                                        @click="openFullscreenChart('hourlyChart', 'Traffic by Hour (24h)')"
                                        title="Click to expand">
                                        <canvas id="hourlyChart"></canvas>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- TCP Flags -->
                                <template x-if="isVisible('flags')">
                                    {% call widget_card('flags', 'TCP Flags', 'üè≥Ô∏è', show_spinner=True) %}
                                    <div class="chart-wrapper-small chart-expandable"
                                        @click="openFullscreenChart('flagsChart', 'TCP Flags Distribution')"
                                        title="Click to expand">
                                        <canvas id="flagsChart"></canvas>
                                    </div>
                                    <div
                                        style="margin-top:10px; font-size:0.75em; color:var(--text-muted); line-height:1.4;">
                                        <strong>Flags:</strong>
                                        <span title="Acknowledge">AP=ACK+PSH</span> ¬∑
                                        <span title="Acknowledge">A=ACK</span> ¬∑
                                        <span title="ACK+PSH+SYN+FIN">APSF=ACK+PSH+SYN+FIN</span> ¬∑
                                        <span title="Reset">R=RST</span> ¬∑
                                        <span title="No flags">None</span>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Long Flows - MOVED TO FORENSICS TAB -->

                                <!-- Packet Size Distribution -->
                                <template x-if="isVisible('packetSizes')">
                                    {% call widget_card('packetSizes', 'Packet Sizes', 'üì¶', show_spinner=True) %}
                                    <div class="chart-wrapper-small chart-expandable"
                                        @click="openFullscreenChart('pktSizeChart', 'Packet Size Distribution')"
                                        title="Click to expand">
                                        <canvas id="pktSizeChart"></canvas>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Protocols -->
                                <template x-if="isVisible('protocols')">
                                    {% call widget_card('protocols', 'Protocols', 'üì°', show_spinner=True) %}
                                    <div class="chart-wrapper-small chart-expandable"
                                        style="margin-bottom: 12px; height: 160px;"
                                        x-show="protoMix && protoMix.labels && protoMix.labels.length > 0"
                                        @click="openFullscreenChart('protoMixChart', 'Protocol Distribution')"
                                        title="Click to expand">
                                        <canvas id="protoMixChart"></canvas>
                                    </div>
                                    <table class="table-fixed table-compact"
                                        x-show="!isMinimized('protocols') && protocols.protocols && protocols.protocols.length > 0">
                                        <thead>
                                            <tr>
                                                <th>Protocol</th>
                                                <th>Stats</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(item, index) in protocols.protocols" :key="index">
                                                <tr>
                                                    <td>
                                                        <strong class="text-cyan" x-text="item.proto_name"></strong>
                                                    </td>
                                                    <td>
                                                        <div class="text-green"
                                                            x-text="item.bytes_fmt || fmtBytes(item.bytes)">
                                                        </div>
                                                        <div class="text-8 text-muted"
                                                            x-text="Number(item.flows).toLocaleString() + ' flows'">
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                    <div x-show="!isMinimized('protocols') && !protocols.loading && (!protocols.protocols || protocols.protocols.length === 0)"
                                        class="empty-state">No protocol data available</div>
                                    {% endcall %}
                                </template>

                                <!-- Traffic Insights -->
                                <template x-if="isVisible('insights')">
                                    {% call widget_card('insights', 'Traffic Insights', 'üí°') %}
                                    <div class="insights-list">
                                        <!-- Top talker insight -->
                                        <div class="insight-item"
                                            x-show="sources.sources && sources.sources.length > 0">
                                            <span class="insight-icon">üìà</span>
                                            <span class="insight-text">
                                                <strong class="text-cyan clickable-ip"
                                                    @click="openIPModal(sources.sources[0]?.key)"
                                                    x-text="sources.sources[0]?.key || 'N/A'"></strong> is the top
                                                talker
                                                with
                                                <strong class="text-green"
                                                    x-text="sources.sources[0]?.bytes_fmt || '0 B'"></strong>
                                            </span>
                                        </div>
                                        <!-- Busiest port insight -->
                                        <div class="insight-item" x-show="ports.ports && ports.ports.length > 0">
                                            <span class="insight-icon">üîå</span>
                                            <span class="insight-text">
                                                Port <strong class="text-cyan"
                                                    x-text="ports.ports[0]?.key || 'N/A'"></strong>
                                                (<span x-text="ports.ports[0]?.service || 'unknown'"></span>)
                                                handles
                                                most
                                                traffic
                                            </span>
                                        </div>
                                        <!-- Protocol breakdown -->
                                        <div class="insight-item"
                                            x-show="protocols.protocols && protocols.protocols.length > 0">
                                            <span class="insight-icon">üì°</span>
                                            <span class="insight-text">
                                                <strong class="text-yellow"
                                                    x-text="protocols.protocols[0]?.proto_name || 'N/A'"></strong>
                                                dominates
                                                with
                                                <strong x-text="protocols.protocols[0]?.bytes_fmt || '0 B'"></strong>
                                            </span>
                                        </div>
                                        <!-- Top destination insight -->
                                        <div class="insight-item"
                                            x-show="destinations.destinations && destinations.destinations.length > 0">
                                            <span class="insight-icon">üéØ</span>
                                            <span class="insight-text">
                                                <strong class="text-green clickable-ip"
                                                    @click="openIPModal(destinations.destinations[0]?.key)"
                                                    x-text="destinations.destinations[0]?.key || 'N/A'"></strong> is
                                                top
                                                destination with
                                                <strong class="text-cyan"
                                                    x-text="destinations.destinations[0]?.bytes_fmt || '0 B'"></strong>
                                            </span>
                                        </div>
                                        <!-- Total traffic summary -->
                                        <div class="insight-item" x-show="summary.total_bytes">
                                            <span class="insight-icon">üìä</span>
                                            <span class="insight-text">
                                                Total traffic: <strong class="text-cyan"
                                                    x-text="fmtBytes(summary.total_bytes || 0)"></strong> across
                                                <strong x-text="(summary.total_flows || 0).toLocaleString()"></strong>
                                                flows
                                            </span>
                                        </div>
                                        <!-- Threat status - fixed template syntax -->
                                        <div class="insight-item" x-show="(threats.hits?.length || 0) === 0">
                                            <span class="insight-icon">‚úÖ</span>
                                            <span class="insight-text text-green">Network traffic is clean - no
                                                threats
                                                detected</span>
                                        </div>
                                        <div class="insight-item" x-show="(threats.hits?.length || 0) > 0">
                                            <span class="insight-icon">‚ö†Ô∏è</span>
                                            <span class="insight-text text-red">
                                                <strong x-text="threats.hits?.length || 0"></strong> threat IPs
                                                detected
                                                in
                                                traffic!
                                            </span>
                                        </div>
                                        <!-- Empty state -->
                                        <div class="empty-state"
                                            x-show="!sources.sources?.length && !ports.ports?.length && !protocols.protocols?.length">
                                            Loading insights...
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Flow Statistics -->
                                <template x-if="isVisible('flowStats')">
                                    {% call widget_card('flowStats', 'Flow Statistics', 'üìä', show_spinner=True) %}
                                    <div class="flow-stats-grid">
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-cyan"
                                                x-text="(flowStats.total_flows || 0).toLocaleString()"></span>
                                            <span class="flow-stat-label">Total Flows</span>
                                        </div>
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-green"
                                                x-text="flowStats.avg_duration_fmt || '0s'"></span>
                                            <span class="flow-stat-label">Avg Duration</span>
                                        </div>
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-cyan"
                                                x-text="flowStats.avg_bytes_fmt || '0 B'"></span>
                                            <span class="flow-stat-label">Avg Size</span>
                                        </div>
                                        <div class="flow-stat-item">
                                            <span class="flow-stat-value text-yellow"
                                                x-text="(flowStats.bytes_per_packet || 0) + ' B'"></span>
                                            <span class="flow-stat-label">Bytes/Pkt</span>
                                        </div>
                                    </div>
                                    <div class="duration-dist"
                                        x-show="!isMinimized('flowStats') && flowStats.duration_dist">
                                        <div class="duration-dist-label">Duration Distribution:</div>
                                        <div class="duration-dist-bars">
                                            <div class="dist-bar-group">
                                                <div class="dist-bar short"
                                                    :style="'width:' + (flowStats.duration_dist?.short / (flowStats.total_flows || 1) * 100) + '%'">
                                                </div>
                                                <span class="dist-label">&lt;1s</span>
                                            </div>
                                            <div class="dist-bar-group">
                                                <div class="dist-bar medium"
                                                    :style="'width:' + (flowStats.duration_dist?.medium / (flowStats.total_flows || 1) * 100) + '%'">
                                                </div>
                                                <span class="dist-label">1s-1m</span>
                                            </div>
                                            <div class="dist-bar-group">
                                                <div class="dist-bar long"
                                                    :style="'width:' + (flowStats.duration_dist?.long / (flowStats.total_flows || 1) * 100) + '%'">
                                                </div>
                                                <span class="dist-label">&gt;1m</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>





                                <!-- Network Health -->
                                <template x-if="isVisible('netHealth')">
                                    {% call widget_card('netHealth', 'Network Health', 'üè•', show_spinner=True) %}
                                    <div class="health-summary">
                                        <span class="health-icon" x-text="netHealth.status_icon || 'üíö'"></span>
                                        <span class="health-score" :class="'health-' + (netHealth.status || 'healthy')"
                                            x-text="netHealth.health_score || 100"></span>
                                        <span class="health-label"
                                            x-text="(netHealth.status || 'healthy').toUpperCase()"></span>
                                    </div>
                                    <div class="health-indicators">
                                        <template x-for="ind in netHealth.indicators" :key="ind.name">
                                            <div class="health-indicator" :class="'status-' + ind.status">
                                                <span class="ind-icon" x-text="ind.icon"></span>
                                                <span class="ind-name" x-text="ind.name"></span>
                                                <span class="ind-value" x-text="ind.value"></span>
                                            </div>
                                        </template>
                                    </div>
                                    {% endcall %}
                                </template>

                            </div>
                        </section>

                    </div>

                    <!-- ============================================
             FORENSICS TAB - Investigation & Incident Response
             ============================================ -->
                    <div x-show="activeTab === 'forensics'"
                        :style="activeTab === 'forensics' ? 'display:block' : 'display:none'" id="forensics-tab"
                        role="tabpanel" aria-labelledby="forensics-tab-btn" tabindex="0">
                        <!-- ========================================
     FIREWALL LOGS (Moved from Security)
     ======================================== -->
                        <section id="section-firewall-forensics" class="scroll-section">
                            <!-- Firewall Logs Widget -->
                            <!-- Firewall Logs Widget -->
                            {% set fw_actions %}
                            <div class="card-actions" style="gap: 8px; flex-wrap: wrap;"
                                x-show="!isMinimized('recentBlocks')">
                                <span class="badge"
                                    :style="recentBlocksAutoRefresh ? 'background: rgba(255,0,60,0.2); color: var(--neon-red);' : 'background: rgba(100,100,100,0.2); color: var(--text-muted);'"
                                    style="font-size: 0.85em;"
                                    x-text="recentBlocksAutoRefresh ? 'üî¥ LIVE' : '‚è∏ PAUSED'"></span>
                                <span class="badge"
                                    style="background: rgba(0,255,100,0.2); color: var(--neon-green); font-size: 0.9em;"
                                    x-text="(recentBlocks.stats?.blocks_last_hour || 0).toLocaleString() + ' blocks (1h)'"></span>
                                <span class="badge"
                                    style="background: rgba(255,0,60,0.18); color: var(--neon-red); font-size: 0.9em;"
                                    x-text="(recentBlocks.stats?.threats || 0).toLocaleString() + ' threats'"></span>
                                <button class="icon-btn-small"
                                    @click="recentBlocksAutoRefresh = !recentBlocksAutoRefresh; toggleRecentBlocksAutoRefresh()"
                                    :title="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                                    :aria-label="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" x-show="recentBlocksAutoRefresh">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" x-show="!recentBlocksAutoRefresh">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="10" y1="8" x2="10" y2="16"></line>
                                        <line x1="14" y1="8" x2="14" y2="16"></line>
                                    </svg>
                                </button>
                            </div>
                            {% endset %}
                            {% call widget_card('recentBlocks', 'Live Firewall Logs', 'üî•', card_class='wide-card',
                            extra_actions=fw_actions, show_spinner=True) %}
                            <div x-show="recentBlocks.blocks.length === 0 && !recentBlocks.loading" class="empty-state">
                                <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">‚úÖ</div>
                                <p
                                    style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                    No firewall logs yet</p>
                                <p style="font-size: var(--text-xs); color: var(--text-tertiary);">The firewall has not
                                    blocked any recent traffic.</p>
                            </div>
                            <div x-show="recentBlocks.blocks.length > 0">
                                <div class="log-toolbar">
                                    <div class="log-chips">
                                        <span class="log-chip"><strong
                                                x-text="(recentBlocks.stats?.total || recentBlocks.blocks.length).toLocaleString()"></strong>
                                            Logs</span>
                                        <span class="log-chip log-chip-green"><strong
                                                x-text="((recentBlocks.stats?.actions?.block || 0) + (recentBlocks.stats?.actions?.reject || 0)).toLocaleString()"></strong>
                                            Block/Reject</span>
                                        <span class="log-chip log-chip-blue"><strong
                                                x-text="(recentBlocks.stats?.actions?.pass || 0).toLocaleString()"></strong>
                                            Pass</span>
                                        <span class="log-chip log-chip-pink"><strong
                                                x-text="(recentBlocks.stats?.threats || 0).toLocaleString()"></strong>
                                            Threat</span>
                                        <span class="log-chip log-chip-slate"><strong
                                                x-text="(recentBlocks.stats?.unique_src || 0).toLocaleString()"></strong>
                                            Src</span>
                                        <span class="log-chip log-chip-slate"><strong
                                                x-text="(recentBlocks.stats?.unique_dst || 0).toLocaleString()"></strong>
                                            Dst</span>
                                    </div>
                                    <div class="log-controls">
                                        <span class="log-count"
                                            x-text="'Showing ' + Math.min(recentBlocksView || filteredRecentBlocks.length, filteredRecentBlocks.length).toLocaleString() + ' / ' + (filteredRecentBlocks.length || 0).toLocaleString() + ' (of ' + (recentBlocks.blocks.length || 0).toLocaleString() + ' total)'"></span>
                                        <span class="log-update-time" x-show="recentBlocks.lastUpdate"
                                            :title="recentBlocks.lastUpdate"
                                            x-text="'Updated ' + timeAgo(new Date(recentBlocks.lastUpdate).getTime() / 1000)"></span>
                                        <div class="log-range">
                                            <button :class="{ 'active': recentBlocksView === 50 }"
                                                @click="setRecentBlocksView(50)">50</button>
                                            <button :class="{ 'active': recentBlocksView === 200 }"
                                                @click="setRecentBlocksView(200)">200</button>
                                            <button :class="{ 'active': recentBlocksView === 1000 }"
                                                @click="setRecentBlocksView(1000)">1000</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Enhanced Filters -->
                                <div class="log-filters"
                                    style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(255, 255, 255, 0.02); border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.05);">
                                    <select x-model="recentBlocksFilter.action" class="filter-select"
                                        style="min-width: 120px;" aria-label="Filter by action">
                                        <option value="all">All Actions</option>
                                        <option value="block">Block</option>
                                        <option value="reject">Reject</option>
                                        <option value="pass">Pass</option>
                                    </select>
                                    <input type="text" x-model="recentBlocksFilter.searchIP"
                                        placeholder="Search IP address..." class="search-box"
                                        style="flex: 1; min-width: 200px; max-width: 300px;"
                                        aria-label="Search by IP address">
                                    <input type="text" x-model="recentBlocksFilter.port" placeholder="Filter by port..."
                                        class="search-box" style="min-width: 120px; max-width: 150px;"
                                        aria-label="Filter by port">
                                    <select x-model="recentBlocksFilter.protocol" class="filter-select"
                                        style="min-width: 120px;" aria-label="Filter by protocol">
                                        <option value="all">All Protocols</option>
                                        <option value="TCP">TCP</option>
                                        <option value="UDP">UDP</option>
                                        <option value="ICMP">ICMP</option>
                                    </select>
                                    <label
                                        style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" x-model="recentBlocksFilter.threatOnly"
                                            style="cursor: pointer;">
                                        <span style="color: var(--text-secondary); font-size: var(--text-sm);">Threats
                                            Only</span>
                                    </label>
                                    <button
                                        @click="recentBlocksFilter = { action: 'all', searchIP: '', port: '', protocol: 'all', threatOnly: false }"
                                        class="btn btn--secondary" style="white-space: nowrap;"
                                        :disabled="recentBlocksFilter.action === 'all' && !recentBlocksFilter.searchIP && !recentBlocksFilter.port && recentBlocksFilter.protocol === 'all' && !recentBlocksFilter.threatOnly">
                                        Clear Filters
                                    </button>
                                </div>

                                <div class="log-table-wrapper">
                                    <table class="table-fixed table-compact thead-sticky"
                                        x-show="recentBlocks.blocks.length > 0">
                                        <thead>
                                            <tr>
                                                <th class="w-16">Time</th>
                                                <th class="w-13">Dir / IF</th>
                                                <th class="w-22">Source</th>
                                                <th class="w-4"></th>
                                                <th style="width: 25%;">Destination</th>
                                                <th style="width: 10%;">Protocol</th>
                                                <th style="width: 10%;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template
                                                x-for="block in filteredRecentBlocks.slice(0, recentBlocksView || filteredRecentBlocks.length)"
                                                :key="block.id || (block.src_ip + block.timestamp + block.dst_port)">
                                                <tr
                                                    :class="{ 'log-row-threat': block.is_threat, 'log-row-pass': block.action === 'pass' }">
                                                    <td style="font-size: 0.85em; color: var(--text-muted);">
                                                        <div style="font-family: monospace;"
                                                            x-text="(block.timestamp || '').replace('T', ' ').split('.')[0] || block.timestamp">
                                                        </div>
                                                        <div class="log-sub" x-text="timeAgo(block.timestamp_ts)">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="log-direction"
                                                            :class="block.direction === 'in' ? 'text-green' : 'text-cyan'">
                                                            <span
                                                                x-text="(block.direction || 'in').toUpperCase()"></span>
                                                            <span class="log-sub" x-text="block.interface || '-'"
                                                                style="display:block;"></span>
                                                        </div>
                                                    </td>
                                                    <td @click="openIPInvestigationModal(block.src_ip)"
                                                        style="cursor: pointer;" title="Click to investigate IP">
                                                        <div class="truncate"><strong class="text-green"
                                                                x-text="block.src_ip || '--'"></strong>
                                                        </div>
                                                        <div class="log-sub"
                                                            x-text="block.src_port ? 'Port ' + block.src_port : ''">
                                                        </div>
                                                    </td>
                                                    <td style="text-align: center; color: var(--text-muted);">
                                                        ‚Üí
                                                    </td>
                                                    <td @click="openIPInvestigationModal(block.dst_ip)"
                                                        style="cursor: pointer;" title="Click to investigate IP">
                                                        <div class="truncate">
                                                            <span class="text-cyan"
                                                                x-text="block.dst_ip || '192.168.0.1'"></span>
                                                            <span class="port-badge" style="margin-left: 4px;"
                                                                x-show="block.dst_port"
                                                                x-text="':' + block.dst_port"></span>
                                                        </div>
                                                        <div class="log-sub"
                                                            x-text="block.service || 'Unknown service'">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                            style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                                            x-text="(block.proto || 'TCP').toUpperCase()"></span>
                                                        <div class="log-sub" x-show="block.direction"
                                                            x-text="block.direction === 'in' ? 'Inbound' : 'Outbound'">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                            :style="(block.action === 'pass') ? 'background: rgba(0,255,100,0.2); color: var(--neon-green);' : 'background: rgba(255,0,60,0.2); color: var(--neon-red);'"
                                                            x-text="(block.action || 'block').toUpperCase()"></span>
                                                        <div class="log-sub" x-show="block.is_threat"
                                                            style="color: var(--neon-red);">Threat</div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endcall %}
                        </section>
                        <!-- ========================================
     FORENSICS INVESTIGATION TOOLS
     ======================================== -->

                        <!-- IP Deep Dive Investigation - Compact Search Bar -->
                        <!-- IP Deep Dive Investigation -->
                        <section id="section-ip-investigation" class="scroll-section" style="margin-bottom: 24px;">
                            {% call widget_card('ipInvestigation', 'IP Deep Dive Investigation', 'üîç',
                            card_class='wide-card', show_spinner=False) %}
                            <div class="forensics-search-bar"
                                style="display: flex; align-items: center; gap: var(--space-3);">
                                <input type="text" x-model="ipInvestigation.searchIP" @keyup.enter="investigateIP()"
                                    aria-label="IP address to investigate"
                                    placeholder="Search IP address, hostname, or domain to investigate..."
                                    class="search-box" style="flex: 1; max-width: 600px;">
                                <button @click="investigateIP()" class="btn btn--primary"
                                    :disabled="!ipInvestigation.searchIP.trim() || ipInvestigation.loading">
                                    <span x-show="!ipInvestigation.loading">Investigate</span>
                                    <span x-show="ipInvestigation.loading">Loading...</span>
                                </button>
                                <div class="spinner" x-show="ipInvestigation.loading"></div>
                            </div>
                            {% endcall %}
                        </section>


                        <!-- Alert Correlation & Attack Chains -->
                        <section id="section-alert-correlation" class="scroll-section" style="margin-bottom: 32px;">
                            {% call widget_card('alertCorrelation', 'Alert Correlation & Attack Chains', 'üîó',
                            card_class='wide-card', show_spinner=True) %}
                            <!-- Explanation Panel (Collapsible) -->
                            <div class="card"
                                style="margin-bottom: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0, 243, 255, 0.06); border: 1px solid rgba(0, 243, 255, 0.15); border-radius: var(--radius-sm);">
                                <button @click="alertCorrelation.showExplanation = !alertCorrelation.showExplanation"
                                    style="display: flex; align-items: center; gap: var(--space-2); width: 100%; background: none; border: none; color: var(--neon-cyan); cursor: pointer; padding: 0; font-size: var(--text-sm);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        :style="'transform: rotate(' + (alertCorrelation.showExplanation ? '90' : '0') + 'deg); transition: transform 0.2s;'">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                    <span style="font-weight: var(--font-weight-semibold);">‚ÑπÔ∏è How Alert
                                        Correlation
                                        Works</span>
                                </button>
                                <div x-show="alertCorrelation.showExplanation"
                                    style="margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.5;">
                                    <p style="margin: 0 0 var(--space-2) 0;">Analyzes security alerts to
                                        identify
                                        <strong>multi-stage attack chains</strong> by correlating related
                                        alerts
                                        from the same IP address within a 1-hour time window.
                                    </p>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-2); font-size: var(--text-xs);">
                                        <div><strong>üîç Detection:</strong> Groups
                                            by IP and time proximity</div>
                                        <div><strong>‚ö° Chains:</strong> Sequences
                                            of related security events</div>
                                        <div><strong>üéØ Use:</strong> Identify
                                            attack progression patterns</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats Summary -->
                            <div
                                style="display: flex; gap: var(--space-2); margin-bottom: var(--space-3); flex-wrap: wrap;">
                                <div class="card"
                                    style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Attack Chains</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                        x-text="alertCorrelation.chains?.length || 0"></div>
                                </div>
                                <div class="card"
                                    style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Total Alerts Correlated</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-cyan);"
                                        x-text="(alertCorrelation.chains || []).reduce((sum, chain) => sum + (chain.alerts?.length || 0), 0)">
                                    </div>
                                </div>
                            </div>

                            <!-- Attack Chains List -->
                            <div x-show="alertCorrelation.chains && alertCorrelation.chains.length > 0">
                                <template x-for="(chain, idx) in alertCorrelation.chains" :key="idx">
                                    <div class="card"
                                        style="margin-bottom: var(--space-4); border-left: 4px solid var(--neon-red); background: rgba(255,0,60,0.05); transition: background var(--motion-base);">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3); flex-wrap: wrap; gap: var(--space-2);">
                                            <div style="flex: 1;">
                                                <div
                                                    style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                                    <strong class="text-red" style="font-size: var(--text-lg);">Attack
                                                        Chain
                                                        #<span x-text="idx + 1"></span></strong>
                                                    <span class="badge"
                                                        style="background: rgba(255,0,60,0.2); color: var(--neon-red); font-size: var(--text-sm);"
                                                        x-text="chain.alerts.length + ' alerts'"></span>
                                                </div>
                                                <div style="margin-bottom: var(--space-2);">
                                                    <span
                                                        style="color: var(--text-secondary); font-size: var(--text-sm);">Source
                                                        IP: </span>
                                                    <span class="text-cyan"
                                                        style="font-family: var(--font-mono); font-weight: var(--font-weight-semibold); cursor: pointer;"
                                                        @click="openIPInvestigationModal(chain.ip)" x-text="chain.ip"
                                                        title="Click to investigate this IP"></span>
                                                </div>
                                                <div style="color: var(--text-muted); font-size: var(--text-sm);">
                                                    <span x-text="chain.timespan"></span>
                                                </div>
                                            </div>
                                            <button @click="openIPInvestigationModal(chain.ip)"
                                                class="btn btn--secondary"
                                                style="white-space: nowrap; font-size: var(--text-sm);">
                                                üîç Investigate IP
                                            </button>
                                        </div>
                                        <div>
                                            <div
                                                style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--text-primary); font-size: var(--text-sm);">
                                                Attack Progression Timeline:</div>
                                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                                <template x-for="(alert, alertIdx) in chain.alerts" :key="alert.id">
                                                    <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border-left: 3px solid var(--neon-red); transition: background var(--motion-base);"
                                                        :style="alertIdx === 0 ? 'border-left-color: var(--neon-green);' : (alertIdx === chain.alerts.length - 1 ? 'border-left-color: var(--neon-red);' : 'border-left-color: var(--neon-yellow);')">
                                                        <div style="flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: rgba(255,0,60,0.2); display: flex; align-items: center; justify-content: center; font-size: var(--text-xs); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                                            x-text="alertIdx + 1"></div>
                                                        <div style="flex: 1; min-width: 0;">
                                                            <div
                                                                style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; margin-bottom: var(--space-1);">
                                                                <span class="badge"
                                                                    :class="'cat-' + (alert.type || '').toLowerCase().replace(/[^a-z0-9]/g, '-')"
                                                                    style="font-size: var(--text-xs);"
                                                                    x-text="alert.type || 'Unknown'"></span>
                                                                <span
                                                                    style="color: var(--text-muted); font-size: var(--text-xs); font-family: var(--font-mono);"
                                                                    x-text="alert.time"></span>
                                                            </div>
                                                            <div style="color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.4;"
                                                                x-text="alert.message || 'Security alert detected'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!alertCorrelation.chains || alertCorrelation.chains.length === 0"
                                class="empty-state">
                                <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">‚úÖ</div>
                                <p
                                    style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                    No Correlated Attack Chains Detected</p>
                                <p
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); max-width: 400px; margin: 0 auto;">
                                    No multi-stage attack patterns identified. Network appears secure or attacks are
                                    isolated events.
                                </p>
                            </div>
                            {% endcall %}
                        </section>

                        <!-- Threat Activity Timeline -->
                        <section id="section-threat-activity-timeline" class="scroll-section"
                            style="margin-bottom: 24px;">
                            {% set threat_actions %}
                            <button class="icon-btn-small" @click="exportThreatActivityTimeline('csv')"
                                title="Export CSV" style="color: var(--neon-green);"
                                x-show="!isMinimized('threatActivityTimeline') && threatActivityTimeline.timeline && threatActivityTimeline.timeline.length > 0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                            {% endset %}
                            {% call widget_card('threatActivityTimeline', 'Threat Activity Timeline', 'üìà',
                            card_class='wide-card', extra_actions=threat_actions, show_spinner=True) %}
                            <!-- Time Range Selector -->
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); flex-wrap: wrap; gap: var(--space-1);">
                                <div style="display: flex; gap: var(--space-1); flex-wrap: wrap;">
                                    <button
                                        @click="threatActivityTimeline.timeRange = '1h'; fetchThreatActivityTimeline()"
                                        :class="{ 'btn--primary': threatActivityTimeline.timeRange === '1h', 'btn--secondary': threatActivityTimeline.timeRange !== '1h' }"
                                        class="btn"
                                        style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                        1 Hour
                                    </button>
                                    <button
                                        @click="threatActivityTimeline.timeRange = '6h'; fetchThreatActivityTimeline()"
                                        :class="{ 'btn--primary': threatActivityTimeline.timeRange === '6h', 'btn--secondary': threatActivityTimeline.timeRange !== '6h' }"
                                        class="btn"
                                        style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                        6 Hours
                                    </button>
                                    <button
                                        @click="threatActivityTimeline.timeRange = '24h'; fetchThreatActivityTimeline()"
                                        :class="{ 'btn--primary': threatActivityTimeline.timeRange === '24h', 'btn--secondary': threatActivityTimeline.timeRange !== '24h' }"
                                        class="btn"
                                        style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                        24 Hours
                                    </button>
                                    <button
                                        @click="threatActivityTimeline.timeRange = '7d'; fetchThreatActivityTimeline()"
                                        :class="{ 'btn--primary': threatActivityTimeline.timeRange === '7d', 'btn--secondary': threatActivityTimeline.timeRange !== '7d' }"
                                        class="btn"
                                        style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                        7 Days
                                    </button>
                                </div>
                                <div style="display: flex; gap: var(--space-1); flex-wrap: wrap;">
                                    <button @click="exportThreatActivityTimeline('csv')" class="btn btn--secondary"
                                        style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);"
                                        :disabled="!threatActivityTimeline.timeline || threatActivityTimeline.timeline.length === 0">
                                        üì• CSV
                                    </button>
                                    <button @click="exportThreatActivityTimeline('json')" class="btn btn--secondary"
                                        style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);"
                                        :disabled="!threatActivityTimeline.timeline || threatActivityTimeline.timeline.length === 0">
                                        üì• JSON
                                    </button>
                                </div>
                            </div>

                            <!-- Stats Summary -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: var(--space-2); margin-bottom: var(--space-2);">
                                <div class="card" style="padding: var(--space-1) var(--space-2); text-align: center;">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Total Threats</div>
                                    <div style="font-size: var(--text-lg); font-weight: var(--font-weight-bold); color: var(--neon-cyan);"
                                        x-text="threatActivityTimeline.total_24h || 0"></div>
                                </div>
                                <div class="card" style="padding: var(--space-1) var(--space-2); text-align: center;"
                                    x-show="threatActivityTimeline.peak_hour">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Peak Hour</div>
                                    <div style="font-size: var(--text-sm); font-weight: var(--font-weight-semibold); color: var(--neon-red);"
                                        x-text="threatActivityTimeline.peak_hour || 'N/A'"></div>
                                    <div style="font-size: var(--text-xs); color: var(--text-muted);"
                                        x-text="(threatActivityTimeline.peak_count || 0) + ' threats'">
                                    </div>
                                </div>
                                <div class="card" style="padding: var(--space-1) var(--space-2); text-align: center;"
                                    x-show="threatActivityTimeline.has_fw_data">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        FW Blocks</div>
                                    <div style="font-size: var(--text-lg); font-weight: var(--font-weight-bold); color: var(--neon-green);"
                                        x-text="threatActivityTimeline.fw_blocks_24h || 0"></div>
                                </div>
                            </div>

                            <!-- Chart -->
                            <div class="chart-wrapper" style="height: 200px; margin-bottom: var(--space-2);"
                                x-show="threatActivityTimeline.timeline && threatActivityTimeline.timeline.length > 0">
                                <canvas id="threatActivityTimelineChart"></canvas>
                            </div>

                            <!-- Description (Collapsible) -->
                            <div
                                style="padding: var(--space-1) var(--space-2); background: rgba(0, 243, 255, 0.04); border-radius: var(--radius-sm); border: 1px solid rgba(0, 243, 255, 0.08);">
                                <button
                                    @click="threatActivityTimeline.showDescription = !threatActivityTimeline.showDescription"
                                    style="display: flex; align-items: center; gap: var(--space-1); width: 100%; background: none; border: none; color: var(--neon-cyan); cursor: pointer; padding: 0; font-size: var(--text-xs);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        :style="'transform: rotate(' + (threatActivityTimeline.showDescription ? '90' : '0') + 'deg); transition: transform 0.2s;'">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                    <span style="font-weight: var(--font-weight-semibold);">üìä About this
                                        timeline</span>
                                </button>
                                <div x-show="threatActivityTimeline.showDescription"
                                    style="margin-top: var(--space-1); padding-top: var(--space-1); border-top: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); font-size: var(--text-xs); line-height: 1.4;">
                                    Shows threat activity patterns over time. Stacked bars show threats by
                                    severity
                                    (Critical, High, Medium, Low), with firewall blocks as a green line
                                    overlay.
                                    Use
                                    to correlate threat activity with Alert Correlation data.
                                </div>
                            </div>

                            <!-- Empty State -->
                            <!-- Empty State -->
                            <div x-show="!threatActivityTimeline.loading && (!threatActivityTimeline.timeline || threatActivityTimeline.timeline.length === 0)"
                                class="empty-state">
                                <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">üìà</div>
                                <p
                                    style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                    No Threat Activity Data</p>
                                <p
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); max-width: 400px; margin: 0 auto;">
                                    No threat activity detected in the selected time range. Network appears secure or
                                    activity is low.
                                </p>
                            </div>
                            {% endcall %}
                        </section>

                        <!-- Active Flows Widget -->
                        <section id="section-flows" class="scroll-section" style="margin-bottom: 32px;">
                            {% set conv_actions %}
                            <!-- View Toggle -->

                            {% endset %}
                            {% call widget_card('flows', 'Active Flows', '‚ö°', card_class='wide-card',
                            extra_actions=conv_actions, footer_content=conv_footer, show_spinner=True) %}
                            <!-- List View -->
                            <table class="table-fixed table-compact" x-show="!isMinimized('flows')">
                                <thead>
                                    <tr>
                                        <th style="width: 15%; cursor: pointer;" @click="sortFlows('age')">
                                            Age <span x-show="flows.sortKey==='age'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 30%; cursor: pointer;" @click="sortFlows('src')">
                                            Source <span x-show="flows.sortKey==='src'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 5%;"></th>
                                        <th style="width: 30%; cursor: pointer;" @click="sortFlows('dst')">
                                            Destination <span x-show="flows.sortKey==='dst'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 10%; cursor: pointer;" @click="sortFlows('proto_name')">
                                            Proto <span x-show="flows.sortKey==='proto_name'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 10%; cursor: pointer;" @click="sortFlows('bytes')">
                                            Stats <span x-show="flows.sortKey==='bytes'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(flow, idx) in flows.flows" :key="idx">
                                        <tr class="flow-item">
                                            <td class="text-xs text-muted font-mono" x-text="timeAgo(flow.ts)">
                                            </td>
                                            <td @click="openIPModal(flow.src)"
                                                style="padding: 6px 8px; overflow: hidden;">
                                                <div
                                                    style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                                    <span
                                                        :class="'flag-icon flag-icon-' + (flow.src_country_code || 'unknown').toLowerCase()"
                                                        style="font-size: 1.1em;"></span>
                                                    <strong class="text-cyan truncate" x-text="flow.src"></strong>
                                                </div>
                                                <div class="flex items-center space-x-1" style="margin-top:2px;">
                                                    <span class="text-muted" style="font-size:0.8em;">:</span>
                                                    <span class="text-muted" style="font-size:0.85em;"
                                                        x-text="flow.src_port"></span>
                                                    <span class="text-muted" style="font-size:0.8em;"
                                                        x-show="flow.service && flow.service!='unknown'"
                                                        x-text="'(' + flow.service + ')'"></span>
                                                </div>
                                            </td>
                                            <td style="text-align:center; color:var(--text-muted); padding: 6px 8px;">‚ûú
                                            </td>
                                            <td @click="openIPModal(flow.dst)"
                                                style="padding: 6px 8px; overflow: hidden;">
                                                <div
                                                    style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                                    <span
                                                        :class="'flag-icon flag-icon-' + (flow.dst_country_code || 'unknown').toLowerCase()"
                                                        style="font-size: 1.1em;"></span>
                                                    <strong class="text-cyan truncate" x-text="flow.dst"></strong>
                                                </div>
                                                <div class="flex items-center space-x-1" style="margin-top:2px;">
                                                    <span class="text-muted" style="font-size:0.8em;">:</span>
                                                    <span class="text-muted" style="font-size:0.85em;"
                                                        x-text="flow.dst_port"></span>
                                                    <span class="text-muted" style="font-size:0.8em;"
                                                        x-show="flow.service && flow.service!='unknown'"
                                                        x-text="'(' + flow.service + ')'"></span>
                                                </div>
                                            </td>
                                            <td style="padding: 6px 8px;">
                                                <div style="font-size:0.85em; white-space: nowrap;">
                                                    <strong x-text="flow.proto_name"></strong>
                                                    <span style="color:var(--text-muted); margin-left:4px;"
                                                        x-text="flow.service"></span>
                                                </div>
                                            </td>
                                            <td style="padding: 6px 8px;">
                                                <div style="font-size:0.85em; white-space: nowrap;">
                                                    <strong class="text-green" x-text="flow.bytes_fmt"></strong>
                                                    <span style="color:var(--text-muted); margin-left:4px;"
                                                        x-text="'(' + flow.duration + ')'"></span>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>

                            <!-- Sankey View -->
                            {% endcall %}
                        </section>
                    </div>

                    <!-- ============================================
             SERVER TAB - Server Health & Statistics
             ============================================ -->
                    <div x-show="activeTab === 'server'"
                        :style="activeTab === 'server' ? 'display:block' : 'display:none'" id="server-tab"
                        role="tabpanel" aria-labelledby="server-tab-btn" tabindex="0">
                        <section id="section-server" class="scroll-section" style="margin-bottom: 32px;">
                            <!-- Loading State -->
                            <template x-if="serverHealth.loading">
                                <div class="empty-state">
                                    <span>Loading server health data...</span>
                                </div>
                            </template>

                            <!-- Error State -->
                            <template x-if="serverHealth.error && !serverHealth.loading">
                                <div class="empty-state" style="color: var(--neon-red);">
                                    <span x-text="serverHealth.error"></span>
                                </div>
                            </template>

                            <!-- Server Health Content -->
                            <template x-if="!serverHealth.loading && !serverHealth.error">
                                <div class="grid"
                                    style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

                                    <!-- CPU Statistics -->
                                    {% set cpu_badge %}
                                    <span class="server-stat-badge" :class="{
                                    'badge-success': serverHealth.cpu.percent < 70,
                                    'badge-warning': serverHealth.cpu.percent >= 70 && serverHealth.cpu.percent < 90,
                                    'badge-error': serverHealth.cpu.percent >= 90
                                }" x-text="serverHealth.cpu.percent ? serverHealth.cpu.percent + '%' : 'N/A'"></span>
                                    {% endset %}
                                    <div x-show="serverHealth.cpu && !serverHealth.cpu.error">
                                        {% call widget_card('server_cpu', 'CPU', '‚ö°', extra_actions=cpu_badge) %}
                                        <div class="server-stat-value"
                                            x-text="serverHealth.cpu.percent ? serverHealth.cpu.percent + '%' : 'N/A'">
                                        </div>
                                        <!-- Progress Bar -->
                                        <div class="server-stat-progress"
                                            x-show="serverHealth.cpu.percent !== undefined">
                                            <div class="server-stat-progress-bar" :class="{
                                        'warning': serverHealth.cpu.percent >= 70 && serverHealth.cpu.percent < 90,
                                        'error': serverHealth.cpu.percent >= 90
                                    }" :style="'width: ' + (serverHealth.cpu.percent || 0) + '%'"></div>
                                        </div>
                                        <div class="server-stat-details" x-show="serverHealth.cpu.load_1min">
                                            <div>
                                                <span>Load 1m:</span>
                                                <span x-text="serverHealth.cpu.load_1min"></span>
                                            </div>
                                            <div>
                                                <span>Load 5m:</span>
                                                <span x-text="serverHealth.cpu.load_5min"></span>
                                            </div>
                                            <div>
                                                <span>Load 15m:</span>
                                                <span x-text="serverHealth.cpu.load_15min"></span>
                                            </div>
                                            <div x-show="serverHealth.cpu.frequency_mhz">
                                                <span>Frequency:</span>
                                                <span x-text="serverHealth.cpu.frequency_mhz + ' MHz'"></span>
                                            </div>
                                            <div x-show="serverHealth.cpu?.process_count">
                                                <span>Processes:</span>
                                                <span x-text="serverHealth.cpu?.process_count?.toLocaleString()"></span>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </div>



                                    <!-- Memory Statistics -->
                                    {% set mem_badge %}
                                    <span class="server-stat-badge" :class="{
                                    'badge-success': serverHealth.memory.percent < 80,
                                    'badge-warning': serverHealth.memory.percent >= 80 && serverHealth.memory.percent < 90,
                                    'badge-error': serverHealth.memory.percent >= 90
                                }" x-text="serverHealth.memory.percent ? serverHealth.memory.percent + '%' : 'N/A'"></span>
                                    {% endset %}
                                    <div x-show="serverHealth.memory && !serverHealth.memory.error">
                                        {% call widget_card('server_memory', 'Memory', 'üíæ', extra_actions=mem_badge) %}
                                        <div class="server-stat-value"
                                            x-text="serverHealth.memory.percent ? serverHealth.memory.percent + '%' : 'N/A'">
                                        </div>
                                        <!-- Progress Bar -->
                                        <div class="server-stat-progress"
                                            x-show="serverHealth.memory.percent !== undefined">
                                            <div class="server-stat-progress-bar" :class="{
                                        'warning': serverHealth.memory.percent >= 80 && serverHealth.memory.percent < 90,
                                        'error': serverHealth.memory.percent >= 90
                                    }" :style="'width: ' + (serverHealth.memory.percent || 0) + '%'"></div>
                                        </div>
                                        <div class="server-stat-details" x-show="serverHealth.memory.total_gb">
                                            <div>
                                                <span>Used:</span>
                                                <span
                                                    x-text="serverHealth.memory.used_gb ? serverHealth.memory.used_gb + ' GB' : 'N/A'"></span>
                                            </div>
                                            <div>
                                                <span>Available:</span>
                                                <span
                                                    x-text="serverHealth.memory.available_gb ? serverHealth.memory.available_gb + ' GB' : 'N/A'"></span>
                                            </div>
                                            <div>
                                                <span>Total:</span>
                                                <span
                                                    x-text="serverHealth.memory.total_gb ? serverHealth.memory.total_gb + ' GB' : 'N/A'"></span>
                                            </div>
                                            <div x-show="serverHealth.memory.buffers_gb">
                                                <span>Buffers:</span>
                                                <span x-text="serverHealth.memory.buffers_gb + ' GB'"></span>
                                            </div>
                                            <div x-show="serverHealth.memory.cached_gb">
                                                <span>Cached:</span>
                                                <span x-text="serverHealth.memory.cached_gb + ' GB'"></span>
                                            </div>
                                            <div x-show="serverHealth.memory.process_mb">
                                                <span>Process:</span>
                                                <span x-text="serverHealth.memory.process_mb + ' MB'"></span>
                                            </div>
                                            <div x-show="serverHealth.memory.pressure">
                                                <span>Pressure:</span>
                                                <span :class="{
                                        'text-green': serverHealth.memory.pressure === 'low',
                                        'text-yellow': serverHealth.memory.pressure === 'medium',
                                        'text-red': serverHealth.memory.pressure === 'high'
                                    }" x-text="serverHealth.memory.pressure ? serverHealth.memory.pressure.toUpperCase() : 'N/A'"></span>
                                            </div>
                                            <div
                                                x-show="serverHealth.memory.swap_total_gb && serverHealth.memory.swap_total_gb > 0 && serverHealth.memory.swap_percent !== undefined">
                                                <span>Swap:</span>
                                                <span x-text="serverHealth.memory.swap_percent + '%'"></span>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </div>

                                    <!-- Disk Statistics - Root -->
                                    {% set disk_badge %}
                                    <span class="server-stat-badge" :class="{
                                    'badge-success': serverHealth.disk.root.percent_used < 80,
                                    'badge-warning': serverHealth.disk.root.percent_used >= 80 && serverHealth.disk.root.percent_used < 90,
                                    'badge-error': serverHealth.disk.root.percent_used >= 90
                                }" x-text="serverHealth.disk.root.percent_used ? serverHealth.disk.root.percent_used + '%' : 'N/A'"></span>
                                    {% endset %}
                                    <div
                                        x-show="serverHealth.disk && serverHealth.disk.root && !serverHealth.disk.error">
                                        {% call widget_card('server_disk', 'Disk (Root)', 'üíø',
                                        extra_actions=disk_badge) %}
                                        <div class="server-stat-value"
                                            x-text="serverHealth.disk.root.percent_used ? serverHealth.disk.root.percent_used + '%' : 'N/A'">
                                        </div>
                                        <!-- Progress Bar -->
                                        <div class="server-stat-progress"
                                            x-show="serverHealth.disk.root.percent_used !== undefined">
                                            <div class="server-stat-progress-bar" :class="{
                                        'warning': serverHealth.disk.root.percent_used >= 80 && serverHealth.disk.root.percent_used < 90,
                                        'error': serverHealth.disk.root.percent_used >= 90
                                    }" :style="'width: ' + (serverHealth.disk.root.percent_used || 0) + '%'"></div>
                                        </div>
                                        <div class="server-stat-details">
                                            <div>
                                                <span>Used:</span>
                                                <span
                                                    x-text="serverHealth.disk.root.used_gb ? serverHealth.disk.root.used_gb + ' GB' : 'N/A'"></span>
                                            </div>
                                            <div>
                                                <span>Free:</span>
                                                <span
                                                    x-text="serverHealth.disk.root.free_gb ? serverHealth.disk.root.free_gb + ' GB' : 'N/A'"></span>
                                            </div>
                                            <div>
                                                <span>Total:</span>
                                                <span
                                                    x-text="serverHealth.disk.root.total_gb ? serverHealth.disk.root.total_gb + ' GB' : 'N/A'"></span>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </div>

                                    <!-- NetFlow Statistics -->
                                    {% set netflow_badge %}
                                    <span class="server-stat-badge" :class="{
                                    'badge-success': serverHealth.netflow.available,
                                    'badge-error': !serverHealth.netflow.available
                                }" x-text="serverHealth.netflow.available ? 'ONLINE' : 'OFFLINE'"></span>
                                    {% endset %}
                                    <div x-show="serverHealth.netflow && !serverHealth.netflow.error">
                                        {% call widget_card('server_netflow', 'NetFlow', 'üåê',
                                        extra_actions=netflow_badge)
                                        %}
                                        <div class="server-stat-value"
                                            x-text="serverHealth.netflow.files_count !== undefined ? serverHealth.netflow.files_count.toLocaleString() + ' files' : 'N/A'">
                                        </div>
                                        <div class="server-stat-details">
                                            <div x-show="serverHealth.netflow.version">
                                                <span>Version:</span>
                                                <span x-text="serverHealth.netflow.version"
                                                    style="font-size: 0.85em;"></span>
                                            </div>
                                            <div x-show="serverHealth.netflow.directory">
                                                <span>Directory:</span>
                                                <span x-text="serverHealth.netflow.directory"
                                                    style="font-size: 0.85em;"></span>
                                            </div>
                                            <div x-show="serverHealth.netflow.files_count !== undefined">
                                                <span>Files:</span>
                                                <span x-text="serverHealth.netflow.files_count.toLocaleString()"></span>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </div>

                                    <!-- Syslog Statistics -->
                                    {% set syslog_badge %}
                                    <span class="server-stat-badge" :class="{
                                    'badge-success': serverHealth.syslog.active,
                                    'badge-error': !serverHealth.syslog.active
                                }" x-text="serverHealth.syslog.active ? 'ACTIVE' : 'INACTIVE'"></span>
                                    {% endset %}
                                    <div x-show="serverHealth.syslog && !serverHealth.syslog.error">
                                        {% call widget_card('server_syslog', 'Syslog', 'üìù', extra_actions=syslog_badge)
                                        %}
                                        <div class="server-stat-value"
                                            x-text="serverHealth.syslog.received ? serverHealth.syslog.received.toLocaleString() : '0'">
                                        </div>
                                        <div class="server-stat-details">
                                            <div>
                                                <span>Received:</span>
                                                <span
                                                    x-text="serverHealth.syslog.received ? serverHealth.syslog.received.toLocaleString() : '0'"></span>
                                            </div>
                                            <div>
                                                <span>Parsed:</span>
                                                <span
                                                    x-text="serverHealth.syslog.parsed ? serverHealth.syslog.parsed.toLocaleString() : '0'"></span>
                                            </div>
                                            <div>
                                                <span>Errors:</span>
                                                <span
                                                    x-text="serverHealth.syslog.errors ? serverHealth.syslog.errors.toLocaleString() : '0'"
                                                    :class="serverHealth.syslog.errors > 0 ? 'text-red' : ''"></span>
                                            </div>
                                            <div x-show="serverHealth.syslog.last_log">
                                                <span>Last Log:</span>
                                                <span
                                                    x-text="serverHealth.syslog.last_log ? new Date(serverHealth.syslog.last_log * 1000).toLocaleTimeString() : 'Never'"></span>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </div>

                                    <!-- Database Statistics -->
                                    {% set db_badge %}
                                    <span class="server-stat-badge" :class="{
                                    'badge-success': serverHealth.database.connected,
                                    'badge-error': !serverHealth.database.connected
                                }" x-text="serverHealth.database.connected ? 'CONNECTED' : 'DISCONNECTED'"></span>
                                    {% endset %}
                                    <div x-show="serverHealth.database">
                                        {% call widget_card('server_database', 'Database', 'üóÑÔ∏è',
                                        extra_actions=db_badge) %}
                                        <div class="server-stat-value"
                                            x-text="serverHealth.database.log_count ? serverHealth.database.log_count.toLocaleString() : '0'">
                                        </div>
                                        <div class="server-stat-details">
                                            <div>
                                                <span>Logs:</span>
                                                <span
                                                    x-text="serverHealth.database.log_count ? serverHealth.database.log_count.toLocaleString() : '0'"></span>
                                            </div>
                                            <div x-show="serverHealth.database.size_mb">
                                                <span>Size:</span>
                                                <span x-text="serverHealth.database.size_mb + ' MB'"></span>
                                            </div>
                                            <div x-show="serverHealth.database?.growth_rate_per_hour !== undefined">
                                                <span>Growth (1h):</span>
                                                <span
                                                    x-text="(serverHealth.database?.growth_rate_per_hour || 0).toLocaleString() + ' logs'"></span>
                                            </div>
                                            <div x-show="serverHealth.database?.growth_rate_per_day !== undefined">
                                                <span>Growth (24h):</span>
                                                <span
                                                    x-text="(serverHealth.database?.growth_rate_per_day || 0).toLocaleString() + ' logs'"></span>
                                            </div>
                                            <div x-show="serverHealth.database.path">
                                                <span>Path:</span>
                                                <span x-text="serverHealth.database.path"
                                                    style="font-size: 0.85em;"></span>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </div>


                                    <!-- System Information (Combined with Uptime) -->
                                    {% set system_badge %}
                                    <span class="server-stat-badge badge-success">ONLINE</span>
                                    {% endset %}
                                    <div x-show="serverHealth.system && !serverHealth.system.error">
                                        {% call widget_card('server_system', 'System', 'üñ•Ô∏è',
                                        extra_actions=system_badge) %}
                                        <div class="server-stat-value" x-text="serverHealth.system.hostname || 'N/A'"
                                            style="font-size: 1.2em;"></div>
                                        <div class="server-stat-details">
                                            <div x-show="serverHealth.system.uptime_formatted">
                                                <span>Uptime:</span>
                                                <span x-text="serverHealth.system.uptime_formatted || 'N/A'"></span>
                                            </div>
                                            <div x-show="serverHealth.system.uptime_seconds">
                                                <span>Total Uptime:</span>
                                                <span
                                                    x-text="serverHealth.system.uptime_seconds ? Math.floor(serverHealth.system.uptime_seconds / 86400) + ' days' : 'N/A'"></span>
                                            </div>
                                            <div x-show="serverHealth.system.boot_time_formatted">
                                                <span>Boot Time:</span>
                                                <span x-text="serverHealth.system.boot_time_formatted"></span>
                                            </div>
                                            <div x-show="serverHealth.system.kernel_version">
                                                <span>Kernel:</span>
                                                <span x-text="serverHealth.system.kernel_version"
                                                    style="font-size: 0.85em;"></span>
                                            </div>
                                            <div x-show="serverHealth.system.os_info">
                                                <span>OS:</span>
                                                <span x-text="serverHealth.system.os_info"
                                                    style="font-size: 0.85em;"></span>
                                            </div>
                                            <div x-show="serverHealth.timestamp">
                                                <span>Last Update:</span>
                                                <span
                                                    x-text="serverHealth.timestamp ? new Date(serverHealth.timestamp).toLocaleString() : 'N/A'"></span>
                                            </div>
                                        </div>
                                        {% endcall %}
                                    </div>
                                </div>
                    </div>

                    <!-- Process/Application Information (Combined) -->
                    {% set process_badge %}
                    <span class="server-stat-badge badge-success">ACTIVE</span>
                    {% endset %}
                    <div
                        x-show="(serverHealth.system && serverHealth.system.process_threads !== undefined && !serverHealth.system.error) || serverHealth.process">
                        {% call widget_card('server_process', 'Process', '‚öôÔ∏è', extra_actions=process_badge) %}
                        <div class="server-stat-value"
                            x-text="serverHealth.process && serverHealth.process.process_memory_mb ? serverHealth.process.process_memory_mb + ' MB' : (serverHealth.system && serverHealth.system.process_threads ? serverHealth.system.process_threads.toLocaleString() + ' threads' : 'N/A')">
                        </div>
                        <div class="server-stat-details">
                            <div x-show="serverHealth.process && serverHealth.process.process_memory_mb">
                                <span>Memory:</span>
                                <span x-text="serverHealth.process.process_memory_mb + ' MB'"></span>
                            </div>
                            <div x-show="serverHealth.process && serverHealth.process.threads">
                                <span>Threads:</span>
                                <span x-text="serverHealth.process.threads.toLocaleString()"></span>
                            </div>
                            <div x-show="serverHealth.system && serverHealth.system.process_threads !== undefined">
                                <span>System Threads:</span>
                                <span
                                    x-text="serverHealth.system.process_threads ? serverHealth.system.process_threads.toLocaleString() : '0'"></span>
                            </div>
                            <div x-show="serverHealth.system && serverHealth.system.process_name">
                                <span>Process:</span>
                                <span x-text="serverHealth.system.process_name || 'N/A'"
                                    style="font-size: 0.85em;"></span>
                            </div>
                        </div>
                        {% endcall %}
                    </div>

                    <!-- Network Statistics (eth0 only) -->
                    {% set network_badge %}
                    <span class="server-stat-badge badge-success">ACTIVE</span>
                    {% endset %}
                    <div
                        x-show="serverHealth.network && serverHealth.network.interfaces && serverHealth.network.interfaces.eth0">
                        {% call widget_card('server_network', 'Network Interface (eth0)', 'üåê',
                        extra_actions=network_badge)
                        %}
                        <div class="server-stat-details">
                            <div>
                                <span>RX:</span>
                                <span
                                    x-text="serverHealth.network.interfaces.eth0.rx_bytes ? (serverHealth.network.interfaces.eth0.rx_bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'N/A'"></span>
                            </div>
                            <div>
                                <span>TX:</span>
                                <span
                                    x-text="serverHealth.network.interfaces.eth0.tx_bytes ? (serverHealth.network.interfaces.eth0.tx_bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'N/A'"></span>
                            </div>
                            <div>
                                <span>RX Packets:</span>
                                <span
                                    x-text="serverHealth.network.interfaces.eth0.rx_packets ? serverHealth.network.interfaces.eth0.rx_packets.toLocaleString() : '0'"></span>
                            </div>
                            <div>
                                <span>TX Packets:</span>
                                <span
                                    x-text="serverHealth.network.interfaces.eth0.tx_packets ? serverHealth.network.interfaces.eth0.tx_packets.toLocaleString() : '0'"></span>
                            </div>
                        </div>
                        {% endcall %}
                    </div>

                    <!-- Cache Statistics -->
                    {% set cache_badge %}
                    <span class="server-stat-badge badge-success">ACTIVE</span>
                    {% endset %}
                    <div x-show="serverHealth.cache">
                        {% call widget_card('server_cache', 'Cache', 'üíæ', extra_actions=cache_badge) %}
                        <div class="server-stat-value"
                            x-text="(serverHealth.cache.dns_cache_size || 0) + (serverHealth.cache.geo_cache_size || 0) + (serverHealth.cache.common_cache_size || 0) + ' entries'">
                        </div>
                        <div class="server-stat-details">
                            <div x-show="serverHealth.cache.dns_cache_size !== undefined">
                                <span>DNS Cache:</span>
                                <span x-text="serverHealth.cache.dns_cache_size.toLocaleString() + ' entries'"></span>
                            </div>
                            <div x-show="serverHealth.cache.geo_cache_size !== undefined">
                                <span>GeoIP Cache:</span>
                                <span x-text="serverHealth.cache.geo_cache_size.toLocaleString() + ' entries'"></span>
                            </div>
                            <div x-show="serverHealth.cache.common_cache_size !== undefined">
                                <span>Common Cache:</span>
                                <span
                                    x-text="serverHealth.cache.common_cache_size.toLocaleString() + ' entries'"></span>
                            </div>
                            <div x-show="serverHealth.cache.bandwidth_history_size !== undefined">
                                <span>Bandwidth History:</span>
                                <span
                                    x-text="serverHealth.cache.bandwidth_history_size.toLocaleString() + ' entries'"></span>
                            </div>
                        </div>
                        {% endcall %}
                    </div>


                </div>
                </template>

                </section>
        </div>

        <!-- ============================================
             AI ASSISTANT TAB - Ollama Chat Interface
             ============================================ -->
        <div x-show="activeTab === 'assistant'" :style="activeTab === 'assistant' ? 'display:block' : 'display:none'"
            id="assistant-tab" role="tabpanel" aria-labelledby="assistant-tab-btn" tabindex="0">
            <section id="section-assistant" class="scroll-section" style="margin-bottom: 32px;">
                <div class="card wide-card" style="height: calc(100vh - 200px); display: flex; flex-direction: column;">
                    <h2>
                        <span>ü§ñ AI Assistant</span>
                        <div class="card-actions">
                            <select x-model="ollamaChat.model" class="filter-select" style="min-width: 150px;"
                                @change="fetchOllamaModels()" title="Select Ollama model">
                                <template
                                    x-for="model in ollamaChat.availableModels.length > 0 ? ollamaChat.availableModels : ['deepseek-coder-v2:16b']"
                                    :key="model">
                                    <option :value="model" x-text="model"></option>
                                </template>
                            </select>
                            <label
                                style="display: flex; align-items: center; gap: 6px; font-size: var(--text-xs); color: var(--text-secondary); cursor: pointer;"
                                title="Include current dashboard data as context">
                                <input type="checkbox" x-model="ollamaChat.includeContext" style="cursor: pointer;">
                                <span>Use Context</span>
                            </label>
                            <button class="btn btn--secondary" @click="clearChat()" title="Clear chat">
                                Clear
                            </button>
                        </div>
                    </h2>

                    <!-- Chat Messages Area -->
                    <div class="chat-messages" style="flex: 1; overflow-y: auto; padding: var(--space-4); 
                                    display: flex; flex-direction: column; gap: var(--space-3); min-height: 0;">
                        <template x-if="ollamaChat.messages.length === 0">
                            <div style="text-align: center; color: var(--text-secondary); padding: var(--space-8);">
                                <div style="font-size: 48px; margin-bottom: var(--space-4);">ü§ñ</div>
                                <div style="font-size: var(--text-lg); margin-bottom: var(--space-2);">AI
                                    Assistant</div>
                                <div style="font-size: var(--text-sm);">Ask me anything about your network,
                                    security, or system.</div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-4);">
                                    Powered by Ollama (local LLM)
                                </div>
                            </div>
                        </template>
                        <template x-for="(msg, idx) in ollamaChat.messages" :key="idx">
                            <div
                                :class="'chat-message ' + (msg.role === 'user' ? 'chat-message-user' : 'chat-message-assistant')">
                                <div class="chat-message-role" x-text="msg.role === 'user' ? 'You' : 'Assistant'"></div>
                                <div class="chat-message-content" x-html="msg.content.replace(/\n/g, '<br>')">
                                </div>
                                <div class="chat-message-time" x-text="msg.timestamp"></div>
                            </div>
                        </template>
                        <div x-show="ollamaChat.loading" class="chat-message chat-message-assistant">
                            <div class="chat-message-role">Assistant</div>
                            <div class="chat-message-content">
                                <div class="spinner" style="display: inline-block; margin-right: var(--space-2);"></div>
                                <span>Thinking...</span>
                            </div>
                        </div>
                        <div x-show="ollamaChat.error" class="chat-message chat-message-error">
                            <div class="chat-message-role">Error</div>
                            <div class="chat-message-content" x-text="ollamaChat.error"></div>
                        </div>
                    </div>

                    <!-- Chat Input Area -->
                    <div style="padding: var(--space-4); border-top: 1px solid var(--card-border);">
                        <div style="display: flex; gap: var(--space-2);">
                            <textarea x-model="ollamaChat.inputMessage"
                                @keydown.enter.prevent="ollamaChat.inputMessage.trim() && !ollamaChat.loading && sendChatMessage()"
                                @keydown.enter.shift="ollamaChat.inputMessage += '\n'"
                                placeholder="Type your message... (Enter to send, Shift+Enter for new line)" style="flex: 1; min-height: 60px; max-height: 150px; padding: var(--space-3); 
                                                background: var(--bg-primary); border: 1px solid var(--card-border); 
                                                border-radius: var(--radius-md); color: var(--text-primary); 
                                                font-family: inherit; font-size: var(--text-base); resize: vertical;"
                                :disabled="ollamaChat.loading"></textarea>
                            <button class="btn btn--primary" @click="sendChatMessage()"
                                :disabled="!ollamaChat.inputMessage.trim() || ollamaChat.loading"
                                style="align-self: flex-end;">
                                <span x-show="!ollamaChat.loading">Send</span>
                                <span x-show="ollamaChat.loading">...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        </main>


        <!-- Expanded Table Modal -->
        <div class="modal" x-show="expandedModalOpen" :style="expandedModalOpen ? 'display:flex' : 'display:none'"
            @click.self="expandedModalOpen = false">
            <div class="modal-content" style="max-width: 1000px; height: 90vh;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0"><span class="text-cyan" x-text="expandedTitle"></span></h2>
                    <button @click="expandedModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close">√ó</button>
                </div>

                <div x-show="expandedLoading" class="spinner" style="margin: 0 auto;"></div>

                <div x-show="!expandedLoading" style="overflow-y:auto; height: calc(100% - 60px);">
                    <table class="table-fixed table-compact" style="width:100%; border-collapse:collapse;">
                        <thead style="position:sticky; top:0; background: #111; z-index:1;">
                            <tr style="border-bottom: 1px solid var(--neon-cyan);">
                                <template x-for="col in expandedColumns">
                                    <th style="padding:10px; text-align:left; color:var(--text-muted);" x-text="col">
                                    </th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(row, idx) in expandedData" :key="idx">
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <template x-for="val in row">
                                        <td style="padding:8px;" x-html="val"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="expandedData.length === 0"
                        style="padding:20px; text-align:center; color:var(--text-muted)">No data available</div>
                </div>
            </div>
        </div>

        <!-- Network Graph Modal -->
        <div class="modal" x-show="networkGraphOpen" :style="networkGraphOpen ? 'display:flex' : 'display:none'"
            @click.self="networkGraphOpen = false">
            <div class="modal-content" style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2 style="margin:0">üï∏Ô∏è Network Graph</h2>
                    <button @click="networkGraphOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close">√ó</button>
                </div>
                <div id="network-graph-container"
                    style="flex: 1; border: 1px solid rgba(0,243,255,0.2); background: rgba(0,0,0,0.5); border-radius: 4px;">
                </div>
                <div style="font-size:0.8em; color:var(--text-muted); margin-top:5px; text-align:center;">
                    <span style="color:#00f3ff">‚óè Source</span> &nbsp;
                    <span style="color:#bc13fe">‚óè Destination</span> &nbsp;
                    <span style="color:#0aff0a">‚óè Both</span>
                    &nbsp;|&nbsp; Drag to pan, Scroll to zoom, Click node to highlight
                </div>
            </div>
        </div>

        <!-- IP Detail Modal -->
        <div class="modal" x-show="modalOpen" :style="modalOpen ? 'display:flex' : 'display:none'"
            @click.self="modalOpen = false">
            <div class="modal-content">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0">IP Details: <span class="text-cyan" x-text="selectedIP"></span></h2>
                    <button @click="modalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close details">√ó</button>
                </div>

                <div x-show="ipLoading" class="spinner" style="margin: 0 auto;"></div>

                <div x-show="!ipLoading && ipDetails">
                    <div class="grid">
                        <div class="card">
                            <p><strong>Hostname:</strong> <span x-text="ipDetails?.hostname || 'N/A'"></span></p>
                            <p><strong>Region:</strong> <span x-text="ipDetails?.region"></span> <span
                                    x-text="ipDetails?.geo?.city"></span></p>
                            <p><strong>ASN:</strong> <span x-text="ipDetails?.geo?.asn"></span> <span
                                    x-text="ipDetails?.geo?.asn_org"></span></p>
                        </div>
                        <div class="card">
                            <p>‚¨ÜÔ∏è Upload: <strong class="text-green"
                                    x-text="fmtBytes(ipDetails?.direction?.upload || 0)"></strong></p>
                            <p>‚¨áÔ∏è Download: <strong class="text-green"
                                    x-text="fmtBytes(ipDetails?.direction?.download || 0)"></strong></p>
                        </div>
                    </div>

                    <h3>Ports & Protocols</h3>
                    <div class="grid">
                        <div class="card">
                            <h4>Src Ports</h4>
                            <template x-for="p in ipDetails?.src_ports">
                                <div style="font-size:0.9em; margin-bottom:4px;">
                                    <span class="text-cyan" x-text="p.key"></span> (<span x-text="p.service"></span>):
                                    <span x-text="fmtBytes(p.bytes)"></span>
                                </div>
                            </template>
                        </div>
                        <div class="card">
                            <h4>Dst Ports</h4>
                            <template x-for="p in ipDetails?.dst_ports">
                                <div style="font-size:0.9em; margin-bottom:4px;">
                                    <span class="text-cyan" x-text="p.key"></span> (<span x-text="p.service"></span>):
                                    <span x-text="fmtBytes(p.bytes)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IP Deep Dive Investigation Modal -->
        <div class="modal" x-show="ipInvestigationModalOpen"
            :style="ipInvestigationModalOpen ? 'display:flex' : 'display:none'"
            @click.self="ipInvestigationModalOpen = false">
            <div class="modal-content"
                style="max-width: 1200px; width: 90vw; height: 85vh; display: flex; flex-direction: column;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0">üîç IP Deep Dive Investigation: <span class="text-cyan"
                            x-text="ipInvestigation.searchIP || 'Enter IP address'"></span></h2>
                    <button @click="ipInvestigationModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close IP investigation">√ó</button>
                </div>

                <div class="ip-investigation-content"
                    style="flex: 1; overflow-y: auto; padding: 0 var(--space-4) var(--space-4);">
                    <!-- Loading State -->
                    <div x-show="ipInvestigation.loading" style="text-align: center; padding: 60px 20px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p style="color: var(--text-secondary);">Investigating IP address...</p>
                        <p style="color: var(--text-tertiary); font-size: var(--text-xs); margin-top: var(--space-2);">
                            This may take a few seconds...</p>
                    </div>

                    <!-- Error State -->
                    <div x-show="ipInvestigation.error && !ipInvestigation.loading"
                        style="padding: var(--space-4); background: rgba(255, 0, 60, 0.1); border: 1px solid rgba(255, 0, 60, 0.3); border-radius: var(--radius-md); margin: var(--space-4) 0;">
                        <div style="display: flex; align-items: flex-start; gap: var(--space-2);">
                            <div style="font-size: 20px;">‚ö†Ô∏è</div>
                            <div style="flex: 1;">
                                <strong
                                    style="color: var(--neon-red); display: block; margin-bottom: var(--space-1);">Investigation
                                    Failed</strong>
                                <p style="color: var(--text-secondary); font-size: var(--text-sm); margin: 0 0 var(--space-3) 0;"
                                    x-text="ipInvestigation.error"></p>
                                <button @click="investigateIP()" class="btn btn--secondary"
                                    style="font-size: var(--text-sm);">Retry Investigation</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div x-show="!ipInvestigation.loading && ipInvestigation.result">
                        <!-- Quick Stats Cards -->
                        <div class="grid"
                            style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                            <div class="card" style="padding: var(--space-4);">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Classification</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    :class="ipInvestigation.result?.classification === 'Internal' ? 'text-green' : 'text-cyan'"
                                    x-text="ipInvestigation.result?.classification || 'N/A'"></div>
                            </div>
                            <div class="card" style="padding: var(--space-4);">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Threat Status</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    :class="ipInvestigation.result?.is_threat ? 'text-red' : 'text-green'"
                                    x-text="ipInvestigation.result?.is_threat ? '‚ö†Ô∏è THREAT' : '‚úÖ Clean'"></div>
                            </div>
                            <div class="card" style="padding: var(--space-4);">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Total Traffic</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    class="text-cyan" x-text="ipInvestigation.result?.total_bytes_fmt || 'N/A'">
                                </div>
                            </div>
                            <div class="card" style="padding: var(--space-4);"
                                x-show="ipInvestigation.result?.flow_count !== undefined">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Total Flows</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    class="text-cyan"
                                    x-text="(ipInvestigation.result?.flow_count || 0).toLocaleString()">
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Information Grid -->
                        <div class="grid"
                            style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                            <div class="card">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    Geographic Information</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                    <div>
                                        <strong style="color: var(--text-secondary);">Country:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.country || ipInvestigation.result?.country || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Region:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.region || ipInvestigation.result?.geo?.region || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">City:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.city || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">ASN:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.asn || ipInvestigation.result?.asn || 'N/A'"></span>
                                    </div>
                                    <div x-show="ipInvestigation.result?.geo?.org">
                                        <strong style="color: var(--text-secondary);">Organization:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.org"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    Activity Summary</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                    <div>
                                        <strong style="color: var(--text-secondary);">Hostname:</strong>
                                        <span style="margin-left: var(--space-2); font-family: var(--font-mono);"
                                            x-text="ipInvestigation.result?.hostname || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Classification:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            :class="ipInvestigation.result?.classification === 'Internal' ? 'text-green' : 'text-cyan'"
                                            x-text="ipInvestigation.result?.classification || (ipInvestigation.result?.internal ? 'Internal' : 'External')"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Total Traffic:</strong>
                                        <span style="margin-left: var(--space-2);" class="text-cyan"
                                            x-text="ipInvestigation.result?.total_bytes_fmt || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Total Flows:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.flow_count || 0"></span>
                                    </div>
                                </div>
                            </div>
                            <!-- Network Activity Card -->
                            <div class="card"
                                x-show="ipInvestigation.result?.src_ports?.length || ipInvestigation.result?.dst_ports?.length || ipInvestigation.result?.protocols?.length">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    Network Activity</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                    <div x-show="ipInvestigation.result?.protocols?.length">
                                        <strong
                                            style="color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">Top
                                            Protocols:</strong>
                                        <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                                            <template
                                                x-for="(proto, idx) in (ipInvestigation.result?.protocols || []).slice(0, 5)"
                                                :key="idx">
                                                <span class="badge"
                                                    style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                                    x-text="proto.proto_name || proto.key"></span>
                                            </template>
                                        </div>
                                    </div>
                                    <div
                                        x-show="ipInvestigation.result?.src_ports?.length || ipInvestigation.result?.dst_ports?.length">
                                        <strong
                                            style="color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">Active
                                            Ports:</strong>
                                        <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                            x-text="((ipInvestigation.result?.src_ports?.length || 0) + (ipInvestigation.result?.dst_ports?.length || 0)) + ' ports'">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Timeline -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.timeline.labels && ipInvestigation.timeline.labels.length > 0">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                                <h4
                                    style="margin: 0; font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    üìà Activity Timeline</h4>
                                <label
                                    style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); cursor: pointer;">
                                    <input type="checkbox" x-model="ipInvestigation.timeline.compareHistory"
                                        @change="loadIPTimeline(ipInvestigation.searchIP)" style="cursor: pointer;">
                                    <span>Compare with previous period</span>
                                </label>
                            </div>
                            <div class="chart-wrapper" style="height: 250px;">
                                <canvas id="ipInvestigationTimelineChart"></canvas>
                            </div>
                            <p
                                style="margin-top: var(--space-2); font-size: var(--text-xs); color: var(--text-muted); text-align: center;">
                                Traffic patterns over the selected time range (bytes and flow counts)
                                <span x-show="ipInvestigation.timeline.compareHistory"> ‚Ä¢ Dashed lines show previous
                                    period</span>
                            </p>
                        </div>

                        <!-- Threat Intelligence -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.result?.threat_intel?.enabled">
                            <h4
                                style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                üõ°Ô∏è Threat Intelligence</h4>
                            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                <!-- VirusTotal -->
                                <div x-show="ipInvestigation.result?.threat_intel?.virustotal">
                                    <div
                                        style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <strong style="color: var(--text-secondary);">VirusTotal:</strong>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'found'"
                                            class="badge"
                                            :class="(ipInvestigation.result?.threat_intel?.virustotal?.malicious || 0) > 0 ? 'badge--danger' : 'badge--success'"
                                            x-text="(ipInvestigation.result?.threat_intel?.virustotal?.malicious || 0) + ' malicious'"></span>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'rate_limited'"
                                            class="badge badge--warning" x-text="'Rate Limited'"></span>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'not_found'"
                                            class="badge" x-text="'Not Found'"></span>
                                    </div>
                                    <div x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'found'"
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-left: var(--space-4);">
                                        <div>Reputation: <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.reputation || 0"></span>
                                        </div>
                                        <div>Harmless: <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.harmless || 0"></span>
                                            ‚Ä¢ Suspicious: <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.suspicious || 0"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.virustotal?.as_owner">AS
                                            Owner:
                                            <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.as_owner"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- AbuseIPDB -->
                                <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb">
                                    <div
                                        style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <strong style="color: var(--text-secondary);">AbuseIPDB:</strong>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'found'"
                                            class="badge"
                                            :class="(ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) > 50 ? 'badge--danger' : (ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) > 25 ? 'badge--warning' : 'badge--success'"
                                            x-text="'Confidence: ' + (ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) + '%'"></span>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'rate_limited'"
                                            class="badge badge--warning" x-text="'Rate Limited'"></span>
                                    </div>
                                    <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'found'"
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-left: var(--space-4);">
                                        <div>Reports: <span
                                                x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.num_reports || 0"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.usage_type">
                                            Usage:
                                            <span
                                                x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.usage_type"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.isp">ISP: <span
                                                x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.isp"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.is_known_attacker"
                                            class="badge badge--danger" style="margin-top: var(--space-1);">Known
                                            Attacker</div>
                                    </div>
                                </div>
                                <div x-show="!ipInvestigation.result?.threat_intel?.enabled"
                                    style="font-size: var(--text-xs); color: var(--text-muted);">
                                    Threat intelligence APIs not configured. Set VIRUSTOTAL_API_KEY and/or
                                    ABUSEIPDB_API_KEY environment variables to enable.
                                </div>
                            </div>
                        </div>

                        <!-- Anomaly Detection -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.result?.anomalies && ipInvestigation.result.anomalies.length > 0">
                            <h4
                                style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                ‚ö†Ô∏è Detected Anomalies</h4>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <template x-for="(anomaly, idx) in ipInvestigation.result?.anomalies || []" :key="idx">
                                    <div style="padding: var(--space-3); background: rgba(255, 152, 0, 0.1); border-left: 3px solid rgba(255, 152, 0, 0.8); border-radius: var(--radius-sm);"
                                        :style="anomaly.severity === 'high' ? 'background: rgba(255, 0, 60, 0.1); border-left-color: rgba(255, 0, 60, 0.8);' : anomaly.severity === 'medium' ? 'background: rgba(255, 152, 0, 0.1); border-left-color: rgba(255, 152, 0, 0.8);' : 'background: rgba(100, 181, 246, 0.1); border-left-color: rgba(100, 181, 246, 0.8);'">
                                        <div
                                            style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                            <span class="badge"
                                                :class="anomaly.severity === 'high' ? 'badge--danger' : anomaly.severity === 'medium' ? 'badge--warning' : 'badge--info'"
                                                x-text="anomaly.severity.toUpperCase()"></span>
                                            <strong style="color: var(--text-primary);"
                                                x-text="anomaly.message"></strong>
                                        </div>
                                        <div x-show="anomaly.port_count"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Port Count: <span x-text="anomaly.port_count"></span>
                                        </div>
                                        <div x-show="anomaly.ports"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Ports: <span x-text="anomaly.ports.join(', ')"></span>
                                        </div>
                                        <div x-show="anomaly.ratio"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Ratio: <span x-text="anomaly.ratio + ':1'"></span> (Upload: <span
                                                x-text="anomaly.upload_mb + ' MB'"></span>, Download: <span
                                                x-text="anomaly.download_mb + ' MB'"></span>)
                                        </div>
                                        <div x-show="anomaly.total_mb"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Total Traffic: <span x-text="anomaly.total_mb + ' MB'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Related IPs -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.result?.related_ips && ipInvestigation.result.related_ips.length > 0">
                            <h4
                                style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                üîó Related IPs</h4>
                            <p
                                style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3);">
                                IPs that directly communicate with this IP (as source or destination)
                            </p>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <template
                                    x-for="(related, idx) in (ipInvestigation.result?.related_ips || []).slice(0, 10)"
                                    :key="idx">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-2) var(--space-3); background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border-left: 3px solid var(--neon-cyan);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div
                                                style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                                <span class="text-cyan"
                                                    style="font-family: var(--font-mono); font-weight: var(--font-weight-semibold); cursor: pointer;"
                                                    @click="openIPInvestigationModal(related.ip)" x-text="related.ip"
                                                    title="Click to investigate this IP"></span>
                                                <span class="badge"
                                                    style="background: rgba(0,243,255,0.15); color: var(--neon-cyan); font-size: var(--text-xs);"
                                                    x-text="related.type === 'destination' ? 'Destination' : 'Source'"></span>
                                                <span x-show="related.country_code"
                                                    x-text="flagFromIso(related.country_code)"
                                                    style="font-size: 16px;"></span>
                                            </div>
                                            <div style="font-size: var(--text-xs); color: var(--text-muted);">
                                                <span x-text="fmtBytes(related.bytes)"></span>
                                                <span style="margin: 0 var(--space-1);">‚Ä¢</span>
                                                <span x-text="related.count + ' flows'"></span>
                                                <span x-show="related.country" style="margin-left: var(--space-2);"
                                                    x-text="related.country"></span>
                                            </div>
                                        </div>
                                        <button @click="openIPInvestigationModal(related.ip)" class="btn btn--secondary"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2); white-space: nowrap;">
                                            Investigate
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Export Actions -->
                        <div
                            style="display: flex; gap: var(--space-3); margin-bottom: var(--space-6); flex-wrap: wrap;">
                            <button @click="exportInvestigationResults('json')" class="btn btn--secondary"
                                :disabled="!ipInvestigation.result">
                                üì• Export JSON
                            </button>
                            <button @click="exportInvestigationResults('csv')" class="btn btn--secondary"
                                :disabled="!ipInvestigation.result">
                                üì• Export CSV
                            </button>
                            <button @click="copyInvestigationIP()" class="btn btn--secondary"
                                :disabled="!ipInvestigation.searchIP">
                                üìã Copy IP
                            </button>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!ipInvestigation.loading && !ipInvestigation.result"
                        style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: var(--space-4);" aria-hidden="true">üîç</div>
                        <p style="font-size: var(--text-lg); margin-bottom: var(--space-2);">Enter an IP address to
                            begin investigation</p>
                        <p style="font-size: var(--text-sm); color: var(--text-tertiary);">Use the search bar at the
                            top
                            of the Forensics page</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- IP Trend Modal -->
        <div class="modal" x-show="trendModalOpen" :style="trendModalOpen ? 'display:flex' : 'display:none'"
            @click.self="trendModalOpen = false">
            <div class="modal-content" style="max-width: 760px;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0">Trend: <span class="text-cyan" x-text="trendIP"></span> <span
                            style="color:var(--text-muted); font-size:0.7em"
                            x-text="'(' + (trendKind==='source' ? 'Source' : 'Destination') + ')' "></span></h2>
                    <button @click="trendModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close trend">√ó</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="ipTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Fullscreen Chart Modal -->
        <div class="modal fullscreen-chart-modal" x-show="fullscreenChart"
            :style="fullscreenChart ? 'display:flex' : 'display:none'" @click.self="closeFullscreenChart()">
            <div class="modal-content fullscreen-chart-content">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="margin:0"><span class="text-cyan" x-text="fullscreenChart?.title || 'Chart'"></span>
                    </h2>
                    <button @click="closeFullscreenChart()"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close fullscreen">√ó</button>
                </div>
                <div class="fullscreen-chart-wrapper">
                    <canvas id="fullscreenChartCanvas"></canvas>
                </div>
                <p style="text-align:center; color:var(--text-muted); font-size:0.8em; margin-top:12px;">Press
                    <kbd>ESC</kbd> or click outside to close
                </p>
            </div>
        </div>

        <!-- Thresholds Modal -->
        <div class="modal" x-show="thresholdsModalOpen" :style="thresholdsModalOpen ? 'display:flex' : 'display:none'"
            @click.self="thresholdsModalOpen = false">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0">Threshold Settings</h2>
                    <button @click="thresholdsModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close settings">√ó</button>
                </div>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">Utilization (%)</h3>
                        <label>Warn <input type="number" min="0" max="100" x-model.number="thresholds.util_warn"
                                style="width:80px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" min="0" max="100"
                                x-model.number="thresholds.util_crit" style="width:80px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">TCP Resets (/s)</h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.resets_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.resets_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">IP Errors (/s)</h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.ip_err_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.ip_err_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">ICMP Errors (/s)</h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.icmp_err_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.icmp_err_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">Interface Err/Disc
                            (/s)
                        </h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.if_err_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.if_err_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">TCP Reliability (/s)
                        </h3>
                        <div>
                            <label>Fails Warn <input type="number" step="0.1" x-model.number="thresholds.tcp_fails_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.tcp_fails_crit"
                                    style="width:90px; margin-left:8px"></label>
                        </div>
                        <div style="margin-top:8px;">
                            <label>Retrans Warn <input type="number" step="0.1"
                                    x-model.number="thresholds.tcp_retrans_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.tcp_retrans_crit"
                                    style="width:90px; margin-left:8px"></label>
                        </div>
                    </div>
                </div>
                <div class="modal__footer" style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
                    <button class="btn btn--ghost" @click="thresholdsModalOpen=false">Cancel</button>
                    <button class="btn btn--primary" @click="saveThresholds()">Save</button>
                </div>
            </div>
        </div>

        <!-- Firewall Detail Modal -->
        <div class="modal" x-show="fwDetailOpen" :style="fwDetailOpen ? 'display:flex' : 'display:none'"
            @click.self="closeFwDetail()">
            <div class="modal-content fw-detail-modal" style="max-width: 500px;">
                <template x-if="fwDetailType && fwDetails[fwDetailType]">
                    <div>
                        <div class="modal__header"
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h2 style="margin:0" x-text="fwDetails[fwDetailType].title"></h2>
                            <button @click="closeFwDetail()"
                                style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                                aria-label="Close detail modal">√ó</button>
                        </div>

                        <p class="fw-detail-desc" x-text="fwDetails[fwDetailType].description"></p>

                        <div class="fw-detail-values">
                            <h4>üìä Current Values</h4>
                            <div class="fw-values-grid">
                                <template x-for="field in fwDetails[fwDetailType].fields" :key="field">
                                    <div class="fw-value-item">
                                        <span class="fw-field-name"
                                            x-text="field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                        <span class="fw-field-value" x-text="getFwValue(field)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <template x-if="fwDetails[fwDetailType].thresholds">
                            <div class="fw-detail-thresholds">
                                <h4>‚ö†Ô∏è Thresholds</h4>
                                <div class="fw-threshold-row">
                                    <span class="status-warning-badge">Warning: <span
                                            x-text="fwDetails[fwDetailType].thresholds.warning"></span></span>
                                    <span class="status-critical-badge">Critical: <span
                                            x-text="fwDetails[fwDetailType].thresholds.critical"></span></span>
                                </div>
                            </div>
                        </template>

                        <template x-if="fwDetails[fwDetailType].tips && fwDetails[fwDetailType].tips.length">
                            <div class="fw-detail-tips">
                                <h4>üí° Tips</h4>
                                <ul>
                                    <template x-for="tip in fwDetails[fwDetailType].tips" :key="tip">
                                        <li x-text="tip"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>

        <!-- Configuration Settings Modal -->
        <div class="modal" x-show="configModalOpen" :style="configModalOpen ? 'display:flex' : 'display:none'"
            @click.self="configModalOpen = false">
            <div class="modal-content config-modal" style="max-width: 420px;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="margin:0">‚öôÔ∏è Configuration Settings</h2>
                    <button @click="configModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close config modal">√ó</button>
                </div>

                <div x-show="configLoading" style="text-align:center; padding:20px;">
                    <div class="spinner"></div>
                    <p style="color:var(--text-muted); margin-top:10px;">Loading configuration...</p>
                </div>

                <div x-show="!configLoading" :style="!configLoading ? 'display:block' : 'display:none'">
                    <div class="config-section">
                        <h3>üåê Network</h3>
                        <div class="config-row">
                            <label>DNS Server</label>
                            <input type="text" x-model="config.dns_server" placeholder="192.168.0.6">
                            <span class="config-hint">Used for hostname resolution</span>
                        </div>
                        <div class="config-row">
                            <label>Internal Networks</label>
                            <input type="text" x-model="config.internal_networks"
                                placeholder="192.168.0.0/16,10.0.0.0/8">
                            <span class="config-hint">CIDR notation, comma-separated</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üì° SNMP (Firewall Monitoring)</h3>
                        <div class="config-row">
                            <label>SNMP Host</label>
                            <input type="text" x-model="config.snmp_host" placeholder="192.168.0.1">
                            <span class="config-hint">OPNsense/pfSense firewall IP</span>
                        </div>
                        <div class="config-row">
                            <label>SNMP Community</label>
                            <input type="password" x-model="config.snmp_community" placeholder="public">
                            <span class="config-hint">SNMP v2c community string</span>
                        </div>
                        <div class="config-row">
                            <label for="snmp-poll-interval">Poll Interval (sec)</label>
                            <input id="snmp-poll-interval" type="number" x-model.number="config.snmp_poll_interval"
                                min="1" max="60" step="1" placeholder="Enter poll interval">
                            <span class="config-hint">How often to poll SNMP (1-60s)</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üìÇ Paths</h3>
                        <div class="config-row">
                            <label>NetFlow Data Directory</label>
                            <input type="text" x-model="config.nfdump_dir" placeholder="/var/cache/nfdump">
                            <span class="config-hint">Where nfcapd stores flow data</span>
                        </div>
                        <div class="config-row">
                            <label>GeoIP City Database</label>
                            <input type="text" x-model="config.geoip_city_path" placeholder="/root/GeoLite2-City.mmdb">
                            <span class="config-hint">MaxMind GeoLite2 City MMDB</span>
                        </div>
                        <div class="config-row">
                            <label>GeoIP ASN Database</label>
                            <input type="text" x-model="config.geoip_asn_path" placeholder="/root/GeoLite2-ASN.mmdb">
                            <span class="config-hint">MaxMind GeoLite2 ASN MMDB</span>
                        </div>
                        <div class="config-row">
                            <label>Threat Feeds File</label>
                            <input type="text" x-model="config.threat_feeds_path" placeholder="/root/threat-feeds.txt">
                            <span class="config-hint">List of threat feed URLs (one per line)</span>
                        </div>
                    </div>

                    <div class="modal__footer"
                        style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px; padding-top:16px; border-top:1px solid var(--card-border);">
                        <button class="btn btn--ghost" @click="configModalOpen = false">Cancel</button>
                        <button class="btn btn--primary" @click="saveConfig()" :disabled="configSaving">
                            <span x-show="!configSaving">üíæ Save Configuration</span>
                            <span x-show="configSaving">Saving...</span>
                        </button>
                    </div>

                    <p style="color:var(--text-muted); font-size:0.8em; margin-top:12px; text-align:center;">‚ö†Ô∏è Some
                        changes require a service restart to take full effect</p>
                </div>
            </div>
        </div>

        <!-- Watchlist Manager Modal -->
        <div class="modal" x-show="watchlistModalOpen" :style="watchlistModalOpen ? 'display:flex' : 'display:none'"
            @click.self="watchlistModalOpen = false">
            <div class="modal-content" style="max-width: 500px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0">üëÅÔ∏è IP Watchlist</h2>
                    <button @click="watchlistModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close watchlist modal">√ó</button>
                </div>
                <p style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 12px;">Monitor specific IPs for
                    any
                    network activity. Matches will appear in threat detections.</p>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" x-model="watchlistInput" aria-label="IP address to add to watchlist"
                        placeholder="Enter IP address (e.g., 192.168.1.100)"
                        style="flex: 1; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--neon-cyan); border-radius: 4px; color: #fff;">
                    <button class="btn btn--primary" @click="addToWatchlist()" :disabled="!watchlistInput"
                        title="Add IP to watchlist">‚ûï Add</button>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <template x-if="watchlist.watchlist && watchlist.watchlist.length > 0">
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <template x-for="entry in watchlist.watchlist" :key="entry.ip">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(0,243,255,0.05); border: 1px solid rgba(0,243,255,0.1); border-radius: 4px;">
                                    <div>
                                        <span style="color: var(--neon-yellow);" x-text="entry.ip"></span>
                                        <span style="font-size: 0.8em; color: var(--text-muted); margin-left: 8px;"
                                            x-text="'added ' + entry.added_ago"></span>
                                    </div>
                                    <button class="btn btn--danger" @click="removeFromWatchlist(entry.ip)"
                                        title="Remove from watchlist"
                                        style="padding: 4px 8px; font-size: 0.85em;">üóëÔ∏è</button>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="!watchlist.watchlist || watchlist.watchlist.length === 0">
                        <div style="color: var(--text-muted); text-align: center; padding: 24px;">
                            No IPs in watchlist. Add IPs above to monitor them.
                        </div>
                    </template>
                </div>
                <div
                    style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,243,255,0.1); text-align: right;">
                    <span style="color: var(--text-muted); font-size: 0.85em;"
                        x-text="(watchlist.count || 0) + ' IPs in watchlist'"></span>
                </div>
            </div>
        </div>

        <!-- Widget Manager Modal -->
        <div class="modal" x-show="widgetManagerOpen" :style="widgetManagerOpen ? 'display:flex' : 'display:none'"
            @click.self="widgetManagerOpen = false">
            <div class="modal-content" style="max-width: 600px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0">Customize Widgets</h2>
                    <button @click="widgetManagerOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close widget manager">√ó</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto;">
                    <div style="display: grid; gap: 10px;">
                        <template x-for="(visible, widgetId) in widgetVisibility" :key="widgetId">
                            <div
                                style="display: flex; align-items: center; padding: 10px; background: rgba(0,243,255,0.05); border-radius: 4px; border: 1px solid rgba(0,243,255,0.1); justify-content: space-between;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <input type="checkbox" :checked="visible" @change="toggleWidget(widgetId)"
                                        style="cursor: pointer;">
                                    <span x-text="getWidgetLabel(widgetId)"></span>
                                </label>
                                <span style="font-size: 0.8em; color: var(--text-muted);"
                                    x-show="isMinimized(widgetId)">üìå
                                    minimized</span>
                            </div>
                        </template>
                    </div>
                </div>
                <div
                    style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,243,255,0.1); display:flex; justify-content:space-between; gap:10px;">
                    <button class="btn btn--danger" @click="resetWidgetPreferences()">Reset All</button>
                    <button class="btn btn--ghost" @click="widgetManagerOpen=false">Close</button>
                </div>
            </div>
        </div>

        <!-- Keyboard Shortcuts Hint -->
        <div class="keyboard-hint" title="Press ? for all shortcuts">
            <kbd>R</kbd> Refresh <kbd>P</kbd> Pause <kbd>1-6</kbd> Time
        </div>

        <!-- Sticky Status Bar -->
        <div class="status-bar"
            style="display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: center; gap: var(--space-3);">
            <!-- System Metrics -->
            <div class="status-bar-item">
                <span class="status-bar-dot"
                    :class="{ 'warning': firewall.cpu_percent >= 70, 'disconnected': firewall.cpu_percent >= 90 }"></span>
                <span class="label">CPU:</span>
                <span class="value"
                    :class="{ 'warning': firewall.cpu_percent >= 70, 'critical': firewall.cpu_percent >= 90 }"
                    x-text="(firewall.cpu_percent || '--') + '%'"></span>
            </div>
            <div class="status-bar-item">
                <span class="label">MEM:</span>
                <span class="value"
                    :class="{ 'warning': firewall.mem_percent >= 70, 'critical': firewall.mem_percent >= 90 }"
                    x-text="(firewall.mem_percent || '--') + '%'"></span>
            </div>
            <!-- Network Metrics -->
            <div class="status-bar-item">
                <span class="label">Threats:</span>
                <span class="value" :class="{ 'critical': threats.hits.length > 0 }"
                    x-text="threats.hits.length"></span>
            </div>
            <div class="status-bar-item">
                <span class="label">Flows:</span>
                <span class="value" x-text="Number(summary.totals.flows || 0).toLocaleString()"></span>
            </div>
            <!-- Status -->
            <div class="status-bar-item">
                <span class="status-bar-dot" :class="{ 'disconnected': !firewallStreamActive && !initDone }"></span>
                <span class="label">Status:</span>
                <span class="value" x-text="paused ? 'Paused' : 'Live'"></span>
            </div>
            <!-- Performance & Timing -->
            <div class="status-bar-item latency-indicator" x-show="avgLatency !== null">
                <span class="label">API:</span>
                <span class="value" :class="latencyClass" x-text="avgLatency + 'ms'"></span>
            </div>
            <div class="status-bar-item">
                <span class="label">Next:</span>
                <span class="value" style="color: var(--text-muted);"
                    x-text="paused ? '--' : refreshCountdown + 's'"></span>
            </div>
            <div class="status-bar-item">
                <span class="label">Up:</span>
                <span class="value" style="color: var(--text-muted);" x-text="lastUpdate"></span>
            </div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav">
            <button class="mobile-nav-item" :class="{ 'active': activeTab === 'overview' }" @click="loadTab('overview')"
                title="Overview">
                <span class="mobile-nav-icon">üìä</span>
                <span class="mobile-nav-label">Overview</span>
            </button>
            <button class="mobile-nav-item" :class="{ 'active': activeTab === 'security' }" @click="loadTab('security')"
                title="Security">
                <span class="mobile-nav-icon">üõ°Ô∏è</span>
                <span class="mobile-nav-label">Security</span>
            </button>
            <button class="mobile-nav-item" :class="{ 'active': activeTab === 'network' }" @click="loadTab('network')"
                title="Network">
                <span class="mobile-nav-icon">üï∏Ô∏è</span>
                <span class="mobile-nav-label">Network</span>
            </button>
            <button class="mobile-nav-item" :class="{ 'active': activeTab === 'forensics' }"
                @click="loadTab('forensics')" title="Forensics">
                <span class="mobile-nav-icon">üîç</span>
                <span class="mobile-nav-label">Forensics</span>
            </button>
            <button class="mobile-nav-item" :class="{ 'active': activeTab === 'server' }" @click="loadTab('server')"
                title="Servers">
                <span class="mobile-nav-icon">üñ•Ô∏è</span>
                <span class="mobile-nav-label">Servers</span>
            </button>
            <button class="mobile-nav-item" :class="{ 'active': activeTab === 'assistant' }"
                @click="loadTab('assistant')" title="AI Assistant">
                <span class="mobile-nav-icon">ü§ñ</span>
                <span class="mobile-nav-label">AI</span>
            </button>
        </nav>

    </div> <!-- End content-scroll-area -->
    </main>
    </div>

    <!-- App Logic already loaded in <head> to ensure Alpine picks it up -->
</body>

</html>