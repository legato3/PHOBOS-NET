<!DOCTYPE html>
<html lang="en">

<head>
    <title x-text="appMetadata.name || 'PHOBOS-NET'">PHOBOS-NET</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description"
        content="Real-time NetFlow analytics dashboard with threat intelligence, bandwidth monitoring, and firewall health metrics. Monitor network traffic, detect threats, and analyze security events.">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" :content="appMetadata.name || 'PHOBOS-NET'">
    <meta property="og:description"
        content="Real-time network traffic monitoring with threat intelligence and security analytics">
    <meta property="og:site_name" :content="appMetadata.name || 'PHOBOS-NET'">

    <!-- Resource hints for better performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <!-- Typography - Inter for UI, JetBrains Mono for technical data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Critical JavaScript modules - Preload for faster execution -->
    <!-- Note: widgets.js and utils.js are ES modules imported by app.js, so they're handled by the module graph -->
    <!-- lazy-load.js is loaded as a regular script, so preloading it makes sense -->
    <link rel="preload" href="/static/js/modules/lazy-load.js" as="script">

    <!-- CSS - Critical render path, load first -->
    <!-- CYBERPUNK UI: Signal-first design system -->
    <link rel="stylesheet" href="/static/css/style.css?v=5.0.0">
    <link rel="stylesheet" href="/static/css/mobile.css">
    <!-- Widget-specific enhancements -->


    <!-- External Libs (bundled locally to reduce CDN dependency) - Defer all heavy libraries -->
    <script src="/static/js/modules/chart.min.js" defer></script>
    <script src="/static/js/modules/alpine-collapse.min.js" defer></script>

    <!-- Modular JavaScript - Load modules before app (critical path) -->
    <script src="/static/js/modules/lazy-load.js"></script>

    <!-- Main app - Register BEFORE Alpine starts so alpine:init is caught -->
    <script type="module" src="/static/js/app.js?v=3.2.0"></script>

    <!-- Alpine.js - Defer to allow app.js to register -->
    <script src="/static/js/modules/alpine.min.js" defer></script>

    <!-- Heavy visualization libraries - Defer until needed -->

    <!-- Leaflet - Local bundle -->
    <link rel="stylesheet" href="/static/css/leaflet.css">
    <script src="/static/js/modules/leaflet.js"></script>
</head>

<body class="antialiased" x-data="dashboard">
    {% from 'macros/widgets.html' import widget_card, insight_panel %}

    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Refresh Progress Bar -->
    <div class="refresh-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"
        :aria-valuenow="countdownPercent" aria-label="Auto-refresh countdown">
        <div class="refresh-progress-bar" :class="{ 'paused': paused }" :style="'width: ' + countdownPercent + '%'">
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-screen" x-show="!initDone" role="status" aria-live="polite">
        <div class="loader">Initializing Neural Link...</div>
    </div>

    <div class="container" x-show="initDone" x-transition.opacity.duration.500ms>
        <!-- Layout with Sidebar -->
        <div class="layout-wrapper">
            {% include "layouts/sidebar.html" %}
            {% include "layouts/header.html" %}
            <main class="main-content" id="main-content" tabindex="-1">
                <div class="content-scroll-area">
                    {% include "tabs/overview.html" %}
                    {% include "tabs/security.html" %}
                    {% include "tabs/network.html" %}
                    {% include "tabs/hosts.html" %}
                    {% include "tabs/firewall.html" %}
                    {% include "tabs/server.html" %}
                    {% include "tabs/firewall-snmp.html" %}
                    {% include "tabs/assistant.html" %}
                    {% include "tabs/forensics.html" %}
                    {% include "tabs/tools.html" %}

                    <!-- Expanded Table Modal -->

                    <!-- IP Trend Modal -->


                    <!-- Flow Details Modal -->

                    <!-- Unified Event Details Modal (Flow, Firewall, Threat) -->

                    <!-- Widget Manager Modal -->

                    <!-- Keyboard Shortcuts Hint -->
                    <div class="keyboard-hint" title="Press ? for all shortcuts">
                        <kbd>R</kbd> Refresh <kbd>P</kbd> Pause <kbd>1-6</kbd> Time
                    </div>

                    <!-- Sticky Status Bar -->
                    <div class="status-bar"
                        style="display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: center; gap: var(--space-3);">
                        <!-- System Metrics -->
                        <div class="status-bar-item">
                            <span class="status-bar-dot"
                                :class="{ 'warning': firewall.cpu_percent >= 70, 'disconnected': firewall.cpu_percent >= 90 }"></span>
                            <span class="label">CPU:</span>
                            <span class="value"
                                :class="{ 'warning': firewall.cpu_percent >= 70, 'critical': firewall.cpu_percent >= 90 }"
                                x-text="(firewall.cpu_percent || '--') + '%'"></span>
                        </div>
                        <div class="status-bar-item">
                            <span class="label">MEM:</span>
                            <span class="value"
                                :class="{ 'warning': firewall.mem_percent >= 70, 'critical': firewall.mem_percent >= 90 }"
                                x-text="(firewall.mem_percent || '--') + '%'"></span>
                        </div>
                        <!-- Network Metrics -->
                        <div class="status-bar-item">
                            <span class="label">Threats:</span>
                            <span class="value" :class="{ 'critical': threats.hits.length > 0 }"
                                x-text="threats.hits.length"></span>
                        </div>
                        <div class="status-bar-item">
                            <span class="label">Flows:</span>
                            <span class="value" x-text="Number(summary.totals.flows || 0).toLocaleString()"></span>
                        </div>
                        <!-- Status -->
                        <div class="status-bar-item">
                            <span class="status-bar-dot"
                                :class="{ 'disconnected': !firewallStreamActive && !initDone }"></span>
                            <span class="label">Status:</span>
                            <span class="value" x-text="paused ? 'Paused' : 'Live'"></span>
                        </div>
                        <!-- Performance & Timing -->
                        <div class="status-bar-item latency-indicator" x-show="avgLatency !== null">
                            <span class="label">API:</span>
                            <span class="value" :class="latencyClass" x-text="avgLatency + 'ms'"></span>
                        </div>
                        <div class="status-bar-item">
                            <span class="label">Next:</span>
                            <span class="value" style="color: var(--text-muted);"
                                x-text="paused ? '--' : refreshCountdown + 's'"></span>
                        </div>
                        <div class="status-bar-item">
                            <span class="label">Up:</span>
                            <span class="value" style="color: var(--text-muted);" x-text="lastUpdate"></span>
                        </div>
                    </div>

                    <!-- Mobile Bottom Navigation -->
                    <nav class="mobile-nav">
                        <button class="mobile-nav-item" :class="{ 'active': activeTab === 'overview' }"
                            @click="loadTab('overview')" title="Overview">
                            <span class="mobile-nav-icon">üìä</span>
                            <span class="mobile-nav-label">Overview</span>
                        </button>
                        <button class="mobile-nav-item" :class="{ 'active': activeTab === 'security' }"
                            @click="loadTab('security')" title="Security">
                            <span class="mobile-nav-icon">üõ°Ô∏è</span>
                            <span class="mobile-nav-label">Security</span>
                        </button>
                        <button class="mobile-nav-item" :class="{ 'active': activeTab === 'network' }"
                            @click="loadTab('network')" title="Network">
                            <span class="mobile-nav-icon">üï∏Ô∏è</span>
                            <span class="mobile-nav-label">Network</span>
                        </button>
                        <button class="mobile-nav-item" :class="{ 'active': activeTab === 'forensics' }"
                            @click="loadTab('forensics')" title="Forensics">
                            <span class="mobile-nav-icon">üîç</span>
                            <span class="mobile-nav-label">Forensics</span>
                        </button>
                        <button class="mobile-nav-item" :class="{ 'active': activeTab === 'assistant' }"
                            @click="loadTab('assistant')" title="Assistant">
                            <span class="mobile-nav-icon">ü§ñ</span>
                            <span class="mobile-nav-label">Assistant</span>
                        </button>
                        <button class="mobile-nav-item"
                            :class="{ 'active': ['server', 'hosts', 'firewall', 'firewall-snmp'].includes(activeTab) || mobileMoreModalOpen }"
                            @click="mobileMoreModalOpen = true" title="More">
                            <span class="mobile-nav-icon">‚ãØ</span>
                            <span class="mobile-nav-label">More</span>
                        </button>
                    </nav>

                </div> <!-- End content-scroll-area -->
            </main>
        </div>

        <!-- Alerts Modal -->
        <div class="modal" x-show="trendModalOpen" :style="trendModalOpen ? 'display:flex' : 'display:none'"
            @click.self="trendModalOpen = false">
            <div class="modal-content" style="max-width: 760px;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0">Trend: <span class="text-cyan" x-text="trendIP"></span> <span
                            style="color:var(--text-muted); font-size:0.7em"
                            x-text="'(' + (trendKind==='source' ? 'Source' : 'Destination') + ')' "></span>
                    </h2>
                    <button @click="trendModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close trend">√ó</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="ipTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Fullscreen Chart Modal -->
        <div class="modal fullscreen-chart-modal" x-show="fullscreenChart"
            :style="fullscreenChart ? 'display:flex' : 'display:none'" @click.self="closeFullscreenChart()">
            <div class="modal-content fullscreen-chart-content">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="margin:0"><span class="text-cyan" x-text="fullscreenChart?.title || 'Chart'"></span>
                    </h2>
                    <button @click="closeFullscreenChart()"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close fullscreen">√ó</button>
                </div>
                <div class="fullscreen-chart-wrapper">
                    <canvas id="fullscreenChartCanvas"></canvas>
                </div>
                <p style="text-align:center; color:var(--text-muted); font-size:0.8em; margin-top:12px;">
                    Press
                    <kbd>ESC</kbd> or click outside to close
                </p>
            </div>
        </div>

        <!-- Thresholds Modal -->
        <div class="modal" x-show="thresholdsModalOpen" :style="thresholdsModalOpen ? 'display:flex' : 'display:none'"
            @click.self="thresholdsModalOpen = false">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0">Threshold Settings</h2>
                    <button @click="thresholdsModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close settings">√ó</button>
                </div>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">Utilization
                            (%)</h3>
                        <label>Warn <input type="number" min="0" max="100" x-model.number="thresholds.util_warn"
                                style="width:80px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" min="0" max="100"
                                x-model.number="thresholds.util_crit" style="width:80px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">TCP Resets
                            (/s)</h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.resets_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.resets_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">IP Errors
                            (/s)</h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.ip_err_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.ip_err_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">ICMP Errors
                            (/s)</h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.icmp_err_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.icmp_err_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">Interface
                            Err/Disc
                            (/s)
                        </h3>
                        <label>Warn <input type="number" step="0.1" x-model.number="thresholds.if_err_warn"
                                style="width:90px; margin-left:8px"></label>
                        <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                x-model.number="thresholds.if_err_crit" style="width:90px; margin-left:8px"></label>
                    </div>
                    <div class="card" style="min-height:auto;">
                        <h3 style="margin:0 0 8px 0; font-size:0.95em; color:var(--neon-cyan)">TCP
                            Reliability (/s)
                        </h3>
                        <div>
                            <label>Fails Warn <input type="number" step="0.1" x-model.number="thresholds.tcp_fails_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.tcp_fails_crit"
                                    style="width:90px; margin-left:8px"></label>
                        </div>
                        <div style="margin-top:8px;">
                            <label>Retrans Warn <input type="number" step="0.1"
                                    x-model.number="thresholds.tcp_retrans_warn"
                                    style="width:90px; margin-left:8px"></label>
                            <label style="margin-left:12px;">Crit <input type="number" step="0.1"
                                    x-model.number="thresholds.tcp_retrans_crit"
                                    style="width:90px; margin-left:8px"></label>
                        </div>
                    </div>
                </div>
                <div class="modal__footer" style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
                    <button class="btn btn--ghost" @click="thresholdsModalOpen=false">Cancel</button>
                    <button class="btn btn--primary" @click="saveThresholds()">Save</button>
                </div>
            </div>
        </div>

        <!-- Firewall Detail Modal -->
        <div class="modal" x-show="fwDetailOpen" :style="fwDetailOpen ? 'display:flex' : 'display:none'"
            @click.self="closeFwDetail()">
            <div class="modal-content fw-detail-modal" style="max-width: 500px;">
                <template x-if="fwDetailType && fwDetails[fwDetailType]">
                    <div>
                        <div class="modal__header"
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h2 style="margin:0" x-text="fwDetails[fwDetailType].title"></h2>
                            <button @click="closeFwDetail()"
                                style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                                aria-label="Close detail modal">√ó</button>
                        </div>

                        <p class="fw-detail-desc" x-text="fwDetails[fwDetailType].description"></p>

                        <div class="fw-detail-values">
                            <h4>üìä Current Values</h4>
                            <div class="fw-values-grid">
                                <template x-for="field in fwDetails[fwDetailType].fields" :key="field">
                                    <div class="fw-value-item">
                                        <span class="fw-field-name"
                                            x-text="field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                        <span class="fw-field-value" x-text="getFwValue(field)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <template x-if="fwDetails[fwDetailType].thresholds">
                            <div class="fw-detail-thresholds">
                                <h4>‚ö†Ô∏è Thresholds</h4>
                                <div class="fw-threshold-row">
                                    <span class="status-warning-badge">Warning: <span
                                            x-text="fwDetails[fwDetailType].thresholds.warning"></span></span>
                                    <span class="status-critical-badge">Critical: <span
                                            x-text="fwDetails[fwDetailType].thresholds.critical"></span></span>
                                </div>
                            </div>
                        </template>

                        <template x-if="fwDetails[fwDetailType].tips && fwDetails[fwDetailType].tips.length">
                            <div class="fw-detail-tips">
                                <h4>üí° Tips</h4>
                                <ul>
                                    <template x-for="tip in fwDetails[fwDetailType].tips" :key="tip">
                                        <li x-text="tip"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>

        <!-- Configuration Settings Modal -->
        <div class="modal" x-show="configModalOpen" :style="configModalOpen ? 'display:flex' : 'display:none'"
            @click.self="configModalOpen = false">
            <div class="modal-content config-modal" style="max-width: 420px;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="margin:0">‚öôÔ∏è Configuration Settings</h2>
                    <button @click="configModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close config modal">√ó</button>
                </div>

                <div x-show="configLoading" style="text-align:center; padding:20px;">
                    <div class="spinner"></div>
                    <p style="color:var(--text-muted); margin-top:10px;">Loading configuration...</p>
                </div>

                <div x-show="!configLoading" :style="!configLoading ? 'display:block' : 'display:none'">
                    <div class="config-section">
                        <h3>üåê Network</h3>
                        <div class="config-row">
                            <label>DNS Server</label>
                            <input type="text" x-model="config.dns_server" placeholder="e.g., 192.168.1.1 (optional)">
                            <span class="config-hint">Used for hostname resolution</span>
                        </div>
                        <div class="config-row">
                            <label>Internal Networks</label>
                            <input type="text" x-model="config.internal_networks"
                                placeholder="192.168.0.0/16,10.0.0.0/8">
                            <span class="config-hint">CIDR notation, comma-separated</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üì° SNMP (Firewall Monitoring)</h3>
                        <div class="config-row">
                            <label>SNMP Host</label>
                            <input type="text" x-model="config.snmp_host" placeholder="e.g., 192.168.1.1 (optional)">
                            <span class="config-hint">OPNsense/pfSense firewall IP</span>
                        </div>
                        <div class="config-row">
                            <label>SNMP Community</label>
                            <input type="password" x-model="config.snmp_community" placeholder="public">
                            <span class="config-hint">SNMP v2c community string</span>
                        </div>
                        <div class="config-row">
                            <label for="snmp-poll-interval">Poll Interval (sec)</label>
                            <input id="snmp-poll-interval" type="number" x-model.number="config.snmp_poll_interval"
                                min="1" max="60" step="1" placeholder="Enter poll interval">
                            <span class="config-hint">How often to poll SNMP (1-60s)</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üìä Analysis</h3>
                        <div class="config-row">
                            <label for="default-time-range">Default Time Range</label>
                            <select id="default-time-range" x-model="config.default_time_range"
                                aria-label="Default Time Range">
                                <option value="15m">15 minutes</option>
                                <option value="30m">30 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="6h">6 hours</option>
                                <option value="24h">24 hours</option>
                                <option value="7d">7 days</option>
                            </select>
                            <span class="config-hint">Default time window for data queries</span>
                        </div>
                        <div class="config-row">
                            <label>Refresh Interval (ms)</label>
                            <input type="number" x-model.number="config.refresh_interval" min="5000" max="300000"
                                step="1000" placeholder="30000">
                            <span class="config-hint">How often to refresh dashboard data (5-300
                                seconds)</span>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>üîß System Resources</h3>
                        <div class="config-row"
                            style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                            <div>
                                <label style="margin: 0;">NetFlow Data</label>
                                <span class="config-hint" style="display: block; margin-top: 2px;"
                                    x-text="serverHealth.netflow?.directory || 'Checking...'"></span>
                            </div>
                            <span class="server-stat-badge" :class="{
                                'badge-success': serverHealth.netflow?.available,
                                'badge-error': serverHealth.netflow && !serverHealth.netflow.available,
                                'badge-warning': serverHealth.loading
                            }"
                                x-text="serverHealth.loading ? '...' : (serverHealth.netflow?.available ? '‚úì Loaded' : '‚úó Not Available')"></span>
                        </div>
                        <div class="config-row"
                            style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                            <div>
                                <label style="margin: 0;">GeoIP Databases</label>
                                <span class="config-hint" style="display: block; margin-top: 2px;"
                                    x-text="serverHealth.cache?.geo_cache_size !== undefined ? (serverHealth.cache.geo_cache_size.toLocaleString() + ' cached entries') : 'Checking...'"></span>
                            </div>
                            <span class="server-stat-badge" :class="{
                                'badge-success': serverHealth.cache?.geo_cache_size !== undefined && serverHealth.cache.geo_cache_size > 0,
                                'badge-error': serverHealth.cache?.geo_cache_size === 0,
                                'badge-warning': serverHealth.cache?.geo_cache_size === undefined
                            }"
                                x-text="serverHealth.cache?.geo_cache_size === undefined ? '...' : (serverHealth.cache.geo_cache_size > 0 ? '‚úì Loaded' : '‚úó Not Available')"></span>
                        </div>
                        <div class="config-row"
                            style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0;">
                            <div>
                                <label style="margin: 0;">Threat Feeds</label>
                                <span class="config-hint" style="display: block; margin-top: 2px;"
                                    x-text="feedHealth.loading ? 'Checking...' : (feedHealth.summary ? (feedHealth.summary.total > 0 ? (feedHealth.summary.total_ips.toLocaleString() + ' IPs from ' + feedHealth.summary.total + ' feeds') : 'No feeds loaded') : 'Unable to load')"></span>
                            </div>
                            <span class="server-stat-badge" :class="{
                                'badge-success': feedHealth.summary && feedHealth.summary.ok > 0,
                                'badge-error': feedHealth.summary && feedHealth.summary.ok === 0 && feedHealth.summary.total > 0,
                                'badge-warning': !feedHealth.summary || feedHealth.loading || (feedHealth.summary && feedHealth.summary.total === 0)
                            }"
                                x-text="feedHealth.loading ? '...' : (!feedHealth.summary ? 'Error' : (feedHealth.summary.ok > 0 ? '‚úì Loaded' : (feedHealth.summary.total === 0 ? 'Not Configured' : '‚úó Not Available')))"></span>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.75em; margin-top: 8px; font-style: italic;">
                            System resources are configured via Docker environment variables and cannot be
                            changed
                            from the UI.</p>
                    </div>

                    <div class="modal__footer"
                        style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px; padding-top:16px; border-top:1px solid var(--card-border);">
                        <button class="btn btn--ghost" @click="configModalOpen = false">Cancel</button>
                        <button class="btn btn--primary" @click="saveConfig()" :disabled="configSaving">
                            <span x-show="!configSaving">üíæ Save Configuration</span>
                            <span x-show="configSaving">Saving...</span>
                        </button>
                    </div>

                    <p style="color:var(--text-muted); font-size:0.8em; margin-top:12px; text-align:center;">
                        ‚ö†Ô∏è Some
                        changes require a service restart to take full effect</p>
                </div>
            </div>
        </div>

        <div class="modal" x-show="flowDetailsModalOpen" :style="flowDetailsModalOpen ? 'display:flex' : 'display:none'"
            @click.self="closeFlowDetailsModal()" @keydown.escape.window="closeFlowDetailsModal()"
            x-data="{ flow: selectedFlow }">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal__header">
                    <div style="flex: 1;">
                        <h2
                            style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                            <span class="text-cyan" x-text="selectedFlow?.src || ''"></span>
                            <span x-text="selectedFlow ? (getDirectionIndicator(selectedFlow)?.symbol || '‚Üí') : '‚Üí'"
                                :style="selectedFlow ? ('color: ' + (getDirectionIndicator(selectedFlow)?.color || 'var(--text-muted)') + '; font-size: 1.1em;') : 'color: var(--text-muted); font-size: 1.1em;'"></span>
                            <span class="text-cyan" x-text="selectedFlow?.dst || ''"></span>
                            <span class="text-muted"
                                style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                x-text="selectedFlow?.proto_name || ''"></span>
                        </h2>
                    </div>
                    <button @click="closeFlowDetailsModal()"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                        aria-label="Close flow details">√ó</button>
                </div>

                <div style="padding: var(--space-4) 0;">
                    <!-- Identity Section (only if data exists) -->
                    <template
                        x-if="selectedFlow && (selectedFlow.src_hostname || selectedFlow.dst_hostname || selectedFlow.src_country || selectedFlow.dst_country)">
                        <div class="card"
                            style="margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.03); border: 1px solid rgba(0, 234, 255, 0.1);">
                            <h3
                                style="margin: 0 0 var(--space-2) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Identity</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                <!-- Source Identity -->
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Source</div>
                                    <div x-show="selectedFlow?.src_hostname"
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                        <span class="text-muted">Hostname:</span> <span
                                            x-text="selectedFlow.src_hostname"></span>
                                    </div>
                                    <div x-show="selectedFlow?.src_country"
                                        style="font-size: var(--text-sm); color: var(--text-secondary);">
                                        <span class="text-muted">Location:</span>
                                        <span x-show="selectedFlow.src_flag"
                                            :class="'flag-icon flag-icon-' + (selectedFlow.src_country_code || 'unknown').toLowerCase()"
                                            style="margin: 0 4px;"></span>
                                        <span x-text="selectedFlow.src_country || 'Unknown'"></span>
                                    </div>
                                </div>
                                <!-- Destination Identity -->
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Destination</div>
                                    <div x-show="selectedFlow?.dst_hostname"
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                        <span class="text-muted">Hostname:</span> <span
                                            x-text="selectedFlow.dst_hostname"></span>
                                    </div>
                                    <div x-show="selectedFlow?.dst_country"
                                        style="font-size: var(--text-sm); color: var(--text-secondary);">
                                        <span class="text-muted">Location:</span>
                                        <span x-show="selectedFlow.dst_flag"
                                            :class="'flag-icon flag-icon-' + (selectedFlow.dst_country_code || 'unknown').toLowerCase()"
                                            style="margin: 0 4px;"></span>
                                        <span x-text="selectedFlow.dst_country || 'Unknown'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Flow Metrics -->
                    <div class="card" style="margin-bottom: var(--space-4); padding: var(--space-3);">
                        <h3
                            style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                            Flow Metrics</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    First Seen</div>
                                <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                    x-text="selectedFlow?.first_seen_ts ? formatFlowTimestamp(selectedFlow.first_seen_ts) : (selectedFlow?.age_seconds ? formatAge(selectedFlow.age_seconds) + ' ago' : 'Unknown')">
                                </div>
                            </div>
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    Duration</div>
                                <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                    x-text="selectedFlow?.duration || selectedFlow?.duration_seconds ? (selectedFlow.duration || selectedFlow.duration_seconds + 's') : 'Unknown'">
                                </div>
                            </div>
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    Bytes</div>
                                <div style="font-size: var(--text-sm); color: var(--signal-ok); font-weight: 500;"
                                    x-text="selectedFlow?.bytes_fmt || '0 B'"></div>
                            </div>
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    Packets</div>
                                <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                    x-text="(selectedFlow?.packets || 0).toLocaleString()"></div>
                            </div>
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    Average Rate</div>
                                <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                    x-text="selectedFlow ? calculateFlowRate(selectedFlow) : '0 B/s'"></div>
                            </div>
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    Direction</div>
                                <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                    x-text="selectedFlow?.direction ? selectedFlow.direction.charAt(0).toUpperCase() + selectedFlow.direction.slice(1) : 'Unknown'">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ports & Protocol Details -->
                    <div class="card" style="padding: var(--space-3);">
                        <h3
                            style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                            Ports & Protocol</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    Source Port</div>
                                <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                    x-text="selectedFlow?.src_port || 'Unknown'"></div>
                                <div x-show="selectedFlow?.service && selectedFlow.service !== 'unknown' && selectedFlow.service !== selectedFlow.src_port"
                                    style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                    x-text="selectedFlow?.service ? 'Service: ' + selectedFlow?.service : ''">
                                </div>
                            </div>
                            <div>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                    Destination Port</div>
                                <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                    x-text="selectedFlow?.dst_port || 'Unknown'"></div>
                                <div x-show="selectedFlow?.service && selectedFlow.service !== 'unknown' && selectedFlow.service !== selectedFlow.dst_port"
                                    style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                    x-text="selectedFlow?.service ? 'Service: ' + selectedFlow?.service : ''">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Interesting Flow Characteristics (Phase 2) -->
                    <template x-if="selectedFlow?.interesting_flags && selectedFlow.interesting_flags.length > 0">
                        <div class="card"
                            style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.02); border: 1px solid rgba(0, 234, 255, 0.08);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Interesting Characteristics</h3>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <template x-for="flag in selectedFlow.interesting_flags" :key="flag">
                                    <div
                                        style="display: flex; align-items: flex-start; gap: var(--space-2); font-size: var(--text-sm);">
                                        <span style="font-size: 1em; opacity: 0.7;"
                                            x-text="getInterestingFlowIcon(flag)"></span>
                                        <div style="flex: 1; color: var(--text-secondary);">
                                            <div style="font-weight: 500; margin-bottom: 2px;"
                                                x-text="getInterestingFlowTooltip(flag).split(':')[0]">
                                            </div>
                                            <div style="font-size: var(--text-xs); color: var(--text-tertiary);"
                                                x-text="getInterestingFlowTooltip(flag).split(':').slice(1).join(':').trim() || getInterestingFlowTooltip(flag)">
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div
                                style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(0, 234, 255, 0.1); font-size: var(--text-xs); color: var(--text-tertiary);">
                                These are informational hints to help identify unusual patterns. They are
                                not alerts
                                or
                                threats.
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Actions -->
                <div class="modal__footer">
                    <button class="btn btn--secondary" @click="openIPInvestigationModal(selectedFlow?.src)"
                        :disabled="!selectedFlow?.src">
                        Investigate Source IP
                    </button>
                    <button class="btn btn--secondary" @click="openIPInvestigationModal(selectedFlow?.dst)"
                        :disabled="!selectedFlow?.dst">
                        Investigate Destination IP
                    </button>

                </div>
            </div>
        </div>
        <div class="modal" x-show="eventDetailsModalOpen"
            :style="eventDetailsModalOpen ? 'display:flex' : 'display:none'" @click.self="closeEventDetailsModal()"
            @keydown.escape.window="closeEventDetailsModal()">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal__header">
                    <div style="flex: 1;">
                        <!-- Flow Header -->
                        <template x-if="selectedEventType === 'flow'">
                            <h2
                                style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                                <span class="text-cyan" x-text="selectedEvent?.src || ''"></span>
                                <span x-text="getDirectionIndicator(selectedEvent)?.symbol || '‚Üí'"
                                    :style="'color: ' + (getDirectionIndicator(selectedEvent)?.color || 'var(--text-muted)') + '; font-size: 1.1em;'"></span>
                                <span class="text-cyan" x-text="selectedEvent?.dst || ''"></span>
                                <span class="text-muted"
                                    style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                    x-text="selectedEvent?.proto_name || ''"></span>
                            </h2>
                        </template>
                        <!-- Firewall Header -->
                        <template x-if="selectedEventType === 'firewall'">
                            <h2
                                style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                                <span class="text-green" x-text="selectedEvent?.src_ip || ''"></span>
                                <span style="color: var(--text-muted);">‚Üí</span>
                                <span class="text-cyan" x-text="selectedEvent?.dst_ip || ''"></span>
                                <span class="text-muted"
                                    style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                    x-text="(selectedEvent?.proto || 'TCP').toUpperCase()"></span>
                            </h2>
                        </template>
                        <!-- Threat Header -->
                        <template x-if="selectedEventType === 'threat'">
                            <h2
                                style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: var(--space-2);">
                                <span class="text-red" x-text="selectedEvent?.ip || selectedEvent?.src_ip || ''"></span>
                                <span class="text-muted"
                                    style="font-size: 0.85em; font-weight: normal; margin-left: var(--space-2);"
                                    x-text="selectedEvent?.threat_type || 'Threat'"></span>
                            </h2>
                        </template>
                    </div>
                    <button @click="closeEventDetailsModal()"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                        aria-label="Close event details">√ó</button>
                </div>

                <div style="padding: var(--space-4) 0;">
                    <!-- Flow Content -->
                    <template x-if="selectedEventType === 'flow'">
                        <!-- Identity Section (only if data exists) -->
                        <template
                            x-if="selectedEvent && (selectedEvent.src_hostname || selectedEvent.dst_hostname || selectedEvent.src_country || selectedEvent.dst_country)">
                            <div class="card"
                                style="margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.03); border: 1px solid rgba(0, 234, 255, 0.1);">
                                <h3
                                    style="margin: 0 0 var(--space-2) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Identity</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Source</div>
                                        <div x-show="selectedEvent?.src_hostname"
                                            style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                            <span class="text-muted">Hostname:</span> <span
                                                x-text="selectedEvent.src_hostname"></span>
                                        </div>
                                        <div x-show="selectedEvent?.src_country"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            <span class="text-muted">Location:</span>
                                            <span x-show="selectedEvent.src_flag"
                                                :class="'flag-icon flag-icon-' + (selectedEvent.src_country_code || 'unknown').toLowerCase()"
                                                style="margin: 0 4px;"></span>
                                            <span x-text="selectedEvent.src_country || 'Unknown'"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <div
                                            style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                            Destination</div>
                                        <div x-show="selectedEvent?.dst_hostname"
                                            style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-1);">
                                            <span class="text-muted">Hostname:</span> <span
                                                x-text="selectedEvent.dst_hostname"></span>
                                        </div>
                                        <div x-show="selectedEvent?.dst_country"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            <span class="text-muted">Location:</span>
                                            <span x-show="selectedEvent.dst_flag"
                                                :class="'flag-icon flag-icon-' + (selectedEvent.dst_country_code || 'unknown').toLowerCase()"
                                                style="margin: 0 4px;"></span>
                                            <span x-text="selectedEvent.dst_country || 'Unknown'"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <!-- Flow Metrics -->
                        <div class="card" style="margin-bottom: var(--space-4); padding: var(--space-3);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Flow Metrics</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        First Seen</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.first_seen_ts ? formatFlowTimestamp(selectedEvent.first_seen_ts) : (selectedEvent?.age_seconds ? formatAge(selectedEvent.age_seconds) + ' ago' : 'Unknown')">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Duration</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.duration || selectedEvent?.duration_seconds ? (selectedEvent.duration || selectedEvent.duration_seconds + 's') : 'Unknown'">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Bytes</div>
                                    <div style="font-size: var(--text-sm); color: var(--signal-ok); font-weight: 500;"
                                        x-text="selectedEvent?.bytes_fmt || '0 B'"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Packets</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="(selectedEvent?.packets || 0).toLocaleString()"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Average Rate</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent ? calculateFlowRate(selectedEvent) : '0 B/s'">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Direction</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.direction ? selectedEvent.direction.charAt(0).toUpperCase() + selectedEvent.direction.slice(1) : 'Unknown'">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Ports & Protocol Details -->
                        <div class="card" style="padding: var(--space-3);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Ports & Protocol</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Source Port</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.src_port || 'Unknown'"></div>
                                    <div x-show="selectedEvent?.service && selectedEvent.service !== 'unknown' && selectedEvent.service !== selectedEvent.src_port"
                                        style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="'Service: ' + selectedEvent.service"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Destination Port</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.dst_port || 'Unknown'"></div>
                                    <div x-show="selectedEvent?.service && selectedEvent.service !== 'unknown' && selectedEvent.service !== selectedEvent.dst_port"
                                        style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="'Service: ' + selectedEvent.service"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Detection (Phase 2) -->
                        <template x-if="selectedEvent?.is_detected">
                            <div class="card"
                                style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(255, 200, 0, 0.08); border: 1px solid rgba(255, 200, 0, 0.25);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--neon-yellow); font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                    <span>‚ö†Ô∏è</span>
                                    <span>Detection: Long-Lived Low-Volume External Flow</span>
                                </h3>
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3); line-height: 1.5;">
                                    <div
                                        x-text="selectedEvent?.detection_reason || 'This flow matches detection criteria for suspicious behavior.'">
                                    </div>
                                </div>
                                <div
                                    style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(255, 200, 0, 0.2); font-size: var(--text-xs); color: var(--text-tertiary);">
                                    Detection criteria: Duration > 5 minutes AND bytes < 100 KB AND external flow (not
                                        internal). This pattern may indicate persistent C2, data exfiltration, or
                                        beaconing activity. </div>
                                </div>
                        </template>
                        <!-- Threat Correlation (Phase 1) -->
                        <template x-if="selectedEvent?.has_threat">
                            <div class="card"
                                style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(255, 0, 60, 0.05); border: 1px solid rgba(255, 0, 60, 0.15);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--neon-red); font-weight: 600; display: flex; align-items: center; gap: var(--space-2);">
                                    <span>üõ°Ô∏è</span>
                                    <span>Threat Correlation</span>
                                </h3>
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3);">
                                    This flow contains <strong style="color: var(--neon-red);"
                                        x-text="selectedEvent?.threat_count || 0"></strong> threat IP(s)
                                    from known
                                    threat
                                    intelligence feeds.
                                </div>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    <template x-for="(threat, idx) in selectedEvent?.threat_info || []" :key="idx">
                                        <div
                                            style="display: flex; align-items: flex-start; gap: var(--space-2); font-size: var(--text-sm); padding: var(--space-2); background: rgba(255, 0, 60, 0.05); border-radius: var(--radius-sm);">
                                            <div style="flex: 1;">
                                                <div
                                                    style="font-weight: 500; color: var(--text-primary); margin-bottom: 2px;">
                                                    <span class="text-red" x-text="threat.ip"></span>
                                                </div>
                                                <div style="font-size: var(--text-xs); color: var(--text-tertiary);">
                                                    <span>Category: </span><span
                                                        x-text="threat.category || 'UNKNOWN'"></span>
                                                    <span style="margin-left: var(--space-2);">Feed:
                                                    </span><span x-text="threat.feed || 'unknown'"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div
                                    style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(255, 0, 60, 0.2); font-size: var(--text-xs); color: var(--text-tertiary);">
                                    Threat correlation is informational. This flow involves IPs from threat
                                    intelligence
                                    feeds.
                                </div>
                            </div>
                        </template>
                        <!-- Flow History Timeline (Phase 3) -->
                        <template x-if="selectedEvent?.history && selectedEvent.history.length > 1">
                            <div class="card"
                                style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.02); border: 1px solid rgba(0, 234, 255, 0.08);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Flow History (Last 60 min)</h3>
                                <div
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-3);">
                                    This flow pattern has occurred <strong
                                        x-text="selectedEvent.history.length"></strong>
                                    time(s) in the last hour.
                                </div>
                                <div
                                    style="display: flex; flex-direction: column; gap: var(--space-2); max-height: 200px; overflow-y: auto;">
                                    <template
                                        x-for="(entry, idx) in selectedEvent.history.slice().reverse().slice(0, 10)"
                                        :key="idx">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-2); background: rgba(0, 234, 255, 0.03); border-radius: var(--radius-sm); font-size: var(--text-xs);">
                                            <div style="color: var(--text-secondary);">
                                                <span x-text="new Date(entry.ts * 1000).toLocaleTimeString()"></span>
                                                <span style="margin-left: var(--space-2); color: var(--text-tertiary);"
                                                    x-text="'(' + timeAgo(entry.ts) + ')'"></span>
                                            </div>
                                            <div
                                                style="display: flex; gap: var(--space-3); color: var(--text-secondary);">
                                                <span><strong class="text-cyan"
                                                        x-text="fmtBytes(entry.bytes)"></strong></span>
                                                <span style="color: var(--text-tertiary);"
                                                    x-text="entry.packets + ' pkts'"></span>
                                                <span style="color: var(--text-tertiary);"
                                                    x-text="entry.duration.toFixed(1) + 's'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div
                                    style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(0, 234, 255, 0.1); font-size: var(--text-xs); color: var(--text-tertiary);">
                                    History aggregated by source, destination, and port. Shows recurring
                                    patterns.
                                </div>
                            </div>
                        </template>
                        <!-- Interesting Flow Characteristics (Phase 2) -->
                        <template x-if="selectedEvent?.interesting_flags && selectedEvent.interesting_flags.length > 0">
                            <div class="card"
                                style="margin-top: var(--space-4); padding: var(--space-3); background: rgba(0, 234, 255, 0.02); border: 1px solid rgba(0, 234, 255, 0.08);">
                                <h3
                                    style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                    Interesting Characteristics</h3>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    <template x-for="flag in selectedEvent.interesting_flags" :key="flag">
                                        <div
                                            style="display: flex; align-items: flex-start; gap: var(--space-2); font-size: var(--text-sm);">
                                            <span style="font-size: 1em; opacity: 0.7;"
                                                x-text="getInterestingFlowIcon(flag)"></span>
                                            <div style="flex: 1; color: var(--text-secondary);">
                                                <div style="font-weight: 500; margin-bottom: 2px;"
                                                    x-text="getInterestingFlowTooltip(flag).split(':')[0]">
                                                </div>
                                                <div style="font-size: var(--text-xs); color: var(--text-tertiary);"
                                                    x-text="getInterestingFlowTooltip(flag).split(':').slice(1).join(':').trim() || getInterestingFlowTooltip(flag)">
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div
                                    style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid rgba(0, 234, 255, 0.1); font-size: var(--text-xs); color: var(--text-tertiary);">
                                    These are informational hints to help identify unusual patterns. They
                                    are not
                                    alerts
                                    or
                                    threats.
                                </div>
                            </div>
                        </template>
                    </template>

                    <!-- Firewall Content -->
                    <template x-if="selectedEventType === 'firewall'">
                        <!-- Firewall Event Details -->
                        <div class="card" style="margin-bottom: var(--space-4); padding: var(--space-3);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Event Details</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Timestamp</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500; font-family: monospace;"
                                        x-text="(selectedEvent?.timestamp || selectedEvent?.timestamp_iso || '').replace('T', ' ').split('.')[0] || 'Unknown'">
                                    </div>
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="selectedEvent?.timestamp_ts ? timeAgo(selectedEvent.timestamp_ts) : ''">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Action</div>
                                    <div>
                                        <span class="badge"
                                            :style="(selectedEvent?.action === 'pass') ? 'background: rgba(0,255,100,0.2); color: var(--neon-green);' : 'background: rgba(255,0,60,0.2); color: var(--neon-red);'"
                                            x-text="(selectedEvent?.action || 'block').toUpperCase()"></span>
                                        <div x-show="selectedEvent?.is_threat"
                                            style="font-size: var(--text-xs); color: var(--neon-red); margin-top: var(--space-1);">
                                            Threat Detected</div>
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Direction</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        :class="selectedEvent?.direction === 'in' ? 'text-green' : 'text-cyan'"
                                        x-text="(selectedEvent?.direction || 'in').toUpperCase()"></div>
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="'Interface: ' + (selectedEvent?.interface || '-')"></div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Protocol</div>
                                    <div>
                                        <span class="badge"
                                            style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                            x-text="(selectedEvent?.proto || 'TCP').toUpperCase()"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Connection Details -->
                        <div class="card" style="padding: var(--space-3);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Connection</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Source</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.src_ip || 'Unknown'"></div>
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="selectedEvent?.src_port ? 'Port: ' + selectedEvent.src_port : ''">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Destination</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.dst_ip || 'Unknown'"></div>
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-1);"
                                        x-text="selectedEvent?.dst_port ? 'Port: ' + selectedEvent.dst_port : ''">
                                    </div>
                                    <div x-show="selectedEvent?.service"
                                        style="font-size: var(--text-xs); color: var(--text-muted);"
                                        x-text="'Service: ' + selectedEvent.service"></div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Threat Content -->
                    <template x-if="selectedEventType === 'threat'">
                        <div class="card" style="padding: var(--space-3);">
                            <h3
                                style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary); font-weight: 600;">
                                Threat Details</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        IP Address</div>
                                    <div style="font-size: var(--text-sm); color: var(--neon-red); font-weight: 500;"
                                        x-text="selectedEvent?.ip || selectedEvent?.src_ip || 'Unknown'">
                                    </div>
                                </div>
                                <div>
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Threat Type</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="selectedEvent?.threat_type || 'Unknown'"></div>
                                </div>
                                <div x-show="selectedEvent?.threat_feed">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Threat Feed</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                        x-text="selectedEvent.threat_feed"></div>
                                </div>
                                <div x-show="selectedEvent?.country">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Country</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                        x-text="selectedEvent.country"></div>
                                </div>
                                <div x-show="selectedEvent?.hits !== undefined">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Occurrences</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-primary); font-weight: 500;"
                                        x-text="(selectedEvent.hits || 0).toLocaleString() + ' hits'"></div>
                                </div>
                                <div x-show="selectedEvent?.category">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1);">
                                        Category</div>
                                    <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                        x-text="selectedEvent.category"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Actions -->
                <div class="modal__footer">
                    <!-- Flow Actions -->
                    <template x-if="selectedEventType === 'flow'">
                        <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                            <button class="btn btn--secondary"
                                @click="openIPInvestigationModal(selectedEvent?.src); closeEventDetailsModal();"
                                :disabled="!selectedEvent?.src">
                                Investigate Source IP
                            </button>
                            <button class="btn btn--secondary"
                                @click="openIPInvestigationModal(selectedEvent?.dst); closeEventDetailsModal();"
                                :disabled="!selectedEvent?.dst">
                                Investigate Destination IP
                            </button>

                        </div>
                    </template>
                    <!-- Firewall Actions -->
                    <template x-if="selectedEventType === 'firewall'">
                        <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                            <button class="btn btn--secondary"
                                @click="openIPInvestigationModal(selectedEvent?.src_ip); closeEventDetailsModal();"
                                :disabled="!selectedEvent?.src_ip">
                                Investigate Source IP
                            </button>
                            <button class="btn btn--secondary"
                                @click="openIPInvestigationModal(selectedEvent?.dst_ip); closeEventDetailsModal();"
                                :disabled="!selectedEvent?.dst_ip">
                                Investigate Destination IP
                            </button>

                        </div>
                    </template>
                    <!-- Threat Actions -->
                    <template x-if="selectedEventType === 'threat'">
                        <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                            <button class="btn btn--secondary"
                                @click="openIPInvestigationModal(selectedEvent?.ip || selectedEvent?.src_ip); closeEventDetailsModal();"
                                :disabled="!selectedEvent?.ip && !selectedEvent?.src_ip">
                                Investigate IP
                            </button>

                        </div>
                    </template>
                </div>
            </div>
        </div>
        <div class="modal" x-show="widgetManagerOpen" :style="widgetManagerOpen ? 'display:flex' : 'display:none'"
            @click.self="widgetManagerOpen = false">
            <div class="modal-content" style="max-width: 600px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h2 style="margin:0">Customize Widgets</h2>
                    <button @click="widgetManagerOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close widget manager">√ó</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto;">
                    <div style="display: grid; gap: 10px;">
                        <template x-for="(visible, widgetId) in widgetVisibility" :key="widgetId">
                            <div
                                style="display: flex; align-items: center; padding: 10px; background: rgba(0,243,255,0.05); border-radius: 4px; border: 1px solid rgba(0,243,255,0.1); justify-content: space-between;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <input type="checkbox" :checked="visible" @change="toggleWidget(widgetId)"
                                        style="cursor: pointer;">
                                    <span x-text="getWidgetLabel(widgetId)"></span>
                                </label>
                            </div>
                        </template>
                    </div>
                </div>
                <div
                    style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,243,255,0.1); display:flex; justify-content:space-between; gap:10px;">
                    <button class="btn btn--danger" @click="resetWidgetPreferences()">Reset All</button>
                    <button class="btn btn--ghost" @click="widgetManagerOpen=false">Close</button>
                </div>
            </div>
        </div>
        <div class="modal" x-show="expandedModalOpen" :style="expandedModalOpen ? 'display:flex' : 'display:none'"
            @click.self="expandedModalOpen = false">
            <div class="modal-content" style="max-width: 1000px; height: 90vh;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0"><span class="text-cyan" x-text="expandedTitle"></span></h2>
                    <button @click="expandedModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close">√ó</button>
                </div>

                <div x-show="expandedLoading" class="spinner" style="margin: 0 auto;"></div>

                <div x-show="!expandedLoading" style="overflow-y:auto; height: calc(100% - 60px);">
                    <table class="table-fixed table-compact" style="width:100%; border-collapse:collapse;">
                        <thead style="position:sticky; top:0; background: #111; z-index:1;">
                            <tr style="border-bottom: 1px solid var(--neon-cyan);">
                                <template x-for="col in expandedColumns">
                                    <th style="padding:10px; text-align:left; color:var(--text-muted);" x-text="col">
                                    </th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(row, idx) in expandedData" :key="idx">
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <template x-for="val in row">
                                        <td style="padding:8px;" x-html="val"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="expandedData.length === 0"
                        style="padding:20px; text-align:center; color:var(--text-muted)">No data available
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Graph Modal -->
        <div class="modal" x-show="networkGraphOpen" :style="networkGraphOpen ? 'display:flex' : 'display:none'"
            @click.self="networkGraphOpen = false">
            <div class="modal-content" style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2 style="margin:0">üï∏Ô∏è Network Graph</h2>
                    <button @click="networkGraphOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close">√ó</button>
                </div>
                <div id="network-graph-container"
                    style="flex: 1; border: 1px solid rgba(0,243,255,0.2); background: rgba(0,0,0,0.5); border-radius: 4px;">
                </div>
                <div style="font-size:0.8em; color:var(--text-muted); margin-top:5px; text-align:center;">
                    <span style="color:#00f3ff">‚óè Source</span> &nbsp;
                    <span style="color:#bc13fe">‚óè Destination</span> &nbsp;
                    <span style="color:#0aff0a">‚óè Both</span>
                    &nbsp;|&nbsp; Drag to pan, Scroll to zoom, Click node to highlight
                </div>
            </div>
        </div>


        <!-- IP Detail Modal -->
        <div class="modal" x-show="modalOpen" :style="modalOpen ? 'display:flex' : 'display:none'"
            @click.self="modalOpen = false">
            <div class="modal-content">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0">
                        IP Details: <span class="text-cyan" x-text="selectedIP"></span>
                        <!-- Subtle new host indicator -->
                        <template x-if="ipDetails?.is_new">
                            <span class="host-new-indicator" title="New host (first seen within 24h)"
                                style="margin-left: 8px; font-size: 0.7em; opacity: 0.7;">üÜï</span>
                        </template>
                    </h2>
                    <button @click="modalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close details">√ó</button>
                </div>

                <div x-show="ipLoading" class="spinner" style="margin: 0 auto;"></div>

                <!-- Error State -->
                <div x-show="!ipLoading && ipDetails?.error" class="card"
                    style="text-align: center; padding: var(--space-6);">
                    <div style="font-size: 2em; margin-bottom: var(--space-2);">‚ö†Ô∏è</div>
                    <p class="text-muted" x-text="ipDetails?.error || 'Failed to load IP details'"></p>
                    <button @click="openIPModal(selectedIP)" class="btn btn-sm" style="margin-top: var(--space-3);">
                        üîÑ Retry
                    </button>
                </div>

                <div x-show="!ipLoading && ipDetails && !ipDetails.error">
                    <div class="grid">
                        <div class="card">
                            <p><strong>Hostname:</strong> <span x-text="ipDetails?.hostname || 'N/A'"></span></p>
                            <p><strong>Region:</strong> <span x-text="ipDetails?.region"></span> <span
                                    x-text="ipDetails?.geo?.city"></span></p>
                            <!-- Host memory: first seen -->
                            <template x-if="ipDetails?.first_seen">
                                <p style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary);">
                                    <strong>First Seen:</strong> <span
                                        x-text="formatFlowTimestamp(ipDetails.first_seen)"></span>
                                    <template x-if="ipDetails?.is_new">
                                        <span style="margin-left: 6px; opacity: 0.7;"
                                            title="First seen within the last 24 hours">(New)</span>
                                    </template>
                                    <template x-if="!ipDetails?.is_new">
                                        <span style="margin-left: 6px; opacity: 0.6;"
                                            title="Previously seen host">(Known)</span>
                                    </template>
                                </p>
                            </template>

                            <!-- Hardware Info (for discovered hosts) -->
                            <div x-show="ipDetails?.mac"
                                style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <p><strong>MAC Address:</strong> <span class="font-mono text-cyan"
                                        x-text="ipDetails?.mac"></span></p>
                                <p><strong>Vendor:</strong> <span class="text-muted" x-text="ipDetails?.vendor"></span>
                                </p>
                            </div>
                        </div>

                        <!-- Reputation Context -->
                        <div class="card">
                            <h4
                                style="margin-bottom: 10px; font-size: 0.95em; color: var(--text-secondary); font-weight: 500;">
                                Reputation Context</h4>

                            <!-- Geographic Context -->
                            <template x-if="ipDetails?.geo">
                                <div style="margin-bottom: 12px;">
                                    <template
                                        x-if="ipDetails.geo.country || ipDetails.geo.country_iso || ipDetails.geo.country_code">
                                        <p style="font-size: 0.9em; margin-bottom: 6px;">
                                            <strong style="color: var(--text-secondary);">Country:</strong>
                                            <span
                                                x-text="ipDetails.geo.country || ipDetails.geo.country_iso || ipDetails.geo.country_code || 'N/A'"></span>
                                            <template
                                                x-if="(ipDetails.geo.country_iso || ipDetails.geo.country_code) && (ipDetails.geo.country_iso || ipDetails.geo.country_code) !== ipDetails.geo.country">
                                                <span style="color: var(--text-secondary); opacity: 0.7;">
                                                    (<span
                                                        x-text="ipDetails.geo.country_iso || ipDetails.geo.country_code"></span>)</span>
                                            </template>
                                        </p>
                                    </template>
                                    <template x-if="ipDetails.geo.asn">
                                        <p style="font-size: 0.9em; margin-bottom: 6px;">
                                            <strong style="color: var(--text-secondary);">ASN:</strong>
                                            <span x-text="ipDetails.geo.asn"></span>
                                            <template x-if="ipDetails.geo.asn_org">
                                                <span style="color: var(--text-secondary); opacity: 0.8;"> ¬∑
                                                    <span x-text="ipDetails.geo.asn_org"></span></span>
                                            </template>
                                        </p>
                                    </template>
                                </div>
                            </template>

                            <!-- Threat List Presence (Passive, Informative) -->
                            <template x-if="ipDetails?.is_threat && ipDetails?.threat_info">
                                <div
                                    style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);">
                                    <p style="font-size: 0.9em; margin-bottom: 6px;">
                                        <strong style="color: var(--text-secondary);">Threat List:</strong>
                                        <span style="color: var(--text-primary);"
                                            x-text="ipDetails.threat_info.feed || 'Unknown'"></span>
                                    </p>
                                    <template
                                        x-if="ipDetails.threat_info.category && ipDetails.threat_info.category !== 'UNKNOWN'">
                                        <p
                                            style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.8; margin-bottom: 4px;">
                                            Category: <span x-text="ipDetails.threat_info.category"></span>
                                        </p>
                                    </template>
                                    <template x-if="ipDetails.threat_info.mitre_name">
                                        <p style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.8;">
                                            MITRE: <span x-text="ipDetails.threat_info.mitre_name"></span>
                                            <template x-if="ipDetails.threat_info.mitre_technique">
                                                <span style="opacity: 0.6;"> (<span
                                                        x-text="ipDetails.threat_info.mitre_technique"></span>)</span>
                                            </template>
                                        </p>
                                    </template>
                                </div>
                            </template>

                            <!-- No threat list presence -->
                            <template x-if="!ipDetails?.is_threat">
                                <div
                                    style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);">
                                    <p
                                        style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.7; font-style: italic;">
                                        Not present in known threat lists
                                    </p>
                                </div>
                            </template>
                        </div>
                        <div class="card">
                            <p>‚¨ÜÔ∏è Upload: <strong class="text-green"
                                    x-text="fmtBytes(ipDetails?.direction?.upload || 0)"></strong></p>
                            <p>‚¨áÔ∏è Download: <strong class="text-green"
                                    x-text="fmtBytes(ipDetails?.direction?.download || 0)"></strong></p>
                        </div>
                    </div>

                    <!-- Activity Timeline -->
                    <div x-show="ipDetails?.timeline && (ipDetails.timeline.labels?.length > 0 || ipDetails.timeline.loading)"
                        style="margin-top: 20px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; font-size: 0.95em; color: var(--text-secondary);">
                            Activity
                            Timeline (24h)</h3>
                        <div
                            style="position: relative; height: 120px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; padding: 8px;">
                            <div x-show="ipDetails?.timeline?.loading" class="spinner" style="margin: 40px auto;">
                            </div>
                            <canvas
                                x-show="ipDetails?.timeline && !ipDetails.timeline.loading && ipDetails.timeline.labels?.length > 0"
                                id="hostDetailTimelineChart"></canvas>
                            <div x-show="ipDetails?.timeline && !ipDetails.timeline.loading && (!ipDetails.timeline.labels || ipDetails.timeline.labels.length === 0)"
                                style="text-align: center; padding: 40px; color: var(--text-secondary); font-size: 0.9em;">
                                No activity data available
                            </div>
                        </div>
                    </div>

                    <h3>Ports & Protocols</h3>
                    <div class="grid">
                        <div class="card">
                            <h4>Src Ports</h4>
                            <template x-for="p in ipDetails?.src_ports">
                                <div style="font-size:0.9em; margin-bottom:4px;">
                                    <span class="text-cyan" x-text="p.key"></span> (<span x-text="p.service"></span>):
                                    <span x-text="fmtBytes(p.bytes)"></span>
                                </div>
                            </template>
                        </div>
                        <div class="card">
                            <h4>Dst Ports</h4>
                            <template x-for="p in ipDetails?.dst_ports">
                                <div style="font-size:0.9em; margin-bottom:4px;">
                                    <span class="text-cyan" x-text="p.key"></span> (<span x-text="p.service"></span>):
                                    <span x-text="fmtBytes(p.bytes)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IP Deep Dive Investigation Modal -->
        <div class="modal" x-show="ipInvestigationModalOpen"
            :style="ipInvestigationModalOpen ? 'display:flex' : 'display:none'"
            @click.self="ipInvestigationModalOpen = false">
            <div class="modal-content"
                style="max-width: 1200px; width: 90vw; height: 85vh; display: flex; flex-direction: column;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0">üîç IP Deep Dive Investigation: <span class="text-cyan"
                            x-text="ipInvestigation.searchIP || 'Enter IP address'"></span></h2>
                    <button @click="ipInvestigationModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close IP investigation">√ó</button>
                </div>

                <div class="ip-investigation-content"
                    style="flex: 1; overflow-y: auto; padding: 0 var(--space-4) var(--space-4);">
                    <!-- Loading State -->
                    <div x-show="ipInvestigation.loading" style="text-align: center; padding: 60px 20px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p style="color: var(--text-secondary);">Investigating IP address...</p>
                        <p style="color: var(--text-tertiary); font-size: var(--text-xs); margin-top: var(--space-2);">
                            This may take a few seconds...</p>
                    </div>

                    <!-- Error State -->
                    <div x-show="ipInvestigation.error && !ipInvestigation.loading"
                        style="padding: var(--space-4); background: rgba(255, 0, 60, 0.1); border: 1px solid rgba(255, 0, 60, 0.3); border-radius: var(--radius-md); margin: var(--space-4) 0;">
                        <div style="display: flex; align-items: flex-start; gap: var(--space-2);">
                            <div style="font-size: 20px;">‚ö†Ô∏è</div>
                            <div style="flex: 1;">
                                <strong
                                    style="color: var(--neon-red); display: block; margin-bottom: var(--space-1);">Investigation
                                    Failed</strong>
                                <p style="color: var(--text-secondary); font-size: var(--text-sm); margin: 0 0 var(--space-3) 0;"
                                    x-text="ipInvestigation.error"></p>
                                <button @click="investigateIP()" class="btn btn--secondary"
                                    style="font-size: var(--text-sm);">Retry Investigation</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div x-show="!ipInvestigation.loading && ipInvestigation.result">
                        <!-- Quick Stats Cards -->
                        <div class="grid"
                            style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                            <div class="card" style="padding: var(--space-4);">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Classification</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    :class="ipInvestigation.result?.classification === 'Internal' ? 'text-green' : 'text-cyan'"
                                    x-text="ipInvestigation.result?.classification || 'N/A'"></div>
                            </div>
                            <div class="card" style="padding: var(--space-4);">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Threat Status</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    :class="ipInvestigation.result?.is_threat ? 'text-red' : 'text-green'"
                                    x-text="ipInvestigation.result?.is_threat ? '‚ö†Ô∏è THREAT' : '‚úÖ Clean'">
                                </div>
                            </div>
                            <div class="card" style="padding: var(--space-4);">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Total Traffic</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    class="text-cyan" x-text="ipInvestigation.result?.total_bytes_fmt || 'N/A'">
                                </div>
                            </div>
                            <div class="card" style="padding: var(--space-4);"
                                x-show="ipInvestigation.result?.flow_count !== undefined">
                                <div
                                    style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-2);">
                                    Total Flows</div>
                                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-semibold);"
                                    class="text-cyan"
                                    x-text="(ipInvestigation.result?.flow_count || 0).toLocaleString()">
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Information Grid -->
                        <div class="grid"
                            style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                            <div class="card">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    Geographic Information</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                    <div>
                                        <strong style="color: var(--text-secondary);">Country:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.country || ipInvestigation.result?.country || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Region:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.region || ipInvestigation.result?.geo?.region || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">City:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.city || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">ASN:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.asn || ipInvestigation.result?.asn || 'N/A'"></span>
                                    </div>
                                    <div x-show="ipInvestigation.result?.geo?.org">
                                        <strong style="color: var(--text-secondary);">Organization:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.geo?.org"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    Activity Summary</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                    <div>
                                        <strong style="color: var(--text-secondary);">Hostname:</strong>
                                        <span style="margin-left: var(--space-2); font-family: var(--font-mono);"
                                            x-text="ipInvestigation.result?.hostname || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Classification:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            :class="ipInvestigation.result?.classification === 'Internal' ? 'text-green' : 'text-cyan'"
                                            x-text="ipInvestigation.result?.classification || (ipInvestigation.result?.internal ? 'Internal' : 'External')"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Total
                                            Traffic:</strong>
                                        <span style="margin-left: var(--space-2);" class="text-cyan"
                                            x-text="ipInvestigation.result?.total_bytes_fmt || 'N/A'"></span>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-secondary);">Total Flows:</strong>
                                        <span style="margin-left: var(--space-2);"
                                            x-text="ipInvestigation.result?.flow_count || 0"></span>
                                    </div>
                                </div>
                            </div>
                            <!-- Network Activity Card -->
                            <div class="card"
                                x-show="ipInvestigation.result?.src_ports?.length || ipInvestigation.result?.dst_ports?.length || ipInvestigation.result?.protocols?.length">
                                <h4
                                    style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    Network Activity</h4>
                                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                    <div x-show="ipInvestigation.result?.protocols?.length">
                                        <strong
                                            style="color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">Top
                                            Protocols:</strong>
                                        <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                                            <template
                                                x-for="(proto, idx) in (ipInvestigation.result?.protocols || []).slice(0, 5)"
                                                :key="idx">
                                                <span class="badge"
                                                    style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                                    x-text="proto.proto_name || proto.key"></span>
                                            </template>
                                        </div>
                                    </div>
                                    <div
                                        x-show="ipInvestigation.result?.src_ports?.length || ipInvestigation.result?.dst_ports?.length">
                                        <strong
                                            style="color: var(--text-secondary); display: block; margin-bottom: var(--space-2);">Active
                                            Ports:</strong>
                                        <div style="font-size: var(--text-sm); color: var(--text-secondary);"
                                            x-text="((ipInvestigation.result?.src_ports?.length || 0) + (ipInvestigation.result?.dst_ports?.length || 0)) + ' ports'">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Timeline -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.timeline.labels && ipInvestigation.timeline.labels.length > 0">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                                <h4
                                    style="margin: 0; font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                    üìà Activity Timeline</h4>
                                <label
                                    style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); cursor: pointer;">
                                    <input type="checkbox" x-model="ipInvestigation.timeline.compareHistory"
                                        @change="loadIPTimeline(ipInvestigation.searchIP)" style="cursor: pointer;">
                                    <span>Compare with previous period</span>
                                </label>
                            </div>
                            <div class="chart-wrapper" style="height: 250px;">
                                <canvas id="ipInvestigationTimelineChart"></canvas>
                            </div>
                            <p
                                style="margin-top: var(--space-2); font-size: var(--text-xs); color: var(--text-muted); text-align: center;">
                                Traffic patterns over the selected time range (bytes and flow counts)
                                <span x-show="ipInvestigation.timeline.compareHistory"> ‚Ä¢ Dashed lines show
                                    previous
                                    period</span>
                            </p>
                        </div>

                        <!-- Threat Intelligence -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.result?.threat_intel?.enabled">
                            <h4
                                style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                üõ°Ô∏è Threat Intelligence</h4>
                            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                <!-- VirusTotal -->
                                <div x-show="ipInvestigation.result?.threat_intel?.virustotal">
                                    <div
                                        style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <strong style="color: var(--text-secondary);">VirusTotal:</strong>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'found'"
                                            class="badge"
                                            :class="(ipInvestigation.result?.threat_intel?.virustotal?.malicious || 0) > 0 ? 'badge--danger' : 'badge--success'"
                                            x-text="(ipInvestigation.result?.threat_intel?.virustotal?.malicious || 0) + ' malicious'"></span>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'rate_limited'"
                                            class="badge badge--warning" x-text="'Rate Limited'"></span>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'not_found'"
                                            class="badge" x-text="'Not Found'"></span>
                                    </div>
                                    <div x-show="ipInvestigation.result?.threat_intel?.virustotal?.status === 'found'"
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-left: var(--space-4);">
                                        <div>Reputation: <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.reputation || 0"></span>
                                        </div>
                                        <div>Harmless: <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.harmless || 0"></span>
                                            ‚Ä¢ Suspicious: <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.suspicious || 0"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.virustotal?.as_owner">
                                            AS
                                            Owner:
                                            <span
                                                x-text="ipInvestigation.result?.threat_intel?.virustotal?.as_owner"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- AbuseIPDB -->
                                <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb">
                                    <div
                                        style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                        <strong style="color: var(--text-secondary);">AbuseIPDB:</strong>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'found'"
                                            class="badge"
                                            :class="(ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) > 50 ? 'badge--danger' : (ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) > 25 ? 'badge--warning' : 'badge--success'"
                                            x-text="'Confidence: ' + (ipInvestigation.result?.threat_intel?.abuseipdb?.abuse_confidence_score || 0) + '%'"></span>
                                        <span
                                            x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'rate_limited'"
                                            class="badge badge--warning" x-text="'Rate Limited'"></span>
                                    </div>
                                    <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.status === 'found'"
                                        style="font-size: var(--text-sm); color: var(--text-secondary); margin-left: var(--space-4);">
                                        <div>Reports: <span
                                                x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.num_reports || 0"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.usage_type">
                                            Usage:
                                            <span
                                                x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.usage_type"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.isp">
                                            ISP:
                                            <span x-text="ipInvestigation.result?.threat_intel?.abuseipdb?.isp"></span>
                                        </div>
                                        <div x-show="ipInvestigation.result?.threat_intel?.abuseipdb?.is_known_attacker"
                                            class="badge badge--danger" style="margin-top: var(--space-1);">
                                            Known
                                            Attacker</div>
                                    </div>
                                </div>
                                <div x-show="!ipInvestigation.result?.threat_intel?.enabled"
                                    style="font-size: var(--text-xs); color: var(--text-muted);">
                                    Threat intelligence APIs not configured. Set VIRUSTOTAL_API_KEY and/or
                                    ABUSEIPDB_API_KEY environment variables to enable.
                                </div>
                            </div>
                        </div>

                        <!-- Anomaly Detection -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.result?.anomalies && ipInvestigation.result.anomalies.length > 0">
                            <h4
                                style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                ‚ö†Ô∏è Detected Anomalies</h4>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <template x-for="(anomaly, idx) in ipInvestigation.result?.anomalies || []" :key="idx">
                                    <div style="padding: var(--space-3); background: rgba(255, 152, 0, 0.1); border-left: 3px solid rgba(255, 152, 0, 0.8); border-radius: var(--radius-sm);"
                                        :style="anomaly.severity === 'high' ? 'background: rgba(255, 0, 60, 0.1); border-left-color: rgba(255, 0, 60, 0.8);' : anomaly.severity === 'medium' ? 'background: rgba(255, 152, 0, 0.1); border-left-color: rgba(255, 152, 0, 0.8);' : 'background: rgba(100, 181, 246, 0.1); border-left-color: rgba(100, 181, 246, 0.8);'">
                                        <div
                                            style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                            <span class="badge"
                                                :class="anomaly.severity === 'high' ? 'badge--danger' : anomaly.severity === 'medium' ? 'badge--warning' : 'badge--info'"
                                                x-text="anomaly.severity.toUpperCase()"></span>
                                            <strong style="color: var(--text-primary);"
                                                x-text="anomaly.message"></strong>
                                        </div>
                                        <div x-show="anomaly.port_count"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Port Count: <span x-text="anomaly.port_count"></span>
                                        </div>
                                        <div x-show="anomaly.ports"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Ports: <span x-text="anomaly.ports.join(', ')"></span>
                                        </div>
                                        <div x-show="anomaly.ratio"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Ratio: <span x-text="anomaly.ratio + ':1'"></span> (Upload:
                                            <span x-text="anomaly.upload_mb + ' MB'"></span>, Download:
                                            <span x-text="anomaly.download_mb + ' MB'"></span>)
                                        </div>
                                        <div x-show="anomaly.total_mb"
                                            style="font-size: var(--text-sm); color: var(--text-secondary);">
                                            Total Traffic: <span x-text="anomaly.total_mb + ' MB'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Related IPs -->
                        <div class="card" style="margin-bottom: var(--space-6);"
                            x-show="ipInvestigation.result?.related_ips && ipInvestigation.result.related_ips.length > 0">
                            <h4
                                style="margin-top: 0; margin-bottom: var(--space-4); font-size: var(--text-lg); font-weight: var(--font-weight-semibold);">
                                üîó Related IPs</h4>
                            <p
                                style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3);">
                                IPs that directly communicate with this IP (as source or destination)
                            </p>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <template
                                    x-for="(related, idx) in (ipInvestigation.result?.related_ips || []).slice(0, 10)"
                                    :key="idx">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-2) var(--space-3); background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border-left: 3px solid var(--neon-cyan);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div
                                                style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                                <span class="text-cyan"
                                                    style="font-family: var(--font-mono); font-weight: var(--font-weight-semibold); cursor: pointer;"
                                                    @click="openIPInvestigationModal(related.ip)" x-text="related.ip"
                                                    title="Click to investigate this IP"></span>
                                                <span class="badge"
                                                    style="background: rgba(0,243,255,0.15); color: var(--neon-cyan); font-size: var(--text-xs);"
                                                    x-text="related.type === 'destination' ? 'Destination' : 'Source'"></span>
                                                <span x-show="related.country_code"
                                                    x-text="flagFromIso(related.country_code)"
                                                    style="font-size: 16px;"></span>
                                            </div>
                                            <div style="font-size: var(--text-xs); color: var(--text-muted);">
                                                <span x-text="fmtBytes(related.bytes)"></span>
                                                <span style="margin: 0 var(--space-1);">‚Ä¢</span>
                                                <span x-text="related.count + ' flows'"></span>
                                                <span x-show="related.country" style="margin-left: var(--space-2);"
                                                    x-text="related.country"></span>
                                            </div>
                                        </div>
                                        <button @click="openIPInvestigationModal(related.ip)" class="btn btn--secondary"
                                            style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2); white-space: nowrap;">
                                            Investigate
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Export Actions -->
                        <div
                            style="display: flex; gap: var(--space-3); margin-bottom: var(--space-6); flex-wrap: wrap;">
                            <button @click="exportInvestigationResults('json')" class="btn btn--secondary"
                                :disabled="!ipInvestigation.result">
                                üì• Export JSON
                            </button>
                            <button @click="exportInvestigationResults('csv')" class="btn btn--secondary"
                                :disabled="!ipInvestigation.result">
                                üì• Export CSV
                            </button>
                            <button @click="copyInvestigationIP()" class="btn btn--secondary"
                                :disabled="!ipInvestigation.searchIP">
                                üìã Copy IP
                            </button>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!ipInvestigation.loading && !ipInvestigation.result"
                        style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: var(--space-4);" aria-hidden="true">üîç
                        </div>
                        <p style="font-size: var(--text-lg); margin-bottom: var(--space-2);">Enter an IP
                            address to
                            begin investigation</p>
                        <p style="font-size: var(--text-sm); color: var(--text-tertiary);">Use the search
                            bar at the
                            top
                            of the Firewall page</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal" x-show="alertHistoryOpen" :style="alertHistoryOpen ? 'display:flex' : 'display:none'"
            @click.self="alertHistoryOpen = false">
            <div class="modal-content" style="max-width: 900px; width: 90vw;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="margin:0">üîî Current Alerts</h2>
                    <button @click="alertHistoryOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red)"
                        aria-label="Close alerts">√ó</button>
                </div>

                <div
                    style="display:flex; justify-content:space-between; align-items:center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                    <div class="text-muted" style="font-size: 0.9em;">
                        <span x-text="activeAlertsCount.toLocaleString()"></span>
                        <span x-text="activeAlertsCount === 1 ? ' active alert' : ' active alerts'"></span>
                    </div>
                    <div style="display:flex; gap: 8px; align-items:center;">
                        <button class="btn btn--ghost btn--sm" @click="fetchAlertHistory()">Refresh</button>
                        <button class="btn btn--danger btn--sm" @click="dismissAllAlerts()"
                            :disabled="activeAlertsCount === 0">Dismiss all</button>
                    </div>
                </div>

                <div class="alert-filters" style="margin-bottom: 12px;">
                    <select x-model="alertFilter.severity" class="filter-select" aria-label="Filter alerts by severity">
                        <option value="all">All Severities</option>
                        <option value="critical">üî¥ Critical</option>
                        <option value="high">üü† High</option>
                        <option value="medium">üü° Medium</option>
                        <option value="low">üü¢ Low</option>
                    </select>
                    <select x-model="alertFilter.type" class="filter-select" aria-label="Filter alerts by type">
                        <option value="all">All Types</option>
                        <template x-for="t in alertTypes.filter(x => x !== 'all')" :key="t">
                            <option :value="t" x-text="t"></option>
                        </template>
                    </select>
                </div>

                <div x-show="alertHistory.loading" class="spinner" style="margin: 20px auto;"></div>

                <div class="alert-list" x-show="!alertHistory.loading">
                    <template x-for="(a, idx) in filteredAlerts.slice(0, 50)" :key="idx">
                        <div class="alert-row" :class="'severity-row-' + a.severity" style="gap: 12px;">
                            <div class="alert-time" x-text="a.time_ago"></div>
                            <div class="alert-info" style="display:flex; align-items:center; gap: 10px; min-width: 0;">
                                <span class="alert-type-badge"
                                    :class="'cat-' + (a.category || a.type || 'unknown').toLowerCase()"
                                    x-text="a.type || 'alert'"></span>
                                <span class="alert-msg" :title="a.msg" x-text="a.msg"></span>
                            </div>
                            <div style="display:flex; align-items:center; gap: 10px;">
                                <div class="alert-severity" :class="'sev-' + a.severity" x-text="a.severity"></div>
                                <button class="btn btn--ghost btn--sm" @click="dismissAlert(a)">Dismiss</button>
                            </div>
                        </div>
                    </template>

                    <template x-if="filteredAlerts.length === 0">
                        <div class="alert-empty" x-text="'‚úÖ No active alerts'"></div>
                    </template>
                </div>
            </div>
        </div>

        <!-- App Logic already loaded in <head> to ensure Alpine picks it up -->

        <!-- Mobile More Menu Modal -->
        <div class="modal" x-show="mobileMoreModalOpen" :style="mobileMoreModalOpen ? 'display:flex' : 'display:none'"
            @click.self="mobileMoreModalOpen = false">
            <div class="modal-content" style="max-width: 100%;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:var(--text-0);">More Navigation</h3>
                    <button @click="mobileMoreModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                        aria-label="Close">√ó</button>
                </div>
                <div class="modal__body" style="color:var(--text-0);">
                    <div class="grid grid-2" style="gap: var(--space-3);">
                        <button class="btn btn--secondary" :class="{ 'active': activeTab === 'server' }"
                            @click="loadTab('server'); mobileMoreModalOpen = false"
                            style="justify-content: flex-start; gap: 12px; height: 60px;">
                            <span style="font-size: 1.5em;">üñ•Ô∏è</span>
                            <span>Server Health</span>
                        </button>
                        <button class="btn btn--secondary" :class="{ 'active': activeTab === 'hosts' }"
                            @click="loadTab('hosts'); mobileMoreModalOpen = false"
                            style="justify-content: flex-start; gap: 12px; height: 60px;">
                            <span style="font-size: 1.5em;">üñ•Ô∏è</span>
                            <span>Hosts</span>
                        </button>
                        <button class="btn btn--secondary" :class="{ 'active': activeTab === 'firewall' }"
                            @click="loadTab('firewall'); mobileMoreModalOpen = false"
                            style="justify-content: flex-start; gap: 12px; height: 60px;">
                            <span style="font-size: 1.5em;">üî•</span>
                            <span>Firewall Logs</span>
                        </button>
                        <button class="btn btn--secondary" :class="{ 'active': activeTab === 'firewall-snmp' }"
                            @click="loadTab('firewall-snmp'); mobileMoreModalOpen = false"
                            style="justify-content: flex-start; gap: 12px; height: 60px;">
                            <span style="font-size: 1.5em;">üì°</span>
                            <span>Interfaces</span>
                        </button>
                    </div>
                </div>
                <div class="modal__footer"
                    style="display:flex; justify-content:flex-end; gap:10px; margin-top:var(--space-4);">
                    <button class="btn btn--primary" @click="mobileMoreModalOpen = false"
                        style="min-height:44px;">Close</button>
                </div>
            </div>
        </div>

        <!-- Overall Health Details Modal -->
        <div class="modal" x-show="overallHealthModalOpen"
            :style="overallHealthModalOpen ? 'display:flex' : 'display:none'"
            @click.self="overallHealthModalOpen = false">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:var(--text-0);">Overall Health Details</h3>
                    <button @click="overallHealthModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                        aria-label="Close">√ó</button>
                </div>
                <div class="modal__body" style="color:var(--text-0);">
                    <div style="margin-bottom:var(--space-4);">
                        <div
                            style="display:flex; align-items:center; gap:var(--space-3); margin-bottom:var(--space-3);">
                            <div style="font-size:var(--text-2xl); font-weight:var(--font-weight-semibold); text-transform:capitalize;"
                                :class="{
                                    'text-green': overallHealth.state === 'healthy',
                                    'text-yellow': overallHealth.state === 'degraded',
                                    'text-red': overallHealth.state === 'unhealthy'
                                }"
                                x-text="overallHealth.state === 'healthy' ? 'Healthy' : overallHealth.state === 'degraded' ? 'Degraded' : 'Unhealthy'">
                            </div>
                            <div style="flex:1; height:2px; background:var(--border-soft);"></div>
                        </div>
                        <p style="font-size:var(--text-base); line-height:var(--line-height-normal); color:var(--text-1); margin:0;"
                            x-text="overallHealth.explanation || 'All systems operating normally.'">
                        </p>
                    </div>

                    <div style="border-top:1px solid var(--border-soft); padding-top:var(--space-4);">
                        <h4
                            style="font-size:var(--text-sm); color:var(--text-secondary); text-transform:uppercase; letter-spacing:var(--letter-spacing-wide); margin-bottom:var(--space-3);">
                            Current Metrics
                        </h4>
                        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:var(--space-3);">
                            <div>
                                <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Active Alerts</div>
                                <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                    x-text="activeAlertsCount || 0">
                                </div>
                            </div>
                            <div>
                                <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Active Flows</div>
                                <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                    x-text="(networkStatsOverview.active_flows || 0).toLocaleString()">
                                </div>
                            </div>
                            <div>
                                <div style="font-size:var(--text-xs); color:var(--text-tertiary);">External Connections
                                </div>
                                <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                    x-text="(networkStatsOverview.external_connections || 0).toLocaleString()">
                                </div>
                            </div>
                            <div>
                                <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Blocked Events (24h)
                                </div>
                                <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                    x-text="(firewallStatsOverview.blocked_events_24h || 0).toLocaleString()">
                                </div>
                            </div>
                            <div>
                                <div style="font-size:var(--text-xs); color:var(--text-tertiary);">Network Anomalies
                                    (24h)
                                </div>
                                <div style="font-size:var(--text-lg); font-weight:var(--font-weight-semibold); color:var(--text-0);"
                                    x-text="(networkStatsOverview.anomalies_24h || 0).toLocaleString()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal__footer"
                    style="display:flex; justify-content:flex-end; gap:10px; margin-top:var(--space-4);">
                    <button class="btn btn--primary" @click="overallHealthModalOpen = false">Close</button>
                </div>
            </div>
        </div>

        <!-- Mobile Controls Modal -->
        <div class="modal" x-show="mobileControlsModalOpen"
            :style="mobileControlsModalOpen ? 'display:flex' : 'display:none'"
            @click.self="mobileControlsModalOpen = false">
            <div class="modal-content" style="max-width: 100%;">
                <div class="modal__header"
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:var(--text-0);">Controls</h3>
                    <button @click="mobileControlsModalOpen = false"
                        style="background:transparent; border:none; font-size:1.5em; color:var(--neon-red); cursor:pointer;"
                        aria-label="Close">√ó</button>
                </div>
                <div class="modal__body" style="color:var(--text-0);">
                    <!-- Search -->
                    <div style="margin-bottom:var(--space-4);">
                        <label
                            style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Search
                            UI</label>
                        <div class="search-wrapper" style="width:100%;">
                            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" x-model="searchQuery" placeholder="Search UI" class="global-search"
                                aria-label="Search UI" style="width:100%;">
                        </div>
                    </div>

                    <!-- Time Range -->
                    <div style="margin-bottom:var(--space-4);">
                        <label
                            style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Time
                            Range</label>
                        <select x-model="timeRange" class="header-select" aria-label="Time Range"
                            style="width:100%; min-height:44px;">
                            <option value="15m">15m</option>
                            <option value="30m">30m</option>
                            <option value="1h">1h</option>
                            <option value="6h">6h</option>
                            <option value="24h">24h</option>
                            <option value="7d">7d</option>
                        </select>
                    </div>

                    <!-- Refresh Interval -->
                    <div style="margin-bottom:var(--space-4);">
                        <label
                            style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Refresh
                            Interval</label>
                        <select x-model="refreshInterval" class="header-select" aria-label="Refresh Interval"
                            style="width:100%; min-height:44px;">
                            <option value="10000">10s</option>
                            <option value="30000">30s</option>
                            <option value="60000">1m</option>
                            <option value="300000">5m</option>
                        </select>
                    </div>

                    <!-- Live Controls -->
                    <div style="margin-bottom:var(--space-4);">
                        <label
                            style="display:block; font-size:var(--text-sm); color:var(--text-secondary); margin-bottom:var(--space-2);">Auto-Refresh</label>
                        <div style="display:flex; gap:var(--space-3); align-items:center;">
                            <button class="btn" :class="{ 'paused': paused }" @click="togglePause()"
                                style="flex:1; min-height:44px;" title="Toggle auto-refresh pause"
                                :title="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'"
                                :aria-label="paused ? 'Resume auto-refresh' : 'Pause auto-refresh'">
                                <template x-if="!paused">
                                    <span>‚è∏ Pause</span>
                                </template>
                                <template x-if="paused">
                                    <span>‚ñ∂ Resume</span>
                                </template>
                            </button>
                            <button class="btn" @click="dataRefresh(); mobileControlsModalOpen = false"
                                style="flex:1; min-height:44px;" title="Refresh" aria-label="Refresh">
                                <span>üîÑ Refresh Now</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal__footer"
                    style="display:flex; justify-content:flex-end; gap:10px; margin-top:var(--space-4);">
                    <button class="btn btn--primary" @click="mobileControlsModalOpen = false"
                        style="min-height:44px;">Close</button>
                </div>
            </div>
        </div>
    </div> <!-- End container -->
</body>

</html>