{% from "components/panel_card.html" import panel_card %}
<div x-show="activeTab === 'hosts'" :style="activeTab === 'hosts' ? 'display:block' : 'display:none'" id="hosts-tab"
    class="fade-in" role="tabpanel" aria-labelledby="hosts-tab-btn" tabindex="0">

    <!-- Hosts Top Stats -->
    <section id="section-hosts-stats" class="mb-6">
        <div class="grid grid-auto-fit gap-4" style="margin-bottom: var(--space-6) !important;">
            <!-- Total Hosts -->
            <div class="card stat-box">
                <div class="value" x-text="hosts.loading ? '...' : (hosts.stats.total_hosts || 0).toLocaleString()">
                    ...</div>
                <div class="label">TOTAL HOSTS 24H</div>
            </div>
            <!-- Active Hosts -->
            <div class="card stat-box">
                <div class="value" x-text="hosts.loading ? '...' : (hosts.stats.active_hosts || 0).toLocaleString()">
                    ...</div>
                <div class="label">ACTIVE HOSTS (currently)</div>
            </div>
            <!-- New Hosts -->
            <div class="card stat-box">
                <div class="value" x-text="hosts.loading ? '...' : hosts.stats.new_hosts">...</div>
                <div class="label">NEW HOSTS (last hour)</div>
            </div>
            <!-- Anomalies -->
            <div class="card stat-box">
                <div class="value" :class="{'text-red': hosts.stats.anomalies > 0}"
                    x-text="hosts.loading ? '...' : (hosts.stats.anomalies || 0).toLocaleString()">
                    ...</div>
                <div class="label">Hosts with Anomalies</div>
            </div>
        </div>
    </section>

    <!-- What Changed -->
    <section id="section-hosts-changes" class="mb-6">
        {% call panel_card(title='WHAT CHANGED (LAST HOUR VS 24H BASELINE)', tier='signal') %}
        <div class="text-xs text-muted" style="margin-bottom: 20px; opacity: 0.8;">
            Ratio is last hour vs average hour across the last 24h.
        </div>
        <div class="grid grid-auto-fit gap-4">
            <div class="card" style="background: rgba(255,255,255,0.01); border: 1px solid var(--border-soft);">
                <div class="column-header">Ports & Services</div>
                <div x-show="hosts.changes.loading" class="spinner" style="margin: 16px auto;"></div>
                <template x-if="!hosts.changes.loading && hosts.changes.ports && hosts.changes.ports.length > 0">
                    <div class="flex flex-col gap-2">
                        <template x-for="item in hosts.changes.ports" :key="item.label">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-xs" x-text="item.label"></span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-muted" x-text="item.bytes_fmt"></span>
                                    <span class="badge badge-outline" x-text="formatHostDeltaRatio(item)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                <div x-show="!hosts.changes.loading && (!hosts.changes.ports || hosts.changes.ports.length === 0)"
                    class="text-xs text-muted">No data</div>
            </div>
            <div class="card" style="background: rgba(255,255,255,0.01); border: 1px solid var(--border-soft);">
                <div class="column-header">Countries</div>
                <div x-show="hosts.changes.loading" class="spinner" style="margin: 16px auto;"></div>
                <template
                    x-if="!hosts.changes.loading && hosts.changes.countries && hosts.changes.countries.length > 0">
                    <div class="flex flex-col gap-2">
                        <template x-for="item in hosts.changes.countries" :key="item.label">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-xs" x-text="item.label"></span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-muted" x-text="item.bytes_fmt"></span>
                                    <span class="badge badge-outline" x-text="formatHostDeltaRatio(item)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                <div x-show="!hosts.changes.loading && (!hosts.changes.countries || hosts.changes.countries.length === 0)"
                    class="text-xs text-muted">No data</div>
            </div>
            <div class="card" style="background: rgba(255,255,255,0.01); border: 1px solid var(--border-soft);">
                <div class="column-header">ASNs</div>
                <div x-show="hosts.changes.loading" class="spinner" style="margin: 16px auto;"></div>
                <template x-if="!hosts.changes.loading && hosts.changes.asns && hosts.changes.asns.length > 0">
                    <div class="flex flex-col gap-2">
                        <template x-for="item in hosts.changes.asns" :key="item.label">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-xs" x-text="item.label"></span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-muted" x-text="item.bytes_fmt"></span>
                                    <span class="badge badge-outline" x-text="formatHostDeltaRatio(item)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                <div x-show="!hosts.changes.loading && (!hosts.changes.asns || hosts.changes.asns.length === 0)"
                    class="text-xs text-muted">No data</div>
            </div>
        </div>
        {% endcall %}
    </section>

    <!-- Hosts Table -->
    <section id="section-hosts-list" class="scroll-section">
        {% call widget_card('hosts', 'Network Hosts', 'üñ•Ô∏è', card_class='wide-card',
        show_spinner=True, extra_actions='
        <div class="flex gap-2">
            <button class="btn btn-sm" :class="hosts.viewMode === \'observed\' ? \'btn-primary\' : \'btn-ghost\'"
                @click="switchHostsView(\'observed\')">Observed</button>
            <button class="btn btn-sm" :class="hosts.viewMode === \'discovered\' ? \'btn-primary\' : \'btn-ghost\'"
                @click="switchHostsView(\'discovered\')">Discovered</button>
        </div>
        ') %}

        <!-- Discovery Controls -->
        <div x-show="hosts.viewMode === 'discovered'"
            class="mb-4 p-4 border rounded border-gray-700 bg-gray-900 bg-opacity-50">
            <div class="flex items-end gap-4">
                <div class="form-control w-full max-w-xs">
                    <label class="label" for="discovery-target-subnet">
                        <span class="label-text">Target Subnet</span>
                    </label>
                    <select id="discovery-target-subnet" class="cyber-input w-full" x-model="hosts.discovery.target"
                        aria-label="Target Subnet">
                        <option value="" disabled selected>Select subnet</option>
                        <template x-for="net in hosts.discovery.subnets" :key="net.cidr">
                            <option :value="net.cidr" x-text="net.interface + ' - ' + net.cidr">
                            </option>
                        </template>
                        <option value="custom">Custom...</option>
                    </select>
                </div>
                <div class="form-control w-full max-w-xs" x-show="hosts.discovery.target === 'custom'">
                    <label class="label" for="discovery-custom-cidr">
                        <span class="label-text">Custom CIDR</span>
                    </label>
                    <input id="discovery-custom-cidr" type="text" x-model="hosts.discovery.target" placeholder="192.168.1.0/24"
                        class="cyber-input w-full" />
                </div>

                <button class="btn btn-sm btn-primary" @click="runDiscoveryScan()"
                    :disabled="hosts.discovery.loading || !hosts.discovery.target">
                    <span x-show="hosts.discovery.loading" class="loading loading-spinner text-primary"></span>
                    <span x-show="!hosts.discovery.loading">Scan Network</span>
                </button>
            </div>
            <div x-show="hosts.discovery.error" class="text-error text-sm mt-2" x-text="hosts.discovery.error"></div>
            <div x-show="hosts.discovery.results" class="text-success text-sm mt-2">
                Last scan: <span x-text="new Date(hosts.discovery.results?.scanned_at).toLocaleTimeString()"></span>
                - Found <span x-text="hosts.discovery.results?.count"></span> hosts
            </div>
        </div>

        <!-- Observed Hosts Table -->
        <div x-show="hosts.viewMode === 'observed'">
            <div x-show="!hosts.loading && (!hosts.list || hosts.list.length === 0)" class="empty-state">
                <div style="font-size: 32px; margin-bottom: var(--space-2);">üîç</div>
                <p>No hosts observed in the selected time range.</p>
            </div>

            <div x-show="!hosts.loading && hosts.list && hosts.list.length > 0 && filteredHosts.length === 0"
                class="empty-state" style="margin-top: var(--space-4);">
                <div style="font-size: 32px; margin-bottom: var(--space-2);">üßπ</div>
                <p>No hosts match the current filters.</p>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-3 mb-4"
                x-show="hosts.list && hosts.list.length > 0">
                <div class="flex flex-wrap items-center gap-2">
                    <input class="cyber-input" style="min-width: 200px;" placeholder="Search IP, tag, owner..."
                        x-model="hosts.filters.search" />
                    <select class="cyber-input" x-model="hosts.filters.owner">
                        <option value="">Owner</option>
                        <template x-for="owner in hostOwnerOptions" :key="owner">
                            <option :value="owner" x-text="owner"></option>
                        </template>
                    </select>
                    <select class="cyber-input" x-model="hosts.filters.device_type">
                        <option value="">Device Type</option>
                        <template x-for="device in hostDeviceTypeOptions" :key="device">
                            <option :value="device" x-text="device"></option>
                        </template>
                    </select>
                    <select class="cyber-input" x-model="hosts.filters.criticality">
                        <option value="">Criticality</option>
                        <template x-for="level in hostCriticalityOptions" :key="level">
                            <option :value="level" x-text="level"></option>
                        </template>
                    </select>
                    <select class="cyber-input" x-model="hosts.filters.tag">
                        <option value="">Tag</option>
                        <template x-for="tag in hostTagOptions" :key="tag">
                            <option :value="tag" x-text="tag"></option>
                        </template>
                    </select>
                    <select class="cyber-input" x-model="hosts.filters.type">
                        <option value="all">All</option>
                        <option value="internal">Internal</option>
                        <option value="external">External</option>
                    </select>
                    <label class="flex items-center gap-2 text-sm text-muted">
                        <input type="checkbox" class="checkbox checkbox-xs" x-model="hosts.filters.newOnly" />
                        New only
                    </label>
                    <button class="btn btn-sm btn-ghost" @click="clearHostFilters()">Clear</button>
                </div>
                <div class="flex items-center gap-2">
                    <select class="cyber-input" x-model="hosts.selectedViewId"
                        @change="applyHostView(hosts.selectedViewId)">
                        <option value="">Saved views</option>
                        <template x-for="view in hosts.savedViews" :key="view.id">
                            <option :value="view.id" x-text="view.name"></option>
                        </template>
                    </select>
                    <button class="btn btn-sm" @click="saveHostView()">Save view</button>
                    <button class="btn btn-sm btn-ghost" @click="deleteHostView(hosts.selectedViewId)"
                        :disabled="!hosts.selectedViewId">Delete</button>
                </div>
            </div>

            <div class="table-container" x-show="hosts.list && hosts.list.length > 0 && filteredHosts.length > 0">
                <table class="table-fixed table-compact thead-sticky">
                    <thead>
                        <tr>
                            <th style="width: 24%">Host</th>
                            <th style="width: 8%">Type</th>
                            <th style="width: 12%">First Seen</th>
                            <th style="width: 12%">Last Seen</th>
                            <th style="width: 14%">Volume</th>
                            <th style="width: 8%">Flows</th>
                            <th style="width: 12%">Activity</th>
                            <th style="width: 10%">Meta</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(host, idx) in filteredHosts" :key="host.ip">
                            <tr @click="openHostDetail(host.ip)" style="cursor: pointer;"
                                x-init="if (idx < 20) ensureHostSparkline(host.ip)">
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="font-mono text-cyan" x-text="host.ip"></div>
                                        <!-- Subtle new host indicator -->
                                        <template x-if="host.is_new">
                                            <span class="host-new-indicator"
                                                title="New host (first seen within 24h)">üÜï</span>
                                        </template>
                                        <template x-if="host.notes">
                                            <span :title="host.notes" style="opacity: 0.7;">üìù</span>
                                        </template>
                                    </div>
                                    <div class="endpoint-badges" x-show="host.tags && host.tags.length > 0">
                                        <template x-for="tag in host.tags.slice(0, 3)" :key="tag">
                                            <span class="badge badge-outline" x-text="tag"></span>
                                        </template>
                                        <template x-if="host.tags.length > 3">
                                            <span class="text-xs text-muted"
                                                x-text="'+' + (host.tags.length - 3)"></span>
                                        </template>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge"
                                        :class="isInternalIP(host.ip) ? 'cat-lateral-movement' : 'cat-new-country'"
                                        x-text="isInternalIP(host.ip) ? 'INTERNAL' : 'EXTERNAL'">
                                    </span>
                                </td>
                                <td class="text-sm text-muted" x-text="formatFlowTimestamp(host.first_seen)">
                                </td>
                                <td class="text-sm text-muted" x-text="formatFlowTimestamp(host.last_seen)"></td>
                                <td>
                                    <div x-text="fmtBytes(host.total_bytes)"></div>
                                    <div class="text-xs text-muted"
                                        x-text="'RX: ' + fmtBytes(host.rx_bytes) + ' | TX: ' + fmtBytes(host.tx_bytes)">
                                    </div>
                                </td>
                                <td x-text="(host.rx_flows + host.tx_flows).toLocaleString()"></td>
                                <td>
                                    <div class="endpoint-meta-sparkline">
                                        <svg class="spark-subtle" viewBox="0 0 80 14" preserveAspectRatio="none">
                                            <polyline :points="getHostSparklinePoints(host.ip)" fill="none"
                                                stroke="var(--accent-cyan)" stroke-width="1"></polyline>
                                        </svg>
                                    </div>
                                    <div class="flex gap-1" style="margin-top: 4px;">
                                        <template x-if="isInternalIP(host.ip) && host.tx_bytes > host.rx_bytes * 10">
                                            <span title="High Upload (Internal)">üì§</span>
                                        </template>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-xs text-muted" x-text="host.owner || '‚Äî'"></div>
                                    <div class="text-xs text-muted" x-text="host.device_type || '‚Äî'"></div>
                                    <div class="text-xs" x-text="host.criticality || '‚Äî'"></div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Discovered Hosts Table -->
        <div x-show="hosts.viewMode === 'discovered'">
            <div x-show="!hosts.discovery.results || !hosts.discovery.results.hosts || hosts.discovery.results.hosts.length === 0"
                class="empty-state">
                <div style="font-size: 32px; margin-bottom: var(--space-2);">üéØ</div>
                <p>Scan a subnet to discover active hosts.</p>
            </div>

            <div class="table-container"
                x-show="hosts.discovery.results && hosts.discovery.results.hosts && hosts.discovery.results.hosts.length > 0">
                <table class="table-fixed table-compact thead-sticky">
                    <thead>
                        <tr>
                            <th style="width: 20%">IP Address</th>
                            <th style="width: 20%">MAC Address</th>
                            <th style="width: 30%">Vendor</th>
                            <th style="width: 15%">Status</th>
                            <th style="width: 15%">Last Seen</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="host in hosts.discovery.results?.hosts" :key="host.ip">
                            <tr class="hover:bg-gray-800 cursor-pointer"
                                @click="openHostDetail(host.ip, { mac: host.mac, vendor: host.vendor, hostname: host.hostname })">
                                <td class="font-mono text-cyan" x-text="host.ip"></td>
                                <td class="font-mono text-xs" x-text="host.mac"></td>
                                <td class="text-xs text-muted" x-text="host.vendor"></td>
                                <td>
                                    <span class="badge badge-success" x-text="host.status"></span>
                                </td>
                                <td class="text-xs text-muted" x-text="new Date(host.last_seen).toLocaleTimeString()">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        {% endcall %}
    </section>

</div>
<!-- ============================================
             FIREWALL TAB - Investigation & Incident Response
             ============================================ -->