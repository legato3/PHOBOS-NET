<div x-show="activeTab === 'network'" :style="activeTab === 'network' ? 'display:block' : 'display:none'"
    id="network-tab" role="tabpanel" aria-labelledby="network-tab-btn" tabindex="0">
    <!-- Network Dashboard -->
    <section id="section-network" class="scroll-section mb-6">

        <!-- Network Status Blocks -->
        <div class="grid mb-6 grid-auto-fit" style="margin-bottom: var(--space-6) !important;">
            <!-- Health Score Stat Box -->
            <div class="card stat-box"
                :class="'grade-' + (netHealth.health_score >= 90 ? 'a' : netHealth.health_score >= 70 ? 'b' : netHealth.health_score >= 50 ? 'c' : 'd')"
                title="Score based on static thresholds for TCP resets, SYN floods, and ICMP traffic.">
                <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                    <span class="health-icon" x-text="netHealth.status_icon || 'üíö'" style="font-size: 1.2em;"></span>
                    <span x-text="netHealth.loading ? '...' : (netHealth.health_score || 100)">...</span>
                </div>
                <div class="label">System Status <span style="opacity:0.6; cursor:pointer;"
            role="button" tabindex="0" aria-label="Network Health Details"
            @click.stop="openFwDetail('networkHealth')"
            @keydown.enter="openFwDetail('networkHealth')"
            @keydown.space.prevent="openFwDetail('networkHealth')"
            title="Click for details">‚ÑπÔ∏è</span>
                    <span x-text="netHealth.status ? ' (' + netHealth.status.toUpperCase() + ')' : ''"
                        style="margin-left: 4px; font-weight: normal;"></span>
                </div>
            </div>
            <div class="card stat-box" :class="{ 'status-warning': networkStatsOverview.anomalies_24h > 0 }">
                <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                    <span
                        x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.anomalies_24h || 0).toLocaleString()">...</span>
                </div>
                <div class="label" x-text="'Anomalies (' + timeRangeLabel + ')'">Network Anomalies</div>
            </div>
            <div class="card stat-box">
                <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                    <span
                        x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.active_flows || 0).toLocaleString()">...</span>
                    <template x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.active_flows">
                        <span
                            :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.active_flows.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (networkStatsOverview.trends.active_flows.muted ? '0.6' : '0.8')"
                            x-text="networkStatsOverview.trends.active_flows.indicator"
                            :title="'Since last hour: ' + (networkStatsOverview.trends.active_flows.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.active_flows.percent_change.toFixed(1) + '%'"></span>
                    </template>
                </div>
                <div class="label">Active Flows</div>

            </div>
            <div class="card stat-box">
                <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                    <span
                        x-text="networkStatsOverview.loading ? '...' : (networkStatsOverview.external_connections || 0).toLocaleString()">...</span>
                    <template x-if="!networkStatsOverview.loading && networkStatsOverview.trends?.external_connections">
                        <span
                            :style="'font-size: 0.8em; color: ' + (networkStatsOverview.trends.external_connections.muted ? 'var(--text-tertiary)' : 'var(--text-tertiary)') + '; opacity: ' + (networkStatsOverview.trends.external_connections.muted ? '0.6' : '0.8')"
                            x-text="networkStatsOverview.trends.external_connections.indicator"
                            :title="'Since last hour: ' + (networkStatsOverview.trends.external_connections.percent_change > 0 ? '+' : '') + networkStatsOverview.trends.external_connections.percent_change.toFixed(1) + '%'"></span>
                    </template>
                </div>
                <div class="label">External Connections (Est.)</div>
            </div>
            <!-- Health Indicator Stat Boxes -->
            <template x-for="ind in netHealth.indicators" :key="ind.name">
                <div class="card stat-box"
                    :class="'status-' + (ind.status === 'good' ? 'ok' : ind.status === 'warn' ? 'warning' : ind.status === 'bad' || ind.status === 'critical' ? 'critical' : 'info')">
                    <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                        <span x-text="ind.icon" style="font-size: 1.1em;"></span>
                        <span x-text="ind.value || 'N/A'"></span>
                    </div>
                    <div class="label" x-text="ind.name"></div>
                </div>
            </template>
            <!-- Loading State -->
            <template x-if="netHealth.loading && netHealth.indicators.length === 0">
                <div class="card stat-box">
                    <div class="value">...</div>
                    <div class="label">Loading Health Data</div>
                </div>
            </template>
            <!-- Empty State -->
            <template x-if="!netHealth.loading && netHealth.indicators.length === 0">
                <div class="card stat-box">
                    <div class="value">‚Äî</div>
                    <div class="label">No Health Indicators</div>
                </div>
            </template>
        </div>

        <!-- Primary Network Endpoints: Sources & Destinations -->



        <!-- Supporting Network Metrics -->
        <div class="grid" data-reorder="true" data-grid-id="network-overview"
            style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: var(--space-4);">


            <!-- Top Sources -->
            <template x-if="isVisible('sources')">
                {% set src_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% set src_footer %}
                <button class="btn-view-all" @click="openExpandedTable('sources')">View All</button>
                {% endset %}
                {% call widget_card('sources', 'Top Sources', 'üîº', extra_actions=src_actions,
                footer_content=src_footer, period_x_text="timeRangeLabel") %}
                <div class="widget-body-inner">
                    <div class="endpoint-grid-header">
                        <div class="grid-th w-50">Source Address</div>
                        <div class="grid-th w-50" style="text-align: right;">Traffic</div>
                    </div>
                    <div class="endpoint-grid-body">
                        <template x-for="(item, index) in filteredSources" :key="index">
                            <div @click="openIPModal(item.key)" class="network-endpoint-row grid-row"
                                role="button" tabindex="0" :aria-label="'View details for IP ' + item.key"
                                @keydown.enter="openIPModal(item.key)"
                                @keydown.space.prevent="openIPModal(item.key)"
                                :data-row-rank="index"
                                :data-percentage="filteredSources.length > 0 && filteredSources[0]?.bytes ? Math.round((item.bytes / filteredSources[0].bytes) * 100) : 0"
                                :style="'--row-percentage: ' + (filteredSources.length > 0 && filteredSources[0]?.bytes ? Math.round((item.bytes / filteredSources[0].bytes) * 100) : 0)">

                                <div class="grid-td w-50">
                                    <div class="endpoint-cell">
                                        <!-- Primary: IP Address -->
                                        <div class="endpoint-primary-line">
                                            <span class="flag-icon"
                                                :class="'flag-icon-' + (item.country_iso || 'xx').toLowerCase()"
                                                :title="item.country || 'Unknown'" style="margin-right: 8px;"></span>
                                            <strong x-text="item.key" class="endpoint-ip"></strong>
                                        </div>
                                        <!-- Supporting: Badges -->
                                        <div class="endpoint-badges">
                                            <span class="badge threat" x-show="item.threat">THREAT</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid-td w-50">
                                    <div class="endpoint-cell endpoint-value-cell">
                                        <div class="endpoint-value"
                                            x-text="item.bytes_fmt || fmtBytes(item.bytes || 0)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                {% endcall %}
            </template>

            <!-- Top Destinations -->
            <template x-if="isVisible('destinations')">
                {% set dst_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% set dst_footer %}
                <button class="btn-view-all" @click="openExpandedTable('destinations')">View
                    All</button>
                {% endset %}
                {% call widget_card('destinations', 'Top Destinations', 'üéØ',
                extra_actions=dst_actions,
                footer_content=dst_footer, period_x_text="timeRangeLabel") %}
                <div class="widget-body-inner">
                    <div class="endpoint-grid-header">
                        <div class="grid-th w-50">IP Address</div>
                        <div class="grid-th w-50" style="text-align: right;">Traffic</div>
                    </div>
                    <div class="endpoint-grid-body">
                        <template x-for="(item, index) in filteredDestinations" :key="index">
                            <div @click="openIPModal(item.key)" class="network-endpoint-row grid-row"
                                role="button" tabindex="0" :aria-label="'View details for IP ' + item.key"
                                @keydown.enter="openIPModal(item.key)"
                                @keydown.space.prevent="openIPModal(item.key)"
                                :data-row-rank="index"
                                :data-percentage="filteredDestinations.length > 0 && filteredDestinations[0]?.bytes ? Math.round((item.bytes / filteredDestinations[0].bytes) * 100) : 0"
                                :style="'--row-percentage: ' + (filteredDestinations.length > 0 && filteredDestinations[0]?.bytes ? Math.round((item.bytes / filteredDestinations[0].bytes) * 100) : 0)">

                                <div class="grid-td w-50">
                                    <div class="endpoint-cell">
                                        <!-- Primary: IP Address -->
                                        <div class="endpoint-primary-line">
                                            <span class="flag-icon"
                                                :class="'flag-icon-' + (item.country_iso || 'xx').toLowerCase()"
                                                :title="item.country || 'Unknown'" style="margin-right: 8px;"></span>
                                            <strong x-text="item.key" class="endpoint-ip"></strong>
                                        </div>
                                        <!-- Supporting: Badges -->
                                        <div class="endpoint-badges">
                                            <span class="badge threat" x-show="item.threat">THREAT</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid-td w-50">
                                    <div class="endpoint-cell endpoint-value-cell">
                                        <div class="endpoint-value"
                                            x-text="item.bytes_fmt || fmtBytes(item.bytes || 0)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                {% endcall %}
            </template>

            <!-- Protocol Hierarchy -->
            <template x-if="isVisible('protocolHierarchy')">
                {% call widget_card('protocolHierarchy', 'Protocol Hierarchy', 'üß¨',
                show_spinner=True, period_x_text="timeRangeLabel") %}
                <div class="chart-wrapper" style="height: 300px; position: relative;">
                    <canvas id="protocolHierarchyChart"></canvas>
                </div>
                <div class="text-center text-xs text-muted mt-3">
                    <span class="badge"
                        style="background: rgba(0, 243, 255, 0.1); color: var(--neon-cyan); font-size: 0.7rem;">Inner:
                        Layer 4</span>
                    <span class="mx-2">‚Ä¢</span>
                    <span class="badge"
                        style="background: rgba(188, 19, 254, 0.1); color: var(--neon-purple); font-size: 0.7rem;">Outer:
                        Layer 7</span>
                </div>
                {% endcall %}
            </template>

            <!-- Traffic Distribution -->
            <template x-if="isVisible('trafficScatter')">
                {% call widget_card('trafficScatter', 'Host Traffic Matrix', 'üí†',
                show_spinner=True, period_x_text="timeRangeLabel") %}
                <div class="chart-wrapper" style="height: 300px; position: relative;">
                    <canvas id="trafficScatterChart"></canvas>
                </div>
                <div class="text-center text-xs text-muted mt-3">
                    <span style="color: var(--neon-cyan)">‚Üì Download</span> (Log) vs
                    <span style="color: var(--neon-purple)">‚Üë Upload</span> (Log)
                </div>
                {% endcall %}
            </template>
            <!-- Top Ports -->
            <template x-if="isVisible('ports')">
                {% set ports_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% call widget_card('ports', 'Top Ports', 'üîå', extra_actions=ports_actions,
                period_x_text="timeRangeLabel")
                %}
                <table class="table-fixed table-compact">
                    <thead>
                        <tr>
                            <th class="w-70">Port</th>
                            <th class="w-30">Traffic</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, index) in (ports.ports || []).slice(0, 5)" :key="index">
                            <tr :data-percentage="ports.ports.length > 0 && ports.ports[0]?.bytes ? Math.round((item.bytes / ports.ports[0].bytes) * 100) : 0"
                                :style="'--row-percentage: ' + (ports.ports.length > 0 && ports.ports[0]?.bytes ? Math.round((item.bytes / ports.ports[0].bytes) * 100) : 0)">
                                <td style="overflow: hidden;">
                                    <strong class="text-cyan" x-text="item.key"></strong>
                                    <div class="truncate text-9 text-muted" x-text="item.service" :title="item.service">
                                    </div>
                                </td>
                                <td>
                                    <div style="color: #fff; font-weight: 500;"
                                        x-text="item.bytes_fmt || fmtBytes(item.bytes)">
                                    </div>
                                    <span class="badge suspicious" x-show="item.suspicious">SUSPICIOUS</span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                {% endcall %}
            </template>

            <!-- Top ASNs -->
            <template x-if="isVisible('asns')">
                {% set asns_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% call widget_card('asns', 'Top ASNs', 'üè¢', extra_actions=asns_actions,
                period_x_text="timeRangeLabel") %}
                <div class="widget-body-inner">
                    <template x-for="asn in asns.asns" :key="asn.asn">
                        <div class="asn-row">
                            <div class="asn-name" x-text="asn.asn" :title="asn.asn"
                                style="color: var(--text-primary); font-weight: 500;"></div>
                            <div class="asn-bar-container">
                                <div class="asn-bar" :style="'width:' + (asn.bytes / (asns.maxBytes||1) * 100) + '%'">
                                </div>
                            </div>
                            <div class="asn-val" x-text="asn.bytes_fmt"
                                style="color: var(--text-primary); font-weight: 500;"></div>
                        </div>
                    </template>
                    <div x-show="!asns.loading && (!asns.asns || asns.asns.length === 0)" class="empty-state">No ASN
                        data available</div>
                </div>
                {% endcall %}
            </template>

            <!-- Top Countries -->
            <template x-if="isVisible('countries')">
                {% set country_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% call widget_card('countries', 'Top Countries', 'üåç',
                extra_actions=country_actions, period_x_text="timeRangeLabel") %}
                <div class="widget-body-inner">
                    <template x-for="c in (countries.map_data || []).slice(0, 10)" :key="c.iso">
                        <div class="country-row">
                            <div class="country-name" :title="c.name">
                                <span :class="'flag-icon flag-icon-' + (c.iso || 'xx').toLowerCase()"
                                    style="margin-right: 6px;"></span>
                                <span x-text="c.name"></span>
                            </div>
                            <div class="country-bar-container">
                                <div class="country-bar" :style="'width:' + c.pct + '%'">
                                </div>
                            </div>
                            <div class="country-val" x-text="c.bytes_fmt"></div>
                        </div>
                    </template>
                    <div x-show="!countries.loading && (!countries.map_data || countries.map_data.length === 0)"
                        class="empty-state">No country data available</div>
                </div>
                {% endcall %}
            </template>

            <!-- Top Talkers - MOVED TO FIREWALL TAB -->

            <!-- Top Services -->
            <template x-if="isVisible('services')">
                {% set svc_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% call widget_card('services', 'Top Services', 'üåê', extra_actions=svc_actions,
                period_x_text="timeRangeLabel") %}
                <div class="widget-body-inner">
                    <template x-for="svc in services.services" :key="svc.service">
                        <div class="service-row">
                            <div class="service-name" x-text="svc.service" :title="svc.service">
                            </div>
                            <div class="service-bar-container">
                                <div class="service-bar" :style="'width:' + svc.pct + '%'">
                                </div>
                            </div>
                            <div class="service-val" x-text="svc.bytes_fmt"></div>
                        </div>
                    </template>
                    <div x-show="!services.loading && (!services.services || services.services.length === 0)"
                        class="empty-state">No data</div>
                </div>
                {% endcall %}
            </template>

            <template x-if="isVisible('hourlyTraffic')">
                {% call widget_card('hourlyTraffic', 'Traffic Volume', '‚è∞', show_spinner=True,
                period_x_text="timeRangeLabel") %}
                <div class="hourly-summary">
                    <div class="hourly-stat">
                        <span class="hourly-stat-value text-green" x-text="hourlyTraffic.peak_hour + ':00'"></span>
                        <span class="hourly-stat-label">Peak Hour</span>
                    </div>
                    <div class="hourly-stat">
                        <span class="hourly-stat-value text-cyan" x-text="hourlyTraffic.peak_bytes_fmt"></span>
                        <span class="hourly-stat-label">Peak Traffic</span>
                    </div>
                    <div class="hourly-stat">
                        <span class="hourly-stat-value" x-text="hourlyTraffic.total_bytes_fmt"></span>
                        <span class="hourly-stat-label" x-text="timeRangeLabel + ' Total'"></span>
                    </div>
                </div>
                <div class="chart-wrapper-small chart-expandable"
                    @click="openFullscreenChart('hourlyChart', 'Traffic by Hour (' + timeRange + ')')"
                    title="Click to expand">
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div x-show="hourlyTrafficHint()"
                    style="margin-top:10px; font-size:0.78em; color:var(--text-tertiary); text-align:center;">
                    <span x-text="hourlyTrafficHint()"></span>
                </div>
                {% endcall %}
            </template>

            <!-- TCP Flags -->
            <template x-if="isVisible('flags')">
                {% call widget_card('flags', 'TCP Flags', 'üè≥Ô∏è', show_spinner=True, period_x_text="timeRangeLabel") %}
                <div class="chart-wrapper-small chart-expandable"
                    @click="openFullscreenChart('flagsChart', 'TCP Flags Distribution')" title="Click to expand">
                    <canvas id="flagsChart"></canvas>
                </div>
                <!-- Custom legend with flag names and colors -->
                <div class="flags-custom-legend"
                    style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; padding: 0 10px;">
                    <template x-for="(flag, idx) in flags.flags" :key="flag.flag">
                        <div class="flags-legend-item" style="display: flex; align-items: center; gap: 6px;">
                            <span class="flags-legend-color"
                                :style="'width: 12px; height: 12px; border-radius: 2px; background: ' + getFlagColor(idx) + ';'"></span>
                            <span style="color: var(--text-1); font-size: 0.85em;" x-text="flag.flag"></span>
                        </div>
                    </template>
                </div>
                <div style="margin-top:10px; font-size:0.75em; color:var(--text-muted); line-height:1.4;">
                    <strong>Flags:</strong>
                    <span title="Acknowledge">AP=ACK+PSH</span> ¬∑
                    <span title="Acknowledge">A=ACK</span> ¬∑
                    <span title="ACK+PSH+SYN+FIN">APSF=ACK+PSH+SYN+FIN</span> ¬∑
                    <span title="Reset">R=RST</span> ¬∑
                    <span title="No flags">None</span>
                </div>
                {% endcall %}
            </template>

            <!-- Long Flows - MOVED TO FIREWALL TAB -->

            <!-- Packet Size Distribution -->
            <template x-if="isVisible('packetSizes')">
                {% call widget_card('packetSizes', 'Packet Sizes', 'üì¶', show_spinner=True,
                period_x_text="timeRangeLabel")
                %}
                <div class="chart-wrapper-small chart-expandable"
                    @click="openFullscreenChart('pktSizeChart', 'Packet Size Distribution')" title="Click to expand">
                    <canvas id="pktSizeChart"></canvas>
                </div>
                {% endcall %}
            </template>

            <!-- Flow Statistics -->
            <template x-if="isVisible('flowStats')">
                {% call widget_card('flowStats', 'Flow Statistics', 'üìä', show_spinner=True,
                period_x_text="timeRangeLabel")
                %}
                <div class="flow-stats-grid">
                    <div class="flow-stat-item">
                        <span class="flow-stat-value text-cyan"
                            x-text="(flowStats.total_flows || 0).toLocaleString()"></span>
                        <span class="flow-stat-label">Total Flows</span>
                    </div>
                    <div class="flow-stat-item">
                        <span class="flow-stat-value text-green" x-text="flowStats.avg_duration_fmt || '0s'"></span>
                        <span class="flow-stat-label">Avg Duration</span>
                    </div>
                    <div class="flow-stat-item">
                        <span class="flow-stat-value text-cyan" x-text="flowStats.avg_bytes_fmt || '0 B'"></span>
                        <span class="flow-stat-label">Avg Size</span>
                    </div>
                    <div class="flow-stat-item">
                        <span class="flow-stat-value text-yellow"
                            x-text="(flowStats.bytes_per_packet || 0) + ' B'"></span>
                        <span class="flow-stat-label">Bytes/Pkt</span>
                    </div>
                </div>
                <div class="duration-dist" x-show="flowStats.duration_dist">
                    <div class="duration-dist-label">Duration Distribution:</div>
                    <div class="duration-dist-bars">
                        <div class="dist-bar-group">
                            <div class="dist-bar short"
                                :style="'width:' + (flowStats.duration_dist?.short / (flowStats.total_flows || 1) * 100) + '%'">
                            </div>
                            <span class="dist-label">&lt;1s</span>
                        </div>
                        <div class="dist-bar-group">
                            <div class="dist-bar medium"
                                :style="'width:' + (flowStats.duration_dist?.medium / (flowStats.total_flows || 1) * 100) + '%'">
                            </div>
                            <span class="dist-label">1s-1m</span>
                        </div>
                        <div class="dist-bar-group">
                            <div class="dist-bar long"
                                :style="'width:' + (flowStats.duration_dist?.long / (flowStats.total_flows || 1) * 100) + '%'">
                            </div>
                            <span class="dist-label">&gt;1m</span>
                        </div>
                    </div>
                </div>
                {% endcall %}
            </template>

            <!-- Network Intelligence Widget -->
            <template x-if="isVisible('insights')">
                {% call widget_card('insights', 'Network Intelligence', 'üß†', show_spinner=True,
                period_x_text="timeRange") %}
                <div class="widget-body-inner" style="padding: var(--space-4);">

                    <!-- Bandwidth Utilization -->
                    <div style="margin-bottom: var(--space-5);">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-3); font-size: var(--fs-sm);">
                            üìä Bandwidth Distribution</div>
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-2);">
                            <div style="text-align: center;">
                                <div style="font-size: var(--fs-2xl); font-weight: 700; color: var(--signal-primary);"
                                    x-text="networkIntelligence.bandwidth_utilization.top_talker_pct + '%'">0%</div>
                                <div style="font-size: var(--fs-xs); color: var(--text-2); margin-top: var(--space-1);">
                                    Top Talker</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: var(--fs-2xl); font-weight: 700; color: var(--signal-info);"
                                    x-text="networkIntelligence.bandwidth_utilization.top_5_pct + '%'">0%</div>
                                <div style="font-size: var(--fs-xs); color: var(--text-2); margin-top: var(--space-1);">
                                    Top 5</div>
                            </div>
                        </div>
                        <div
                            style="text-align: center; padding: var(--space-2); background: rgba(0, 234, 255, 0.05); border-radius: var(--radius-sm);">
                            <span style="font-size: var(--fs-xs); color: var(--text-2);">Distribution: </span>
                            <span style="font-weight: 600; color: var(--text-primary);"
                                x-text="networkIntelligence.bandwidth_utilization.distribution">Balanced</span>
                        </div>
                    </div>

                    <!-- Protocol Diversity -->
                    <div style="margin-bottom: var(--space-5);">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2); font-size: var(--fs-sm);">
                            üîÄ Protocol Mix</div>
                        <div
                            style="padding: var(--space-3); background: rgba(123, 123, 255, 0.05); border-left: 3px solid var(--signal-tertiary); border-radius: var(--radius-sm);">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: var(--fs-md);"
                                        x-text="networkIntelligence.protocol_diversity.primary_protocol">TCP</div>
                                    <div style="font-size: var(--fs-xs); color: var(--text-2);">Primary Protocol</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: var(--fs-xl); font-weight: 700; color: var(--signal-tertiary);"
                                        x-text="networkIntelligence.protocol_diversity.primary_pct + '%'">0%</div>
                                </div>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; font-size: var(--fs-xs); color: var(--text-2);">
                                <span x-text="networkIntelligence.protocol_diversity.protocols_count + ' protocols'">0
                                    protocols</span>
                                <span style="font-weight: 600;"
                                    :style="'color: ' + (networkIntelligence.protocol_diversity.balance === 'Diverse' ? 'var(--signal-ok)' : networkIntelligence.protocol_diversity.balance === 'Dominant' ? 'var(--signal-info)' : 'var(--signal-warn)')"
                                    x-text="networkIntelligence.protocol_diversity.balance">Diverse</span>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Patterns -->
                    <div style="margin-bottom: var(--space-5);">
                        <div
                            style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2); font-size: var(--fs-sm);">
                            ‚è±Ô∏è Connection Patterns</div>
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-2); margin-bottom: var(--space-2);">
                            <div
                                style="padding: var(--space-2); background: rgba(0, 255, 136, 0.05); border-radius: var(--radius-sm); text-align: center;">
                                <div style="font-size: var(--fs-lg); font-weight: 700; color: var(--signal-ok);"
                                    x-text="networkIntelligence.connection_patterns.short_lived_pct + '%'">0%</div>
                                <div style="font-size: var(--fs-xs); color: var(--text-2); margin-top: var(--space-1);">
                                    Short</div>
                            </div>
                            <div
                                style="padding: var(--space-2); background: rgba(0, 162, 255, 0.05); border-radius: var(--radius-sm); text-align: center;">
                                <div style="font-size: var(--fs-lg); font-weight: 700; color: var(--signal-info);"
                                    x-text="networkIntelligence.connection_patterns.long_lived_pct + '%'">0%</div>
                                <div style="font-size: var(--fs-xs); color: var(--text-2); margin-top: var(--space-1);">
                                    Long</div>
                            </div>
                            <div
                                style="padding: var(--space-2); background: rgba(255, 255, 255, 0.02); border-radius: var(--radius-sm); text-align: center;">
                                <div style="font-size: var(--fs-lg); font-weight: 700; color: var(--text-primary);"
                                    x-text="networkIntelligence.connection_patterns.avg_duration_fmt">0s</div>
                                <div style="font-size: var(--fs-xs); color: var(--text-2); margin-top: var(--space-1);">
                                    Avg</div>
                            </div>
                        </div>
                        <div style="text-align: center; font-size: var(--fs-xs); color: var(--text-2);">
                            Pattern: <span style="font-weight: 600; color: var(--text-primary);"
                                x-text="networkIntelligence.connection_patterns.pattern">Normal</span>
                        </div>
                    </div>

                </div>
                {% endcall %}
            </template>

            <!-- Protocols -->
            <template x-if="isVisible('protocols')">
                {% call widget_card('protocols', 'Protocols', 'üì°', show_spinner=True, period_x_text="timeRangeLabel")
                %}
                <div class="chart-wrapper-small chart-expandable" style="margin-bottom: 12px; height: 160px;"
                    x-show="protoMix && protoMix.labels && protoMix.labels.length > 0"
                    @click="openFullscreenChart('protoMixChart', 'Protocol Distribution')" title="Click to expand">
                    <canvas id="protoMixChart"></canvas>
                </div>
                <table class="table-fixed table-compact" x-show="protocols.protocols && protocols.protocols.length > 0">
                    <thead>
                        <tr>
                            <th>Protocol</th>
                            <th>Stats</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, index) in protocols.protocols" :key="index">
                            <tr>
                                <td>
                                    <strong class="text-cyan" x-text="item.proto_name"></strong>
                                </td>
                                <td>
                                    <div class="text-green" x-text="item.bytes_fmt || fmtBytes(item.bytes)">
                                    </div>
                                    <div class="text-8 text-muted"
                                        x-text="Number(item.flows).toLocaleString() + ' flows'">
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="!protocols.loading && (!protocols.protocols || protocols.protocols.length === 0)"
                    class="empty-state">No protocol data available</div>
                {% endcall %}
            </template>

            <!-- Long-Duration Flows -->
            <template x-if="isVisible('durations')">
                {% set dur_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% call widget_card('durations', 'Long Flows', '‚è±Ô∏è', extra_actions=dur_actions,
                show_spinner=True, period_x_text="timeRangeLabel") %}
                <div class="widget-body-inner">
                    <!-- Summary Stats -->
                    <div class="duration-summary"
                        style="display: flex; gap: var(--space-4); margin-bottom: var(--space-3); font-size: var(--text-sm);">
                        <div>
                            <span class="text-muted">Max:</span>
                            <span class="text-cyan" x-text="durations.stats?.max_duration_fmt || '‚Äî'"></span>
                        </div>
                        <div>
                            <span class="text-muted">Avg:</span>
                            <span class="text-green" x-text="durations.stats?.avg_duration_fmt || '‚Äî'"></span>
                        </div>
                        <div>
                            <span class="text-muted">Flows:</span>
                            <span x-text="durations.stats?.total_flows || 0"></span>
                        </div>
                    </div>
                    <!-- Flow List -->
                    <div class="duration-flow-list" style="display: flex; flex-direction: column; gap: var(--space-2);">
                        <template x-for="(flow, idx) in (durations.durations || []).slice(0, 6)" :key="idx">
                            <div class="duration-flow-row"
                                style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); background: transparent; border-radius: 0; border-bottom: 1px solid var(--border-soft);">
                                <!-- Flow Info -->
                                <div style="flex: 1; min-width: 0; overflow: hidden;">
                                    <div
                                        style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); flex-wrap: nowrap;">
                                        <span class="text-cyan clickable-ip" @click="openIPModal(flow.src)"
                                            role="button" tabindex="0" :aria-label="'View details for IP ' + flow.src"
                                            @keydown.enter="openIPModal(flow.src)"
                                            @keydown.space.prevent="openIPModal(flow.src)"
                                            style="cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;"
                                            x-text="flow.src"
                                            :title="flow.src + ' (' + (flow.src_hostname || 'Unknown') + ')'"></span>
                                        <span class="text-muted">‚Üí</span>
                                        <span class="text-purple clickable-ip" @click="openIPModal(flow.dst)"
                                            role="button" tabindex="0" :aria-label="'View details for IP ' + flow.dst"
                                            @keydown.enter="openIPModal(flow.dst)"
                                            @keydown.space.prevent="openIPModal(flow.dst)"
                                            style="cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;"
                                            x-text="flow.dst"
                                            :title="flow.dst + ' (' + (flow.dst_hostname || 'Unknown') + ')'"></span>
                                        <span class="badge"
                                            style="background: rgba(188,19,254,0.15); color: var(--neon-purple); font-size: var(--text-xs); flex-shrink: 0;"
                                            x-text="flow.proto_name || flow.proto"></span>
                                    </div>
                                </div>
                                <!-- Duration & Bytes -->
                                <div style="text-align: right; flex-shrink: 0;">
                                    <div style="color: #fff; font-weight: 600; font-size: var(--text-sm);"
                                        x-text="flow.duration_fmt"></div>
                                    <div class="text-muted" style="font-size: var(--text-xs);" x-text="flow.bytes_fmt">
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="!durations.loading && (!durations.durations || durations.durations.length === 0)"
                            class="empty-state" style="text-align: center; padding: var(--space-4);">
                            No long-duration flows detected
                        </div>
                    </div>
                </div>
                {% endcall %}
            </template>

            <!-- Top Talkers -->
            <template x-if="isVisible('talkers')">
                {% set talk_actions %}
                <div class="status-pills">
                </div>
                {% endset %}
                {% call widget_card('talkers', 'Top Talkers', 'üí¨', extra_actions=talk_actions,
                show_spinner=True, period_x_text="timeRangeLabel") %}
                <div class="widget-body-inner">
                    <div class="talkers-list" style="display: flex; flex-direction: column; gap: var(--space-2);">
                        <template x-for="(flow, idx) in (talkers.flows || []).slice(0, 5)" :key="idx">
                            <div class="talker-row"
                                style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); background: transparent; border-radius: 0; border-bottom: 1px solid var(--border-soft);">
                                <!-- Flow Info -->
                                <div style="flex: 1; min-width: 0;">
                                    <div
                                        style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); flex-wrap: wrap;">
                                        <!-- Source -->
                                        <span class="text-cyan clickable-ip" @click="openIPModal(flow.src)"
                                            role="button" tabindex="0" :aria-label="'View details for IP ' + flow.src"
                                            @keydown.enter="openIPModal(flow.src)"
                                            @keydown.space.prevent="openIPModal(flow.src)"
                                            style="cursor: pointer;" x-text="flow.src"
                                            :title="flow.src_country || ''"></span>
                                        <span class="text-muted">‚Üí</span>
                                        <!-- Destination -->
                                        <span class="text-purple clickable-ip" @click="openIPModal(flow.dst)"
                                            role="button" tabindex="0" :aria-label="'View details for IP ' + flow.dst"
                                            @keydown.enter="openIPModal(flow.dst)"
                                            @keydown.space.prevent="openIPModal(flow.dst)"
                                            style="cursor: pointer;" x-text="flow.dst"
                                            :title="flow.dst_country || ''"></span>
                                    </div>
                                    <div
                                        style="display: flex; align-items: center; gap: var(--space-3); font-size: var(--text-xs); color: var(--text-muted); margin-top: 2px;">
                                        <span x-text="flow.proto_name || flow.proto"></span>
                                        <span x-show="flow.service && flow.service !== flow.dst_port"
                                            x-text="'‚Ä¢ ' + flow.service"></span>
                                        <span x-text="'‚Ä¢ ' + flow.duration"></span>
                                        <span x-text="'‚Ä¢ ' + flow.age"></span>
                                    </div>
                                </div>
                                <!-- Traffic -->
                                <div style="text-align: right;">
                                    <div style="color: #fff; font-weight: 600; font-size: var(--text-sm);"
                                        x-text="flow.bytes_fmt"></div>
                                    <div class="text-muted" style="font-size: var(--text-xs);"
                                        x-text="(flow.packets || 0).toLocaleString() + ' pkts'">
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="!talkers.loading && (!talkers.flows || talkers.flows.length === 0)"
                            class="empty-state" style="text-align: center; padding: var(--space-4);">
                            No flow data available
                        </div>
                    </div>
                </div>
                {% endcall %}
            </template>


        </div>
    </section>

</div>

<!-- ============================================
                 HOSTS TAB
                 ============================================ -->
