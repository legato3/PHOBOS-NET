<div x-show="activeTab === 'overview'" id="overview-tab" role="tabpanel" class="custom-scroll"
    style="display:none; height:100%; padding-bottom:40px; width:100%; margin:0; padding:20px; overflow-y: auto;"
    x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100">

    <!-- CHANGE DIGEST (Calm, dense, actionable delta summary) -->
    <div class="change-digest-rail">
        <div class="change-digest-rail__header">
            <div class="change-digest-rail__title">
                WHAT CHANGED
                <template x-if="changeDigest.baselineStatus === 'building'">
                    <span class="change-digest-rail__badge">BASELINE BUILDING</span>
                </template>
            </div>
            <div class="change-digest-rail__controls">
                <!-- Time window selector -->
                <select x-model="changeDigest.window" @change="fetchChangeDigest()"
                    class="change-digest-rail__window-select">
                    <option value="15m">15m</option>
                    <option value="1h">1h</option>
                    <option value="24h">24h</option>
                </select>
            </div>
        </div>

        <!-- One-line deterministic summary -->
        <div class="change-digest-rail__summary" x-text="changeDigest.summaryLine"></div>

        <!-- Digest groups (collapsible) -->
        <div class="change-digest-rail__groups">
            <!-- NEEDS ATTENTION -->
            <template x-if="changeDigest.groups.needsAttention.length > 0">
                <div class="change-digest-group">
                    <div class="change-digest-group__header"
                         @click="toggleDigestGroup('needsAttention')"
                         role="button"
                         tabindex="0">
                        <span class="change-digest-group__icon"
                              x-text="changeDigest.expandedGroups.has('needsAttention') ? '‚ñº' : '‚ñ∂'"></span>
                        <span class="change-digest-group__title">NEEDS ATTENTION</span>
                        <span class="change-digest-group__count"
                              x-text="'(' + changeDigest.groups.needsAttention.length + ')'"></span>
                    </div>
                    <template x-if="changeDigest.expandedGroups.has('needsAttention')">
                        <div class="change-digest-group__rows">
                            <template x-for="row in changeDigest.groups.needsAttention.slice(0, 3)" :key="row.title">
                                <div class="change-digest-row">
                                    <span class="change-digest-row__category" x-text="row.category"></span>
                                    <span class="change-digest-row__title" x-text="row.title"></span>
                                    <span class="change-digest-row__delta" x-text="row.delta"></span>
                                    <button class="change-digest-row__action"
                                            @click="navigateFromDigestRow(row.action)"
                                            title="View details">
                                        ‚Üí
                                    </button>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>

            <!-- NEW & UNUSUAL -->
            <template x-if="changeDigest.groups.newUnusual.length > 0">
                <div class="change-digest-group">
                    <div class="change-digest-group__header"
                         @click="toggleDigestGroup('newUnusual')"
                         role="button"
                         tabindex="0">
                        <span class="change-digest-group__icon"
                              x-text="changeDigest.expandedGroups.has('newUnusual') ? '‚ñº' : '‚ñ∂'"></span>
                        <span class="change-digest-group__title">NEW & UNUSUAL</span>
                        <span class="change-digest-group__count"
                              x-text="'(' + changeDigest.groups.newUnusual.length + ')'"></span>
                    </div>
                    <template x-if="changeDigest.expandedGroups.has('newUnusual')">
                        <div class="change-digest-group__rows">
                            <template x-for="row in changeDigest.groups.newUnusual.slice(0, 3)" :key="row.title">
                                <div class="change-digest-row">
                                    <span class="change-digest-row__category" x-text="row.category"></span>
                                    <span class="change-digest-row__title" x-text="row.title"></span>
                                    <span class="change-digest-row__delta" x-text="row.delta"></span>
                                    <button class="change-digest-row__action"
                                            @click="navigateFromDigestRow(row.action)"
                                            title="View details">
                                        ‚Üí
                                    </button>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>

            <!-- BIGGEST MOVERS -->
            <template x-if="changeDigest.groups.biggestMovers.length > 0">
                <div class="change-digest-group">
                    <div class="change-digest-group__header"
                         @click="toggleDigestGroup('biggestMovers')"
                         role="button"
                         tabindex="0">
                        <span class="change-digest-group__icon"
                              x-text="changeDigest.expandedGroups.has('biggestMovers') ? '‚ñº' : '‚ñ∂'"></span>
                        <span class="change-digest-group__title">BIGGEST MOVERS</span>
                        <span class="change-digest-group__count"
                              x-text="'(' + changeDigest.groups.biggestMovers.length + ')'"></span>
                    </div>
                    <template x-if="changeDigest.expandedGroups.has('biggestMovers')">
                        <div class="change-digest-group__rows">
                            <template x-for="row in changeDigest.groups.biggestMovers.slice(0, 3)" :key="row.title">
                                <div class="change-digest-row">
                                    <span class="change-digest-row__category" x-text="row.category"></span>
                                    <span class="change-digest-row__title" x-text="row.title"></span>
                                    <span class="change-digest-row__delta" x-text="row.delta"></span>
                                    <button class="change-digest-row__action"
                                            @click="navigateFromDigestRow(row.action)"
                                            title="View details">
                                        ‚Üí
                                    </button>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>

            <!-- Empty state -->
            <template x-if="changeDigest.groups.needsAttention.length === 0 &&
                             changeDigest.groups.newUnusual.length === 0 &&
                             changeDigest.groups.biggestMovers.length === 0">
                <div class="change-digest-rail__empty">
                    No meaningful changes in the last <span x-text="changeDigest.window"></span>. System stable.
                </div>
            </template>
        </div>
    </div>

    <!-- EVIDENCE STAT BOXES -->
    <div class="overview-grid-spacing">
        <!-- 1. NETWORK STATE -->
        <div class="card overview-stat-card clickable" role="button" tabindex="0"
            @click="openStatDetail('networkState')" @keydown.enter="openStatDetail('networkState')"
            @keydown.space.prevent="openStatDetail('networkState')" aria-label="View Network State Details">
            <h2>
                <div class="card-title-content">
                    <span>NETWORK STATE</span>
                </div>
            </h2>
            <div class="stat-box-body">
                <div class="stat-hero-value" :style="'color: ' + getNetworkState().color"
                    x-text="getNetworkState().state"></div>
                <div class="stat-subtext" x-text="getNetworkState().subtext"></div>
            </div>
        </div>

        <!-- 2. ACTIONABLE ALERTS -->
        <div class="card overview-stat-card clickable" role="button" tabindex="0" @click="openStatDetail('alerts')"
            @keydown.enter="openStatDetail('alerts')" @keydown.space.prevent="openStatDetail('alerts')"
            aria-label="View Alerts Details">
            <h2>
                <div class="card-title-content">
                    <span>ACTIONABLE ALERTS</span>
                </div>
            </h2>
            <div class="stat-box-body">
                <div class="stat-hero-value" style="color:var(--text-primary);" x-text="getAlertsSummary().count"></div>
                <div class="stat-subtext" x-text="getAlertsSummary().subtext"></div>
            </div>
        </div>

        <!-- 3. TRAFFIC LEVEL -->
        <div class="card overview-stat-card clickable" role="button" tabindex="0"
            @click="openStatDetail('trafficLevel')" @keydown.enter="openStatDetail('trafficLevel')"
            @keydown.space.prevent="openStatDetail('trafficLevel')" aria-label="View Traffic Level Details">
            <h2>
                <div class="card-title-content">
                    <span>TRAFFIC LEVEL</span>
                </div>
            </h2>
            <div class="stat-box-body">
                <div class="stat-hero-value" style="color:var(--text-primary);" x-text="getTrafficLevel().level"></div>
                <div class="stat-subtext" x-text="getTrafficLevel().subtext"></div>
            </div>
        </div>

        <!-- 4. PROTECTED (24H) -->
        <div class="card overview-stat-card clickable" role="button" tabindex="0"
            @click="openStatDetail('protectedConnections')" @keydown.enter="openStatDetail('protectedConnections')"
            @keydown.space.prevent="openStatDetail('protectedConnections')"
            aria-label="View Protected Connections Details">
            <h2>
                <div class="card-title-content">
                    <span>PROTECTED (24H)</span>
                </div>
            </h2>
            <div class="stat-box-body">
                <div class="stat-hero-value" style="color:var(--signal-ok);" x-text="getProtectedSummary().count"></div>
                <div class="stat-subtext" x-text="getProtectedSummary().subtext"></div>
            </div>
        </div>

        <!-- 5. ATTACK SURFACE -->
        <div class="card overview-stat-card clickable" role="button" tabindex="0"
            @click="openStatDetail('internetExposure')" @keydown.enter="openStatDetail('internetExposure')"
            @keydown.space.prevent="openStatDetail('internetExposure')" aria-label="View Attack Surface Details">
            <h2>
                <div class="card-title-content">
                    <span>ATTACK SURFACE</span>
                </div>
            </h2>
            <div class="stat-box-body">
                <div class="stat-hero-value" style="color:var(--text-primary);" x-text="getExposureSummary().value">
                </div>
                <div class="stat-subtext" x-text="getExposureSummary().subtext"></div>
            </div>
        </div>

        <!-- 6. NOTABLE CHANGES -->
        <div class="card overview-stat-card clickable" role="button" tabindex="0"
            @click="openStatDetail('unusualActivity')" @keydown.enter="openStatDetail('unusualActivity')"
            @keydown.space.prevent="openStatDetail('unusualActivity')" aria-label="View Notable Changes Details">
            <h2>
                <div class="card-title-content">
                    <span>NOTABLE CHANGES</span>
                </div>
            </h2>
            <div class="stat-box-body">
                <div class="stat-hero-value" :style="'color: ' + getUnusualActivitySummary().color"
                    x-text="getUnusualActivitySummary().value">
                </div>
                <div class="stat-subtext" x-text="getUnusualActivitySummary().subtext"></div>
            </div>
        </div>
    </div>

    <!-- LEGACY WIDGETS RESTORED (Context & Deep Dive) -->
    <div style="margin-top: 0; padding-top: 0;">
        <!-- Bandwidth Chart (Conditional) -->
        <template x-if="isVisible('bandwidth')">
            {% call widget_card('bandwidth', 'Bandwidth & Flow Rate', 'üìä',
            period_x_text='global_time_range') %}
            <div class="chart-wrapper chart-expandable" @click="openFullscreenChart('bwChart', 'Bandwidth & Flow Rate')"
                title="Click to expand">
                <canvas id="bwChart"></canvas>
            </div>
            {% endcall %}
        </template>
    </div>



    <div style="margin-top: var(--space-6);">
        <!-- World Map Section -->
        <section id="section-worldmap" class="scroll-section">
            <!-- Logic for World Map (Same as Step 141) -->
            {% set wm_actions %}
            <div class="world-map-mode-toggle">
                <button class="world-map-mode-btn" :class="{ 'active': worldMapMode === 'traffic' }"
                    @click="worldMapMode = 'traffic'" title="Traffic view - balanced emphasis">
                    Traffic
                </button>
                <button class="world-map-mode-btn" :class="{ 'active': worldMapMode === 'exposure' }"
                    @click="worldMapMode = 'exposure'" title="Exposure view - emphasize destinations">
                    Exposure
                </button>
                <button class="world-map-mode-btn" :class="{ 'active': worldMapMode === 'attacks' }"
                    @click="worldMapMode = 'attacks'" title="View Threats & Blocked traffic">
                    Threats & Blocks
                </button>
            </div>
            <div class="world-map-layer-toggles">
                <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.sources }"
                    title="Toggle Sources layer">
                    <input type="checkbox" x-model="worldMapLayers.sources">
                    <span class="layer-dot layer-dot-cyan"></span>
                    <span class="layer-label">Sources</span>
                </label>
                <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.destinations }"
                    title="Toggle Destinations layer">
                    <input type="checkbox" x-model="worldMapLayers.destinations">
                    <span class="layer-dot layer-dot-purple"></span>
                    <span class="layer-label">Destinations</span>
                </label>
                <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.threats }"
                    title="Toggle Threats layer">
                    <input type="checkbox" x-model="worldMapLayers.threats">
                    <span class="layer-dot layer-dot-red"></span>
                    <span class="layer-label">Threats</span>
                </label>
            </div>
            <button class="world-map-reset-btn" @click="resetWorldMapView()" title="Reset map view">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                </svg>
                Reset
            </button>
            {% endset %}

            {% set wm_title %}
            <div>
                <span>Traffic World Map</span>
                <span x-show="mapStatus" x-text="'[' + mapStatus + ']'" class="text-75 text-yellow ml-2"></span>
            </div>
            {% endset %}

            {% call widget_card('worldmap', wm_title, 'üó∫Ô∏è', card_class='wide-card world-map-card',
            extra_actions=wm_actions) %}
            <div class="world-map-container" style="min-height: 400px;">
                <div id="world-map-svg" class="world-map-svg"></div>
                <div x-show="worldMap.loading" class="spinner-overlay">
                    <div class="spinner"></div>
                </div>

                <div class="world-map-countries compact-grid">
                    <div class="wm-country-col">
                        <h4>üîº Sources</h4>
                        <template x-for="c in worldMap.source_countries?.slice(0, 5)" :key="c.iso || c.name">
                            <div class="wm-country-row" role="button" tabindex="0"
                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                @click="selectCountryForMap(c.iso || c.name)"
                                @keydown.enter="selectCountryForMap(c.iso || c.name)"
                                @keydown.space.prevent="selectCountryForMap(c.iso || c.name)"
                                :aria-label="'Select country ' + (c.name || c.iso)">
                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                <span class="wm-c-name" x-text="c.name"></span>
                                <span class="wm-c-val text-cyan" x-text="c.bytes_fmt"></span>
                            </div>
                        </template>
                    </div>
                    <div class="wm-country-col">
                        <h4>üîΩ Dests</h4>
                        <template x-for="c in worldMap.dest_countries?.slice(0, 5)" :key="c.iso || c.name">
                            <div class="wm-country-row" role="button" tabindex="0"
                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                @click="selectCountryForMap(c.iso || c.name)"
                                @keydown.enter="selectCountryForMap(c.iso || c.name)"
                                @keydown.space.prevent="selectCountryForMap(c.iso || c.name)"
                                :aria-label="'Select country ' + (c.name || c.iso)">
                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                <span class="wm-c-name" x-text="c.name"></span>
                                <span class="wm-c-val text-purple" x-text="c.bytes_fmt"></span>
                            </div>
                        </template>
                    </div>
                    <div class="wm-country-col">
                        <h4>‚ö†Ô∏è Threats</h4>
                        <template x-for="c in worldMap.threat_countries?.slice(0, 5)" :key="c.iso || c.name">
                            <div class="wm-country-row" role="button" tabindex="0"
                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                @click="selectCountryForMap(c.iso || c.name)"
                                @keydown.enter="selectCountryForMap(c.iso || c.name)"
                                @keydown.space.prevent="selectCountryForMap(c.iso || c.name)"
                                :aria-label="'Select country ' + (c.name || c.iso)">
                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                <span class="wm-c-name" x-text="c.name"></span>
                                <span class="wm-c-val text-red" x-text="c.bytes_fmt || c.count || 'N/A'"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            {% endcall %}
        </section>
    </div>

    <!-- Stat Drilldown Modal -->
    <div class="modal stat-drilldown-modal" x-show="statDetailOpen"
        :style="statDetailOpen ? 'display:flex' : 'display:none'"
        @click.self="statDetailOpen = false">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <template x-if="statDetail">
                <div>
                    <!-- Header -->
                    <div class="stat-drilldown-header">
                        <div>
                            <h2 x-text="statDetail.title"></h2>
                            <div class="stat-drilldown-meta">
                                <span class="stat-drilldown-value" x-text="statDetail.value"></span>
                                <span class="stat-drilldown-window" x-text="statDetail.window"></span>
                            </div>
                        </div>
                        <button @click="statDetailOpen = false" class="btn btn--secondary"
                            style="padding: var(--space-1) var(--space-2);">‚úï Close</button>
                    </div>

                    <!-- Verdict -->
                    <div class="stat-drilldown-verdict" :style="'border-left-color: ' + statDetail.verdict.color">
                        <strong>Assessment:</strong>
                        <span :style="'color: ' + statDetail.verdict.color" x-text="statDetail.verdict.label"></span>
                    </div>

                    <!-- Why this number (computation) -->
                    <template x-if="statDetail.computation">
                        <div class="stat-drilldown-why">
                            <strong>Why this number:</strong>
                            <span x-text="statDetail.computation"></span>
                        </div>
                    </template>

                    <!-- Breakdowns (if present) -->
                    <template x-if="statDetail.breakdowns && statDetail.breakdowns.length > 0">
                        <div class="stat-drilldown-section">
                            <div class="stat-drilldown-section-title">METRICS</div>
                            <div class="stat-drilldown-grid">
                                <template x-for="b in statDetail.breakdowns" :key="b.label">
                                    <div class="stat-drilldown-grid-item">
                                        <span class="stat-drilldown-grid-label" x-text="b.label"></span>
                                        <span class="stat-drilldown-grid-value" x-text="b.value"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Components (for Network State) -->
                    <template x-if="statDetail.components && statDetail.components.length > 0">
                        <div class="stat-drilldown-section">
                            <div class="stat-drilldown-section-title">COMPONENTS</div>
                            <div class="stat-drilldown-grid">
                                <template x-for="c in statDetail.components" :key="c.label">
                                    <div class="stat-drilldown-grid-item">
                                        <span class="stat-drilldown-grid-label" x-text="c.label"></span>
                                        <span class="stat-drilldown-grid-value" :style="'color: ' + c.color" x-text="c.status"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Top Contributors -->
                    <template x-if="statDetail.top && statDetail.top.length > 0">
                        <div class="stat-drilldown-section">
                            <div class="stat-drilldown-section-title">TOP CONTRIBUTORS</div>
                            <div class="stat-drilldown-table">
                                <template x-for="(item, idx) in statDetail.top" :key="idx">
                                    <div class="stat-drilldown-row">
                                        <div class="stat-drilldown-row-label" x-text="item.label"></div>
                                        <div class="stat-drilldown-row-value" x-text="item.value"></div>
                                        <template x-if="item.hint">
                                            <div class="stat-drilldown-row-hint" x-text="item.hint"></div>
                                        </template>
                                        <template x-if="item.action">
                                            <button @click="navigateToStatAction(item.action)" class="stat-drilldown-row-action">
                                                ‚Üí
                                            </button>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Next Actions -->
                    <template x-if="statDetail.actions && statDetail.actions.length > 0">
                        <div class="stat-drilldown-actions">
                            <template x-for="action in statDetail.actions" :key="action.label">
                                <button @click="navigateToStatAction(action); statDetailOpen = false;" class="btn btn--primary">
                                    üìä <span x-text="action.label"></span>
                                </button>
                            </template>
                        </div>
                    </template>

                    <!-- Demo mode indicator -->
                    <template x-if="isDemoMode()">
                        <div style="margin-top: var(--space-3); padding: var(--space-2); background: rgba(255, 200, 0, 0.1); border: 1px solid rgba(255, 200, 0, 0.3); border-radius: var(--radius-sm); font-size: var(--text-xs); color: var(--signal-warn);">
                            ‚ö†Ô∏è Demo mode: Sample data shown for testing
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
</div>