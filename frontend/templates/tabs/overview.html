<div x-show="activeTab === 'overview'" id="overview-tab" role="tabpanel" class="custom-scroll"
    style="display:none; height:100%; padding-bottom:40px; width:100%; margin:0; padding:20px; overflow-y: auto;"
    x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100">

    <!-- LEGACY HEADER METRICS (Restored) -->
    <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:var(--space-4); margin-bottom:var(--space-6);">
        <!-- 1. HEALTH -->
        <div class="card"
            style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:15px; background:rgba(20,20,25,0.6); border:1px solid var(--card-border);">
            <div style="font-size:1.1em; font-weight:600; color:var(--signal-ok); margin-bottom:4px;">Healthy</div>
            <div style="font-size:0.65em; color:var(--text-tertiary); letter-spacing:1px;">OVERALL HEALTH</div>
        </div>

        <!-- 2. ACTIVE ALERTS -->
        <div class="card"
            style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:15px; background:rgba(20,20,25,0.6); border:1px solid var(--card-border);">
            <div style="font-size:1.4em; font-weight:600; color:var(--text-primary); margin-bottom:2px;"
                x-text="alertHistory.active_count || '0'"></div>
            <div style="font-size:0.65em; color:var(--text-tertiary); letter-spacing:1px;">ACTIVE ALERTS</div>
        </div>

        <!-- 3. ACTIVE FLOWS -->
        <div class="card"
            style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:15px; background:rgba(20,20,25,0.6); border:1px solid var(--card-border);">
            <div style="display:flex; align-items:baseline; gap:4px; margin-bottom:2px;">
                <span style="font-size:1.4em; font-weight:600; color:var(--text-primary);"
                    x-text="formatNumOrDash(networkStatsOverview?.active_flows)"></span>
            </div>
            <div style="font-size:0.65em; color:var(--text-tertiary); letter-spacing:1px;">ACTIVE FLOWS</div>
        </div>

        <!-- 4. EXTERNAL CONNECTIONS -->
        <div class="card"
            style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:15px; background:rgba(20,20,25,0.6); border:1px solid var(--card-border);">
            <div style="display:flex; align-items:baseline; gap:4px; margin-bottom:2px;">
                <span style="font-size:1.4em; font-weight:600; color:var(--text-primary);"
                    x-text="formatNumOrDash(networkStatsOverview?.external_connections)"></span>
            </div>
            <div style="font-size:0.65em; color:var(--text-tertiary); letter-spacing:1px;">EXTERNAL CONNECTIONS</div>
        </div>

        <!-- 5. BLOCKED EVENTS -->
        <div class="card"
            style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:15px; background:rgba(20,20,25,0.6); border:1px solid var(--card-border);">
            <div style="display:flex; align-items:baseline; gap:4px; margin-bottom:2px;">
                <span style="font-size:1.4em; font-weight:600; color:var(--text-primary);"
                    x-text="formatNumOrDash(firewallStatsOverview?.blocked_events_24h)"></span>
            </div>
            <div style="font-size:0.65em; color:var(--text-tertiary); letter-spacing:1px;">BLOCKED EVENTS (24H)</div>
        </div>

        <!-- 6. ANOMALIES -->
        <div class="card"
            style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:15px; background:rgba(20,20,25,0.6); border:1px solid var(--card-border);">
            <div style="display:flex; align-items:baseline; gap:4px; margin-bottom:2px;">
                <span style="font-size:1.4em; font-weight:600; color:var(--signal-warn);"
                    x-text="formatNumOrDash(networkStatsOverview?.anomalies_count)"></span>
            </div>
            <div style="font-size:0.65em; color:var(--text-tertiary); letter-spacing:1px;">NETWORK ANOMALIES</div>
        </div>
    </div>


    <!-- LEGACY WIDGETS RESTORED (Context & Deep Dive) -->
    <div style="margin-top: 0; padding-top: 0;">
        <!-- Bandwidth Chart (Conditional) -->
        <template x-if="isVisible('bandwidth')">
            {% call widget_card('bandwidth', 'Bandwidth & Flow Rate', 'üìä',
            period_x_text='global_time_range') %}
            <!-- Mobile Toggle for Bandwidth Chart -->
            <div class="mobile-chart-toggle" x-data="{ collapsed: window.innerWidth <= 768 }">
                <button class="world-map-toggle" style="margin-bottom: 12px;" x-show="window.innerWidth <= 768"
                    @click="collapsed = !collapsed">
                    <span x-text="collapsed ? 'üìä Show Chart' : 'üìä Hide Chart'"></span>
                </button>
                <div class="chart-wrapper chart-expandable" x-show="!collapsed || window.innerWidth > 768"
                    @click="openFullscreenChart('bwChart', 'Bandwidth & Flow Rate')" title="Click to expand">
                    <canvas id="bwChart"></canvas>
                </div>
            </div>
            {% endcall %}
        </template>
    </div>

    <div style="margin-top: var(--space-6);">
        {% call widget_card('threatPulse', 'Threat Pulse', 'üì°', min_height='220px') %}
        <div class="pulse-container" x-data="{
            pulseHistory: new Array(40).fill(50),
            pulsePhase: 0,
            pulseSpeed: 0.05,
            healthStatus: 'STABLE',
            initPulse() {
                try {
                    // Animation loop for EKG
                    const update = () => {
                        this.pulsePhase += this.pulseSpeed;
                        
                        // Base rhythm
                        let val = 50;
                        const p = this.pulsePhase % (Math.PI * 2);
                        
                        // Heartbeat spike
                        if (p > 5.8 && p < 6.2) {
                            val = 50 - Math.sin((p - 5.8) * 20) * 35;
                        }
                        
                        // Add some noise based on threat level
                        if (this.healthStatus !== 'STABLE') {
                            val += (Math.random() - 0.5) * 10;
                        }
                        
                        this.pulseHistory.push(val);
                        if (this.pulseHistory.length > 40) this.pulseHistory.shift();
                        
                        requestAnimationFrame(update);
                    };
                    requestAnimationFrame(update);
                    
                    // Watch for metric changes to adjust heartbeat
                    this.$watch('radar.metrics', (m) => {
                        if (!m) return;
                        const threats = (m.anomalies_24h || 0) + (m.active_alerts || 0);
                        if (threats > 10) {
                            this.healthStatus = 'CRITICAL';
                            this.pulseSpeed = 0.15;
                        } else if (threats > 0) {
                            this.healthStatus = 'ELEVATED';
                            this.pulseSpeed = 0.08;
                        } else {
                            this.healthStatus = 'STABLE';
                            this.pulseSpeed = 0.05;
                        }
                    });
                } catch (e) { console.error('Pulse Init Error', e); }
            },
            getPulsePath() {
                // Generate SVG path from history
                return 'M 0 50 ' + this.pulseHistory.map((v, i) => `L ${i * (100/40)} ${v}`).join(' ');
            }
        }" x-init="initPulse()">

            <!-- Radar Section -->
            <div class="radar-scope">
                <div class="radar-grid-ring" style="width: 70%; height: 70%;"></div>
                <div class="radar-grid-ring" style="width: 35%; height: 35%;"></div>
                <div class="radar-sweep"></div>

                <!-- Dynamic Blips from WorldMap Threats -->
                <template x-for="(country, idx) in worldMap.threat_countries?.slice(0, 5) || []" :key="idx">
                    <div class="radar-blip"
                        :style="`top: ${50 + Math.sin(idx * 2) * (20 + idx * 8)}%; left: ${50 + Math.cos(idx * 2) * (20 + idx * 8)}%; animation-delay: ${idx * 0.5}s`">
                    </div>
                </template>
            </div>

            <!-- Pulse Readout Section -->
            <div class="pulse-readout">
                <div class="pulse-sig-container">
                    <div class="pulse-grid"></div>
                    <svg width="100%" height="100%" preserveAspectRatio="none">
                        <path :d="getPulsePath()" class="pulse-line" :class="{ 
                                  'elevated': healthStatus === 'ELEVATED', 
                                  'critical': healthStatus === 'CRITICAL' 
                              }"></path>
                    </svg>
                </div>

                <div class="pulse-status">
                    <div class="pulse-label">SYSTEM STATUS</div>
                    <div class="pulse-val" x-text="healthStatus" :class="{ 
                             'elevated': healthStatus === 'ELEVATED', 
                             'critical': healthStatus === 'CRITICAL' 
                         }"></div>
                </div>
                <div class="pulse-status" style="margin-top: 4px;">
                    <div class="pulse-label">THREAT LEVEL</div>
                    <div class="pulse-label" x-text="(radar.metrics?.anomalies_24h || 0) + ' DETECTIONS'"></div>
                </div>
            </div>
        </div>
        {% endcall %}
    </div>

    <div style="margin-top: var(--space-6);">
        <!-- World Map Section -->
        <section id="section-worldmap" class="scroll-section">
            <!-- Logic for World Map (Same as Step 141) -->
            {% set wm_actions %}
            <div class="world-map-mode-toggle">
                <button class="world-map-mode-btn" :class="{ 'active': worldMapMode === 'traffic' }"
                    @click="worldMapMode = 'traffic'" title="Traffic view - balanced emphasis">
                    Traffic
                </button>
                <button class="world-map-mode-btn" :class="{ 'active': worldMapMode === 'exposure' }"
                    @click="worldMapMode = 'exposure'" title="Exposure view - emphasize destinations">
                    Exposure
                </button>
                <button class="world-map-mode-btn" :class="{ 'active': worldMapMode === 'attacks' }"
                    @click="worldMapMode = 'attacks'" title="View Threats & Blocked traffic">
                    Threats & Blocks
                </button>
            </div>
            <div class="world-map-layer-toggles">
                <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.sources }"
                    title="Toggle Sources layer">
                    <input type="checkbox" x-model="worldMapLayers.sources">
                    <span class="layer-dot layer-dot-cyan"></span>
                    <span class="layer-label">Sources</span>
                </label>
                <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.destinations }"
                    title="Toggle Destinations layer">
                    <input type="checkbox" x-model="worldMapLayers.destinations">
                    <span class="layer-dot layer-dot-purple"></span>
                    <span class="layer-label">Destinations</span>
                </label>
                <label class="world-map-layer-toggle" :class="{ 'active': worldMapLayers.threats }"
                    title="Toggle Threats layer">
                    <input type="checkbox" x-model="worldMapLayers.threats">
                    <span class="layer-dot layer-dot-red"></span>
                    <span class="layer-label">Threats</span>
                </label>
            </div>
            <button class="world-map-reset-btn" @click="resetWorldMapView()" title="Reset map view">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                </svg>
                Reset
            </button>
            {% endset %}

            {% set wm_title %}
            <div>
                <span>Traffic World Map</span>
                <span x-show="mapStatus" x-text="'[' + mapStatus + ']'" class="text-75 text-yellow ml-2"></span>
            </div>
            {% endset %}

            {% call widget_card('worldmap', wm_title, 'üó∫Ô∏è', card_class='wide-card world-map-card',
            extra_actions=wm_actions) %}
            <div class="world-map-container" style="min-height: 400px;">
                <div id="world-map-svg" class="world-map-svg"></div>
                <div x-show="worldMap.loading" class="spinner-overlay">
                    <div class="spinner"></div>
                </div>

                <div class="world-map-countries compact-grid">
                    <div class="wm-country-col">
                        <h4>üîº Sources</h4>
                        <template x-for="c in worldMap.source_countries?.slice(0, 5)" :key="c.iso || c.name">
                            <div class="wm-country-row"
                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                @click="selectCountryForMap(c.iso || c.name)">
                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                <span class="wm-c-name" x-text="c.name"></span>
                                <span class="wm-c-val text-cyan" x-text="c.bytes_fmt"></span>
                            </div>
                        </template>
                    </div>
                    <div class="wm-country-col">
                        <h4>üîΩ Dests</h4>
                        <template x-for="c in worldMap.dest_countries?.slice(0, 5)" :key="c.iso || c.name">
                            <div class="wm-country-row"
                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                @click="selectCountryForMap(c.iso || c.name)">
                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                <span class="wm-c-name" x-text="c.name"></span>
                                <span class="wm-c-val text-purple" x-text="c.bytes_fmt"></span>
                            </div>
                        </template>
                    </div>
                    <div class="wm-country-col">
                        <h4>‚ö†Ô∏è Threats</h4>
                        <template x-for="c in worldMap.threat_countries?.slice(0, 5)" :key="c.iso || c.name">
                            <div class="wm-country-row"
                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                @click="selectCountryForMap(c.iso || c.name)">
                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                <span class="wm-c-name" x-text="c.name"></span>
                                <span class="wm-c-val text-red" x-text="c.bytes_fmt || c.count || 'N/A'"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            {% endcall %}
        </section>
    </div>
</div>