                                <!-- Mobile Toggle for Bandwidth Chart -->
                                <div class="mobile-chart-toggle" x-data="{ collapsed: window.innerWidth <= 768 }">
                                    <button class="world-map-toggle" style="margin-bottom: 12px;"
                                        x-show="window.innerWidth <= 768" @click="collapsed = !collapsed">
                                        <span x-text="collapsed ? 'üìä Show Chart' : 'üìä Hide Chart'"></span>
                                    </button>
                                    <div class="chart-wrapper chart-expandable"
                                        x-show="!collapsed || window.innerWidth > 768"
                                        @click="openFullscreenChart('bwChart', 'Bandwidth & Flow Rate')"
                                        title="Click to expand">
                                        <canvas id="bwChart"></canvas>
                                    </div>
                                </div>
                                {% endcall %}
                            </template>

                        </section>


                        <!-- World Map Section -->
                        <section id="section-worldmap" class="scroll-section">
                            <!-- Mobile Toggle (hidden on desktop) -->
                            <button class="world-map-toggle" @click="worldMapMobileVisible = !worldMapMobileVisible"
                                :class="{ 'active': worldMapMobileVisible }" style="display: none;"
                                x-show="window.innerWidth <= 768">
                                <span
                                    x-text="worldMapMobileVisible ? 'üó∫Ô∏è Hide World Map' : 'üó∫Ô∏è Show World Map'"></span>
                            </button>

                            {% set wm_actions %}{% endset %}

                            {% set wm_title %}
                            <div>
                                <span>Traffic World Map</span>
                                <span x-show="mapStatus" x-text="'[' + mapStatus + ']'"
                                    class="text-75 text-yellow ml-2"></span>
                                <div style="font-size: 0.75em; color: var(--text-secondary); font-weight: normal; margin-top: 2px;"
                                    x-text="'Based on selected time range'"></div>
                            </div>
                            {% endset %}
                            <div x-show="window.innerWidth > 768 || worldMapMobileVisible">
                                {% call widget_card('worldmap', wm_title, 'üó∫Ô∏è', card_class='wide-card world-map-card',
                                extra_actions=wm_actions) %}
                                <!-- Map Controls -->
                                <div class="world-map-controls">
                                    <div class="world-map-mode-toggle">
                                        <button class="world-map-mode-btn"
                                            :class="{ 'active': worldMapMode === 'traffic' }"
                                            @click="worldMapMode = 'traffic'" title="Traffic view - balanced emphasis">
                                            Traffic
                                        </button>
                                        <button class="world-map-mode-btn"
                                            :class="{ 'active': worldMapMode === 'exposure' }"
                                            @click="worldMapMode = 'exposure'"
                                            title="Exposure view - emphasize destinations">
                                            Exposure
                                        </button>
                                        <button class="world-map-mode-btn"
                                            :class="{ 'active': worldMapMode === 'attacks' }"
                                            @click="worldMapMode = 'attacks'" title="View Threats & Blocked traffic">
                                            Threats & Blocks
                                        </button>
                                    </div>
                                    <div class="world-map-layer-toggles">
                                        <label class="world-map-layer-toggle"
                                            :class="{ 'active': worldMapLayers.sources }" title="Toggle Sources layer">
                                            <input type="checkbox" x-model="worldMapLayers.sources">
                                            <span class="layer-dot layer-dot-cyan"></span>
                                            <span class="layer-label">Sources</span>
                                        </label>
                                        <label class="world-map-layer-toggle"
                                            :class="{ 'active': worldMapLayers.destinations }"
                                            title="Toggle Destinations layer">
                                            <input type="checkbox" x-model="worldMapLayers.destinations">
                                            <span class="layer-dot layer-dot-purple"></span>
                                            <span class="layer-label">Destinations</span>
                                        </label>
                                        <label class="world-map-layer-toggle"
                                            :class="{ 'active': worldMapLayers.threats }" title="Toggle Threats layer">
                                            <input type="checkbox" x-model="worldMapLayers.threats">
                                            <span class="layer-dot layer-dot-red"></span>
                                            <span class="layer-label">Threats</span>
                                        </label>
                                    </div>
                                    <button class="world-map-reset-btn" @click="resetWorldMapView()"
                                        title="Reset map view">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 6v6l4 2"></path>
                                        </svg>
                                        Reset
                                    </button>
                                </div>
                                <div class="world-map-container">
                                    <div id="world-map-svg" class="world-map-svg"></div>
                                    <div x-show="worldMap.loading" class="spinner-overlay">
                                        <div class="spinner"></div>
                                    </div>
                                    <div x-show="worldMap.error" class="error-overlay"
                                        style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:red; display:flex; align-items:center; justify-content:center; z-index:10;"
                                        x-text="worldMap.error"></div>
                                </div>
                                <!-- Country Stats (Interactive) -->
                                <div class="world-map-countries compact-grid">
                                    <div class="wm-country-col">
                                        <h4>üîº Sources</h4>
                                        <template x-for="c in worldMap.source_countries?.slice(0, 5)"
                                            :key="c.iso || c.name">
                                            <div class="wm-country-row"
                                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                                @click="selectCountryForMap(c.iso || c.name)"
                                                style="cursor: pointer; transition: background-color var(--transition-base); padding: var(--space-2); border-radius: var(--radius-sm);"
                                                :style="worldMapSelectedCountry === (c.iso || c.name) ? 'background-color: var(--bg-2); border-left: 2px solid var(--signal-primary);' : ''"
                                                :title="worldMapSelectedCountry === (c.iso || c.name) ? 'Click to deselect' : 'Click to highlight on map'">
                                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                                <span class="wm-c-name" x-text="c.name"></span>
                                                <span class="wm-c-val text-cyan" x-text="c.bytes_fmt"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="wm-country-col">
                                        <h4>üîΩ Dests</h4>
                                        <template x-for="c in worldMap.dest_countries?.slice(0, 5)"
                                            :key="c.iso || c.name">
                                            <div class="wm-country-row"
                                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                                @click="selectCountryForMap(c.iso || c.name)"
                                                style="cursor: pointer; transition: background-color var(--transition-base); padding: var(--space-2); border-radius: var(--radius-sm);"
                                                :style="worldMapSelectedCountry === (c.iso || c.name) ? 'background-color: var(--bg-2); border-left: 2px solid var(--signal-tertiary);' : ''"
                                                :title="worldMapSelectedCountry === (c.iso || c.name) ? 'Click to deselect' : 'Click to highlight on map'">
                                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                                <span class="wm-c-name" x-text="c.name"></span>
                                                <span class="wm-c-val text-purple" x-text="c.bytes_fmt"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="wm-country-col">
                                        <h4>‚ö†Ô∏è Threats</h4>
                                        <template x-for="c in worldMap.threat_countries?.slice(0, 5)"
                                            :key="c.iso || c.name">
                                            <div class="wm-country-row"
                                                :class="{ 'selected': worldMapSelectedCountry === (c.iso || c.name) }"
                                                @click="selectCountryForMap(c.iso || c.name)"
                                                style="cursor: pointer; transition: background-color var(--transition-base); padding: var(--space-2); border-radius: var(--radius-sm);"
                                                :style="worldMapSelectedCountry === (c.iso || c.name) ? 'background-color: var(--bg-2); border-left: 2px solid var(--signal-crit);' : ''"
                                                :title="worldMapSelectedCountry === (c.iso || c.name) ? 'Click to deselect' : 'Click to highlight on map'">
                                                <span x-text="flagFromIso(c.iso || '??')"></span>
                                                <span class="wm-c-name" x-text="c.name"></span>
                                                <span class="wm-c-val text-red"
                                                    x-text="c.bytes_fmt || c.count || 'N/A'"></span>
                                            </div>
                                        </template>
                                        <template
                                            x-if="!worldMap.threat_countries || worldMap.threat_countries.length === 0">
                                            <div class="wm-country-row">
                                                <span class="wm-c-name" style="opacity: 0.6;">No threats</span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                {% endcall %}
                            </div>
                        </section>
                    </div>

                    <!-- ============================================
             SECURITY TAB
             ============================================ -->
                    <div x-show="activeTab === 'security'"
                        :style="activeTab === 'security' ? 'display:block' : 'display:none'" id="security-tab"
                        role="tabpanel" aria-labelledby="security-tab-btn" tabindex="0">
                        <!-- ============================================
             SECURITY CENTER
             ============================================ -->
                        <section id="section-security" class="scroll-section mb-8">
                            <!-- Security Summary Stats -->
                            <div class="grid mb-6 grid-auto-fit">
                                <div class="card stat-box">
                                    <div class="value"
                                        :style="'color: ' + getStateColor(securityObservability.overall_state || 'unknown')"
                                        x-text="securityObservability.overall_state || 'UNKNOWN'"></div>
                                    <div class="label">Security State</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="feedHealth.summary?.ok || 0"></div>
                                    <div class="label">Feeds OK</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="(feedHealth.summary?.total_ips || 0).toLocaleString()">
                                    </div>
                                    <div class="label">Blocklist IPs</div>
                                </div>
                                <div class="card stat-box">
                                    <div class="value" x-text="alertHistory.total || 0"></div>
                                    <div class="label">Alerts 24h</div>
                                </div>
                            </div>

                            <!-- Security Actions -->
                            <div class="flex gap-2 mb-6 flex-wrap">
                                <button class="btn-sm" @click="watchlistModalOpen = true"
                                    aria-label="Manage watchlist">üëÅÔ∏è
                                    Watchlist</button>
                                <button class="btn-sm" @click="exportThreats('csv')"
                                    aria-label="Export threats as CSV">üì•
                                    Export</button>
                                <button class="btn-sm" @click="refreshFeed()" aria-label="Refresh threat feeds">üîÑ
                                    Refresh</button>
                            </div>

                            <!-- Security Widgets Grid -->
                            <div class="security-grid">

                                <!-- Security Observability Widget -->
                                <template x-if="isVisible('securityObservability')">
                                    {% call widget_card('securityObservability', 'Security Observability', 'üîç',
                                    show_spinner=True,
                                    card_class="security-observability-card") %}
                                    <!-- Authority Header -->
                                    <div class="authority-header-compact">
                                        <div class="current-state-dominant">
                                            <span class="authority-label">CURRENT STATE:</span>
                                            <span class="authority-value"
                                                :style="'color: ' + getStateColor(securityObservability.overall_state || 'unknown')"
                                                x-text="securityObservability.overall_state || 'UNKNOWN'"></span>
                                        </div>
                                        <div class="state-explanation">
                                            <span class="explanation-text">Detection confidence reduced (2 feeds
                                                unavailable)</span>
                                        </div>
                                    </div>
                                    <div class="observability-display">

                                        <!-- Compact Cause & Signals -->
                                        <div class="compact-signals">
                                            <!-- One-Line Cause -->
                                            <div class="cause-compact">
                                                <span class="cause-label">Primary limitation:</span>
                                                <span class="cause-text">Threat intelligence coverage gaps (2/13
                                                    feeds)</span>
                                            </div>

                                            <!-- Compact Signals List -->
                                            <div class="signals-list-compact">
                                                <template
                                                    x-if="securityObservability.protection_signals && securityObservability.protection_signals.length > 0">
                                                    <div class="signal-item-compact">
                                                        <span class="signal-icon">üõ°Ô∏è</span>
                                                        <span class="signal-text">Active (230 threats blocked)</span>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="securityObservability.exposure_signals && securityObservability.exposure_signals.length > 0">
                                                    <div class="signal-item-compact">
                                                        <span class="signal-icon">‚ö†Ô∏è</span>
                                                        <span class="signal-text">Elevated (~2√ó baseline attacks)</span>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="securityObservability.data_quality_signals && securityObservability.data_quality_signals.length > 0">
                                                    <div class="signal-item-compact critical">
                                                        <span class="signal-icon">üìä</span>
                                                        <span class="signal-text">Limited (unknown IP visibility)</span>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Details Toggle -->
                                            <div class="details-toggle">
                                                <button class="toggle-button"
                                                    @click="showObservabilityDetails = !showObservabilityDetails">
                                                    <span
                                                        x-text="showObservabilityDetails ? 'Hide details' : 'View details'"></span>
                                                </button>
                                            </div>

                                            <!-- Expandable Details (Hidden by default) -->
                                            <div class="details-section" x-show="showObservabilityDetails" x-transition>
                                                <div class="details-content">
                                                    <template
                                                        x-if="securityObservability.protection_signals && securityObservability.protection_signals.length > 0">
                                                        <div class="detail-group">
                                                            <div class="detail-title">Protection Status</div>
                                                            <template
                                                                x-for="signal in securityObservability.protection_signals"
                                                                :key="signal">
                                                                <div class="detail-item">No unblocked or bypassed
                                                                    attacks observed</div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="securityObservability.exposure_signals && securityObservability.exposure_signals.length > 0">
                                                        <div class="detail-group">
                                                            <div class="detail-title">Exposure Analysis</div>
                                                            <template
                                                                x-for="signal in securityObservability.exposure_signals"
                                                                :key="signal">
                                                                <div class="detail-item">Inbound attacks increased 2√ó
                                                                    over 6-hour baseline</div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="securityObservability.data_quality_signals && securityObservability.data_quality_signals.length > 0">
                                                        <div class="detail-group">
                                                            <div class="detail-title">Data Quality Impact</div>
                                                            <template
                                                                x-for="signal in securityObservability.data_quality_signals"
                                                                :key="signal">
                                                                <div class="detail-item">Unknown IP classification
                                                                    confidence reduced</div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endcall %}
                                </template>

                                <!-- Alert History Widget -->
                                <template x-if="isVisible('alertHistory')">
                                    {% call widget_card('alertHistory', 'Alert History (24h)', 'üîî', show_spinner=True)
                                    %}
                                    <!-- Alert Filters -->
                                    <div class="alert-filters">
                                        <select x-model="alertFilter.severity" class="filter-select"
                                            aria-label="Filter alerts by severity">
                                            <option value="all">All Severities</option>
                                            <option value="critical">üî¥ Critical</option>
                                            <option value="high">üü† High</option>
                                            <option value="medium">üü° Medium</option>
                                            <option value="low">üü¢ Low</option>
                                        </select>
                                        <select x-model="alertFilter.type" class="filter-select"
                                            aria-label="Filter alerts by type">
                                            <option value="all">All Types</option>
                                            <option value="threat_ip">Threat IP</option>
                                            <option value="port_scan">Port Scan</option>
                                            <option value="brute_force">Brute Force</option>
                                            <option value="data_exfil">Data Exfil</option>
                                            <option value="dns_tunneling">DNS Tunneling</option>
                                            <option value="lateral_movement">Lateral Movement</option>
                                            <option value="suspicious_port">Suspicious Port</option>
                                            <option value="large_transfer">Large Transfer</option>
                                            <option value="off_hours">Off-Hours</option>
                                            <option value="watchlist">Watchlist</option>
                                        </select>
                                    </div>
