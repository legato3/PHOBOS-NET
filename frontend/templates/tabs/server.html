<div x-show="activeTab === 'server'" :style="activeTab === 'server' ? 'display:block' : 'display:none'" id="server-tab"
    role="tabpanel" aria-labelledby="server-tab-btn" tabindex="0">
    <section id="section-server" class="scroll-section" style="margin-bottom: 32px;">
        <!-- Loading State -->
        <template x-if="serverHealth.loading && !serverHealth.timestamp">
            <div class="empty-state">
                <span>Loading server health data...</span>
            </div>
        </template>

        <!-- Error State -->
        <template x-if="serverHealth.error && !serverHealth.loading">
            <div class="empty-state" style="color: var(--signal-crit);">
                <span x-text="serverHealth.error"></span>
            </div>
        </template>

        <!-- Server Health Content -->
        <template x-if="!serverHealth.error || serverHealth.timestamp">
            <div>
                <!-- ═══════════════════════════════════════════════════════════
                     HOST STRIP - Compact horizontal system vitals bar
                ═══════════════════════════════════════════════════════════ -->
                <div class="card"
                    style="padding: 14px 20px; margin-bottom: 20px; flex-direction: row !important; flex-wrap: wrap; align-items: center; gap: 24px;">
                    <span class="status-pill" :class="{
                        'status-pill-ok': (serverHealth.cpu?.percent || 0) < 70 && (serverHealth.memory?.percent || 0) < 80,
                        'status-pill-warn': ((serverHealth.cpu?.percent || 0) >= 70 || (serverHealth.memory?.percent || 0) >= 80) && !((serverHealth.cpu?.percent || 0) >= 90 || (serverHealth.memory?.percent || 0) >= 90),
                        'status-pill-crit': (serverHealth.cpu?.percent || 0) >= 90 || (serverHealth.memory?.percent || 0) >= 90
                    }"
                        x-text="(serverHealth.cpu?.percent || 0) >= 90 || (serverHealth.memory?.percent || 0) >= 90 ? 'CRITICAL' : ((serverHealth.cpu?.percent || 0) >= 70 || (serverHealth.memory?.percent || 0) >= 80 ? 'ELEVATED' : 'HEALTHY')"></span>

                    <span style="display: inline-flex; gap: 6px; align-items: baseline;"><span
                            class="text-muted text-8">Host</span><span
                            x-text="serverHealth.system?.hostname || '—'"></span></span>
                    <span style="display: inline-flex; gap: 6px; align-items: baseline;"><span
                            class="text-muted text-8">Uptime</span><span
                            x-text="serverHealth.system?.uptime_formatted || '—'"></span></span>
                    <span style="display: inline-flex; gap: 6px; align-items: baseline;"><span
                            class="text-muted text-8">OS</span><span class="text-1 text-85"
                            x-text="serverHealth.system?.os_info || '—'"></span></span>
                    <span style="flex: 1; min-width: 20px;"></span>
                    <span style="display: inline-flex; gap: 6px; align-items: baseline;"><span
                            class="text-muted text-8">CPU</span><span
                            :class="{'text-ok': (serverHealth.cpu?.percent || 0) < 70, 'text-warn': (serverHealth.cpu?.percent || 0) >= 70 && (serverHealth.cpu?.percent || 0) < 90, 'text-crit': (serverHealth.cpu?.percent || 0) >= 90}"
                            x-text="(serverHealth.cpu?.percent ?? '—') + '%'"></span></span>
                    <span style="display: inline-flex; gap: 6px; align-items: baseline;"><span
                            class="text-muted text-8">Mem</span><span
                            :class="{'text-ok': (serverHealth.memory?.percent || 0) < 80, 'text-warn': (serverHealth.memory?.percent || 0) >= 80 && (serverHealth.memory?.percent || 0) < 90, 'text-crit': (serverHealth.memory?.percent || 0) >= 90}"
                            x-text="(serverHealth.memory?.percent ?? '—') + '%'"></span></span>
                    <span style="display: inline-flex; gap: 6px; align-items: baseline;"><span
                            class="text-muted text-8">Disk</span><span
                            :class="{'text-ok': (serverHealth.disk?.root?.percent_used || 0) < 80, 'text-warn': (serverHealth.disk?.root?.percent_used || 0) >= 80 && (serverHealth.disk?.root?.percent_used || 0) < 90, 'text-crit': (serverHealth.disk?.root?.percent_used || 0) >= 90}"
                            x-text="(serverHealth.disk?.root?.percent_used ?? '—') + '%'"></span></span>
                    <span style="display: inline-flex; gap: 6px; align-items: baseline;"><span
                            class="text-muted text-8">Load</span><span class="text-1 text-85"
                            x-text="(serverHealth.cpu?.load_1min || '—') + ' / ' + (serverHealth.cpu?.load_5min || '—') + ' / ' + (serverHealth.cpu?.load_15min || '—')"></span></span>
                </div>

                <!-- ═══════════════════════════════════════════════════════════
                     INGESTION PIPELINES - Primary focus area
                ═══════════════════════════════════════════════════════════ -->
                {% from "components/status_card.html" import status_card %}

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
                    <!-- NetFlow Pipeline -->
                    {{ status_card(
                    title='NetFlow',
                    meta_items=['UDP 2055'],
                    state={
                    'class_expr': "serverHealth.netflow?.available ? 'status-ok' : 'status-crit'",
                    'text_expr': "serverHealth.netflow?.available ? 'ACTIVE' : 'OFFLINE'"
                    },
                    hero={
                    'value_expr': "ingestionRates?.netflow_eps !== undefined ? ingestionRates.netflow_eps : '—'",
                    'unit': 'EPS'
                    },
                    stats=[
                    {
                    'label': 'FILES',
                    'value_expr': "serverHealth.netflow?.files_count?.toLocaleString() ?? '—'",
                    'subvalue_expr': "''"
                    },
                    {
                    'label': 'FLOWS',
                    'value_expr': "serverHealth.netflow?.total_flows?.toLocaleString() ?? '—'",
                    'subvalue_expr': "serverHealth.netflow?.files_count > 0 ? 'AVG ' +
                    Math.round((serverHealth.netflow?.total_flows || 0) /
                    serverHealth.netflow.files_count).toLocaleString() + '/FILE' : 'AVG —'",
                    'primary': true
                    },
                    {
                    'label': 'ERRORS',
                    'value_expr': "serverHealth.netflow?.errors ?? '0'",
                    'value_class_expr': "(serverHealth.netflow?.errors || 0) > 0 ? 'text-warn' : ''",
                    'subvalue_expr': "''"
                    },
                    {
                    'label': 'LAST',
                    'value_expr': "serverHealth.netflow?.last_file ? serverHealth.netflow.last_file.split(' ').pop() :
                    '—'",
                    'subvalue_expr': "''"
                    }
                    ]
                    ) }}

                    <!-- Filterlog (UDP 514) -->
                    {{ status_card(
                    title='Filterlog',
                    meta_items=['UDP 514'],
                    state={
                    'class_expr': "serverHealth.syslog?.active ? 'status-active' : 'status-crit'",
                    'text_expr': "serverHealth.syslog?.active ? 'ACTIVE' : 'INACTIVE'"
                    },
                    hero={
                    'value_expr': "ingestionRates?.syslog_eps !== undefined ? ingestionRates.syslog_eps : '—'",
                    'unit': 'EPS'
                    },
                    stats=[
                    {
                    'label': 'RCVD',
                    'value_expr': "serverHealth.syslog?.received?.toLocaleString() ?? '0'",
                    'subvalue_expr': "''"
                    },
                    {
                    'label': 'PARSED',
                    'value_expr': "serverHealth.syslog?.parsed?.toLocaleString() ?? '0'",
                    'subvalue_expr': "serverHealth.syslog?.received > 0 ? 'EFF ' + ((serverHealth.syslog?.parsed || 0) /
                    serverHealth.syslog.received * 100).toFixed(0) + '%' : 'EFF —'",
                    'primary': true
                    },
                    {
                    'label': 'ERRORS',
                    'value_expr': "serverHealth.syslog?.errors ?? '0'",
                    'value_class_expr': "(serverHealth.syslog?.errors || 0) > 0 ? 'text-warn' : ''",
                    'subvalue_expr': "''"
                    },
                    {
                    'label': 'LAST',
                    'value_expr': "serverHealth.syslog?.last_event ? serverHealth.syslog.last_event.split(' ').pop() :
                    '—'",
                    'subvalue_expr': "''"
                    }
                    ]
                    ) }}

                    <!-- Firewall (UDP 515) -->
                    {{ status_card(
                    title='Firewall',
                    meta_items=['UDP 515'],
                    state={
                    'class_expr': "serverHealth.firewall_syslog?.active ? 'status-active' : 'status-crit'",
                    'text_expr': "serverHealth.firewall_syslog?.active ? 'ACTIVE' : 'INACTIVE'"
                    },
                    hero={
                    'value_expr': "ingestionRates?.firewall_eps !== undefined ? ingestionRates.firewall_eps : '—'",
                    'unit': 'EPS'
                    },
                    stats=[
                    {
                    'label': 'RCVD',
                    'value_expr': "serverHealth.firewall_syslog?.received?.toLocaleString() ?? '0'",
                    'subvalue_expr': "''",
                    'primary': true
                    },
                    {
                    'label': 'PARSED',
                    'value_expr': "serverHealth.firewall_syslog?.parsed?.toLocaleString() ?? '0'",
                    'subvalue_expr': "''"
                    },
                    {
                    'label': 'ERRORS',
                    'value_expr': "serverHealth.firewall_syslog?.errors ?? '0'",
                    'value_class_expr': "(serverHealth.firewall_syslog?.errors || 0) > 0 ? 'text-warn' : ''",
                    'subvalue_expr': "''"
                    },
                    {
                    'label': 'LAST',
                    'value_expr': "serverHealth.firewall_syslog?.last_event ?
                    serverHealth.firewall_syslog.last_event.split(' ').pop() : '—'",
                    'subvalue_expr': "''"
                    }
                    ]
                    ) }}
                </div>

                <!-- ═══════════════════════════════════════════════════════════
                     APPLICATION INTERNALS - Separate cards
                ═══════════════════════════════════════════════════════════ -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    {% from "components/panel_card.html" import panel_card %}

                    <!-- Services Card -->
                    {% call panel_card(title='Services', meta_items=[]) %}
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-muted text-8">nfcapd</span>
                            <span :class="monitoringSummary.dependencies?.nfcapd?.running ? 'text-ok' : 'text-crit'"
                                x-text="monitoringSummary.dependencies?.nfcapd?.running ? 'Running' : 'Stopped'"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-muted text-8">Syslog 514</span>
                            <span
                                :class="monitoringSummary.dependencies?.syslog_514?.listening ? 'text-cyan' : 'text-crit'"
                                x-text="monitoringSummary.dependencies?.syslog_514?.listening ? 'Listening' : 'Down'"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-muted text-8">Syslog 515</span>
                            <span
                                :class="monitoringSummary.dependencies?.syslog_515?.listening ? 'text-cyan' : 'text-crit'"
                                x-text="monitoringSummary.dependencies?.syslog_515?.listening ? 'Listening' : 'Down'"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-muted text-8">Threads</span>
                            <span
                                :class="monitoringSummary.thread_health?.ok === monitoringSummary.thread_health?.total ? 'text-ok' : 'text-warn'"
                                x-text="(monitoringSummary.thread_health?.ok || 0) + '/' + (monitoringSummary.thread_health?.total || 0)"></span>
                        </div>
                    </div>
                    {% endcall %}

                    <!-- Process & Cache Card -->
                    {% call panel_card(title='Process / Cache', meta_items=[]) %}
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; justify-content: space-between;"><span
                                class="text-muted text-8">Process</span><span
                                x-text="serverHealth.system?.process_name || 'gunicorn'"></span></div>
                        <div style="display: flex; justify-content: space-between;"><span
                                class="text-muted text-8">Memory</span><span
                                x-text="serverHealth.process?.process_memory_mb ? serverHealth.process.process_memory_mb + ' MB' : '—'"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;"><span
                                class="text-muted text-8">Threads</span><span
                                x-text="serverHealth.process?.threads || serverHealth.system?.process_threads || '—'"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;"><span
                                class="text-muted text-8">Total Cache</span><span
                                x-text="((serverHealth.cache?.dns_cache_size || 0) + (serverHealth.cache?.geo_cache_size || 0) + (serverHealth.cache?.common_cache_size || 0)).toLocaleString()"></span>
                        </div>
                        <div class="text-2 text-8" style="margin-top: 4px;">DNS: <span
                                x-text="serverHealth.cache?.dns_cache_size?.toLocaleString() || '0'"></span> · Geo:
                            <span x-text="serverHealth.cache?.geo_cache_size?.toLocaleString() || '0'"></span> ·
                            Common: <span
                                x-text="serverHealth.cache?.common_cache_size?.toLocaleString() || '0'"></span>
                        </div>
                    </div>
                    {% endcall %}

                    <!-- HTTP Metrics Card -->
                    {{ status_card(
                    title='HTTP Traffic',
                    meta_items=['TCP 3434'],
                    state={
                    'class_expr': "(monitoringSummary.http?.error_rate_percent || 0) < 1 ? 'status-ok' :
                        ((monitoringSummary.http?.error_rate_percent || 0) < 5 ? 'status-warn' : 'status-crit'
                        )", 'text_expr'
                        : "(monitoringSummary.http?.error_rate_percent || 0) < 1 ? 'HEALTHY' : ((monitoringSummary.http?.error_rate_percent || 0) < 5 ? 'DEGRADED' : 'CRITICAL')"
                        }, hero={ 'value_expr' : "monitoringSummary.http?.concurrent_requests ?? '0'" , 'unit' : 'CONNS'
                        }, stats=[ { 'label' : 'TOTAL REQ' , 'value_expr'
                        : "monitoringSummary.http?.total_requests?.toLocaleString() ?? '0'" , 'subvalue_expr' : "''" },
                        { 'label' : 'PEAK' , 'value_expr' : "monitoringSummary.http?.peak_concurrent ?? '0'"
                        , 'subvalue_expr' : "''" }, { 'label' : '5XX ERR' , 'value_expr'
                        : "(monitoringSummary.http?.status_codes?.['500'] || 0) + (monitoringSummary.http?.status_codes?.['502'] || 0) + (monitoringSummary.http?.status_codes?.['503'] || 0)"
                        , 'value_class_expr'
                        : "((monitoringSummary.http?.status_codes?.['500'] || 0) + (monitoringSummary.http?.status_codes?.['502'] || 0) + (monitoringSummary.http?.status_codes?.['503'] || 0)) > 0 ? 'text-crit' : ''"
                        , 'subvalue_expr' : "''" }, { 'label' : 'ERR RATE' , 'value_expr'
                        : "(monitoringSummary.http?.error_rate_percent || 0) + '%'" , 'value_class_expr'
                        : "(monitoringSummary.http?.error_rate_percent || 0) < 1 ? 'text-ok' : ((monitoringSummary.http?.error_rate_percent || 0) < 5 ? 'text-warn' : 'text-crit')"
                        , 'subvalue_expr' : "''" , 'primary' : true } ] ) }} <!-- Network I/O Card -->
                        {% call panel_card(title='Network I/O', meta_items=[]) %}
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="display: flex; justify-content: space-between;"><span
                                    class="text-muted text-8">↓
                                    Inbound</span><span class="text-cyan"
                                    x-text="monitoringSummary.network_io?.rx_mbps !== undefined ? monitoringSummary.network_io.rx_mbps + ' Mbps' : '—'"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;"><span
                                    class="text-muted text-8">↑
                                    Outbound</span><span class="text-ok"
                                    x-text="monitoringSummary.network_io?.tx_mbps !== undefined ? monitoringSummary.network_io.tx_mbps + ' Mbps' : '—'"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;"><span
                                    class="text-muted text-8">Errors</span><span
                                    :class="((monitoringSummary.network_io?.interfaces?.eth0?.rx_errors || 0) + (monitoringSummary.network_io?.interfaces?.eth0?.tx_errors || 0)) > 0 ? 'text-warn' : 'text-muted'"
                                    x-text="((monitoringSummary.network_io?.interfaces?.eth0?.rx_errors || 0) + (monitoringSummary.network_io?.interfaces?.eth0?.tx_errors || 0))"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;"><span
                                    class="text-muted text-8">Dropped</span><span
                                    :class="((monitoringSummary.network_io?.interfaces?.eth0?.rx_dropped || 0) + (monitoringSummary.network_io?.interfaces?.eth0?.tx_dropped || 0)) > 0 ? 'text-warn' : 'text-muted'"
                                    x-text="((monitoringSummary.network_io?.interfaces?.eth0?.rx_dropped || 0) + (monitoringSummary.network_io?.interfaces?.eth0?.tx_dropped || 0))"></span>
                            </div>
                        </div>
                        {% endcall %}

                        <!-- Container / Runtime Card -->
                        {% call panel_card(title_expr="monitoringSummary.container?.is_containerized ? 'Container' :
                        'Runtime'", meta_items=[{
                        'badge_expr': "monitoringSummary.container?.health_status?.toUpperCase()",
                        'badge_class_expr': "{'status-pill-ok': monitoringSummary.container?.health_status ===
                        'healthy', 'status-pill-warn': monitoringSummary.container?.health_status === 'starting',
                        'status-pill-crit': monitoringSummary.container?.health_status === 'unhealthy'}",
                        'badge_x_if': "monitoringSummary.container?.is_containerized &&
                        monitoringSummary.container?.health_status"
                        }]) %}
                        <template x-if="monitoringSummary.container?.is_containerized">
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">Uptime</span><span
                                        x-text="monitoringSummary.container?.container_uptime_formatted || '—'"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">Restarts</span><span
                                        :class="(monitoringSummary.container?.restart_count || 0) > 0 ? 'text-warn' : 'text-muted'"
                                        x-text="monitoringSummary.container?.restart_count ?? '0'"></span></div>
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">Memory</span><span
                                        :class="{'text-ok': (monitoringSummary.container?.memory_usage_percent || 0) < 80, 'text-warn': (monitoringSummary.container?.memory_usage_percent || 0) >= 80 && (monitoringSummary.container?.memory_usage_percent || 0) < 90, 'text-crit': (monitoringSummary.container?.memory_usage_percent || 0) >= 90}"
                                        x-text="(monitoringSummary.container?.memory_usage_percent ?? '—') + '% / ' + (monitoringSummary.container?.memory_limit_mb ? monitoringSummary.container.memory_limit_mb + ' MB' : '—')"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">PIDs / FDs</span><span
                                        x-text="(monitoringSummary.container?.pids_current ?? '—') + ' / ' + (monitoringSummary.container?.fd_current ?? '—')"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">OOM / Throttle</span><span><span
                                            :class="(monitoringSummary.container?.oom_kill_count || 0) > 0 ? 'text-crit' : 'text-muted'"
                                            x-text="monitoringSummary.container?.oom_kill_count ?? '0'"></span> /
                                        <span
                                            :class="(monitoringSummary.container?.cpu_throttled_periods || 0) > 100 ? 'text-warn' : 'text-muted'"
                                            x-text="monitoringSummary.container?.cpu_throttled_periods ?? '0'"></span></span>
                                </div>
                                <div class="text-2 text-8" style="margin-top: 4px;"
                                    x-show="monitoringSummary.container?.container_id_short">ID: <span
                                        x-text="monitoringSummary.container?.container_id_short"></span></div>
                            </div>
                        </template>
                        <template x-if="!monitoringSummary.container?.is_containerized">
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">Mode</span><span>Host Process</span></div>
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">Memory</span><span
                                        x-text="serverHealth.process?.process_memory_mb ? serverHealth.process.process_memory_mb + ' MB' : '—'"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">Threads</span><span
                                        x-text="serverHealth.process?.threads || serverHealth.system?.process_threads || '—'"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;"><span
                                        class="text-muted text-8">FDs</span><span class="text-muted"
                                        x-text="(monitoringSummary.container?.fd_current ?? '—') + (monitoringSummary.container?.fd_limit ? ' / ' + monitoringSummary.container.fd_limit : '')"></span>
                                </div>
                            </div>
                        </template>
                        {% endcall %}
                </div>

                <!-- ═══════════════════════════════════════════════════════════
                     DATABASE STATISTICS
                ═══════════════════════════════════════════════════════════ -->
                <template x-if="databaseStats.loading">
                    <div class="empty-state" style="padding: 20px;"><span>Loading database statistics...</span></div>
                </template>
                <template x-if="databaseStats.error && !databaseStats.loading">
                    <div class="empty-state" style="color: var(--signal-crit); padding: 20px;"><span
                            x-text="databaseStats.error"></span></div>
                </template>
                <template x-if="!databaseStats.loading && !databaseStats.error && databaseStats.databases">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <template x-for="db in databaseStats.databases" :key="db.name">
                            {% call panel_card(title_expr="db.name + ' Database'", meta_items=[{
                            'badge_text': 'ERROR',
                            'badge_class_expr': "'status-warn'",
                            'badge_x_if': 'db.error'
                            }]) %}
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                <div>
                                    <div class="text-2 text-8">Size</div>
                                    <div x-text="db.file_size ? fmtBytes(db.file_size) : 'N/A'"></div>
                                </div>
                                <div>
                                    <div class="text-2 text-8">Records</div>
                                    <div x-text="db.total_records ? db.total_records.toLocaleString() : 'N/A'">
                                    </div>
                                </div>
                                <div>
                                    <div class="text-2 text-8">WAL</div>
                                    <div><template x-if="db.wal_exists"><span
                                                x-text="fmtBytes(db.wal_size)"></span></template><template
                                            x-if="!db.wal_exists && db.journal_mode && db.journal_mode.toLowerCase() === 'wal'"><span
                                                class="text-muted">Idle</span></template><template
                                            x-if="!db.wal_exists && (!db.journal_mode || db.journal_mode.toLowerCase() !== 'wal')"><span
                                                class="text-muted">—</span></template></div>
                                </div>
                                <div>
                                    <div class="text-2 text-8">Last Write</div>
                                    <div class="text-1 text-85"
                                        x-text="db.last_write ? new Date(db.last_write).toLocaleTimeString() : 'N/A'">
                                    </div>
                                </div>
                            </div>
                            <div class="text-2 text-8"
                                style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.04);">
                                <template x-if="db.oldest_record_age"><span>Oldest: <span
                                            x-text="db.oldest_record_age"></span> · </span></template>
                                SQLite <span x-text="db.sqlite_version || 'N/A'"></span> · <span
                                    x-text="db.journal_mode || 'N/A'"></span> · Page <span
                                    x-text="db.page_size ? fmtBytes(db.page_size) : 'N/A'"></span>
                            </div>
                            {% endcall %}
                        </template>
                    </div>
                </template>

                <!-- ═══════════════════════════════════════════════════════════
                     RESOURCE HISTORY
                ═══════════════════════════════════════════════════════════ -->
                {% call panel_card(title='Resource History (1h)', meta_items=[{
                'text': '',
                'badge_expr': "resourceHistory.history?.length ? resourceHistory.history.length + ' samples' :
                'Collecting...'",
                'badge_class_expr': "''"
                }]) %}
                <div x-show="resourceHistory.loading && !resourceHistory.history?.length"
                    style="text-align: center; padding: 16px; color: var(--text-2); font-size: 12px;">
                    <span>Loading resource history...</span>
                </div>
                <div x-show="!resourceHistory.loading || resourceHistory.history?.length > 0">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span class="text-muted text-8">CPU</span>
                                <span class="text-2 text-8">Current: <span
                                        x-text="resourceHistory.history?.length ? (resourceHistory.history[resourceHistory.history.length-1]?.cpu_percent ?? '—') + '%' : '—'"></span>
                                    · Peak: <span
                                        x-text="resourceHistory.cpu_peak !== null ? resourceHistory.cpu_peak + '%' : '—'"></span></span>
                            </div>
                            <div class="panel-card__chart-container" style="height: 45px;">
                                <canvas id="cpuHistoryChart" x-ref="cpuHistoryChart"
                                    style="width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span class="text-muted text-8">Memory</span>
                                <span class="text-2 text-8">Current: <span
                                        x-text="resourceHistory.history?.length ? (resourceHistory.history[resourceHistory.history.length-1]?.mem_percent ?? '—') + '%' : '—'"></span>
                                    · Peak: <span
                                        x-text="resourceHistory.mem_peak !== null ? resourceHistory.mem_peak + '%' : '—'"></span></span>
                            </div>
                            <div class="panel-card__chart-container" style="height: 45px;">
                                <canvas id="memHistoryChart" x-ref="memHistoryChart"
                                    style="width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div x-show="resourceHistory.history?.length < 5"
                    style="padding: 8px 12px; background: rgba(255,180,0,0.06); border-radius: var(--radius-sm); border-left: 2px solid var(--signal-warn); font-size: 11px; color: var(--text-2); margin-top: 10px;">
                    Resource history warming up. Full data after ~5 minutes.
                </div>
                {% endcall %}

                <!-- ═══════════════════════════════════════════════════════════
                     SERVER LOGS
                ═══════════════════════════════════════════════════════════ -->
                {% call panel_card(title='Server Logs', meta_items=[{
                'badge_expr': "serverLogs.source === 'docker' ? 'DOCKER' : (serverLogs.source === 'buffer' ? 'BUFFER' :
                (serverLogs.source === 'files' ? 'FILES' : 'N/A'))",
                'badge_class_expr': "{'status-ok': serverLogs.source === 'buffer' || serverLogs.source === 'docker',
                'status-warn': serverLogs.source === 'files', 'status-crit': serverLogs.source === 'none'}"
                }]) %}
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04);">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="text-muted text-8">Lines:</span>
                        <select x-model="serverLogs.lines" @change="fetchServerLogs(serverLogs.lines)"
                            aria-label="Number of log lines"
                            style="padding: 4px 8px; background: rgba(0,0,0,0.4); border: 1px solid rgba(0,234,255,0.1); border-radius: var(--radius-sm); color: var(--text-0); font-size: 11px;">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                        <button @click="fetchServerLogs(serverLogs.lines)" aria-label="Refresh logs"
                            :disabled="serverLogs.loading"
                            style="padding: 4px 12px; background: rgba(0,234,255,0.08); border: 1px solid rgba(0,234,255,0.15); border-radius: var(--radius-sm); color: var(--signal-primary); font-size: 11px; font-weight: 500; cursor: pointer;">
                            <span x-text="serverLogs.loading ? '...' : 'Refresh'"></span>
                        </button>
                    </div>
                    <span class="text-2 text-8" x-text="serverLogs.count + ' lines'"></span>
                </div>
                <div x-show="serverLogs.loading"
                    style="text-align: center; padding: 30px; color: var(--text-2); font-size: 12px;"><span>Loading
                        logs...</span></div>
                <div x-show="!serverLogs.loading && serverLogs.logs.length > 0"
                    style="padding: 12px 0; font-family: var(--font-mono); font-size: 11px; line-height: 1.6; color: var(--text-1); max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: var(--radius-sm); margin-top: 8px;">
                    <template x-for="(log, index) in serverLogs.logs" :key="index">
                        <div style="padding: 0 12px; margin-bottom: 2px; word-break: break-all;" x-text="log"></div>
                    </template>
                </div>
                <div x-show="!serverLogs.loading && serverLogs.logs.length === 0"
                    style="text-align: center; padding: 30px; color: var(--text-3); font-size: 12px;"><span>No logs
                        available</span></div>
                <div x-show="serverLogs.container" class="text-2 text-8"
                    style="padding-top: 8px; margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.04);">
                    Container: <span x-text="serverLogs.container"></span></div>
                {% endcall %}
            </div>
        </template>
    </section>
</div>

<!-- Resource History Chart Rendering -->
<script>
    (function () {
        function renderResourceHistoryCharts() {
            const store = Alpine.store ? Alpine.store('dashboard') : null;
            if (!store || !store.resourceHistory?.history?.length) return;
            const history = store.resourceHistory.history;

            // Map data safely
            const cpuData = history.map(s => s.cpu_percent);
            const memData = history.map(s => s.mem_percent);

            const cpuCanvas = document.getElementById('cpuHistoryChart');
            if (cpuCanvas && cpuCanvas.offsetParent !== null) { // Check if visible
                renderSparkline(cpuCanvas, cpuData, '#00ffaa'); // Bright Spring Green
            }

            const memCanvas = document.getElementById('memHistoryChart');
            if (memCanvas && memCanvas.offsetParent !== null) { // Check if visible
                renderSparkline(memCanvas, memData, '#00ccff'); // Vivid Cyber Blue
            }
        }
        function renderSparkline(canvas, values, color) {
            const ctx = canvas.getContext('2d');

            // Force layout recalculation
            const parent = canvas.parentElement;
            const width = parent?.clientWidth || canvas.clientWidth || canvas.offsetWidth || 200;
            const height = parent?.clientHeight || canvas.clientHeight || canvas.offsetHeight || 45;

            // Reset backing store
            canvas.width = width * 2;
            canvas.height = height * 2;
            ctx.scale(2, 2);

            ctx.clearRect(0, 0, width, height);

            // Filter out nulls for range calculation
            const validValues = values.filter(v => v !== null && v !== undefined);
            if (validValues.length < 2) return;

            // Use 100 as fixed floor for range to keep scale consistent for %
            const max = Math.max(...validValues, 100);
            const range = max || 1;

            // Draw area fill
            ctx.beginPath();
            ctx.moveTo(0, height);
            let lastX = 0;
            values.forEach((v, i) => {
                const x = (i / Math.max(1, values.length - 1)) * width;
                if (v !== null && v !== undefined) {
                    const y = height - (v / range) * (height - 6) - 3;
                    if (i === 0 || values[i - 1] === null) ctx.lineTo(x, height);
                    ctx.lineTo(x, y);
                    lastX = x;
                }
            });
            ctx.lineTo(lastX, height);
            ctx.closePath();

            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, color + '40'); // 25% opacity
            gradient.addColorStop(1, color + '08'); // 3% opacity
            ctx.fillStyle = gradient;
            ctx.fill();

            // Draw stroke line
            ctx.beginPath();
            let started = false;
            values.forEach((v, i) => {
                if (v !== null && v !== undefined) {
                    const x = (i / Math.max(1, values.length - 1)) * width;
                    const y = height - (v / range) * (height - 6) - 3;
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });
            ctx.strokeStyle = color;
            ctx.lineWidth = 2.0;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        // Multiple render triggers to ensure charts appear
        document.addEventListener('alpine:init', () => {
            // Initial render after delays
            setTimeout(renderResourceHistoryCharts, 1500);
            setTimeout(renderResourceHistoryCharts, 3000);

            // Dynamic refresh loop
            setInterval(() => {
                if (document.querySelector('#server-tab')?.style.display !== 'none') {
                    renderResourceHistoryCharts();
                }
            }, 3000);
        });

        // Catch-all startup triggers
        window.addEventListener('load', () => {
            setTimeout(renderResourceHistoryCharts, 1000);
            setTimeout(renderResourceHistoryCharts, 2000);
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(renderResourceHistoryCharts, 100);
            }
        });

        // Render when tab becomes active
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-tab="server"]') || e.target.id === 'server-tab-btn') {
                setTimeout(renderResourceHistoryCharts, 500);
            }
        });
    })();
</script>