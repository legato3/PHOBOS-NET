                    <!-- ============================================
             FIREWALL TAB - Investigation & Incident Response
             ============================================ -->
                    <div x-show="activeTab === 'firewall'"
                        :style="activeTab === 'firewall' ? 'display:block' : 'display:none'" id="firewall-tab"
                        role="tabpanel" aria-labelledby="firewall-tab-btn" tabindex="0">

                        <!-- Firewall Stats Overview (4 stat boxes) -->
                        <div class="grid mb-6 grid-auto-fit">
                            <div class="card stat-box">
                                <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                                    <span
                                        x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.blocked_events_24h || 0).toLocaleString()">...</span>
                                    <template
                                        x-if="!firewallStatsOverview.loading && firewallStatsOverview.trends?.blocked_events">
                                        <span
                                            :style="'font-size: 0.8em; color: ' + (firewallStatsOverview.trends.blocked_events.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (firewallStatsOverview.trends.blocked_events.muted ? '0.6' : '0.8')"
                                            x-text="firewallStatsOverview.trends.blocked_events.indicator"
                                            :title="'Since last hour: ' + (firewallStatsOverview.trends.blocked_events.percent_change > 0 ? '+' : '') + firewallStatsOverview.trends.blocked_events.percent_change.toFixed(1) + '%'"></span>
                                    </template>
                                </div>
                                <div class="label">Blocked Events (24h)</div>
                            </div>
                            <div class="card stat-box">
                                <div class="value"
                                    x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.unique_blocked_sources || 0).toLocaleString()">
                                    ...</div>
                                <div class="label">Unique Blocked Sources</div>
                            </div>
                            <div class="card stat-box">
                                <div class="value"
                                    x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.new_blocked_ips || 0).toLocaleString()">
                                    ...</div>
                                <div class="label">New Blocked IPs</div>
                            </div>
                            <div class="card stat-box">
                                <div class="value" style="font-size: 0.9em;"
                                    x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.top_block_reason || 'N/A')">
                                    ...</div>
                                <div class="label">Top Block Reason</div>
                                <div x-show="!firewallStatsOverview.loading && firewallStatsOverview.top_block_count > 0"
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); margin-top: var(--space-1);"
                                    x-text="'(' + (firewallStatsOverview.top_block_count || 0).toLocaleString() + ' times)'">
                                </div>
                            </div>
                        </div>

                        <!-- IP Investigation - Compact Top Menu -->
                        <div class="card"
                            style="margin-bottom: var(--space-4); padding: var(--space-2) var(--space-3); background: rgba(0, 234, 255, 0.05); border: 1px solid rgba(0, 234, 255, 0.15);">
                            <div style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap;">
                                <span
                                    style="color: var(--text-secondary); font-size: var(--text-sm); white-space: nowrap;">üîç
                                    IP Investigation:</span>
                                <input type="text" x-model="ipInvestigation.searchIP" @keyup.enter="investigateIP()"
                                    aria-label="IP address to investigate" placeholder="IP, hostname, or domain..."
                                    class="search-box"
                                    style="flex: 1; min-width: 200px; max-width: 400px; font-size: var(--text-sm); padding: var(--space-1) var(--space-2);">
                                <button @click="investigateIP()" class="btn btn--primary"
                                    :disabled="!ipInvestigation.searchIP.trim() || ipInvestigation.loading"
                                    style="font-size: var(--text-sm); padding: var(--space-1) var(--space-2); white-space: nowrap;">
                                    <span x-show="!ipInvestigation.loading">Investigate</span>
                                    <span x-show="ipInvestigation.loading">Loading...</span>
                                </button>
                                <div class="spinner" x-show="ipInvestigation.loading"
                                    style="width: 14px; height: 14px;">
                                </div>
                            </div>
                        </div>

                        <!-- ========================================
     FIREWALL LOGS (Moved from Security)
     ======================================== -->
                        <section id="section-firewall-forensics" class="scroll-section">
                            <!-- Firewall Logs Widget -->
                            <!-- Firewall Logs Widget -->
                            {% set fw_actions %}
                            <div class="card-actions" style="gap: var(--space-2); flex-wrap: wrap;">
                                <button class="icon-btn-small"
                                    @click="recentBlocksAutoRefresh = !recentBlocksAutoRefresh; toggleRecentBlocksAutoRefresh()"
                                    title="Toggle auto-refresh"
                                    :title="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                                    :aria-label="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                                    :style="recentBlocksAutoRefresh ? 'color: var(--signal-crit);' : 'color: var(--text-muted);'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" x-show="recentBlocksAutoRefresh">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" x-show="!recentBlocksAutoRefresh">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="10" y1="8" x2="10" y2="16"></line>
                                        <line x1="14" y1="8" x2="14" y2="16"></line>
                                    </svg>
                                </button>
                            </div>
                            {% endset %}
                            {% call widget_card('recentBlocks', 'Firewall Logs', 'üî•', card_class='wide-card',
                            extra_actions=fw_actions, show_spinner=True) %}
                            <div x-show="recentBlocks.blocks.length === 0 && !recentBlocks.loading" class="empty-state">
                                <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">‚úÖ</div>
                                <p
                                    style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                    No firewall logs yet</p>
                                <p style="font-size: var(--text-xs); color: var(--text-tertiary);">The firewall has not
                                    blocked any recent traffic.</p>
                            </div>
                            <div x-show="recentBlocks.blocks.length > 0">
                                <div class="log-toolbar">
                                    <div class="log-chips">
                                        <span class="log-chip"><strong
                                                x-text="(recentBlocks.stats?.total || recentBlocks.blocks.length).toLocaleString()"></strong>
                                            Logs</span>
                                        <span class="log-chip log-chip-red"><strong
                                                x-text="((recentBlocks.stats?.actions?.block || 0) + (recentBlocks.stats?.actions?.reject || 0)).toLocaleString()"></strong>
                                            Block/Reject</span>
                                        <span class="log-chip log-chip-green"><strong
                                                x-text="(recentBlocks.stats?.actions?.pass || 0).toLocaleString()"></strong>
                                            Pass</span>
                                        <span class="log-chip log-chip-pink"><strong
                                                x-text="(recentBlocks.stats?.threats || 0).toLocaleString()"></strong>
                                            Threat</span>
                                        <span class="log-chip log-chip-slate"><strong
                                                x-text="(recentBlocks.stats?.unique_src || 0).toLocaleString()"></strong>
                                            Src</span>
                                        <span class="log-chip log-chip-slate"><strong
                                                x-text="(recentBlocks.stats?.unique_dst || 0).toLocaleString()"></strong>
                                            Dst</span>
                                    </div>
                                    <div class="log-controls">
                                        <span class="log-count"
                                            x-text="'Showing ' + Math.min(recentBlocksView || filteredRecentBlocks.length, filteredRecentBlocks.length).toLocaleString() + ' / ' + (filteredRecentBlocks.length || 0).toLocaleString() + ' (of ' + (recentBlocks.blocks.length || 0).toLocaleString() + ' total)'"></span>
                                        <span class="log-update-time" x-show="recentBlocks.lastUpdate"
                                            :title="recentBlocks.lastUpdate"
                                            x-text="'Updated ' + timeAgo(new Date(recentBlocks.lastUpdate).getTime() / 1000)"></span>
                                        <div class="log-range">
                                            <button :class="{ 'active': recentBlocksView === 50 }"
                                                @click="setRecentBlocksView(50)">50</button>
                                            <button :class="{ 'active': recentBlocksView === 200 }"
                                                @click="setRecentBlocksView(200)">200</button>
                                            <button :class="{ 'active': recentBlocksView === 1000 }"
                                                @click="setRecentBlocksView(1000)">1000</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Enhanced Filters -->
                                <div class="log-filters"
                                    style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(255, 255, 255, 0.02); border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.05);">
                                    <select x-model="recentBlocksFilter.action" class="filter-select"
                                        style="min-width: 120px;" aria-label="Filter by action">
                                        <option value="all">All Actions</option>
                                        <option value="block">Block</option>
                                        <option value="reject">Reject</option>
                                        <option value="pass">Pass</option>
                                    </select>
                                    <input type="text" x-model="recentBlocksFilter.searchIP"
                                        placeholder="Search IP address..." class="search-box"
                                        style="flex: 1; min-width: 200px; max-width: 300px;"
                                        aria-label="Search by IP address">
                                    <input type="text" x-model="recentBlocksFilter.port" placeholder="Filter by port..."
                                        class="search-box" style="min-width: 120px; max-width: 150px;"
                                        aria-label="Filter by port">
                                    <select x-model="recentBlocksFilter.protocol" class="filter-select"
                                        style="min-width: 120px;" aria-label="Filter by protocol">
                                        <option value="all">All Protocols</option>
                                        <option value="TCP">TCP</option>
                                        <option value="UDP">UDP</option>
                                        <option value="ICMP">ICMP</option>
                                    </select>
                                    <label
                                        style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; white-space: nowrap;">
                                        <input type="checkbox" x-model="recentBlocksFilter.threatOnly"
                                            style="cursor: pointer;">
                                        <span style="color: var(--text-secondary); font-size: var(--text-sm);">Threats
                                            Only</span>
                                    </label>
                                    <button
                                        @click="recentBlocksFilter = { action: 'all', searchIP: '', port: '', protocol: 'all', threatOnly: false }"
                                        class="btn btn--secondary" style="white-space: nowrap;"
                                        :disabled="recentBlocksFilter.action === 'all' && !recentBlocksFilter.searchIP && !recentBlocksFilter.port && recentBlocksFilter.protocol === 'all' && !recentBlocksFilter.threatOnly">
                                        Clear Filters
                                    </button>
                                </div>

                                <div class="log-table-wrapper">
                                    <table class="table-fixed table-compact thead-sticky"
                                        x-show="recentBlocks.blocks.length > 0">
                                        <thead>
                                            <tr>
                                                <th class="w-16">Time</th>
                                                <th class="w-13">Dir / IF</th>
                                                <th class="w-22">Source</th>
                                                <th class="w-4"></th>
                                                <th style="width: 25%;">Destination</th>
                                                <th style="width: 10%;">Protocol</th>
                                                <th style="width: 10%;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template
                                                x-for="block in filteredRecentBlocks.slice(0, recentBlocksView || filteredRecentBlocks.length)"
                                                :key="block.id || (block.src_ip + block.timestamp + block.dst_port)">
                                                <tr @click="openEventDetails(block, 'firewall')"
                                                    :class="{ 'log-row-threat': block.is_threat, 'log-row-pass': block.action === 'pass' }"
                                                    style="cursor: pointer;">
                                                    <td style="font-size: 0.85em; color: var(--text-muted);">
                                                        <div style="font-family: monospace;"
                                                            x-text="(block.timestamp || '').replace('T', ' ').split('.')[0] || block.timestamp">
                                                        </div>
                                                        <div class="log-sub" x-text="timeAgo(block.timestamp_ts)">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="log-direction"
                                                            :class="block.direction === 'in' ? 'text-green' : 'text-cyan'">
                                                            <span
                                                                x-text="(block.direction || 'in').toUpperCase()"></span>
                                                            <span class="log-sub" x-text="block.interface || '-'"
                                                                style="display:block;"></span>
                                                        </div>
                                                    </td>
                                                    <td @click.stop="openEventDetails(block, 'firewall')"
                                                        style="cursor: pointer;" title="Click to view event details">
                                                        <div class="truncate"><strong class="text-green"
                                                                x-text="block.src_ip || '--'"></strong>
                                                        </div>
                                                        <div class="log-sub"
                                                            x-text="block.src_port ? 'Port ' + block.src_port : ''">
                                                        </div>
                                                    </td>
                                                    <td style="text-align: center; color: var(--text-muted);">
                                                        ‚Üí
                                                    </td>
                                                    <td @click.stop="openEventDetails(block, 'firewall')"
                                                        style="cursor: pointer;" title="Click to view event details">
                                                        <div class="truncate">
                                                            <span class="text-cyan"
                                                                x-text="block.dst_ip || '192.168.0.1'"></span>
                                                            <span class="port-badge" style="margin-left: 4px;"
                                                                x-show="block.dst_port"
                                                                x-text="':' + block.dst_port"></span>
                                                        </div>
                                                        <div class="log-sub"
                                                            x-text="block.service || 'Unknown service'">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                            style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                                            x-text="(block.proto || 'TCP').toUpperCase()"></span>
                                                        <div class="log-sub" x-show="block.direction"
                                                            x-text="block.direction === 'in' ? 'Inbound' : 'Outbound'">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge"
                                                            :style="(block.action === 'pass') ? 'background: rgba(0,255,100,0.2); color: var(--neon-green);' : 'background: rgba(255,0,60,0.2); color: var(--neon-red);'"
                                                            x-text="(block.action || 'block').toUpperCase()"></span>
                                                        <div class="log-sub" x-show="block.is_threat"
                                                            style="color: var(--neon-red);">Threat</div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endcall %}
                        </section>
                        <!-- ========================================
     FIREWALL INVESTIGATION TOOLS
     ======================================== -->

                        <!-- Alert Correlation & Attack Chains -->
                        <section id="section-alert-correlation" class="scroll-section" style="margin-bottom: 32px;">
                            {% call widget_card('alertCorrelation', 'Alert Correlation & Attack Chains', 'üîó',
                            card_class='wide-card', show_spinner=True) %}
                            <!-- Explanation Panel (Collapsible) -->
                            <div class="card"
                                style="margin-bottom: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0, 243, 255, 0.06); border: 1px solid rgba(0, 243, 255, 0.15); border-radius: var(--radius-sm);">
                                <button @click="alertCorrelation.showExplanation = !alertCorrelation.showExplanation"
                                    style="display: flex; align-items: center; gap: var(--space-2); width: 100%; background: none; border: none; color: var(--neon-cyan); cursor: pointer; padding: 0; font-size: var(--text-sm);">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        :style="'transform: rotate(' + (alertCorrelation.showExplanation ? '90' : '0') + 'deg); transition: transform 0.2s;'">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                    <span style="font-weight: var(--font-weight-semibold);">‚ÑπÔ∏è How Alert
                                        Correlation
                                        Works</span>
                                </button>
                                <div x-show="alertCorrelation.showExplanation"
                                    style="margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.5;">
                                    <p style="margin: 0 0 var(--space-2) 0;">Analyzes security alerts to
                                        identify
                                        <strong>multi-stage attack chains</strong> by correlating related
                                        alerts
                                        from the same IP address within a 1-hour time window.
                                    </p>
                                    <div
                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-2); font-size: var(--text-xs);">
                                        <div><strong>üîç Detection:</strong> Groups
                                            by IP and time proximity</div>
                                        <div><strong>‚ö° Chains:</strong> Sequences
                                            of related security events</div>
                                        <div><strong>üéØ Use:</strong> Identify
                                            attack progression patterns</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats Summary -->
                            <div
                                style="display: flex; gap: var(--space-2); margin-bottom: var(--space-3); flex-wrap: wrap;">
                                <div class="card"
                                    style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Attack Chains</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                        x-text="alertCorrelation.chains?.length || 0"></div>
                                </div>
                                <div class="card"
                                    style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                                    <div
                                        style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                                        Total Alerts Correlated</div>
                                    <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-cyan);"
                                        x-text="(alertCorrelation.chains || []).reduce((sum, chain) => sum + (chain.alerts?.length || 0), 0)">
                                    </div>
                                </div>
                            </div>

                            <!-- Attack Chains List -->
                            <div x-show="alertCorrelation.chains && alertCorrelation.chains.length > 0">
                                <template x-for="(chain, idx) in alertCorrelation.chains" :key="idx">
                                    <div class="card"
                                        style="margin-bottom: var(--space-4); border-left: 4px solid var(--neon-red); background: rgba(255,0,60,0.05); transition: background var(--motion-base);">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3); flex-wrap: wrap; gap: var(--space-2);">
                                            <div style="flex: 1;">
                                                <div
                                                    style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                                    <strong class="text-red" style="font-size: var(--text-lg);">Attack
                                                        Chain
                                                        #<span x-text="idx + 1"></span></strong>
                                                    <span class="badge"
                                                        style="background: rgba(255,0,60,0.2); color: var(--neon-red); font-size: var(--text-sm);"
                                                        x-text="chain.alerts.length + ' alerts'"></span>
                                                </div>
                                                <div style="margin-bottom: var(--space-2);">
                                                    <span
                                                        style="color: var(--text-secondary); font-size: var(--text-sm);">Source
                                                        IP: </span>
                                                    <span class="text-cyan"
                                                        style="font-family: var(--font-mono); font-weight: var(--font-weight-semibold); cursor: pointer;"
                                                        @click="openIPInvestigationModal(chain.ip)" x-text="chain.ip"
                                                        title="Click to investigate this IP"></span>
                                                </div>
                                                <div style="color: var(--text-muted); font-size: var(--text-sm);">
                                                    <span x-text="chain.timespan"></span>
                                                </div>
                                            </div>
                                            <button @click="openIPInvestigationModal(chain.ip)"
                                                class="btn btn--secondary"
                                                style="white-space: nowrap; font-size: var(--text-sm);">
                                                üîç Investigate IP
                                            </button>
                                        </div>
                                        <div>
                                            <div
                                                style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--text-primary); font-size: var(--text-sm);">
                                                Attack Progression Timeline:</div>
                                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                                <template x-for="(alert, alertIdx) in chain.alerts" :key="alert.id">
                                                    <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border-left: 3px solid var(--neon-red); transition: background var(--motion-base);"
                                                        :style="alertIdx === 0 ? 'border-left-color: var(--neon-green);' : (alertIdx === chain.alerts.length - 1 ? 'border-left-color: var(--neon-red);' : 'border-left-color: var(--neon-yellow);')">
                                                        <div style="flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: rgba(255,0,60,0.2); display: flex; align-items: center; justify-content: center; font-size: var(--text-xs); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                                            x-text="alertIdx + 1"></div>
                                                        <div style="flex: 1; min-width: 0;">
                                                            <div
                                                                style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; margin-bottom: var(--space-1);">
                                                                <span class="badge"
                                                                    :class="'cat-' + (alert.type || '').toLowerCase().replace(/[^a-z0-9]/g, '-')"
                                                                    style="font-size: var(--text-xs);"
                                                                    x-text="alert.type || 'Unknown'"></span>
                                                                <span
                                                                    style="color: var(--text-muted); font-size: var(--text-xs); font-family: var(--font-mono);"
                                                                    x-text="alert.time"></span>
                                                            </div>
                                                            <div style="color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.4;"
                                                                x-text="alert.message || 'Security alert detected'">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!alertCorrelation.chains || alertCorrelation.chains.length === 0"
                                class="empty-state" style="text-align: center;">
                                <p
                                    style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                                    No Correlated Attack Chains Detected</p>
                                <p
                                    style="font-size: var(--text-xs); color: var(--text-tertiary); max-width: 400px; margin: 0 auto;">
                                    No multi-stage attack patterns identified. Network appears secure or attacks are
                                    isolated events.
                                </p>
                            </div>
                            {% endcall %}
                        </section>


                        <!-- Active Flows Widget -->
                        <section id="section-flows" class="scroll-section" style="margin-bottom: 32px;">
                            {% set conv_actions %}
                            <div class="flex gap-2" style="align-items: center;">
                                <div class="status-pills">
                                    <span class="status-pill running">Live</span>
                                </div>
                                <button @click="setFlowsViewLimit(15)"
                                    :class="{ 'btn--primary': flows.viewLimit === 15, 'btn--secondary': flows.viewLimit !== 15 }"
                                    class="btn"
                                    style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                    Top 15
                                </button>
                                <button @click="setFlowsViewLimit(50)"
                                    :class="{ 'btn--primary': flows.viewLimit === 50, 'btn--secondary': flows.viewLimit !== 50 }"
                                    class="btn"
                                    style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                                    Top 50
                                </button>
                                <button @click="setFlowsViewLimit(999999)"
                                    :class="{ 'btn--primary': flows.viewLimit >= 999999, 'btn--secondary': flows.viewLimit < 999999 }"
                                    class="btn"
                                    style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);"
                                    title="Show all flows (may be slow)">
                                    All
                                </button>
                            </div>
                            {% endset %}
                            {% call widget_card('flows', 'Active Flows', '‚ö°', card_class='wide-card',
                            extra_actions=conv_actions, footer_content=conv_footer, show_spinner=True) %}
                            <!-- List View -->
                            <table class="table-fixed table-compact">
                                <thead>
                                    <tr>
                                        <th style="width: 15%; cursor: pointer;" @click="sortFlows('age')">
                                            Age <span x-show="flows.sortKey==='age'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 28%; cursor: pointer;" @click="sortFlows('src')">
                                            Source <span x-show="flows.sortKey==='src'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 6%;" title="Flow Direction">Dir</th>
                                        <th style="width: 28%; cursor: pointer;" @click="sortFlows('dst')">
                                            Destination <span x-show="flows.sortKey==='dst'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 8%; cursor: pointer;" @click="sortFlows('proto_name')">
                                            Proto <span x-show="flows.sortKey==='proto_name'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                        <th style="width: 10%; cursor: pointer;" @click="sortFlows('bytes')">
                                            Stats <span x-show="flows.sortKey==='bytes'"
                                                x-text="flows.sortDesc ? '‚ñº' : '‚ñ≤'"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(flow, idx) in flows.flows.slice(0, flows.viewLimit || 15)"
                                        :key="idx">
                                        <tr class="flow-item" @click="openFlowDetails(flow)" style="cursor: pointer;"
                                            :class="{
                                                'flow-item-heavy': flow.bytes > 1000000,
                                                'flow-item-long-duration': flow.duration_seconds > 300 && flow.bytes < 100000,
                                                'flow-item-burst': flow.duration_seconds < 10 && flow.bytes > 500000,
                                                'flow-item-detected': flow.is_detected
                                            }">
                                            <td class="text-xs text-muted font-mono" style="position: relative;">
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span
                                                        x-text="flow.age_seconds !== undefined ? formatAge(flow.age_seconds) : (flow.first_seen_ts ? timeAgo(flow.first_seen_ts) : timeAgo(flow.ts))"></span>
                                                    <!-- Detection indicator (Phase 2) -->
                                                    <template x-if="flow.is_detected">
                                                        <span
                                                            :title="flow.detection_reason || 'Detected: Long-lived low-volume external flow'"
                                                            style="font-size: 0.85em; opacity: 0.9; color: var(--neon-yellow); cursor: help; line-height: 1; display: inline-block; font-weight: bold;"
                                                            x-text="'‚ö†Ô∏è'"></span>
                                                    </template>
                                                    <!-- Threat correlation indicator (Phase 1) -->
                                                    <template x-if="flow.has_threat">
                                                        <span
                                                            :title="'Threat correlation: ' + (flow.threat_count || 0) + ' threat IP(s) in this flow'"
                                                            style="font-size: 0.85em; opacity: 0.8; color: var(--neon-red); cursor: help; line-height: 1; display: inline-block;"
                                                            x-text="'üõ°Ô∏è'"></span>
                                                    </template>
                                                    <!-- Interesting flow indicators (max 2) -->
                                                    <template
                                                        x-if="flow.interesting_flags && flow.interesting_flags.length > 0">
                                                        <div style="display: flex; gap: 3px; margin-left: 4px;">
                                                            <template
                                                                x-for="(flag, idx) in flow.interesting_flags.slice(0, 2)"
                                                                :key="idx">
                                                                <span :title="getInterestingFlowTooltip(flag)"
                                                                    class="flow-interest-icon"
                                                                    x-text="getInterestingFlowIcon(flag)"></span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </td>
                                            <td @click.stop="openIPModal(flow.src)" class="flow-cell-ip">
                                                <!-- Line 1: IP address (primary) + optional hostname inline -->
                                                <div class="flow-line-1">
                                                    <span
                                                        :class="'flag-icon flag-icon-' + (flow.src_country_code || 'unknown').toLowerCase()"
                                                        class="flow-flag"></span>
                                                    <strong class="text-cyan flow-ip" x-text="flow.src"></strong>
                                                    <span x-show="flow.src_hostname" class="flow-hostname"
                                                        :title="flow.src_hostname"
                                                        x-text="' ' + flow.src_hostname"></span>
                                                </div>
                                                <!-- Line 2: Port / protocol (secondary, muted) - always present -->
                                                <div class="flow-line-2">
                                                    <span class="text-muted flow-port">
                                                        <span x-text="flow.src_port"></span>
                                                        <span x-show="flow.proto_name"
                                                            x-text="'/' + flow.proto_name"></span>
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="flow-cell-dir" :title="getDirectionIndicator(flow).title"
                                                :style="'color: ' + getDirectionIndicator(flow).color + ';'">
                                                <span class="flow-dir-icon"
                                                    x-text="getDirectionIndicator(flow).symbol"></span>
                                            </td>
                                            <td @click.stop="openIPModal(flow.dst)" class="flow-cell-ip">
                                                <!-- Line 1: IP address (primary) + optional hostname inline -->
                                                <div class="flow-line-1">
                                                    <span
                                                        :class="'flag-icon flag-icon-' + (flow.dst_country_code || 'unknown').toLowerCase()"
                                                        class="flow-flag"></span>
                                                    <strong class="text-cyan flow-ip" x-text="flow.dst"></strong>
                                                    <span x-show="flow.dst_hostname" class="flow-hostname"
                                                        :title="flow.dst_hostname"
                                                        x-text="' ' + flow.dst_hostname"></span>
                                                </div>
                                                <!-- Line 2: Port / protocol (secondary, muted) - always present -->
                                                <div class="flow-line-2">
                                                    <span class="text-muted flow-port">
                                                        <span x-text="flow.dst_port"></span>
                                                        <span
                                                            x-show="flow.service && flow.service !== flow.dst_port && flow.service !== 'unknown'"
                                                            x-text="' (' + flow.service + ')'"></span>
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="flow-cell-proto">
                                                <span class="text-muted flow-proto" x-text="flow.proto_name"></span>
                                            </td>
                                            <td style="padding: 6px 8px;">
                                                <div style="font-size:0.85em; white-space: nowrap;">
                                                    <strong class="text-green" x-text="flow.bytes_fmt"></strong>
                                                    <span
                                                        style="color:var(--text-muted); margin-left:4px; font-size: 0.8em;"
                                                        x-text="flow.duration"></span>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <div x-show="flows.flows.length > (flows.viewLimit || 15)"
                                style="margin-top: var(--space-2); padding: var(--space-2); background: rgba(255, 200, 0, 0.1); border: 1px solid rgba(255, 200, 0, 0.3); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: var(--text-sm);">
                                Showing <strong x-text="flows.viewLimit || 15"></strong> of <strong
                                    x-text="flows.flows.length"></strong> flows. Use controls above to show more.
                            </div>
                            {% endcall %}
                        </section>
                    </div>
