<div x-show="activeTab === 'firewall'" :style="activeTab === 'firewall' ? 'display:block' : 'display:none'"
    id="firewall-tab" role="tabpanel" aria-labelledby="firewall-tab-btn" tabindex="0">

    <!-- Firewall Stats Overview (4 stat boxes) -->
    <div class="grid mb-6 grid-auto-fit" style="margin-bottom: var(--space-6) !important;">
        <div class="card stat-box">
            <div class="value" style="display: flex; align-items: center; gap: var(--space-2);">
                <span
                    x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.blocked_events_24h || 0).toLocaleString()">...</span>
                <template x-if="!firewallStatsOverview.loading && firewallStatsOverview.trends?.blocked_events">
                    <span
                        :style="'font-size: 0.8em; color: ' + (firewallStatsOverview.trends.blocked_events.muted ? 'var(--text-tertiary)' : 'var(--text-secondary)') + '; opacity: ' + (firewallStatsOverview.trends.blocked_events.muted ? '0.6' : '0.8')"
                        x-text="firewallStatsOverview.trends.blocked_events.indicator"
                        :title="'Since last hour: ' + (firewallStatsOverview.trends.blocked_events.percent_change > 0 ? '+' : '') + firewallStatsOverview.trends.blocked_events.percent_change.toFixed(1) + '%'"></span>
                </template>
            </div>
            <div class="label">Blocked Events (24h)</div>
        </div>
        <div class="card stat-box">
            <div class="value"
                x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.unique_blocked_sources || 0).toLocaleString()">
                ...</div>
            <div class="label">Unique Blocked Sources</div>
        </div>
        <div class="card stat-box">
            <div class="value"
                x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.new_blocked_ips || 0).toLocaleString()">
                ...</div>
            <div class="label">New Blocked IPs</div>
        </div>
        <div class="card stat-box">
            <div class="value" style="font-size: 0.9em;"
                x-text="firewallStatsOverview.loading ? '...' : (firewallStatsOverview.top_block_reason || 'N/A')">
                ...</div>
            <div class="label">Top Block Reason</div>
        </div>
    </div>

    <!-- IP Investigation - Compact Top Menu -->
    <div class="card"
        style="margin-bottom: var(--space-6); padding: var(--space-3) var(--space-4); background: var(--card-bg); border: 1px solid var(--card-border);">
        <div style="display: flex; align-items: center; gap: var(--space-3); flex-wrap: wrap;">
            <span
                style="color: var(--text-secondary); font-size: var(--text-sm); white-space: nowrap; font-weight: 500;">üîç
                IP Investigation:</span>
            <input type="text" x-model="ipInvestigation.searchIP" @keyup.enter="investigateIP()"
                aria-label="IP address to investigate" placeholder="IP, hostname, or domain..."
                style="flex: 1; min-width: 200px; max-width: 400px; font-size: var(--text-sm); padding: var(--space-2) var(--space-3); background: var(--input-bg); border: 1px solid var(--input-border); border-radius: var(--radius-sm); color: var(--text-primary); font-family: var(--font-mono);">
            <button @click="investigateIP()" class="btn btn--primary"
                :disabled="!ipInvestigation.searchIP.trim() || ipInvestigation.loading"
                style="font-size: var(--text-sm); padding: var(--space-2) var(--space-3); white-space: nowrap;">
                <span x-show="!ipInvestigation.loading">Investigate</span>
                <span x-show="ipInvestigation.loading">Loading...</span>
            </button>
            <div class="spinner" x-show="ipInvestigation.loading" style="width: 14px; height: 14px;">
            </div>
        </div>
    </div>

    <!-- ========================================
     FIREWALL DECISIONS (Intelligence View)
     ======================================== -->
    <section id="section-firewall-decisions" class="scroll-section" style="margin-bottom: var(--space-6);">
        {% set fd_actions %}
        <div class="flex gap-2" style="align-items: center;">
            <button @click="setFirewallDecisionsTimeWindow('15m')"
                :class="{ 'btn--primary': firewallDecisions.timeWindow === '15m', 'btn--secondary': firewallDecisions.timeWindow !== '15m' }"
                class="btn" style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                LAST 15M
            </button>
            <button @click="setFirewallDecisionsTimeWindow('1h')"
                :class="{ 'btn--primary': firewallDecisions.timeWindow === '1h', 'btn--secondary': firewallDecisions.timeWindow !== '1h' }"
                class="btn" style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                1H
            </button>
            <button @click="setFirewallDecisionsTimeWindow('24h')"
                :class="{ 'btn--primary': firewallDecisions.timeWindow === '24h', 'btn--secondary': firewallDecisions.timeWindow !== '24h' }"
                class="btn" style="font-size: var(--text-xs); padding: var(--space-1) var(--space-2);">
                24H
            </button>
        </div>
        {% endset %}

        {% call widget_card('firewallDecisions', 'Firewall Decisions (Live)', 'üõ°Ô∏è', card_class='wide-card',
        extra_actions=fd_actions, show_spinner=True) %}

        <template x-if="firewallDecisions.summary">
            <div>
                <!-- ROW A: Summary Tiles (5 compact stat tiles) -->
                <div class="fw-summary-tiles">
                    <div class="fw-summary-tile">
                        <div class="fw-summary-tile__label">BLOCKS</div>
                        <div class="fw-summary-tile__value" style="color: var(--signal-crit);"
                            x-text="firewallDecisions.summary.totals.block.toLocaleString()"></div>
                    </div>
                    <div class="fw-summary-tile">
                        <div class="fw-summary-tile__label">PASSES</div>
                        <div class="fw-summary-tile__value" style="color: var(--signal-ok);"
                            x-text="firewallDecisions.summary.totals.pass.toLocaleString()"></div>
                    </div>
                    <div class="fw-summary-tile">
                        <div class="fw-summary-tile__label">NATS</div>
                        <div class="fw-summary-tile__value" style="color: var(--neon-cyan);"
                            x-text="firewallDecisions.summary.totals.nat.toLocaleString()"></div>
                    </div>
                    <div class="fw-summary-tile">
                        <div class="fw-summary-tile__label">UNIQUE SOURCES</div>
                        <div class="fw-summary-tile__value"
                            x-text="firewallDecisions.summary.unique.src.toLocaleString()"></div>
                    </div>
                    <div class="fw-summary-tile">
                        <div class="fw-summary-tile__label">TOP REASON</div>
                        <div class="fw-summary-tile__reason" x-text="firewallDecisions.summary.top_reason.label"></div>
                        <div class="fw-summary-tile__count"
                            x-text="firewallDecisions.summary.top_reason.count.toLocaleString() + ' hits'"></div>
                    </div>
                </div>

                <!-- ROW B: Visual + Ranked Lists (no table) -->
                <div class="fw-intelligence-row">
                    <!-- Left: Decision Mix Chart -->
                    <div class="fw-intelligence-section fw-decision-mix">
                        <div class="fw-intelligence-section__title">DECISION MIX</div>

                        <!-- Stacked horizontal bar -->
                        <div class="fw-mix-bar">
                            <div class="fw-mix-segment fw-mix-pass"
                                :style="'width: ' + firewallDecisions.summary.mix.pass_pct + '%'"
                                :title="'Pass: ' + firewallDecisions.summary.mix.pass_pct + '%'">
                            </div>
                            <div class="fw-mix-segment fw-mix-nat"
                                :style="'width: ' + firewallDecisions.summary.mix.nat_pct + '%'"
                                :title="'NAT: ' + firewallDecisions.summary.mix.nat_pct + '%'">
                            </div>
                            <div class="fw-mix-segment fw-mix-block"
                                :style="'width: ' + firewallDecisions.summary.mix.block_pct + '%'"
                                :title="'Block: ' + firewallDecisions.summary.mix.block_pct + '%'">
                            </div>
                        </div>

                        <!-- Mix legend with deltas -->
                        <div class="fw-mix-legend">
                            <div class="fw-mix-legend__item">
                                <span class="fw-mix-dot fw-mix-pass"></span>
                                <span x-text="'Pass ' + firewallDecisions.summary.mix.pass_pct + '%'"></span>
                                <span class="fw-mix-delta"
                                    :class="firewallDecisions.summary.mix.delta.pass_pct > 0 ? 'fw-mix-delta-up' : 'fw-mix-delta-down'"
                                    x-text="(firewallDecisions.summary.mix.delta.pass_pct > 0 ? '+' : '') + firewallDecisions.summary.mix.delta.pass_pct + 'pp'"></span>
                            </div>
                            <div class="fw-mix-legend__item">
                                <span class="fw-mix-dot fw-mix-nat"></span>
                                <span x-text="'NAT ' + firewallDecisions.summary.mix.nat_pct + '%'"></span>
                                <span class="fw-mix-delta"
                                    :class="firewallDecisions.summary.mix.delta.nat_pct > 0 ? 'fw-mix-delta-up' : 'fw-mix-delta-down'"
                                    x-text="(firewallDecisions.summary.mix.delta.nat_pct > 0 ? '+' : '') + firewallDecisions.summary.mix.delta.nat_pct + 'pp'"></span>
                            </div>
                            <div class="fw-mix-legend__item">
                                <span class="fw-mix-dot fw-mix-block"></span>
                                <span x-text="'Block ' + firewallDecisions.summary.mix.block_pct + '%'"></span>
                                <span class="fw-mix-delta"
                                    :class="firewallDecisions.summary.mix.delta.block_pct > 0 ? 'fw-mix-delta-up' : 'fw-mix-delta-down'"
                                    x-text="(firewallDecisions.summary.mix.delta.block_pct > 0 ? '+' : '') + firewallDecisions.summary.mix.delta.block_pct + 'pp'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Middle: Top Drivers List -->
                    <div class="fw-intelligence-section fw-top-drivers">
                        <div class="fw-intelligence-section__title">
                            TOP DRIVERS
                            <button @click="viewFirewallLogsFiltered('action', 'all')" class="fw-view-details">
                                View details ‚Üí
                            </button>
                        </div>
                        <div class="fw-driver-list">
                            <template x-for="(driver, idx) in firewallDecisions.summary.top_reasons.slice(0, 8)" :key="idx">
                                <div class="fw-driver-item" @click="viewFirewallLogsFiltered('reason', driver.reason)"
                                    role="button" tabindex="0">
                                    <span class="fw-driver-badge" :class="'fw-badge-' + driver.action.toLowerCase()"
                                        x-text="driver.action"></span>
                                    <span class="fw-driver-reason" x-text="driver.reason"></span>
                                    <span class="fw-driver-count" x-text="driver.count.toLocaleString()"></span>
                                    <span class="fw-driver-delta"
                                        :class="driver.delta > 0 ? 'fw-delta-up' : (driver.delta < 0 ? 'fw-delta-down' : '')"
                                        x-text="driver.delta > 0 ? '‚Üë' + driver.delta : (driver.delta < 0 ? '‚Üì' + Math.abs(driver.delta) : '‚Äî')"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Right: Top Targets List -->
                    <div class="fw-intelligence-section fw-top-targets">
                        <div class="fw-intelligence-section__title">
                            TOP TARGETS
                            <button @click="loadTab('traffic-explorer')" class="fw-view-details">
                                Flow Search ‚Üí
                            </button>
                        </div>
                        <div class="fw-target-list">
                            <template x-for="(target, idx) in firewallDecisions.summary.top_targets.slice(0, 8)" :key="idx">
                                <div class="fw-target-item" @click="openIPModal(target.dst)"
                                    role="button" tabindex="0">
                                    <span class="fw-target-dst" x-text="target.dst"></span>
                                    <span class="fw-target-port" x-text="target.port !== '‚Äî' ? ':' + target.port : ''"></span>
                                    <span class="fw-target-proto" x-text="target.proto"></span>
                                    <span class="fw-target-count" x-text="target.count.toLocaleString()"></span>
                                    <span class="fw-target-badge" :class="'fw-badge-' + target.action.toLowerCase()"
                                        x-text="target.action"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Empty state -->
        <template x-if="!firewallDecisions.loading && !firewallDecisions.summary">
            <div class="empty-state" style="text-align: center; padding: var(--space-6);">
                <p style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                    No Decision Data</p>
                <p style="font-size: var(--text-xs); color: var(--text-tertiary);">
                    No firewall activity in the selected window.
                </p>
            </div>
        </template>

        {% endcall %}
    </section>

    <!-- ========================================
     FIREWALL LOGS (Moved from Security)
     ======================================== -->
    <section id="section-firewall-logs" class="scroll-section" style="margin-bottom: var(--space-6);">
        <!-- Firewall Filter Logs Widget -->
        {% set fw_actions %}
        <div class="card-actions" style="gap: var(--space-2); flex-wrap: wrap;">
            <button class="icon-btn-small"
                @click="recentBlocksAutoRefresh = !recentBlocksAutoRefresh; toggleRecentBlocksAutoRefresh()"
                title="Toggle auto-refresh"
                :title="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                :aria-label="recentBlocksAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                :style="recentBlocksAutoRefresh ? 'color: var(--signal-crit);' : 'color: var(--text-muted);'">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    x-show="recentBlocksAutoRefresh">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    x-show="!recentBlocksAutoRefresh">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="10" y1="8" x2="10" y2="16"></line>
                    <line x1="14" y1="8" x2="14" y2="16"></line>
                </svg>
            </button>
        </div>
        {% endset %}
        {% call widget_card('recentBlocks', 'Firewall Filter Logs', 'üõ°Ô∏è', card_class='wide-card mb-6',
        extra_actions=fw_actions, show_spinner=True) %}
        <div x-show="recentBlocks.blocks.length === 0 && !recentBlocks.loading" class="empty-state">
            <div style="font-size: 32px; margin-bottom: var(--space-2);" aria-hidden="true">‚úÖ</div>
            <p
                style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                No filterlog events yet</p>
            <p style="font-size: var(--text-xs); color: var(--text-tertiary);">The firewall has not
                blocked any recent traffic via filterlog.</p>
        </div>
        <div x-show="recentBlocks.blocks.length > 0">
            <div class="log-toolbar">
                <div class="log-chips">
                    <span class="log-chip"><strong
                            x-text="(recentBlocks.stats?.total || recentBlocks.blocks.length).toLocaleString()"></strong>
                        Logs</span>
                    <span class="log-chip log-chip-red"><strong
                            x-text="((recentBlocks.stats?.actions?.block || 0) + (recentBlocks.stats?.actions?.reject || 0)).toLocaleString()"></strong>
                        Block/Reject</span>
                    <span class="log-chip log-chip-green"><strong
                            x-text="(recentBlocks.stats?.actions?.pass || 0).toLocaleString()"></strong>
                        Pass</span>
                    <span class="log-chip log-chip-pink"><strong
                            x-text="(recentBlocks.stats?.threats || 0).toLocaleString()"></strong>
                        Threat</span>
                    <span class="log-chip log-chip-slate"><strong
                            x-text="(recentBlocks.stats?.unique_src || 0).toLocaleString()"></strong>
                        Src</span>
                    <span class="log-chip log-chip-slate"><strong
                            x-text="(recentBlocks.stats?.unique_dst || 0).toLocaleString()"></strong>
                        Dst</span>
                </div>
                <div class="log-controls">
                    <span class="log-count"
                        x-text="'Showing ' + Math.min(recentBlocksView || filteredRecentBlocks.length, filteredRecentBlocks.length).toLocaleString() + ' / ' + (filteredRecentBlocks.length || 0).toLocaleString() + ' (of ' + (recentBlocks.blocks.length || 0).toLocaleString() + ' total)'"></span>
                    <span class="log-update-time" x-show="recentBlocks.lastUpdate" :title="recentBlocks.lastUpdate"
                        x-text="'Updated ' + timeAgo(new Date(recentBlocks.lastUpdate).getTime() / 1000)"></span>
                    <div class="log-range">
                        <button :class="{ 'active': recentBlocksView === 50 }"
                            @click="setRecentBlocksView(50)">50</button>
                        <button :class="{ 'active': recentBlocksView === 200 }"
                            @click="setRecentBlocksView(200)">200</button>
                        <button :class="{ 'active': recentBlocksView === 1000 }"
                            @click="setRecentBlocksView(1000)">1000</button>
                    </div>
                </div>
            </div>
            <!-- Enhanced Filters -->
            <div class="log-filters"
                style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(255, 255, 255, 0.02); border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.05);">
                <select x-model="recentBlocksFilter.action" class="filter-select" style="min-width: 120px;"
                    aria-label="Filter by action">
                    <option value="all">All Actions</option>
                    <option value="block">Block</option>
                    <option value="reject">Reject</option>
                    <option value="pass">Pass</option>
                </select>
                <input type="text" x-model="recentBlocksFilter.searchIP" placeholder="Search IP address..."
                    style="flex: 1; min-width: 200px; max-width: 300px; padding: var(--space-2) var(--space-3); background: var(--input-bg); border: 1px solid var(--input-border); border-radius: var(--radius-sm); color: var(--text-primary); font-family: var(--font-mono); font-size: var(--text-sm);"
                    aria-label="Search by IP address">
                <input type="text" x-model="recentBlocksFilter.port" placeholder="Filter by port..."
                    style="min-width: 120px; max-width: 150px; padding: var(--space-2) var(--space-3); background: var(--input-bg); border: 1px solid var(--input-border); border-radius: var(--radius-sm); color: var(--text-primary); font-family: var(--font-mono); font-size: var(--text-sm);"
                    aria-label="Filter by port">
                <select x-model="recentBlocksFilter.protocol" class="filter-select" style="min-width: 120px;"
                    aria-label="Filter by protocol">
                    <option value="all">All Protocols</option>
                    <option value="TCP">TCP</option>
                    <option value="UDP">UDP</option>
                    <option value="ICMP">ICMP</option>
                </select>
                <label
                    style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; white-space: nowrap;">
                    <input type="checkbox" x-model="recentBlocksFilter.threatOnly" style="cursor: pointer;">
                    <span style="color: var(--text-secondary); font-size: var(--text-sm);">Threats
                        Only</span>
                </label>
                <button
                    @click="recentBlocksFilter = { action: 'all', searchIP: '', port: '', protocol: 'all', threatOnly: false }"
                    class="btn btn--secondary" style="white-space: nowrap;"
                    :disabled="recentBlocksFilter.action === 'all' && !recentBlocksFilter.searchIP && !recentBlocksFilter.port && recentBlocksFilter.protocol === 'all' && !recentBlocksFilter.threatOnly">
                    Clear Filters
                </button>
            </div>

            <div class="log-table-wrapper">
                <table class="table-fixed table-compact thead-sticky" x-show="recentBlocks.blocks.length > 0">
                    <thead>
                        <tr>
                            <th class="w-16">Time</th>
                            <th class="w-13">Dir / IF</th>
                            <th class="w-22">Source</th>
                            <th class="w-4"></th>
                            <th style="width: 20%;">Destination</th>
                            <th style="width: 8%;">Proto</th>
                            <th style="width: 10%;">Label</th>
                            <th style="width: 10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template
                            x-for="block in filteredRecentBlocks.slice(0, recentBlocksView || filteredRecentBlocks.length)"
                            :key="block.id || (block.src_ip + block.timestamp + block.dst_port)">
                            <tr @click="openEventDetails(block, 'firewall')"
                                :class="{ 'log-row-threat': block.is_threat, 'log-row-pass': block.action === 'pass' }"
                                style="cursor: pointer;">
                                <td style="font-size: 0.85em; color: var(--text-muted);">
                                    <div style="font-family: monospace;"
                                        x-text="(block.timestamp || '').replace('T', ' ').split('.')[0] || block.timestamp">
                                    </div>
                                    <div class="log-sub" x-text="timeAgo(block.timestamp_ts)">
                                    </div>
                                </td>
                                <td>
                                    <div class="log-direction"
                                        :class="block.direction === 'in' ? 'text-green' : 'text-cyan'">
                                        <span x-text="(block.direction || 'in').toUpperCase()"></span>
                                        <span class="log-sub" x-text="block.interface || '-'"
                                            style="display:block;"></span>
                                    </div>
                                </td>
                                <td @click.stop="openEventDetails(block, 'firewall')" style="cursor: pointer;"
                                    title="Click to view event details">
                                    <div class="truncate"><strong class="text-green"
                                            x-text="block.src_ip || '--'"></strong>
                                    </div>
                                    <div class="log-sub" x-text="block.src_port ? 'Port ' + block.src_port : ''">
                                    </div>
                                </td>
                                <td style="text-align: center; color: var(--text-muted);">
                                    ‚Üí
                                </td>
                                <td @click.stop="openEventDetails(block, 'firewall')" style="cursor: pointer;"
                                    title="Click to view event details">
                                    <div class="truncate">
                                        <span class="text-cyan" x-text="block.dst_ip || '192.168.0.1'"></span>
                                        <span class="port-badge" style="margin-left: 4px;" x-show="block.dst_port"
                                            x-text="':' + block.dst_port"></span>
                                    </div>
                                    <div class="log-sub" x-text="block.service || 'Unknown service'">
                                    </div>
                                </td>
                                <td>
                                    <span class="badge"
                                        style="background: rgba(0,243,255,0.15); color: var(--neon-cyan);"
                                        x-text="(block.proto || 'TCP').toUpperCase()"></span>
                                    <div class="log-sub" x-show="block.direction"
                                        x-text="block.direction === 'in' ? 'Inbound' : 'Outbound'">
                                    </div>
                                </td>
                                <td>
                                    <div class="truncate cursor-pointer hover:text-primary transition-colors duration-200"
                                        style="max-width: 100px; font-family: monospace; font-size: 0.85em; color: var(--text-secondary);"
                                        x-text="block.rule_label || '-'"
                                        :title="(block.rule_label_full || block.rule_label || 'No label') + ' (Click to copy ID)'"
                                        @click="if(block.rule_label_full) { 
                                            navigator.clipboard.writeText(block.rule_label_full); 
                                            $store.notifications.add('Copied Rule ID: ' + block.rule_label_full, 'info');
                                         }">
                                    </div>
                                </td>
                                <td>
                                    <span class="badge"
                                        :style="(block.action === 'pass') ? 'background: rgba(0,255,100,0.2); color: var(--neon-green);' : 'background: rgba(255,0,60,0.2); color: var(--neon-red);'"
                                        x-text="(block.action || 'block').toUpperCase()"></span>
                                    <button class="btn btn--ghost"
                                        style="margin-top: 4px; padding: 2px 6px; font-size: 0.7em;"
                                        @click.stop="openTrafficExplorer({ search: block.src_ip || block.dst_ip, direction: block.direction, protocol: block.proto, action: block.action, range: timeRange })">
                                        View traffic
                                    </button>
                                    <div class="log-sub" x-show="block.is_threat" style="color: var(--neon-red);">Threat
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        {% endcall %}

        <!-- OPNsense Syslog (Port 515) Widget -->
        {% set fw515_actions %}
        <div class="card-actions" style="gap: var(--space-2); flex-wrap: wrap;">
            <button class="icon-btn-small"
                @click="firewallSyslogAutoRefresh = !firewallSyslogAutoRefresh; toggleFirewallSyslogAutoRefresh()"
                :title="firewallSyslogAutoRefresh ? 'Pause auto-refresh' : 'Resume auto-refresh'"
                :style="firewallSyslogAutoRefresh ? 'color: var(--signal-ok);' : 'color: var(--text-muted);'">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    x-show="firewallSyslogAutoRefresh">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    x-show="!firewallSyslogAutoRefresh">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="10" y1="8" x2="10" y2="16"></line>
                    <line x1="14" y1="8" x2="14" y2="16"></line>
                </svg>
            </button>
        </div>
        {% endset %}
        {% call widget_card('syslog515', 'Firewall Application Logs', 'üì°', card_class='wide-card',
        extra_actions=fw515_actions, show_spinner=True) %}

        <!-- Empty State -->
        <div x-show="!syslog515.logs || syslog515.logs.length === 0 && !syslog515.loading"
            style="text-align: center; padding: 48px 16px; color: var(--text-muted);">
            <div style="font-size: 48px; margin-bottom: var(--space-3); opacity: 0.5;">üì°</div>
            <p
                style="font-size: var(--text-base); margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--text-secondary);">
                No application logs yet</p>
            <p style="font-size: var(--text-sm); color: var(--text-tertiary); max-width: 400px; margin: 0 auto;">
                Configure OPNsense to send syslog to port 515. Events will appear here once received.</p>
        </div>

        <!-- Content when logs exist -->
        <div x-show="syslog515.logs && syslog515.logs.length > 0">
            <!-- Summary Stats -->
            <div class="log-toolbar">
                <div class="log-chips">
                    <span class="log-chip"><strong x-text="(syslog515.stats?.total || 0).toLocaleString()"></strong>
                        Total</span>
                    <span class="log-chip log-chip-cyan" x-show="syslog515.receiver?.received > 0">
                        <strong x-text="(syslog515.receiver?.received || 0).toLocaleString()"></strong> Received
                    </span>
                    <!-- Program breakdown chips -->
                    <template x-for="(count, program) in (syslog515.stats?.programs || {})" :key="program">
                        <span class="log-chip log-chip-purple" style="font-size: 0.85em;">
                            <strong x-text="count"></strong>
                            <span x-text="program"></span>
                        </span>
                    </template>
                </div>
                <div class="log-controls">
                    <span class="log-count"
                        x-text="'Showing ' + Math.min(syslog515View || 100, filteredSyslog515.length).toLocaleString() + ' / ' + (filteredSyslog515.length || 0).toLocaleString()"></span>
                    <span class="log-update-time" x-show="syslog515.lastUpdate" :title="syslog515.lastUpdate"
                        x-text="'Updated ' + timeAgo(new Date(syslog515.lastUpdate).getTime() / 1000)"></span>
                    <div class="log-range">
                        <button :class="{ 'active': syslog515View === 50 }" @click="syslog515View = 50">50</button>
                        <button :class="{ 'active': syslog515View === 100 }" @click="syslog515View = 100">100</button>
                        <button :class="{ 'active': syslog515View === 500 }" @click="syslog515View = 500">500</button>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="log-filters"
                style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(255, 255, 255, 0.02); border-radius: var(--radius-md); border: 1px solid rgba(255, 255, 255, 0.05);">
                <input type="text" x-model="syslog515Filter.search" placeholder="Search logs..." class="search-box"
                    style="flex: 1; min-width: 250px; max-width: 400px;" aria-label="Search logs">
                <select x-model="syslog515Filter.program" class="filter-select" style="min-width: 140px;"
                    aria-label="Filter by program">
                    <option value="all">All Programs</option>
                    <template x-for="(count, program) in (syslog515.stats?.programs || {})" :key="program">
                        <option :value="program" x-text="program + ' (' + count + ')'"></option>
                    </template>
                </select>
                <button @click="syslog515Filter = { search: '', program: 'all' }" class="btn btn--secondary"
                    style="white-space: nowrap;"
                    :disabled="!syslog515Filter.search && syslog515Filter.program === 'all'">
                    Clear Filters
                </button>
            </div>

            <!-- Logs Table -->
            <div class="log-table-wrapper">
                <table class="table-fixed table-compact thead-sticky">
                    <thead>
                        <tr>
                            <th style="width: 160px;">Time</th>
                            <th style="width: 120px;">Program</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(log, index) in filteredSyslog515.slice(0, syslog515View || 100)" :key="index">
                            <tr style="vertical-align: top;">
                                <td style="font-size: 0.85em; color: var(--text-muted); white-space: nowrap;">
                                    <div style="font-family: monospace;"
                                        x-text="(log.timestamp || '').replace('T', ' ').split('.')[0]"></div>
                                    <div class="log-sub" x-text="timeAgo(log.timestamp_ts)"></div>
                                </td>
                                <td>
                                    <span class="badge"
                                        style="background: rgba(138, 43, 226, 0.2); color: #b388ff; font-size: 0.85em;"
                                        x-text="log.program || 'unknown'"></span>
                                </td>
                                <td style="font-size: 0.9em; color: var(--text-secondary); word-break: break-word;">
                                    <span x-text="log.message || '(no message)'"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        {% endcall %}
    </section>
    <!-- ========================================
     FIREWALL INVESTIGATION TOOLS
     ======================================== -->

    <!-- Alert Correlation & Attack Chains -->
    <section id="section-alert-correlation" class="scroll-section" style="margin-bottom: var(--space-6);">
        {% call widget_card('alertCorrelation', 'Alert Correlation & Attack Chains', 'üîó',
        card_class='wide-card', show_spinner=True) %}
        <!-- Explanation Panel (Collapsible) -->
        <div class="card"
            style="margin-bottom: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0, 243, 255, 0.06); border: 1px solid rgba(0, 243, 255, 0.15); border-radius: var(--radius-sm);">
            <button @click="alertCorrelation.showExplanation = !alertCorrelation.showExplanation"
                style="display: flex; align-items: center; gap: var(--space-2); width: 100%; background: none; border: none; color: var(--neon-cyan); cursor: pointer; padding: 0; font-size: var(--text-sm);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    :style="'transform: rotate(' + (alertCorrelation.showExplanation ? '90' : '0') + 'deg); transition: transform 0.2s;'">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
                <span style="font-weight: var(--font-weight-semibold);">‚ÑπÔ∏è How Alert
                    Correlation
                    Works</span>
            </button>
            <div x-show="alertCorrelation.showExplanation"
                style="margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.5;">
                <p style="margin: 0 0 var(--space-2) 0;">Analyzes security alerts to
                    identify
                    <strong>multi-stage attack chains</strong> by correlating related
                    alerts
                    from the same IP address within a 1-hour time window.
                </p>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-2); font-size: var(--text-xs);">
                    <div><strong>üîç Detection:</strong> Groups
                        by IP and time proximity</div>
                    <div><strong>‚ö° Chains:</strong> Sequences
                        of related security events</div>
                    <div><strong>üéØ Use:</strong> Identify
                        attack progression patterns</div>
                </div>
            </div>
        </div>

        <!-- Stats Summary -->
        <div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-3); flex-wrap: wrap;">
            <div class="card" style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                    Attack Chains</div>
                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                    x-text="alertCorrelation.chains?.length || 0"></div>
            </div>
            <div class="card" style="padding: var(--space-2) var(--space-3); flex: 1; min-width: 140px;">
                <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                    Total Alerts Correlated</div>
                <div style="font-size: var(--text-xl); font-weight: var(--font-weight-bold); color: var(--neon-cyan);"
                    x-text="(alertCorrelation.chains || []).reduce((sum, chain) => sum + (chain.alerts?.length || 0), 0)">
                </div>
            </div>
        </div>

        <!-- Attack Chains List -->
        <div x-show="alertCorrelation.chains && alertCorrelation.chains.length > 0">
            <template x-for="(chain, idx) in alertCorrelation.chains" :key="idx">
                <div class="card"
                    style="margin-bottom: var(--space-4); border-left: 4px solid var(--neon-red); background: rgba(255,0,60,0.05); transition: background var(--motion-base);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3); flex-wrap: wrap; gap: var(--space-2);">
                        <div style="flex: 1;">
                            <div
                                style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <strong class="text-red" style="font-size: var(--text-lg);">Attack
                                    Chain
                                    #<span x-text="idx + 1"></span></strong>
                                <span class="badge"
                                    style="background: rgba(255,0,60,0.2); color: var(--neon-red); font-size: var(--text-sm);"
                                    x-text="chain.alerts.length + ' alerts'"></span>
                            </div>
                            <div style="margin-bottom: var(--space-2);">
                                <span style="color: var(--text-secondary); font-size: var(--text-sm);">Source
                                    IP: </span>
                                <span class="text-cyan"
                                    style="font-family: var(--font-mono); font-weight: var(--font-weight-semibold); cursor: pointer;"
                                    @click="openIPInvestigationModal(chain.ip)" x-text="chain.ip"
                                    title="Click to investigate this IP"></span>
                            </div>
                            <div style="color: var(--text-muted); font-size: var(--text-sm);">
                                <span x-text="chain.timespan"></span>
                            </div>
                        </div>
                        <button @click="openIPInvestigationModal(chain.ip)" class="btn btn--secondary"
                            style="white-space: nowrap; font-size: var(--text-sm);">
                            üîç Investigate IP
                        </button>
                    </div>
                    <div>
                        <div
                            style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--text-primary); font-size: var(--text-sm);">
                            Attack Progression Timeline:</div>
                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <template x-for="(alert, alertIdx) in chain.alerts" :key="alert.id">
                                <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border-left: 3px solid var(--neon-red); transition: background var(--motion-base);"
                                    :style="alertIdx === 0 ? 'border-left-color: var(--neon-green);' : (alertIdx === chain.alerts.length - 1 ? 'border-left-color: var(--neon-red);' : 'border-left-color: var(--neon-yellow);')">
                                    <div style="flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: rgba(255,0,60,0.2); display: flex; align-items: center; justify-content: center; font-size: var(--text-xs); font-weight: var(--font-weight-bold); color: var(--neon-red);"
                                        x-text="alertIdx + 1"></div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div
                                            style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; margin-bottom: var(--space-1);">
                                            <span class="badge"
                                                :class="'cat-' + (alert.type || '').toLowerCase().replace(/[^a-z0-9]/g, '-')"
                                                style="font-size: var(--text-xs);"
                                                x-text="alert.type || 'Unknown'"></span>
                                            <span
                                                style="color: var(--text-muted); font-size: var(--text-xs); font-family: var(--font-mono);"
                                                x-text="alert.time"></span>
                                        </div>
                                        <div style="color: var(--text-secondary); font-size: var(--text-sm); line-height: 1.4;"
                                            x-text="alert.message || 'Security alert detected'">
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div x-show="!alertCorrelation.chains || alertCorrelation.chains.length === 0" class="empty-state"
            style="text-align: center;">
            <p
                style="font-size: var(--text-base); margin-bottom: var(--space-1); font-weight: var(--font-weight-semibold);">
                No Correlated Attack Chains Detected</p>
            <p style="font-size: var(--text-xs); color: var(--text-tertiary); max-width: 400px; margin: 0 auto;">
                No multi-stage attack patterns identified. Network appears secure or attacks are
                isolated events.
            </p>
        </div>
        {% endcall %}
    </section>


</div>

<!-- Removed Decision Detail Modal - widget now uses aggregated intelligence view -->
