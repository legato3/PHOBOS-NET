const CACHE_NAME='netflow-dashboard-v2.6.1';const STATIC_ASSETS=['/','/static/style.min.css','/static/app.min.js','/static/chart.min.js','/static/chartjs-chart-sankey.min.js','/static/alpine.min.js','/static/alpine-collapse.min.js','/static/vis-network.min.js'];const API_CACHE_TTL=60;self.addEventListener('install',(event)=>{event.waitUntil(caches.open(CACHE_NAME).then(cache=>{console.log('[SW] Caching static assets');return cache.addAll(STATIC_ASSETS);}).then(()=>self.skipWaiting()));});self.addEventListener('activate',(event)=>{event.waitUntil(caches.keys().then(keys=>{return Promise.all(keys.filter(key=>key!==CACHE_NAME).map(key=>{console.log('[SW] Removing old cache:',key);return caches.delete(key);}));}).then(()=>self.clients.claim()));});self.addEventListener('fetch',(event)=>{const url=new URL(event.request.url);if(event.request.method!=='GET')return;if(url.pathname.includes('/stream'))return;if(STATIC_ASSETS.some(asset=>url.pathname.endsWith(asset)||url.pathname===asset)){event.respondWith(caches.match(event.request).then(cached=>{if(cached)return cached;return fetch(event.request).then(response=>{if(response.status===200){const clone=response.clone();caches.open(CACHE_NAME).then(cache=>cache.put(event.request,clone));}
return response;});}));return;}
if(url.pathname.startsWith('/api/')){event.respondWith(fetch(event.request).then(response=>{if(response.status===200){const clone=response.clone();caches.open(CACHE_NAME).then(cache=>cache.put(event.request,clone));}
return response;}).catch(()=>{return caches.match(event.request).then(cached=>{if(cached){console.log('[SW] Serving cached API:',url.pathname);return cached;}
return new Response(JSON.stringify({error:'Offline',cached:false}),{status:503,headers:{'Content-Type':'application/json'}});});}));return;}
event.respondWith(fetch(event.request).catch(()=>caches.match(event.request)));});self.addEventListener('message',(event)=>{if(event.data==='skipWaiting'){self.skipWaiting();}
if(event.data==='clearCache'){caches.delete(CACHE_NAME);}});